<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UP_DON_CT + C·ªôt b·ªï sung</title>

  <style>
    /* =======================
       PH·∫¶N GIAO DI·ªÜN (CSS) ƒê√É T·ªêI ∆ØU
       ======================= */

    * { 
      box-sizing: border-box; 
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f5f9ff; 
      color: #333;
    }
    
    .container { 
      max-width: 100%; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,.08); 
      overflow: hidden; 
    }

    .header { 
      background: linear-gradient(135deg, #4a6ee0 0%, #6a3db3 100%); 
      color: #fff; 
      padding: 24px 20px; 
      text-align: center; 
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }
    
    .header h2 { 
      margin: 0; 
      font-size: 26px; 
      font-weight: 500; 
      position: relative;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .controls { 
      padding: 18px 20px; 
      background: #f8fafe; 
      border-bottom: 1px solid #e1e8f0; 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      flex-wrap: wrap; 
    }
    
    .search-box { 
      flex: 1; 
      min-width: 200px; 
      padding: 10px 14px; 
      border: 1px solid #d1d9e6; 
      border-radius: 6px; 
      font-size: 14px; 
      transition: all 0.3s ease;
      background: #fff;
    }
    
    .search-box:focus {
      outline: none;
      border-color: #4a6ee0;
      box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.1);
    }
    
    .btn { 
      padding: 10px 18px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 14px; 
      font-weight: 500;
      transition: all 0.3s ease; 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary { 
      background: #4a6ee0; 
      color: #fff; 
    }
    
    .btn-primary:hover { 
      background: #3a5ecf; 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(74, 110, 224, 0.2);
    }
    
    .btn-success { 
      background: #2ecc71; 
      color: #fff; 
    }
    
    .btn-success:hover { 
      background: #27ae60; 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2);
    }

    .loading { 
      text-align: center; 
      padding: 50px; 
      color: #666; 
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    .spinner { 
      display: inline-block; 
      width: 32px; 
      height: 32px; 
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #4a6ee0; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }

    .table-wrapper { 
      overflow-x: auto; 
      max-height: 65vh; 
      border: 1px solid #e1e8f0;
      border-radius: 8px;
      margin: 0 20px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    table { 
      border-collapse: collapse; 
      width: 100%; 
      font-size: 13px; 
      background: #fff; 
      min-width: 1200px;
    }
    
    th, td { 
      border: 1px solid #e8edf5; 
      padding: 10px 8px; 
      text-align: left; 
      white-space: nowrap; 
    }
    
    th { 
      background: linear-gradient(to bottom, #f8fafe, #eef2f9); 
      position: sticky; 
      top: 0; 
      font-weight: 600; 
      color: #2c3e50; 
      z-index: 10; 
      box-shadow: 0 2px 3px -1px rgba(0,0,0,.1); 
      border-bottom: 2px solid #d1d9e6;
    }
    
    tr:nth-child(even) { 
      background-color: #fafcff; 
    }
    
    tr:hover { 
      background-color: #f0f5ff; 
    }

    /* T√¥ v√†ng ƒë∆°n h·ªßy */
    .cancelled-order { 
      background-color: #fff9e6 !important; 
      border-left: 4px solid #e6b400 !important; 
    }
    
    .cancelled-order td { 
      background-color: #fff9e6 !important; 
    }
    
    .cancelled-order:hover td { 
      background-color: #fff0b3 !important; 
    }

    .error { 
      background: #ffeaea; 
      color: #d63031; 
      padding: 16px 20px; 
      margin: 20px; 
      border-radius: 8px; 
      border: 1px solid #ffcccc; 
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .error::before {
      content: '‚ö†Ô∏è';
      font-size: 18px;
    }
    
    .stats { 
      padding: 14px 20px; 
      background: #f0f5ff; 
      color: #2c3e50; 
      font-size: 14px; 
      border-top: 1px solid #e1e8f0; 
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .stats-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stats-badge {
      background: #4a6ee0;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .stats-badge.huy {
      background: #e6b400;
    }
    
    .stats-badge.hople {
      background: #2ecc71;
    }

    /* C·∫£i ti·∫øn responsive */
    @media (max-width: 1024px) {
      .table-wrapper {
        margin: 0 10px 10px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .controls { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 12px;
      }
      
      .search-box { 
        min-width: unset; 
        margin-bottom: 0; 
      }
      
      .btn-group {
        display: flex;
        gap: 10px;
      }
      
      .btn {
        flex: 1;
        justify-content: center;
      }
      
      .stats {
        flex-direction: column;
        gap: 8px;
      }
    }
    
    @media (max-width: 480px) {
      .header h2 {
        font-size: 20px;
      }
      
      .btn-group {
        flex-direction: column;
      }
    }
    
    /* Scrollbar t√πy ch·ªânh */
    .table-wrapper::-webkit-scrollbar {
      height: 10px;
      width: 10px;
    }
    
    .table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 5px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Hi·ªáu ·ª©ng cho c√°c h√†ng khi t·∫£i */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    tr {
      animation: fadeIn 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Ti√™u ƒë·ªÅ -->
    <div class="header">
      <h2>D·ªØ li·ªáu t·ª´ Sheet UP_DON_CT (k√®m c·ªôt b·ªï sung)</h2>
    </div>

    <!-- Thanh c√¥ng c·ª•: t√¨m ki·∫øm, l·ªçc theo ng√†y, l√†m m·ªõi, xu·∫•t CSV/Excel -->
    <div class="controls">
      <input type="text" id="searchInput" class="search-box" placeholder="üîç T√¨m ki·∫øm trong b·∫£ng...">
      <input type="date" id="dateFilter" class="search-box" style="max-width:200px;">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="refreshData()">
          <span>üîÑ</span> L√†m m·ªõi
        </button>
        <button class="btn btn-success" onclick="exportToCSV()">
          <span>üìä</span> Xu·∫•t CSV
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
          <span>üìã</span> Xu·∫•t Excel
        </button>
      </div>
    </div>

    <!-- Tr·∫°ng th√°i loading -->
    <div id="loadingDiv" class="loading">
      <span class="spinner"></span>
      <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <!-- Hi·ªÉn th·ªã l·ªói -->
    <div id="errorDiv" class="error" style="display:none;"></div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table id="data-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>

    <!-- Th·ªëng k√™ -->
    <div class="stats" id="statsDiv" style="display:none;"></div>
  </div>

  <!-- SheetJS ƒë·ªÉ xu·∫•t Excel .xlsx -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    /* =======================
       C·∫§U H√åNH & TR·∫†NG TH√ÅI
       ======================= */

    // API Google Apps Script tr·∫£ v·ªÅ JSON
    const API_URL = "https://script.google.com/macros/s/AKfycbwwR3GI-ZwWKsueXHJX2rehWzjZOW9MfeQsmbY_mPSk0F6asm3BwfBh1Pps3jELfYJ7/exec";

    // Bi·∫øn gi·ªØ d·ªØ li·ªáu g·ªëc v√† d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã (sau l·ªçc)
    let originalData = [];
    let filteredData = [];

    /* =======================
       KHAI B√ÅO C·ªòT B·ªî SUNG
       - Gi·ªØ ƒë·ªß m·ªçi c·ªôt tr√™n UI v√† khi xu·∫•t
       - N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√¨ d√πng default
       ======================= */
    const extraColumns = [
      { name: "Hi·ªÉn th·ªã tr√™n s·ªï", default: "0" },
      { name: "H√¨nh th·ª©c b√°n h√†ng", default: "0" },
      { name: "Ph∆∞∆°ng th·ª©c thanh to√°n", default: "0" },
      { name: "Ki√™m phi·∫øu xu·∫•t kho", default: "1" },
      { name: "L·∫≠p k√®m h√≥a ƒë∆°n", default: "0" },
      { name: "ƒê√£ l·∫≠p h√≥a ƒë∆°n", default: "0" },
      { name: "Ng√†y h·∫°ch to√°n (*)", default: "" },
      { name: "Ng√†y ch·ª©ng t·ª´ (*)", default: "" },
      { name: "S·ªë ch·ª©ng t·ª´ (*)", default: "" },
      { name: "S·ªë phi·∫øu xu·∫•t", default: "" },
      { name: "L√Ω do xu·∫•t", default: "" },
      { name: "S·ªë h√≥a ƒë∆°n", default: "" },
      { name: "Ng√†y h√≥a ƒë∆°n", default: "" },
      { name: "M√£ ƒë∆°n h√†ng", default: "" },
      { name: "M√£ th·ªëng k√™", default: "" },
      { name: "M√£ kh√°ch h√†ng", default: "" },
      { name: "T√™n kh√°ch h√†ng", default: "" },
      { name: "ƒê·ªãa ch·ªâ", default: "" },
      { name: "M√£ s·ªë thu·∫ø", default: "" },
      { name: "Di·ªÖn gi·∫£i", default: "" },
      { name: "N·ªôp v√†o TK", default: "" },
      { name: "NV b√°n h√†ng", default: "" },
      { name: "M√£ h√†ng (*)", default: "" },
      { name: "T√™n h√†ng", default: "" },
      { name: "H√†ng khuy·∫øn m·∫°i", default: "" },
      { name: "TK Ti·ªÅn/Chi ph√≠/N·ª£ (*)", default: "131" },
      { name: "TK Doanh thu/C√≥ (*)", default: "5111" },
      { name: "ƒêVT", default: "" },
      { name: "S·ªë l∆∞·ª£ng", default: "" },
      { name: "ƒê∆°n gi√° sau thu·∫ø", default: "" },
      { name: "ƒê∆°n gi√°", default: "" },            /* <-- s·∫Ω hi·ªÉn th·ªã t·ª´ row.don_gia_1 */
      { name: "Th√†nh ti·ªÅn", default: "" },         /* <-- don_gia_1 * slg_xuat */
      { name: "T·ª∑ l·ªá CK (%)", default: "" },
      { name: "Ti·ªÅn chi·∫øt kh·∫•u", default: "" },
      { name: "TK chi·∫øt kh·∫•u", default: "" },
      { name: "Gi√° t√≠nh thu·∫ø XK", default: "" },
      { name: "% thu·∫ø XK", default: "" },
      { name: "Ti·ªÅn thu·∫ø XK", default: "" },
      { name: "TK thu·∫ø XK", default: "" },
      { name: "% thu·∫ø GTGT", default: "" },
      { name: "Ti·ªÅn thu·∫ø GTGT", default: "" },
      { name: "TK thu·∫ø GTGT", default: "" },
      { name: "HH kh√¥ng TH tr√™n t·ªù khai thu·∫ø GTGT", default: "" },
      { name: "Kho", default: "KMN" },
      { name: "TK gi√° v·ªën", default: "632" },
      { name: "TK Kho", default: "1561" },
      { name: "ƒê∆°n gi√° v·ªën", default: "" },
      { name: "Ti·ªÅn v·ªën", default: "" },
      { name: "H√†ng h√≥a gi·ªØ h·ªô/b√°n h·ªô", default: "" }
    ];

    /* =======================
       H√ÄM TI·ªÜN √çCH (Helper)
       ======================= */

    // Chu·∫©n ho√° tr·∫°ng th√°i ƒë·ªÉ so s√°nh an to√†n
    function normalizeStatus(val) { return String(val || "").trim().toUpperCase(); }
    function isCancelled(row) { return normalizeStatus(row.trang_thai) === "1 H·ª¶Y"; }

    // ƒê·ªãnh d·∫°ng ng√†y dd/mm/yyyy (ƒë·∫ßu v√†o c√≥ th·ªÉ l√† chu·ªói date ho·∫∑c ISO)
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
    }

    // ƒê·ªãnh d·∫°ng ng√†y ddmmyy ƒë·ªÉ g·∫Øn v√†o S·ªë ch·ª©ng t·ª´
    function formatDateShort(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      return `${String(d.getDate()).padStart(2,"0")}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getFullYear()).slice(-2)}`;
    }

    // Chuy·ªÉn gi√° tr·ªã v·ªÅ s·ªë an to√†n (lo·∫°i , v√† space)
    function toNumber(v) {
      const n = parseFloat(String(v ?? "").replace(/[\s,]/g, ""));
      return isNaN(n) ? 0 : n;
    }

    // T·∫°o S·ªë ch·ª©ng t·ª´ / S·ªë phi·∫øu xu·∫•t theo quy t·∫Øc ƒë√£ m√¥ t·∫£
    function generateSoChungTu(row) {
      let prefix = "";
      const sanValue = (row["san"] || "").toUpperCase().trim();
      const khungValue = (row["khung_h"] || "").trim();

      if (sanValue === "SHOPEE") prefix = (khungValue === "10H" ? "N " : "") + "SPE";
      else if (sanValue === "LAZADA") prefix = "LDZ";
      else if (sanValue === "BEST") prefix = "GHN";
      else if (sanValue === "ƒê∆†N NGO√ÄI") prefix = "XDN";

      const maGian = (row["ma_gian"] || "").trim();
      const ngayFmt = formatDateShort(row["ngay"]);
      return prefix && maGian && ngayFmt ? `${prefix}-${maGian}-${ngayFmt}.MN` : "";
    }

    // Sinh Di·ªÖn gi·∫£i tu·ª≥ theo s√†n/khung gi·ªù
    function generateDienGiai(row) {
      const sanValue = (row["san"] || "").trim();
      const khungValue = (row["khung_h"] || "").trim();
      const part = (sanValue === "ƒê∆†N NGO√ÄI") ? " " : (khungValue === "10H" ? " NOW " : " ");
      return `MN${part}${sanValue} NG√ÄY ${formatDate(row["ngay"])}`;
    }

    // L·∫•y gi√° tr·ªã hi·ªÉn th·ªã cho t·ª´ng c·ªôt (g·ªìm c·∫£ c·ªôt b·ªï sung & c·ªôt JSON)
    function getCellValue(row, columnName) {
      // C·ªôt ng√†y: hi·ªÉn th·ªã dd/mm/yyyy
      if (columnName === "Ng√†y h·∫°ch to√°n (*)" || columnName === "Ng√†y ch·ª©ng t·ª´ (*)") 
        return formatDate(row["ngay"]);

      // S·ªë ch·ª©ng t·ª´ / phi·∫øu xu·∫•t
      if (columnName === "S·ªë ch·ª©ng t·ª´ (*)" || columnName === "S·ªë phi·∫øu xu·∫•t")
        return generateSoChungTu(row);

      // M√£ ƒë∆°n h√†ng = mdh/mvd (n·∫øu ƒë·ªß), ho·∫∑c mdh, ho·∫∑c mvd
      if (columnName === "M√£ ƒë∆°n h√†ng") {
        const mdh = row["mdh"] || "";
        const mvd = row["mvd"] || "";
        return mdh && mvd ? `${mdh}/${mvd}` : (mdh || mvd);
      }

      // M√£ KH = m√£ gian
      if (columnName === "M√£ kh√°ch h√†ng") return row["ma_gian"] || "";

      // Di·ªÖn gi·∫£i
      if (columnName === "Di·ªÖn gi·∫£i") return generateDienGiai(row);

      // M√£ h√†ng (*)
      if (columnName === "M√£ h√†ng (*)") return row["sku_cha"] || "";

    

      // S·ªë l∆∞·ª£ng
      if (columnName === "S·ªë l∆∞·ª£ng") return row["slg_xuat"] || "";

      // ƒê∆°n gi√°: L·∫§Y T·ª™ don_gia_1 (theo y√™u c·∫ßu)
      if (columnName === "ƒê∆°n gi√°") {
        const dg = toNumber(row["don_gia_1"]);
        return dg ? dg.toLocaleString('vi-VN') : "";
      }

      // Th√†nh ti·ªÅn = don_gia_1 * slg_xuat (theo y√™u c·∫ßu)
      if (columnName === "Th√†nh ti·ªÅn") {
        const donGia = toNumber(row["don_gia_1"]);
        const soLuong = toNumber(row["slg_xuat"]);
        const thanhTien = donGia * soLuong;
        return thanhTien ? thanhTien.toLocaleString('vi-VN') : "";
      }

      // N·∫øu l√† c·ªôt b·ªï sung -> tr·∫£ m·∫∑c ƒë·ªãnh; n·∫øu l√† c·ªôt JSON g·ªëc -> tr·∫£ theo d·ªØ li·ªáu
      const extra = extraColumns.find(c => c.name === columnName);
      return extra ? extra.default : (row[columnName] || "");
    }

    /* =======================
       H√ÄM QU·∫¢N L√ù UI
       ======================= */
    function showLoading() {
      document.getElementById('loadingDiv').style.display = 'flex';
      document.getElementById('tableWrapper').style.display = 'none';
      document.getElementById('statsDiv').style.display = 'none';
      document.getElementById('errorDiv').style.display = 'none';
    }
    
    function hideLoading() {
      document.getElementById('loadingDiv').style.display = 'none';
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('errorDiv');
      errorDiv.textContent = message;
      errorDiv.style.display = 'flex';
      hideLoading();
    }
    
    function showTable() {
      document.getElementById('tableWrapper').style.display = 'block';
      document.getElementById('statsDiv').style.display = 'flex';
      hideLoading();
    }

    /* =======================
       RENDER B·∫¢NG
       - S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t
       - T√¥ v√†ng ƒë∆°n h·ªßy
       ======================= */
    function renderTable(data) {
      if (!data || !data.length) {
        showError("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã");
        return;
      }

      // S·∫Øp x·∫øp theo ng√†y (m·ªõi nh·∫•t tr∆∞·ªõc)
      const sorted = [...data].sort((a,b) => new Date(b.ngay || 0) - new Date(a.ngay || 0));

      // T·∫°o header: c·ªôt b·ªï sung + c·ªôt JSON g·ªëc
      const jsonHeaders = Object.keys(sorted[0]);
      const allHeaders = extraColumns.map(c => c.name).concat(jsonHeaders);

      const headerRow = document.getElementById("header-row");
      const body = document.getElementById("data-body");
      headerRow.innerHTML = "";
      body.innerHTML = "";

      // Render header
      allHeaders.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });

      // Render rows
      sorted.forEach(row => {
        const tr = document.createElement("tr");
        if (isCancelled(row)) tr.classList.add('cancelled-order'); // t√¥ v√†ng ƒë∆°n h·ªßy
        allHeaders.forEach(col => {
          const td = document.createElement("td");
          td.textContent = getCellValue(row, col);
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });

      filteredData = sorted;
      updateStats(); // c·∫≠p nh·∫≠t th·ªëng k√™
      showTable();
    }

    /* =======================
       TH·ªêNG K√ä
       - T·ªïng hi·ªÉn th·ªã
       - ‚úÖ h·ª£p l·ªá (kh√¥ng h·ªßy)
       - üü® h·ªßy
       ======================= */
    function updateStats() {
      const total = originalData.length;
      const visible = filteredData.length;
      const huy = filteredData.filter(r => isCancelled(r)).length;
      const hopLe = visible - huy;
      
      document.getElementById('statsDiv').innerHTML = `
        <div class="stats-item">
          <span>T·ªïng s·ªë d√≤ng:</span>
          <span class="stats-badge">${total}</span>
        </div>
        <div class="stats-item">
          <span>Hi·ªÉn th·ªã:</span>
          <span class="stats-badge">${visible}</span>
        </div>
        <div class="stats-item">
          <span>‚úÖ ƒê∆°n h·ª£p l·ªá:</span>
          <span class="stats-badge hople">${hopLe}</span>
        </div>
        <div class="stats-item">
          <span>üü® ƒê∆°n h·ªßy:</span>
          <span class="stats-badge huy">${huy}</span>
        </div>
      `;
    }

    /* =======================
       L·ªåC D·ªÆ LI·ªÜU
       - Theo ng√†y (ch√≠nh x√°c theo ng√†y)
       - Theo t·ª´ kho√° (t√¨m trong m·ªçi c·ªôt JSON)
       ======================= */
    function filterTable(searchTerm) {
      const selectedDate = document.getElementById('dateFilter').value;
      let filtered = [...originalData];

      if (selectedDate) {
        const filterDate = new Date(selectedDate);
        filtered = filtered.filter(row => new Date(row.ngay).toDateString() === filterDate.toDateString());
      }
      if (searchTerm && searchTerm.trim()) {
        const t = searchTerm.toLowerCase();
        filtered = filtered.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(t)));
      }
      renderTable(filtered);
    }
    
    function filterByDate() {
      const term = document.getElementById('searchInput').value;
      filterTable(term);
    }

    /* =======================
       XU·∫§T CSV
       - L·∫•y t·ª´ filteredData (nh·ªØng g√¨ ƒëang hi·ªÉn th·ªã)
       - Lo·∫°i b·ªè ƒë∆°n h·ªßy
       - Xu·∫•t ƒë·∫ßy ƒë·ªß: c·ªôt b·ªï sung + c·ªôt JSON
       ======================= */
    function exportToCSV() {
      if (!filteredData.length) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'); return; }

      // Ch·ªâ xu·∫•t ƒë∆°n KH√îNG H·ª¶Y
      const dataToExport = filteredData.filter(r => !isCancelled(r));
      if (!dataToExport.length) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ xu·∫•t'); return; }

      const jsonHeaders = Object.keys(dataToExport[0]);
      const allHeaders = extraColumns.map(c => c.name).concat(jsonHeaders);

      let csv = allHeaders.map(h => `"${h}"`).join(',') + '\n';
      dataToExport.forEach(row => {
        const values = allHeaders.map(col => `"${String(getCellValue(row, col)).replace(/"/g, '""')}"`);
        csv += values.join(',') + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `UP_DON_CT_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }

    /* =======================
       XU·∫§T EXCEL (.xlsx) - SheetJS
       - Y√äU C·∫¶U: ch·ªçn ng√†y
       - L·ªçc theo ng√†y + lo·∫°i b·ªè ƒë∆°n h·ªßy
       - Ch·ªâ xu·∫•t C·ªòT B·ªî SUNG, lu√¥n ƒë·ªß c·ªôt theo th·ª© t·ª±
       ======================= */
    function exportToExcel() {
      const selectedDate = document.getElementById('dateFilter').value;
      if (!selectedDate) { alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xu·∫•t Excel'); return; }

      const filterDate = new Date(selectedDate);
      const dateFiltered = originalData.filter(r => new Date(r.ngay).toDateString() === filterDate.toDateString());

      // Ch·ªâ xu·∫•t ƒë∆°n KH√îNG H·ª¶Y
      const dataToExport = dateFiltered.filter(r => !isCancelled(r));
      if (!dataToExport.length) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá cho ng√†y ƒë√£ ch·ªçn'); return; }

      // Ch·ªâ c·ªôt b·ªï sung (ƒë·ªß, ƒë√∫ng th·ª© t·ª±)
      const onlyExtraCols = extraColumns.map(c => c.name);
      const exportData = dataToExport.map(r => {
        const obj = {};
        onlyExtraCols.forEach(col => { obj[col] = getCellValue(r, col); });
        return obj;
      });

      // T·∫°o worksheet v·ªõi header ƒë√∫ng th·ª© t·ª±; set ƒë·ªô r·ªông c·ªôt
      const ws = XLSX.utils.json_to_sheet(exportData, { header: onlyExtraCols });
      ws['!cols'] = onlyExtraCols.map(() => ({ wch: 20 }));

      // T·∫°o workbook + ghi file
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "UP_DON_CT");

      const dateStr = filterDate.toLocaleDateString('vi-VN').replace(/\//g, '-');
      XLSX.writeFile(wb, `UP_DON_CT_B·ªî_SUNG_${dateStr}.xlsx`);
    }

    /* =======================
       T·∫¢I D·ªÆ LI·ªÜU & S·ª∞ KI·ªÜN
       ======================= */
    function loadData() {
      showLoading();
      fetch(API_URL)
        .then(resp => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then(data => {
          // ƒê·∫£m b·∫£o l√† m·∫£ng
          originalData = Array.isArray(data) ? data : [];
          filteredData = [...originalData];
          renderTable(filteredData);
        })
        .catch(err => {
          console.error(err);
          showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${err.message}`);
        });
    }
    
    function refreshData() { 
      loadData(); 
    }

    // L·∫Øng nghe s·ª± ki·ªán ng∆∞·ªùi d√πng
    document.getElementById('searchInput').addEventListener('input', e => filterTable(e.target.value));
    document.getElementById('dateFilter').addEventListener('change', filterByDate);
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>

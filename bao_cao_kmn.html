<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>B√ÅO C√ÅO</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --primary:#4a6ee0;--secondary:#6a3db3;--success:#2ecc71;--warning:#f39c12;
  --gray-light:#eef3ff;--gray-medium:#d1d9e6;--white:#fff;
  --transition:all .3s ease;--box-shadow:0 4px 20px rgba(0,0,0,.08);
}
body{font-family:'Segoe UI',sans-serif;background:#f5f9ff;margin:0;padding:20px;color:#333}
.container{background:#fff;border-radius:12px;box-shadow:var(--box-shadow);max-width:1400px;margin:0 auto;overflow:hidden}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center;padding:22px}
.tabs{display:flex;flex-wrap:wrap;gap:6px;background:var(--gray-light);border-bottom:1px solid var(--gray-medium)}
.tab{flex:1;min-width:180px;text-align:center;padding:12px 0;cursor:pointer;font-weight:500;border-radius:6px 6px 0 0;transition:var(--transition)}
.tab.active{background:var(--primary);color:#fff}
.controls{display:flex;flex-wrap:wrap;gap:12px;padding:16px 20px;background:#f8fafe;border-bottom:1px solid #e1e8f0;align-items:center}
.search-box{padding:10px 14px;border:1px solid var(--gray-medium);border-radius:6px;font-size:14px}
.btn{padding:10px 14px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:var(--transition)}
.btn:hover{opacity:.9}
.btn-primary{background:var(--primary);color:#fff}
.btn-preset{background:#e8ecf9;color:#333}
.table-wrapper{overflow-x:auto;margin:20px;border:1px solid #e1e8f0;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:1000px}
th,td{border:1px solid #e8edf5;padding:8px;text-align:left;white-space:nowrap}
th{background:#f0f3fa;position:sticky;top:0;z-index:1}
tr:nth-child(even){background:#fafcff}
tr:hover{background:#f0f5ff}
.chart-container,.summary-container{display:none;padding:20px}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:20px}
.chart-box{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:15px;position:relative}
.chart-total{position:absolute;top:10px;right:16px;font-size:13px;color:#555;font-weight:500}
.flex-summary{display:flex;gap:20px;flex-wrap:wrap}
.summary-table{flex:1;min-width:400px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:15px}
.summary-table h3{margin-top:0;text-align:center;color:#355ad8}
.loading{text-align:center;padding:30px}
@media(max-width:768px){.flex-summary{flex-direction:column}.chart-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h2>B√°o c√°o t·ªïng h·ª£p</h2></div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" id="tabData" onclick="switchTab('data')">üìã B·∫£ng d·ªØ li·ªáu</div>
    <div class="tab" id="tabChart" onclick="switchTab('chart')">üìà Bi·ªÉu ƒë·ªì xu h∆∞·ªõng</div>
    <div class="tab" id="tabSummary" onclick="switchTab('summary')">üìÖ Th·ªëng k√™ theo ng√†y</div>
  </div>

  <!-- üìã D·ªÆ LI·ªÜU -->
  <div id="dataSection">
    <div class="controls">
      <input type="date" id="fromData" class="search-box" />
      <input type="date" id="toData" class="search-box" />
      <button class="btn btn-preset" onclick="applyPreset('data','today')">H√¥m nay</button>
      <button class="btn btn-preset" onclick="applyPreset('data','yesterday')">H√¥m qua</button>
      <button class="btn btn-primary" onclick="filterDataTable()">üìÖ L·ªçc</button>
    </div>
    <div class="table-wrapper" id="tableWrapper">
      <table id="data-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>
  </div>

  <!-- üìà BI·ªÇU ƒê·ªí -->
  <div id="chartSection" class="chart-container">
    <div class="controls">
      <input type="date" id="fromDate" class="search-box" />
      <input type="date" id="toDate" class="search-box" />
      <select id="sanSelect" class="search-box">
        <option value="ALL">T·∫•t c·∫£</option>
        <option value="Shopee">Shopee</option>
        <option value="Tiktok">Tiktok</option>
        <option value="Best">Best</option>
      </select>
      <button class="btn btn-preset" onclick="applyPreset('chart','today')">H√¥m nay</button>
      <button class="btn btn-preset" onclick="applyPreset('chart','yesterday')">H√¥m qua</button>
      <button class="btn btn-primary" onclick="updateCharts()">üìä C·∫≠p nh·∫≠t</button>
    </div>
    <div class="chart-grid">
      <div class="chart-box">
        <div class="chart-total" id="totalCount"></div>
        <canvas id="chartTotal"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-total" id="cancelAvg"></div>
        <canvas id="chartCancel"></canvas>
      </div>
      <div class="chart-box" style="grid-column:1/-1;">
        <div class="chart-total" id="uniqueTotal"></div>
        <canvas id="chartUnique"></canvas>
      </div>
    </div>
  </div>

  <!-- üìÖ TH·ªêNG K√ä -->
  <div id="summarySection" class="summary-container">
    <div class="controls">
      <input type="date" id="fromDateSummary" class="search-box" />
      <input type="date" id="toDateSummary" class="search-box" />
      <button class="btn btn-preset" onclick="applyPreset('summary','today')">H√¥m nay</button>
      <button class="btn btn-preset" onclick="applyPreset('summary','yesterday')">H√¥m qua</button>
      <button class="btn btn-primary" onclick="generateSummary()">üìä Th·ªëng k√™</button>
    </div>
    <div id="summaryResults" class="flex-summary"></div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwwR3GI-ZwWKsueXHJX2rehWzjZOW9MfeQsmbY_mPSk0F6asm3BwfBh1Pps3jELfYJ7/exec";
let originalData=[],chart1,chart2,chart3;

/* ===== Gi·ªù Vi·ªát Nam (GMT+7) ===== */
function nowVN(){
  const now=new Date();
  const vnOffset=7*60;
  const localOffset=now.getTimezoneOffset();
  return new Date(now.getTime() + (vnOffset+localOffset)*60000);
}

/* ===== Date Helpers ===== */
const fmt=d=>d.toISOString().slice(0,10);
const addDays=(date,n)=>new Date(date.getFullYear(),date.getMonth(),date.getDate()+n);

/* ===== Load d·ªØ li·ªáu v√† x·ª≠ l√Ω URL ===== */
document.addEventListener("DOMContentLoaded",()=>{
  fetch(API_URL).then(r=>r.json()).then(d=>{
    originalData = Array.isArray(d)? d : [];
    originalData.sort((a,b)=>new Date(b.ngay)-new Date(a.ngay));
    renderTable(originalData);
    initDefaultDates();

    // ‚úÖ Ki·ªÉm tra URL c√≥ tham s·ªë ?ngay=
    const params = new URLSearchParams(window.location.search);
    const ngay = params.get("ngay");
    if (ngay) {
      try {
        const parts = ngay.split("/");
        const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        document.getElementById("fromData").value = isoDate;
        document.getElementById("toData").value = isoDate;
        switchTab("data");
        filterDataTable();
      } catch (e) {
        console.error("L·ªói parse ng√†y URL:", e);
      }
    }
  });
});

/* ===== Tabs ===== */
function switchTab(tab){
  ["tabData","tabChart","tabSummary"].forEach(id=>document.getElementById(id).classList.remove("active"));
  ["dataSection","chartSection","summarySection"].forEach(id=>document.getElementById(id).style.display="none");
  if(tab==="data"){tabData.classList.add("active");dataSection.style.display="block";}
  if(tab==="chart"){tabChart.classList.add("active");chartSection.style.display="block";updateCharts();}
  if(tab==="summary"){tabSummary.classList.add("active");summarySection.style.display="block";}
}

/* ===== Default Dates ===== */
function initDefaultDates(){
  const todayVN=new Date(nowVN().getFullYear(),nowVN().getMonth(),nowVN().getDate());
  fromDate.value=fmt(addDays(todayVN,-7));
  toDate.value=fmt(todayVN);
  const y=addDays(todayVN,-1);
  fromDateSummary.value=fmt(y);
  toDateSummary.value=fmt(y);
}

/* ===== Preset Buttons ===== */
function applyPreset(tab,preset){
  const base=new Date(nowVN().getFullYear(),nowVN().getMonth(),nowVN().getDate());
  let start,end;
  switch(preset){
    case"today":start=addDays(base,1);end=addDays(base,2);break;
    case"yesterday":start=base;end=addDays(base,1);break;
  }
  const s=fmt(start),e=fmt(addDays(end,-1));
  if(tab==="data"){fromData.value=s;toData.value=e;filterDataTable();}
  if(tab==="chart"){fromDate.value=s;toDate.value=e;updateCharts();}
  if(tab==="summary"){fromDateSummary.value=s;toDateSummary.value=e;generateSummary();}
}

/* ===== B·∫£ng d·ªØ li·ªáu ===== */
const displayCols=["STT","ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","sku_cha","slg_xuat","ten_sp","tinh_trang","trang_thai"];
function renderTable(data){
  const h=document.getElementById("header-row"),b=document.getElementById("data-body");
  h.innerHTML="";b.innerHTML="";
  displayCols.forEach(c=>{const th=document.createElement("th");th.textContent=c;h.appendChild(th);});
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");
    displayCols.forEach(c=>{
      const td=document.createElement("td");
      if(c==="STT")td.textContent=i+1;
      else if(c==="ngay"){const d=new Date(r.ngay);td.textContent=isNaN(d)?"":d.toLocaleDateString('vi-VN');}
      else td.textContent=r[c]||"";tr.appendChild(td);
    });
    b.appendChild(tr);
  });
}
function filterDataTable(){
  const f=fromData.value,t=toData.value;
  if(!f||!t)return renderTable(originalData);
  let from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");
  if(from>to)[from,to]=[to,from];
  const rows=originalData.filter(r=>{const d=new Date(r.ngay);return d>=from&&d<=to;});
  rows.sort((a,b)=>new Date(b.ngay)-new Date(a.ngay));
  renderTable(rows);
}

/* ===== Bi·ªÉu ƒë·ªì & Th·ªëng k√™ gi·ªØ nguy√™n ===== */


/* ===== Bi·ªÉu ƒë·ªì ===== */
function updateCharts(){
  if(!originalData.length)return;
  const f=fromDate.value,t=toDate.value,s=sanSelect.value;
  const from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");
  const filtered=originalData.filter(r=>{
    const d=new Date(r.ngay);
    if(d<from||d>to)return false;
    if(s!=="ALL"&&(r.san||"").toUpperCase()!==s.toUpperCase())return false;
    return true;
  });
  const g={};
  filtered.forEach(r=>{
    const day=new Date(r.ngay).toLocaleDateString('vi-VN');
    if(!g[day])g[day]={total:0,cancel:0,keys:new Set()};
    g[day].total++;if((r.trang_thai||"").toUpperCase().includes("H·ª¶Y"))g[day].cancel++;
    g[day].keys.add(r.mvd+"_"+r.san+"_"+r.khung_h);
  });
  const labels=Object.keys(g).sort((a,b)=>{const[da,ma,ya]=a.split('/').map(Number),[db,mb,yb]=b.split('/').map(Number);return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);});
  const total=labels.map(d=>g[d].total),cancel=labels.map(d=>g[d].cancel/g[d].total*100||0),unique=labels.map(d=>g[d].keys.size);
  const sumTotal=total.reduce((a,b)=>a+b,0),avgCancel=(cancel.reduce((a,b)=>a+b,0)/(cancel.length||1)).toFixed(1),sumUnique=unique.reduce((a,b)=>a+b,0);
  totalCount.innerText="T·ªïng: "+sumTotal.toLocaleString();cancelAvg.innerText="TB H·ªßy: "+avgCancel+"%";uniqueTotal.innerText="T·ªïng t·ªï h·ª£p: "+sumUnique.toLocaleString();
  if(chart1)chart1.destroy();if(chart2)chart2.destroy();if(chart3)chart3.destroy();
  chart1=new Chart(chartTotal,{type:'line',data:{labels,datasets:[{data:total,borderColor:'#4a6ee0',backgroundColor:'#4a6ee033',fill:true,tension:0.4}]},options:{plugins:{legend:{display:false}}}});
  chart2=new Chart(chartCancel,{type:'bar',data:{labels,datasets:[{data:cancel,backgroundColor:'#f39c12'}]},options:{plugins:{legend:{display:false}},scales:{y:{max:100}}}});
  chart3=new Chart(chartUnique,{type:'line',data:{labels,datasets:[{data:unique,borderColor:'#2ecc71',backgroundColor:'#2ecc7133',fill:true,tension:0.4}]},options:{plugins:{legend:{display:false}}}});
}

/* ===== Th·ªëng k√™ ===== */
function generateSummary(){
  const f=fromDateSummary.value,t=toDateSummary.value,res=document.getElementById("summaryResults");
  if(!f||!t){res.innerHTML="Ch·ªçn kho·∫£ng ng√†y";return;}
  let from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");
  if(from>to)[from,to]=[to,from];
  const data=originalData.filter(r=>{const d=new Date(r.ngay);return d>=from&&d<=to;});
  if(!data.length){res.innerHTML="Kh√¥ng c√≥ d·ªØ li·ªáu.";return;}
  const skuMap={},gianMap={};
  data.forEach(r=>{
    const sku=r.sku_cha||"Kh√°c",sl=Number(r.slg_xuat)||0,name=r.ten_sp||"";
    if(!skuMap[sku])skuMap[sku]={tong:0,ten:name};
    skuMap[sku].tong+=sl;if(name.length>skuMap[sku].ten.length)skuMap[sku].ten=name;
    const g=r.ma_gian||"Kh√°c";if(!gianMap[g])gianMap[g]=new Set();if(r.mvd)gianMap[g].add(r.mvd);
  });
  const skuArr=Object.entries(skuMap).map(([sku,v])=>({sku,ten:v.ten,tong:v.tong})).sort((a,b)=>b.tong-a.tong);
  const gianArr=Object.entries(gianMap).map(([g,set])=>({gian:g,count:set.size})).sort((a,b)=>b.count-a.count);
  let html1="<div class='summary-table'><h3>SKU_CHA ‚Äì S·ªê_LG ‚Äì T√äN_SP</h3><table><tr><th>SKU_CHA</th><th>S·ªê_LG</th><th>T√äN_SP</th></tr>";
  skuArr.forEach(r=>html1+=`<tr><td>${r.sku}</td><td>${r.tong.toLocaleString()}</td><td>${r.ten}</td></tr>`);html1+="</table></div>";
  let html2="<div class='summary-table'><h3>M√É_GIAN v√† s·ªë MVD kh√¥ng tr√πng</h3><table><tr><th>M√É_GIAN</th><th>S·ªê MVD</th></tr>";
  gianArr.forEach(r=>html2+=`<tr><td>${r.gian}</td><td>${r.count}</td></tr>`);html2+="</table></div>";
  res.innerHTML=`<div class='flex-summary'>${html1}${html2}</div>`;
}
</script>
</body>
</html>

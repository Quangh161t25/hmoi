<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>B√ÅO C√ÅO D·ªÆ LI·ªÜU</title>
<style>
:root{
  --primary:#4a6ee0;--secondary:#6a3db3;
  --gray-light:#eef3ff;--gray-medium:#d1d9e6;
  --transition:all .3s ease;--box-shadow:0 4px 20px rgba(0,0,0,.08);
  --row-blue:#dff6ff;
  --row-orange:#ffe9d6;
}
body{
  font-family:'Segoe UI',sans-serif;
  background:#f5f9ff;
  margin:0;
  padding:10px;
  color:#333;
}
.container{
  background:#fff;
  border-radius:10px;
  box-shadow:var(--box-shadow);
  width:100%;
  max-width:100%;
  margin:0 auto;
  overflow:hidden;
}
.header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;
  text-align:center;
  padding:16px;
}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:10px 14px;
  background:#f8fafe;
  border-bottom:1px solid #e1e8f0;
  align-items:center;
}
.search-box{
  padding:8px 12px;
  border:1px solid var(--gray-medium);
  border-radius:6px;
  font-size:14px;
}
.btn{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  font-weight:500;
  transition:var(--transition);
}
.btn:hover{opacity:.9}
.btn-primary{background:var(--primary);color:#fff}
.btn-preset{background:#e8ecf9;color:#333}
.table-wrapper{
  width:100%;
  overflow:auto;
  height:calc(100vh - 160px);
  border-top:1px solid #e1e8f0;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width:1200px;
}
th,td{
  border:1px solid #e8edf5;
  padding:10px;
  text-align:left;
  white-space:nowrap;
  line-height:1.5;
}
th{
  background:#f0f3fa;
  position:sticky;
  top:0;
  z-index:2;
}
tr:nth-child(even){background:#fafcff}
tr:hover{background:#f0f5ff}
.row-blue{background:var(--row-blue)!important;}
.row-orange{background:var(--row-orange)!important;}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h2>üìã B√°o c√°o d·ªØ li·ªáu</h2></div>

  <div class="controls">
    <input type="date" id="fromData" class="search-box" />
    <input type="date" id="toData" class="search-box" />

    <input list="listKhung" id="filterKhung" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p khung_h" class="search-box" />
    <datalist id="listKhung"></datalist>

    <input list="listGian" id="filterGian" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p ma_gian" class="search-box" />
    <datalist id="listGian"></datalist>

    <input list="listMvd" id="filterMvd" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p mvd" class="search-box" />
    <datalist id="listMvd"></datalist>

    <button class="btn btn-preset" onclick="applyPreset('today')">H√¥m nay</button>
    <button class="btn btn-preset" onclick="applyPreset('yesterday')">H√¥m qua</button>
    <button class="btn btn-primary" onclick="filterDataTable()">üìÖ L·ªçc</button>
  </div>

  <div class="table-wrapper">
    <table id="data-table">
      <thead><tr id="header-row"></tr></thead>
      <tbody id="data-body"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwwR3GI-ZwWKsueXHJX2rehWzjZOW9MfeQsmbY_mPSk0F6asm3BwfBh1Pps3jELfYJ7/exec";
let originalData=[];

/* ===== Parse ng√†y Vi·ªát Nam (dd/MM/yyyy) ===== */
function parseVNDate(str){
  if(!str) return null;
  const parts = str.split(/[\/\-]/);
  if(parts.length === 3){
    const [d,m,y] = parts.map(Number);
    if(y && m && d) return new Date(y, m-1, d);
  }
  const d2 = new Date(str);
  return isNaN(d2)? null : d2;
}

/* ===== Gi·ªù Vi·ªát Nam (GMT+7) ===== */
function nowVN(){
  const now=new Date();
  const vnOffset=7*60;
  const localOffset=now.getTimezoneOffset();
  return new Date(now.getTime() + (vnOffset+localOffset)*60000);
}

/* ===== Helpers ===== */
const fmt=d=>d.toISOString().slice(0,10);
const addDays=(date,n)=>new Date(date.getFullYear(),date.getMonth(),date.getDate()+n);

/* ===== Load d·ªØ li·ªáu ===== */
document.addEventListener("DOMContentLoaded",()=>{
  fetch(API_URL).then(r=>r.json()).then(d=>{
    originalData = Array.isArray(d)? d.sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay)):[];
    renderTable(originalData);
    fillUniqueLists(originalData);

    const params = new URLSearchParams(window.location.search);
    const ngay = params.get("ngay");
    if (ngay) {
      try {
        const parts = ngay.split("/");
        const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
        document.getElementById("fromData").value = isoDate;
        document.getElementById("toData").value = isoDate;
        filterDataTable();
      } catch (e) { console.error("L·ªói parse ng√†y:", e); }
    }
  });
});

/* ===== Sinh datalist unique ===== */
function fillUniqueLists(data){
  const khungSet=new Set(),gianSet=new Set(),mvdSet=new Set();
  data.forEach(r=>{
    if(r.khung_h)khungSet.add(r.khung_h);
    if(r.ma_gian)gianSet.add(r.ma_gian);
    if(r.mvd)mvdSet.add(r.mvd);
  });
  const fill=(id,set)=>{
    const dl=document.getElementById(id);
    dl.innerHTML="";
    Array.from(set).sort().forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v;dl.appendChild(opt);
    });
  };
  fill("listKhung",khungSet);
  fill("listGian",gianSet);
  fill("listMvd",mvdSet);
}

/* ===== Preset Buttons ===== */
function applyPreset(preset){
  const base=new Date(nowVN().getFullYear(),nowVN().getMonth(),nowVN().getDate());
  let start,end;
  switch(preset){
    case"today":start=addDays(base,1);end=addDays(base,2);break;
    case"yesterday":start=base;end=addDays(base,1);break;
  }
  const s=fmt(start),e=fmt(addDays(end,-1));
  fromData.value=s;toData.value=e;filterDataTable();
}

/* ===== B·∫£ng d·ªØ li·ªáu ===== */
const displayCols=["STT","ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","sku_cha","slg_xuat","ten_sp","tinh_trang","trang_thai"];
function renderTable(data){
  const h=document.getElementById("header-row"),b=document.getElementById("data-body");
  h.innerHTML="";b.innerHTML="";
  displayCols.forEach(c=>{const th=document.createElement("th");th.textContent=c;h.appendChild(th);});
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");

    // üîπ Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·ªÉ t√¥ m√†u d√≤ng
    const tinh=r.tinh_trang ? r.tinh_trang.trim().toUpperCase() : "";
    const tt=r.trang_thai ? r.trang_thai.trim().toUpperCase() : "";
    if(tinh.includes("3 DVVC L·∫§Y H√ÄNG")) tr.classList.add("row-blue");
    else if(tt.includes("1 H·ª¶Y")) tr.classList.add("row-orange");

    displayCols.forEach(c=>{
      const td=document.createElement("td");
      if(c==="STT")td.textContent=i+1;
      else if(c==="ngay"){
        const d=parseVNDate(r.ngay);
        td.textContent=d? d.toLocaleDateString('vi-VN') : (r.ngay||"");
      }
      else td.textContent=r[c]||"";
      tr.appendChild(td);
    });
    b.appendChild(tr);
  });
}

/* ===== L·ªçc d·ªØ li·ªáu ===== */
function filterDataTable(){
  const f=fromData.value,t=toData.value;
  const kh=filterKhung.value.trim().toLowerCase();
  const mg=filterGian.value.trim().toLowerCase();
  const mv=filterMvd.value.trim().toLowerCase();

  let rows=[...originalData];

  if(f && t){
    let from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");
    if(from>to)[from,to]=[to,from];
    rows=rows.filter(r=>{
      const d=parseVNDate(r.ngay);
      return d && d>=from && d<=to;
    });
  }

  rows=rows.filter(r=>{
    if(kh && !(r.khung_h||"").toLowerCase().includes(kh)) return false;
    if(mg && !(r.ma_gian||"").toLowerCase().includes(mg)) return false;
    if(mv && !(r.mvd||"").toLowerCase().includes(mv)) return false;
    return true;
  });

  rows.sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
  renderTable(rows);
}
</script>
</body>
</html>

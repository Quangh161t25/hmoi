<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VieAI Dashboard</title>
<style>
:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --primary-dark: #1d4ed8;
  --secondary: #64748b;
  --success: #16a34a;
  --success-light: #dcfce7;
  --warning: #d97706;
  --warning-light: #f9d958;
  --danger: #dc2626;
  --danger-light: #fee2e2;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --white: #ffffff;
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 8px;
  --radius-lg: 12px;
}

* { box-sizing: border-box; }

body {
  font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--gray-50);
  margin: 0;
  color: var(--gray-800);
  line-height: 1.5;
}

/* Header */
.header {
  background: var(--primary);
  color: var(--white);
  padding: 16px 24px;
  box-shadow: var(--shadow-md);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header h2::before {
  content: "üìä";
  font-size: 24px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--white);
  padding: 8px 16px;
  border-bottom: 1px solid var(--gray-200);
  position: sticky;
  top: 64px;
  z-index: 90;
  overflow-x: auto;
  scrollbar-width: none;
}

.tabs::-webkit-scrollbar { display: none; }

.tabs button {
  padding: 12px 16px;
  border: none;
  border-radius: var(--radius);
  background: transparent;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--gray-600);
}

.tabs button:hover {
  background: var(--gray-100);
  color: var(--gray-800);
}

.tabs button.active {
  background: var(--primary);
  color: var(--white);
  box-shadow: var(--shadow);
}

.tab { display: none; padding: 20px; }
.tab.active { display: block; }

/* Controls */
.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  align-items: center;
  padding: 16px;
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}

.input {
  padding: 10px 12px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
  min-width: 160px;
  font-size: 14px;
  background: var(--white);
  transition: border-color 0.2s, box-shadow 0.2s;
}

.input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--radius);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: var(--primary);
  color: var(--white);
}

.btn-primary:hover { background: var(--primary-dark); }

.btn-ghost {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.btn-ghost:hover { background: var(--gray-200); }

.btn.active-filter {
  background: var(--primary);
  color: var(--white);
  box-shadow: var(--shadow);
}

/* Table */
.table-wrap {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: auto;
  max-height: calc(100vh - 280px);
  box-shadow: var(--shadow);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border: 1px solid var(--gray-200);
  padding: 10px 12px;
  text-align: left;
  white-space: nowrap;
}

th {
  background: var(--gray-50);
  position: sticky;
  top: 0;
  z-index: 1;
  font-weight: 600;
  color: var(--gray-700);
}

tr:hover { background: var(--primary-light); }

/* Status Grid */
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 20px;
}

.status-box {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.status-box h3 {
  margin: 0;
  padding: 16px 20px;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Row Colors */
tr.row-red td { background: var(--danger-light) !important; }
tr.row-yellow td { background: var(--warning-light) !important; }
tr.row-green td { background: var(--success-light) !important; }

/* Responsive */
@media (max-width: 768px) {
  .tabs { padding: 6px 12px; }
  .tabs button { padding: 10px 12px; font-size: 14px; }
  .tab { padding: 16px; }
  .controls { padding: 12px; }
  .input, .btn { min-width: 100%; }
  .status-grid { grid-template-columns: 1fr; }
  .table-wrap { max-height: calc(100vh - 320px); }
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 16px;
  margin: 0;
}

/* Card */
.card {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: var(--gray-800);
}

.filter-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
  min-width: 80px;
}
</style>
</head>
<body>
<div class="header"><h2>VieAI Dashboard</h2></div>

<!-- Tabs -->
<div class="tabs">
  <button data-tab="tab-don" class="active">üöö ƒê∆°n chi ti·∫øt</button>
  <button data-tab="tab-status">üì¶ Theo tr·∫°ng th√°i ƒë∆°n h√†ng</button>
  <button data-tab="tab-ton">üè∑Ô∏è T·ªìn kho</button>
  <button data-tab="tab-hoan">üîÅ H√†ng ho√†n BH</button>
  <button data-tab="tab-tb">üì¢ Th√¥ng b√°o</button>
</div>

<!-- ========== ƒê∆†N CHI TI·∫æT ========== -->
<div id="tab-don" class="tab active">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">ƒê∆°n chi ti·∫øt</h3>
      <div class="filter-group">
        <span class="filter-label">B·ªô l·ªçc:</span>
        <button class="btn btn-ghost" onclick="setDatePreset('don','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','week')">Tu·∫ßn n√†y</button>
        <button class="btn btn-ghost" onclick="resetDon()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateDon" class="input">
      <input type="date" id="toDateDon" class="input">
      <select id="fKhungDon" class="input"></select>
      <input id="fGianDon" class="input" list="listGianDon" placeholder="Nh·∫≠p m√£ gian...">
      <datalist id="listGianDon"></datalist>
      <input id="fMvdDon" class="input" placeholder="Nh·∫≠p MVD...">
      <div class="filter-group">
        <span class="filter-label">T√¨nh tr·∫°ng:</span>
        <button class="btn btn-ghost" onclick="filterTinhTrangDon(this, 1)">ƒê√É IN ƒê∆†N</button>
        <button class="btn btn-ghost" onclick="filterTinhTrangDon(this, 3)">DVVC L·∫§Y H√ÄNG</button>
        <span class="filter-label" style="margin-left:16px;">Tr·∫°ng th√°i:</span>
        <button class="btn btn-ghost" onclick="filterTrangThaiDon(this, 1)">H·ª¶Y</button>
        <button class="btn btn-ghost" onclick="clearFiltersDon()">‚úñ X√≥a l·ªçc</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="tblDon">
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>S√¢n</th>
            <th>Khung</th>
            <th>M√£ gian</th>
            <th>MVD</th>
            <th>MDH</th>
            <th>ID SP</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T√™n SP</th>
            <th>T√¨nh tr·∫°ng</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========== TR·∫†NG TH√ÅI ƒê∆†N H√ÄNG ========== -->
<div id="tab-status" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
      <div class="filter-group">
        <span class="filter-label">B·ªô l·ªçc:</span>
        <button class="btn btn-ghost" onclick="setDatePreset('status','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','week')">Tu·∫ßn n√†y</button>
        <button class="btn btn-ghost" onclick="resetStatus()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateStatus" class="input">
      <input type="date" id="toDateStatus" class="input">
      <select id="fKhungStatus" class="input"></select>
      <input id="fGianStatus" class="input" list="listGianStatus" placeholder="Nh·∫≠p m√£ gian...">
      <datalist id="listGianStatus"></datalist>
      <input id="fMvdStatus" class="input" placeholder="Nh·∫≠p MVD...">
      <div class="filter-group">
        <span class="filter-label">T√¨nh tr·∫°ng:</span>
        <button class="btn btn-ghost" onclick="filterTinhTrangStatus(this, 1)">ƒê√É IN ƒê∆†N</button>
        <button class="btn btn-ghost" onclick="filterTinhTrangStatus(this, 3)">DVVC L·∫§Y H√ÄNG</button>
        <span class="filter-label" style="margin-left:16px;">Tr·∫°ng th√°i:</span>
        <button class="btn btn-ghost" onclick="filterTrangThaiStatus(this, 1)">H·ª¶Y</button>
        <button class="btn btn-ghost" onclick="clearFiltersStatus()">‚úñ X√≥a l·ªçc</button>
      </div>
    </div>
    <div class="status-grid">
      <div class="status-box">
        <h3 style="color: var(--primary);">üìò ƒê∆†N ƒê√É IN ƒê∆†N</h3>
        <div class="table-wrap">
          <table id="tblPrinted">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>ID SP</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="status-box">
        <h3 style="color: var(--success);">üöö ƒê∆†N DVVC L·∫§Y H√ÄNG</h3>
        <div class="table-wrap">
          <table id="tblPicked">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- C√°c tab c√≤n l·∫°i gi·ªØ nguy√™n -->
<!-- (T·ªìn kho, H√†ng ho√†n, Th√¥ng b√°o) -->

<script>
// ========== D·ªÆ LI·ªÜU ==========
const API_URL="https://script.google.com/macros/s/AKfycbzEgZwWIGr_31qDy4ZJjehUVP_-0Tpq2SKrGGgubU28dQZMV7lnYkJVzlRvVXRlL9cR/exec";
let RAW=[],DON=[],TON=[],HOAN=[],TB=[];
const $ = s => document.querySelector(s);

// ========== LOAD ==========
fetch(API_URL).then(r=>r.json()).then(d=>{
  RAW=d;
  DON=RAW.filter(r=>r.id_up_don);
  TON=RAW.filter(r=>r.kho);
  HOAN=RAW.filter(r=>r.mvd_hoan);
  TB=RAW.filter(r=>r.tb);
  initDropdowns(); initDateDefaults();
  renderDon(); renderStatusTables(true); renderTonKho(); renderHoan(); renderTB();
});

// ========== H√ÄM CHUNG ==========
function parseVNDate(d){ if(!d) return new Date(0); const [a,b,c]=d.split("/").map(Number); return new Date(c,b-1,a); }
function fmt(d){
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0,10);
}
function addDays(dt,n){ return new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()+n); }

function setDatePreset(tab,type){
  const now=new Date(), today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  let f=today, t=today;
  if(type==="yesterday"){ f=t=addDays(today,-1); }
  if(type==="week"){ const d=today.getDay()||7; f=addDays(today,1-d); t=addDays(f,6); }
  if(tab==="don"){ $("#fromDateDon").value=fmt(f); $("#toDateDon").value=fmt(t); renderDon(); }
  if(tab==="status"){ $("#fromDateStatus").value=fmt(f); $("#toDateStatus").value=fmt(t); renderStatusTables(); }
}

function initDateDefaults(){
  const t=fmt(new Date());
  ["#fromDateDon","#toDateDon","#fromDateStatus","#toDateStatus"].forEach(id=>$(id).value=t);
}

function uniq(a){ return ["T·∫•t c·∫£",...[...new Set(a.filter(x=>x))]]; }

// ========== DROPDOWN ==========
function initDropdowns(){
  const uKhung = uniq(DON.map(r => r.khung_h));
  const uGian  = uniq(DON.map(r => r.ma_gian));
  ["#fKhungDon", "#fKhungStatus"].forEach(i => {
    $(i).innerHTML = uKhung.map(v => `<option>${v}</option>`).join("");
  });
  ["#listGianDon", "#listGianStatus"].forEach(id => $(id).innerHTML = uGian.map(v => `<option value="${v}">`).join(""));
  $("#fKhungDon").onchange = renderDon;
  $("#fKhungStatus").onchange = renderStatusTables;
  $("#fGianDon").oninput = renderDon;
  $("#fGianStatus").oninput = renderStatusTables;
  $("#fMvdDon").oninput = renderDon;
  $("#fMvdStatus").oninput = renderStatusTables;
}

// ========== ƒê∆†N CHI TI·∫æT ==========
let activeTinhTrangDon = null, activeTrangThaiDon = null;

function filterTinhTrangDon(btn, value) {
  const btns = document.querySelectorAll('#tab-don button[onclick^="filterTinhTrangDon"]');
  btns.forEach(b => b.classList.remove("active-filter"));
  if (activeTinhTrangDon === value) {
    activeTinhTrangDon = null;
  } else {
    activeTinhTrangDon = value;
    btn.classList.add("active-filter");
  }
  renderDon();
}

function filterTrangThaiDon(btn, value) {
  const btns = document.querySelectorAll('#tab-don button[onclick^="filterTrangThaiDon"]');
  btns.forEach(b => b.classList.remove("active-filter"));
  if (activeTrangThaiDon === value) {
    activeTrangThaiDon = null;
  } else {
    activeTrangThaiDon = value;
    btn.classList.add("active-filter");
  }
  renderDon();
}

function clearFiltersDon() {
  activeTinhTrangDon = activeTrangThaiDon = null;
  document.querySelectorAll('#tab-don button[onclick^="filterTinhTrangDon"], #tab-don button[onclick^="filterTrangThaiDon"]')
    .forEach(b => b.classList.remove("active-filter"));
  renderDon();
}

function renderDon(){
  const tb=$("#tblDon tbody"); tb.innerHTML="";
  const fK=$("#fKhungDon").value, fG=$("#fGianDon").value, fM=$("#fMvdDon").value;
  const from=$("#fromDateDon").value, to=$("#toDateDon").value;
  const f1=new Date(from+"T00:00:00"), f2=new Date(to+"T23:59:59");
  let filtered = DON.filter(r=>{
    const d=parseVNDate(r.ngay);
    const matchDate = d>=f1 && d<=f2;
    const matchKhung = !fK || fK==="T·∫•t c·∫£" || r.khung_h===fK;
    const matchGian = !fG || r.ma_gian===fG;
    const matchMvd = !fM || r.mvd===fM;
    const matchTinhTrang = !activeTinhTrangDon || (r.tinh_trang||"").trim().includes(activeTinhTrangDon === 1 ? "ƒê√É IN ƒê∆†N" : "DVVC L·∫§Y H√ÄNG");
    const matchTrangThai = !activeTrangThaiDon || (r.trang_thai||"").trim().includes("H·ª¶Y");
    return matchDate && matchKhung && matchGian && matchMvd && matchTinhTrang && matchTrangThai;
  }).sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));

  if (!filtered.length) {
    tb.innerHTML = `<tr><td colspan="12" class="empty-state"><div class="empty-state-icon">üì≠</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng</p></td></tr>`;
    return;
  }

  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    if ((r.trang_thai||"").trim().includes("H·ª¶Y")) tr.classList.add("row-red");
    else if ((r.tinh_trang||"").trim().includes("DVVC L·∫§Y H√ÄNG")) tr.classList.add("row-green");
    ["ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","so_luong","ten_sp","tinh_trang","trang_thai","ghi_chu"]
      .forEach(k=>{ const td=document.createElement("td"); td.textContent=r[k]||""; tr.appendChild(td); });
    tb.appendChild(tr);
  });
}

function resetDon(){
  ["#fKhungDon","#fGianDon","#fMvdDon"].forEach(s=>$(s).value="T·∫•t c·∫£");
  clearFiltersDon();
}

// ========== TR·∫†NG TH√ÅI ==========
let activeTinhTrangStatus = null, activeTrangThaiStatus = null;

function filterTinhTrangStatus(btn, value) {
  const btns = document.querySelectorAll('#tab-status button[onclick^="filterTinhTrangStatus"]');
  btns.forEach(b => b.classList.remove("active-filter"));
  activeTinhTrangStatus = activeTinhTrangStatus === value ? null : value;
  if (activeTinhTrangStatus) btn.classList.add("active-filter");
  renderStatusTables();
}

function filterTrangThaiStatus(btn, value) {
  const btns = document.querySelectorAll('#tab-status button[onclick^="filterTrangThaiStatus"]');
  btns.forEach(b => b.classList.remove("active-filter"));
  activeTrangThaiStatus = activeTrangThaiStatus === value ? null : value;
  if (activeTrangThaiStatus) btn.classList.add("active-filter");
  renderStatusTables();
}

function clearFiltersStatus() {
  activeTinhTrangStatus = activeTrangThaiStatus = null;
  document.querySelectorAll('#tab-status button[onclick^="filterTinhTrangStatus"], #tab-status button[onclick^="filterTrangThaiStatus"]')
    .forEach(b => b.classList.remove("active-filter"));
  renderStatusTables();
}

function renderStatusTables(auto=false){
  const pT=$("#tblPrinted tbody"), pK=$("#tblPicked tbody"); pT.innerHTML=""; pK.innerHTML="";
  let fK=$("#fKhungStatus").value, fG=$("#fGianStatus").value, fM=$("#fMvdStatus").value;
  let from=$("#fromDateStatus").value, to=$("#toDateStatus").value;
  if(auto){ const t=fmt(new Date()); from=to=t; $("#fromDateStatus").value=t; $("#toDateStatus").value=t; }
  const f1=new Date(from+"T00:00:00"), f2=new Date(to+"T23:59:59");
  let filtered = DON.filter(r=>{
    const d=parseVNDate(r.ngay);
    const matchDate = d>=f1 && d<=f2;
    const matchKhung = !fK || fK==="T·∫•t c·∫£" || r.khung_h===fK;
    const matchGian = !fG || r.ma_gian===fG;
    const matchMvd = !fM || r.mvd===fM;
    const matchTinhTrang = !activeTinhTrangStatus || (r.tinh_trang||"").trim().includes(activeTinhTrangStatus === 1 ? "ƒê√É IN ƒê∆†N" : "DVVC L·∫§Y H√ÄNG");
    const matchTrangThai = !activeTrangThaiStatus || (r.trang_thai||"").trim().includes("H·ª¶Y");
    return matchDate && matchKhung && matchGian && matchMvd && matchTinhTrang && matchTrangThai;
  });

  const printed = filtered.filter(r => (r.tinh_trang||"").trim().includes("ƒê√É IN ƒê∆†N"));
  const picked = filtered.filter(r => (r.tinh_trang||"").trim().includes("DVVC L·∫§Y H√ÄNG"));

  // Render printed
  if (!printed.length) {
    pT.innerHTML = `<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üìÑ</div><p class="empty-state-text">Kh√¥ng c√≥ ƒë∆°n ƒë√£ in</p></td></tr>`;
  } else {
    printed.forEach((r,i)=>{
      const tr=document.createElement("tr");
      if ((r.trang_thai||"").includes("H·ª¶Y")) tr.classList.add("row-red");
      ["STT","ngay","ma_gian","mvd","id_sp","tinh_trang","trang_thai","ghi_chu"].forEach(k=>{
        const td=document.createElement("td");
        td.textContent = k==="STT" ? i+1 : (r[k]||"");
        tr.appendChild(td);
      });
      pT.appendChild(tr);
    });
  }

  // Render picked
  if (!picked.length) {
    pK.innerHTML = `<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üöö</div><p class="empty-state-text">Kh√¥ng c√≥ ƒë∆°n DVVC l·∫•y h√†ng</p></td></tr>`;
  } else {
    picked.forEach((r,i)=>{
      const tr=document.createElement("tr");
      if ((r.trang_thai||"").includes("H·ª¶Y")) tr.classList.add("row-red");
      else tr.classList.add("row-green");
      ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"].forEach(k=>{
        const td=document.createElement("td");
        td.textContent = k==="STT" ? i+1 : (r[k]||"");
        tr.appendChild(td);
      });
      pK.appendChild(tr);
    });
  }
}

function resetStatus(){
  ["#fKhungStatus","#fGianStatus","#fMvdStatus"].forEach(s=>$(s).value="T·∫•t c·∫£");
  clearFiltersStatus();
}

// ========== T·ªíN KHO, HO√ÄN, TH√îNG B√ÅO (gi·ªØ nguy√™n) ==========
function renderTonKho() {
  const tb = $("#tblTonKho tbody"); tb.innerHTML = "";
  const idVal = ($("#filterIdSp").value || "").trim().toLowerCase();
  const tenVal = ($("#filterTenSp").value || "").trim().toLowerCase();
  const filtered = TON.filter(r => {
    const idMatch = !idVal || (r.id_sp || "").toLowerCase().includes(idVal);
    const tenMatch = !tenVal || (r.ten_sp || "").toLowerCase().includes(tenVal);
    return idMatch && tenMatch;
  }).sort((a,b) => {
    if (a.kho > b.kho) return -1;
    if (a.kho < b.kho) return 1;
    return (a.id_sp || "").localeCompare(b.id_sp || "");
  });

  if (!filtered.length) {
    tb.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üì¶</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</p></td></tr>`;
    return;
  }

  filtered.forEach(r => {
    const tr = document.createElement("tr");
    const ton = Number(r.ton_cuoi) || 0;
    if (ton <= 0) tr.classList.add("row-red");
    else if (ton <= 4) tr.classList.add("row-yellow");
    ["kho","id_sp","ton_cuoi","ten_sp","thuong_hieu"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

function renderHoan(){
  const tb = $("#tblHoan tbody"); tb.innerHTML = "";
  const s = ($("#fShop").value || "").toLowerCase();
  const m = ($("#fMVD").value || "").toLowerCase();
  const sku = ($("#fSKU").value || "").toLowerCase();
  const data = HOAN.filter(r =>
    (!s || (r.shop || "").toLowerCase().includes(s)) &&
    (!m || (r.mvd_hoan || "").toLowerCase().includes(m)) &&
    (!sku || (r.sku_hoan || "").toLowerCase().includes(sku))
  ).sort((a,b) => parseVNDate(b.ngay) - parseVNDate(a.ngay));

  if (!data.length) {
    tb.innerHTML = `<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üîÅ</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu h√†ng ho√†n</p></td></tr>`;
    return;
  }

  data.forEach(r => {
    const tr = document.createElement("tr");
    ["ngay","shop","mvd_hoan","sku_hoan","slg"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });
    const tdImg = document.createElement("td");
    const link = r.link_anh || r.anh || "";
    if (link) {
      const img = document.createElement("img");
      img.src = link; img.style = "width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;";
      img.onclick = () => window.open(link, "_blank");
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = "(Kh√¥ng c√≥ ·∫£nh)"; tdImg.style.color = "#999"; tdImg.style.fontStyle = "italic";
    }
    tr.appendChild(tdImg);
    tb.appendChild(tr);
  });
}

function renderTB(){
  const tb=$("#tblTB tbody"); tb.innerHTML="";
  const sorted = [...TB].sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
  if (!sorted.length) {
    tb.innerHTML = `<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">üì¢</div><p class="empty-state-text">Kh√¥ng c√≥ th√¥ng b√°o</p></td></tr>`;
    return;
  }
  sorted.forEach(r=>{
    const tr=document.createElement("tr");
    [r.ngay, r.truong, formatTB(r.tb||"")].forEach((val, i) => {
      const td = document.createElement("td");
      if (i === 2) td.innerHTML = val;
      else td.textContent = val || "";
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

function formatTB(t){
  return "<table style='border-collapse:collapse;width:100%;font-size:12px'>"+t.split(/\n+/).filter(Boolean).map(r=>"<tr>"+r.split("|").map(c=>`<td style='border:1px solid #ddd;padding:3px'>${c}</td>`).join("")+"</tr>").join("")+"</table>";
}

// ========== TAB ==========
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll(".tabs button, .tab").forEach(el => el.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if (btn.dataset.tab === "tab-status") renderStatusTables(true);
    if (btn.dataset.tab === "tab-don") renderDon();
  };
});

// Kh·ªüi t·∫°o c√°c b·∫£ng c√≤n l·∫°i
$("#filterIdSp").oninput = renderTonKho;
$("#filterTenSp").oninput = renderTonKho;
$("#fShop").oninput = renderHoan;
$("#fMVD").oninput = renderHoan;
$("#fSKU").oninput = renderHoan;

</script>
</body>
</html>

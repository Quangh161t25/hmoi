<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VieAI Dashboard</title>
<!-- Import Font Inter cho hi·ªán ƒë·∫°i -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  /* Palette m√†u hi·ªán ƒë·∫°i h∆°n (Indigo theme) */
  --primary: #4f46e5; --primary-hover: #4338ca; --primary-bg: #eef2ff;
  --success: #10b981; --success-bg: #d1fae5;
  --warning: #f59e0b; --warning-bg: #fef3c7;
  --danger: #ef4444; --danger-bg: #fee2e2;
 
  /* Grayscale & Backgrounds */
  --bg-body: #f3f4f6;
  --bg-card: #ffffff;
  --text-main: #111827;
  --text-secondary: #6b7280;
  --border: #e5e7eb;
  /* Effects */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 8px;
  --radius-lg: 16px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    line-height: 1.6;
    font-size: 14px;
}
/* Header Gradient ƒë·∫πp h∆°n */
.header {
    background: linear-gradient(135deg, var(--primary), #6366f1);
    color: white;
    padding: 16px 24px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; letter-spacing: -0.025em; }
.header h2::before { content: "üìä"; font-size: 22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
/* Tabs Style d·∫°ng Pills n·ªïi */
.tabs {
    display: flex;
    gap: 8px;
    padding: 12px 24px;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 60px;
    z-index: 90;
    overflow-x: auto;
    scrollbar-width: none;
}
.tabs button {
    padding: 8px 16px;
    border: 1px solid transparent;
    border-radius: 20px; /* Pill shape */
    background: transparent;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    color: var(--text-secondary);
    transition: var(--transition);
    font-size: 13px;
}
.tabs button:hover { background: var(--gray-100); color: var(--primary); }
.tabs button.active {
    background: var(--primary-bg);
    color: var(--primary);
    border-color: rgba(79, 70, 229, 0.1);
    box-shadow: var(--shadow-sm);
}
.tab { display: none; padding: 24px; max-width: 1600px; margin: 0 auto; }
.tab.active { display: block; animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
/* Card Design */
.card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    border: 1px solid rgba(0,0,0,0.02);
    overflow: hidden;
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: #fafafa;
}
.card-title { font-size: 16px; font-weight: 700; color: var(--text-main); }
/* Controls Area */
.controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    padding: 20px 24px;
    background: var(--bg-card);
    align-items: center;
}
/* Inputs & Selects */
.input, .btn, select.input {
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 14px;
    background: white;
    transition: var(--transition);
    color: var(--text-main);
}
.input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-bg);
}
/* Buttons */
.btn {
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.btn-success {
    background: linear-gradient(to bottom, #10b981, #059669);
    color: white;
    border: none;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
}
.btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }
.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--bg-body); border-color: var(--text-secondary); color: var(--text-main); }
.btn.active-filter {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
}
/* Table Styles */
.table-container { position: relative; overflow: auto; max-height: calc(100vh - 300px); border-top: 1px solid var(--border); }
table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
th {
    background: #f8fafc;
    position: sticky;
    top: 0;
    z-index: 10;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.05em;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
}
td {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-main);
    white-space: nowrap;
    transition: background 0.1s;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: #f8fafc; }
/* Status Highlights */
tr.row-red td { background: #fef2f2; color: #991b1b; }
tr.row-yellow td { background: #fffbeb; color: #92400e; }
tr.row-green td { background: #f0fdf4; color: #166534; }
.text-right { text-align: right; }
.font-bold { font-weight: 600; }
/* Empty State */
.empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
.empty-state-icon { font-size: 56px; margin-bottom: 16px; display: block; filter: grayscale(100%); opacity: 0.3; }
/* Filter Group */
.filter-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.filter-label { font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-right: 4px; }
/* Status Grid */
.status-grid {
  display: grid;
  grid-template-columns: minmax(200px, 300px) 1fr;  /* C·ªôt th∆∞∆°ng hi·ªáu nh·ªè h∆°n (t·ªëi thi·ªÉu 200px, t·ªëi ƒëa 300px), c·ªôt s·∫£n ph·∫©m chi·∫øm ph·∫ßn c√≤n l·∫°i */
  gap: 24px;
}
.status-box { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
.status-box h3 { margin: 0; padding: 16px 24px; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; background: #fafafa; border-bottom: 1px solid var(--border); }
/* Loading */
.loading {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.8s linear infinite; z-index: 10;
}
@keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
/* Responsive */
@media (max-width: 768px) {
  .header { padding: 12px 16px; }
  .tabs { top: 56px; padding: 8px 16px; }
  .tab { padding: 16px 0; }
  .card { border-radius: 0; box-shadow: none; border: none; border-bottom: 1px solid var(--border); }
  .controls, .card-header { flex-direction: column; align-items: stretch; gap: 12px; }
  .input, .btn { width: 100%; }
  .status-grid { grid-template-columns: 1fr; }
}
/* ================= DARK MODE ƒê·∫∏P ================= *//* ================= DARK MODE HO√ÄN H·∫¢O 100% ================= */
@media (prefers-color-scheme: dark) {
  :root:not(.dark-mode) {
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --text-main: #f1f5f9;
    --text-secondary: #94a3b8;
    --border: #334155;
    --primary: #818cf8;
    --primary-bg: #312e81;
  }
}
@media (prefers-color-scheme: dark) {
  :root, body {
    --bg-body: #0f172a !important;
    --bg-card: #1e293b !important;
    --text-main: #f1f5f9 !important;
    --text-secondary: #94a3b8 !important;
    --border: #334155 !important;
    --primary: #818cf8 !important;
    --primary-bg: #312e81 !important;
  }
  body { background: var(--bg-body); color: var(--text-main); }
  .header { background: linear-gradient(135deg, #6b21d9, #a855f7) !important; }
  .card, .status-box { background: var(--bg-card) !important; border-color: var(--border) !important; }
  th { background: #1e293b !important; color: #cbd5e1 !important; }
  td { color: #e2e8f0 !important; }
  input, select, .input { background: #1e293b !important; color: #e2e8f0 !important; border-color: #475569 !important; }
  .btn-ghost { color: #cbd5e1 !important; }
  tr:hover td { background: #334155 !important; }
  /* D√≤ng H·ª¶Y - ƒë·ªè ƒë·∫≠m c·ª±c n·ªïi */
  .row-red td {
    background: #7f1d1d !important;
    color: #fca5a5 !important;
    font-weight: 600 !important;
  }
  .row-red:hover td { background: #991b1b !important; }
  /* D√≤ng CH∆ØA IN / T·ªíN S·∫ÆP H·∫æT - v√†ng cam */
  .row-yellow td {
    background: #78350f !important;
    color: #fcd34d !important;
    font-weight: 600 !important;
  }
  /* D√≤ng ƒê√É L·∫§Y H√ÄNG - xanh l√° */
  .row-green td {
    background: #166534 !important;
    color: #86efac !important;
  }
  /* T·ªìn kho = 0 ‚Üí ƒë·ªè ƒë·∫≠m ch·ªØ tr·∫Øng */
  tr.row-red td { background: #7f1d1d !important; color: #ffffff !important; font-weight: 700 !important; }
  /* ƒê∆°n ƒë√£ in (n·ªÅn t√≠m nh·∫°t) */
  tr[style*="background"] td {
    color: #ddd6fe !important;
  }
  /* Empty state */
  .empty-state { color: #94a3b8 !important; }
}

#tblThuongHieu {
  width: 250px;  /* Gi·∫£m chi·ªÅu r·ªông b·∫£ng xu·ªëng 250px (b·∫°n c√≥ th·ªÉ ch·ªânh th√†nh 200px ho·∫∑c nh·ªè h∆°n) */
  max-height: 400px;  /* Gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa, n·∫øu v∆∞·ª£t s·∫Ω cu·ªôn */
  overflow-y: auto;  /* Th√™m thanh cu·ªôn d·ªçc n·∫øu danh s√°ch th∆∞∆°ng hi·ªáu d√†i */
}
#tblThuongHieu th, #tblThuongHieu td {
  padding: 8px 12px;  /* Gi·∫£m padding ƒë·ªÉ b·∫£ng g·ªçn h∆°n */
  font-size: 12px;  /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ ƒë·ªÉ v·ª´a v·ªõi b·∫£ng nh·ªè */
}

@media (max-width: 768px) {
  .status-grid {
    grid-template-columns: 1fr;  /* Chuy·ªÉn sang 1 c·ªôt tr√™n mobile, b·∫£ng th∆∞∆°ng hi·ªáu s·∫Ω n·∫±m tr√™n */
  }
  #tblThuongHieu {
    width: 100%;  /* B·∫£ng ƒë·∫ßy r·ªông tr√™n mobile */
    max-height: 300px;  /* Gi·ªõi h·∫°n chi·ªÅu cao v√† cu·ªôn */
    overflow-y: auto;
  }
}
</style>
</head>
<body>
<div class="header">
    <h2>VieAI Dashboard</h2>
    <div style="display:flex; align-items:center; gap:12px;">
        <!-- √î t√¨m ki·∫øm to√†n dashboard -->
        <input type="text" id="globalSearch" placeholder="üîç T√¨m MVD / MDH / M√£ gian..."
               style="padding:8px 12px; border-radius:20px; border:none; width:280px; font-size:14px;">
        <button id="themeToggle" class="btn-ghost" style="padding:8px 12px; font-size:18px;">üåô</button>
    </div>
</div>
<div class="tabs">
  <button data-tab="tab-don" class="active">üìÑ ƒê∆°n chi ti·∫øt</button>
  <button data-tab="tab-status">üìä Tr·∫°ng th√°i</button>
  <button data-tab="tab-ton">üì¶ T·ªìn kho</button>
  <button data-tab="tab-hoan">‚Ü©Ô∏è H√†ng ho√†n</button>
  <button data-tab="tab-tb">üîî Th√¥ng b√°o</button>
  <button data-tab="tab-chuain">‚è≥ Ch∆∞a in ƒë∆°n</button>
  <button data-tab="tab-huy">‚ùå ƒê∆°n h·ªßy h√¥m nay</button>
</div>
</div>
<!-- TAB ƒê∆†N CHI TI·∫æT -->
 <!-- TAB ƒê∆†N CHI TI·∫æT - B·∫¢NG L·ªöN ƒê·∫∏P NH∆Ø CHUY√äN NGHI·ªÜP -->
<div id="tab-don" class="tab active">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">üìÑ Danh s√°ch ƒê∆°n h√†ng Chi ti·∫øt</h3>
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="setDatePreset('don','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','week')">Tu·∫ßn n√†y</button>
        <button class="btn btn-ghost" onclick="resetFilters('don')">‚Ü∫ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateDon" class="input" style="width:140px;">
      <span>-</span>
      <input type="date" id="toDateDon" class="input" style="width:140px;">
      <select id="fKhungDon" class="input" style="width:120px;"></select>
      <input id="fGianDon" class="input" list="listGianDon" placeholder="M√£ gian..." debounce="300">
      <datalist id="listGianDon"></datalist>
      <input id="fMvdDon" class="input" placeholder="T√¨m MVD ho·∫∑c MDH..." debounce="300" style="flex:1;">
    </div>
    <!-- B·∫¢NG L·ªöN ƒê·∫∏P - GI·ªÆ NGUY√äN T·∫§T C·∫¢ C·ªòT -->
    <div class="table-container" style="max-height: calc(100vh - 280px);">
      <div class="loading" id="loadingDon"></div>
      <table id="tblDonChiTiet">
        <thead>
          <tr>
            <th>STT</th>
            <th>Ng√†y</th>
            <th>S√¢n</th>
            <th>Khung</th>
            <th>M√£ gian</th>
            <th>MVD</th>
            <th>MDH</th>
            <th>ID SP</th>
            <th>SL</th>
            <th>T√™n SP</th>
            <th>T√¨nh tr·∫°ng</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody id="tbodyDon"></tbody>
      </table>
    </div>
  </div>
</div>
<!-- TAB THEO TR·∫†NG TH√ÅI -->
<div id="tab-status" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Theo d√µi Tr·∫°ng th√°i</h3>
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="setDatePreset('status','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','week')">Tu·∫ßn n√†y</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateStatus" class="input">
      <input type="date" id="toDateStatus" class="input">
      <select id="fKhungStatus" class="input"></select>
      <input id="fGianStatus" class="input" list="listGianStatus" placeholder="M√£ gian..." debounce="300">
      <datalist id="listGianStatus"></datalist>
      <input id="fMvdStatus" class="input" placeholder="MVD..." debounce="300">
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="resetFilters('status')">L√†m m·ªõi</button>
      </div>
    </div>
    <div class="status-grid">
      <div class="status-box">
        <h3 style="color: var(--primary);">üìã ƒê∆†N ƒê√É IN ƒê∆†N</h3>
        <div class="table-container">
          <div class="loading" id="loadingPrinted"></div>
          <table id="tblPrinted">
            <thead>
              <tr>
                <th>STT</th><th>Ng√†y</th><th>M√£ gian</th><th>MVD</th><th>ID SP</th>
                <th>T√¨nh tr·∫°ng</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th><th>Khung</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="status-box">
        <h3 style="color: var(--success);">üöö ƒê∆†N DVVC L·∫§Y H√ÄNG</h3>
        <div class="table-container">
          <div class="loading" id="loadingPicked"></div>
          <table id="tblPicked">
            <thead>
              <tr>
                <th>STT</th><th>Ng√†y</th><th>M√£ gian</th><th>MVD</th>
                <th>T√¨nh tr·∫°ng</th><th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- TAB T·ªíN KHO (API Google Sheet) -->
<div id="tab-ton" class="tab">
  <div class="card">
    <div class="card-header">
        <h3 class="card-title">D·ªØ li·ªáu T·ªìn kho (API)</h3>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-success" onclick="exportInventoryExcel()">üì• Xu·∫•t Excel</button>
        </div>
    </div>
    <div class="status-grid">
      <div class="status-box">
        <h3>üìå Danh s√°ch Th∆∞∆°ng hi·ªáu</h3>
        <div class="table-container">
          <table id="tblThuongHieu">
            <thead>
              <tr>
                <th>Th∆∞∆°ng hi·ªáu</th>
                <th>S·ªë SP</th>
                <th class="text-right">T·ªìn t·ªïng</th>
              </tr>
            </thead>
            <tbody id="tbodyThuongHieu"></tbody>
          </table>
        </div>
      </div>
      <div class="status-box">
        <h3>üì¶ Chi ti·∫øt S·∫£n ph·∫©m</h3>
        <div class="controls">
          <input id="filterIdSp" class="input" placeholder="üîç T√¨m theo ID s·∫£n ph·∫©m..." onkeyup="renderTonKho()" style="flex: 1;">
          <input id="filterTenSp" class="input" placeholder="üîç T√¨m theo t√™n s·∫£n ph·∫©m..." onkeyup="renderTonKho()" style="flex: 2;">
        </div>
        <div class="table-container">
          <div class="loading" id="loadingTon"></div>
          <table id="tblTonKho">
            <thead>
              <tr>
                <th>Kho</th>
                <th>ID SP</th>
                <th class="text-right">T·ªìn cu·ªëi</th>
                <th>T√™n SP</th>
                <th>Th∆∞∆°ng hi·ªáu</th>
              </tr>
            </thead>
            <tbody id="tbodyTonKho"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- TAB H√ÄNG HO√ÄN -->
<div id="tab-hoan" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">Qu·∫£n l√Ω H√†ng ho√†n</h3></div>
    <div class="controls">
      <input id="fShop" class="input" placeholder="L·ªçc shop..." debounce="300">
      <input id="fMVD" class="input" placeholder="L·ªçc MVD..." debounce="300">
      <input id="fSKU" class="input" placeholder="L·ªçc SKU..." debounce="300">
    </div>
    <div class="table-container">
      <table id="tblHoan">
        <thead><tr><th>Ng√†y</th><th>Shop</th><th>MVD ho√†n</th><th>SKU ho√†n</th><th>SLG</th><th>·∫¢nh</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<!-- TAB TH√îNG B√ÅO -->
<div id="tab-tb" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">Th√¥ng b√°o H·ªá th·ªëng</h3></div>
    <div class="table-container">
      <table id="tblTB">
        <thead><tr><th>Ng√†y</th><th>Tr∆∞·ªùng</th><th>N·ªôi dung th√¥ng b√°o</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<!-- TAB CH∆ØA IN ƒê∆†N -->
<div id="tab-chuain" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">‚è≥ ƒê∆°n Ch∆∞a In (H√¥m nay & H√¥m qua)</h3></div>
    <div class="table-container" style="max-height: calc(100vh - 260px);">
      <div class="loading" id="loadingChuaIn"></div>
      <table id="tblChuaIn">
        <thead><tr><th>STT</th><th>Ng√†y</th><th>S√¢n</th><th>Khung</th><th>M√£ gian</th><th>MVD</th><th>ID SP</th><th>SL</th><th>T√™n SP</th><th>Ghi ch√∫</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<!-- TAB ƒê∆†N H·ª¶Y H√îM NAY -->
<div id="tab-huy" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">‚ùå ƒê∆°n b·ªã H·ªßy h√¥m nay</h3></div>
    <div class="table-container" style="max-height: calc(100vh - 260px);">
      <div class="loading" id="loadingHuy"></div>
      <table id="tblHuy">
        <thead><tr><th>STT</th><th>Ng√†y</th><th>S√¢n</th><th>Khung</th><th>M√£ gian</th><th>MVD</th><th>ID SP</th><th>SL</th><th>T√™n SP</th><th>L√Ω do h·ªßy</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<script>
// ========== D·ªÆ LI·ªÜU API ==========
const API_URL = "https://script.google.com/macros/s/AKfycbzEgZwWIGr_31qDy4ZJjehUVP_-0Tpq2SKrGGgubU28dQZMV7lnYkJVzlRvVXRlL9cR/exec";
let DATA = { DON: [], TON: [], HOAN: [], TB: [] };
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
// ========== HELPER L·∫§Y NG√ÄY GI·ªú VN (GMT+7) ==========
function getVNDateString(offsetDays = 0) {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const vnTime = new Date(utc + (3600000 * 7));
  vnTime.setDate(vnTime.getDate() + offsetDays);
  const y = vnTime.getFullYear();
  const m = String(vnTime.getMonth() + 1).padStart(2, '0');
  const d = String(vnTime.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
// ========== DEBOUNCE ==========
function debounce(fn, delay) {
  let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); };
}
// ========== INPUT DEBOUNCE ==========
document.addEventListener("input", e => {
  if (e.target.hasAttribute("debounce")) {
    e.target._debounce ||= debounce(() => {
      const tab = e.target.closest(".tab").id;
      if (tab === "tab-don") renderDon();
      else if (tab === "tab-status") renderStatusTables();
      else if (tab === "tab-hoan") renderHoan();
    }, +e.target.getAttribute("debounce"));
    e.target._debounce();
  }
});
// ========== LOAD DATA T·ª™ API ==========
fetch(API_URL)
  .then(r => r.json())
  .then(raw => {
    DATA.DON = raw.filter(r => r.id_up_don);
    // L·∫•y d·ªØ li·ªáu t·ªìn kho t·ª´ API
    DATA.TON = raw.filter(r => r.kho);
    DATA.HOAN = raw.filter(r => r.mvd_hoan);
    DATA.TB = raw.filter(r => r.tb);
    initUI();
    renderAll();
  })
  .catch(e => console.log("API Load Error: " + e));
// ========== INIT UI ==========
function initUI() {
  const todayVN = getVNDateString(0);
 
  ["#fromDateDon","#toDateDon","#fromDateStatus","#toDateStatus"].forEach(id => {
    if($(id)) $(id).value = todayVN;
  });
  const khung = ["T·∫•t c·∫£", ...new Set(DATA.DON.map(r => r.khung_h).filter(Boolean))];
  const gian = [...new Set(DATA.DON.map(r => r.ma_gian).filter(Boolean))];
  ["#fKhungDon", "#fKhungStatus"].forEach(sel => {
    if($(sel)) $(sel).innerHTML = khung.map(v => `<option>${v}</option>`).join("");
  });
  ["#listGianDon", "#listGianStatus"].forEach(dl => {
    if($(dl)) $(dl).innerHTML = gian.map(v => `<option value="${v}">`).join("");
  });
  $$("button[data-filter]").forEach(btn => {
    btn.onclick = () => {
      const filter = btn.dataset.filter;
      const tab = btn.closest(".tab").id;
      $$(`#${tab} button[data-filter="${filter}"]`).forEach(b => b.classList.remove("active-filter"));
      btn.classList.toggle("active-filter");
      tab === "tab-don" ? renderDon() : renderStatusTables();
    };
  });
  renderThuongHieu();
}
// ========== RENDER ALL ==========
function renderAll() {
  renderDon();
  renderStatusTables(true);
  renderTonKho();
  renderHoan();
  renderTB();
}
// ============================================================
// LOGIC T·ªíN KHO (API + SORT Z-A KHO, A-Z ID)
// ============================================================
let currentThuongHieu = '';
function renderThuongHieu() {
  const tbody = $('#tbodyThuongHieu');
  const groups = {};
  let totalCount = 0;
  let totalTon = 0;
  DATA.TON.forEach(item => {
    const th = item.thuong_hieu || "Kh√¥ng c√≥";
    if (!groups[th]) groups[th] = { count: 0, ton: 0 };
    groups[th].count++;
    groups[th].ton += parseInt(item.ton_cuoi) || 0;
    totalCount++;
    totalTon += parseInt(item.ton_cuoi) || 0;
  });
  const sorted = Object.entries(groups).sort((a, b) => b[1].count - a[1].count);
  tbody.innerHTML = '';
  // D√≤ng "T·∫•t c·∫£" ·ªü ƒë·∫ßu
  const allTr = document.createElement('tr');
  allTr.innerHTML = `
    <td class="font-bold">T·∫•t c·∫£</td>
    <td>${totalCount}</td>
    <td class="text-right">${totalTon.toLocaleString('vi-VN')}</td>
  `;
  allTr.style.cursor = 'pointer';
  allTr.classList.add('row-yellow'); // Highlight m·∫∑c ƒë·ªãnh
  allTr.onclick = () => {
    currentThuongHieu = '';
    $$('#tblThuongHieu tr').forEach(t => t.classList.remove('row-yellow'));
    allTr.classList.add('row-yellow');
    renderTonKho();
  };
  tbody.appendChild(allTr);
  // C√°c th∆∞∆°ng hi·ªáu kh√°c
  sorted.forEach(([th, {count, ton}]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="font-bold">${th}</td>
      <td>${count}</td>
      <td class="text-right">${ton.toLocaleString('vi-VN')}</td>
    `;
    tr.style.cursor = 'pointer';
    tr.onclick = () => {
      currentThuongHieu = th === "Kh√¥ng c√≥" ? "" : th;
      $$('#tblThuongHieu tr').forEach(t => t.classList.remove('row-yellow'));
      tr.classList.add('row-yellow');
      renderTonKho();
    };
    tbody.appendChild(tr);
  });
}
function renderTonKho() {
    const tbody = $('#tbodyTonKho');
    const loading = $('#loadingTon');
    const filterId = ($('#filterIdSp').value || "").toLowerCase();
    const filterName = ($('#filterTenSp').value || "").toLowerCase();
    if(loading) loading.style.display = "block";
    // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ nh·∫π ƒë·ªÉ UI m∆∞·ª£t
    setTimeout(() => {
        // L·ªçc d·ªØ li·ªáu t·ª´ DATA.TON
        let filtered = DATA.TON.filter(item =>
            (!filterId || (item.id_sp || "").toLowerCase().includes(filterId)) &&
            (!filterName || (item.ten_sp || "").toLowerCase().includes(filterName)) &&
            (!currentThuongHieu || (item.thuong_hieu || "") === currentThuongHieu)
        );
        // S·∫ÆP X·∫æP: Kho (Z -> A) sau ƒë√≥ t·ªõi ID SP (A -> Z)
        filtered.sort((a, b) => {
            const khoA = (a.kho || "").toLowerCase();
            const khoB = (b.kho || "").toLowerCase();
            if (khoA < khoB) return 1; // Z l√™n ƒë·∫ßu
            if (khoA > khoB) return -1;
           
            const idA = (a.id_sp || "").toLowerCase();
            const idB = (b.id_sp || "").toLowerCase();
            if (idA < idB) return -1; // A l√™n ƒë·∫ßu
            if (idA > idB) return 1;
           
            return 0;
        });
        if(loading) loading.style.display = "none";
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üì¶</div><p>Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho</p></td></tr>`;
            return;
        }
        let html = '';
        filtered.forEach(item => {
            const tonCuoi = parseInt(item.ton_cuoi) || 0;
            let rowClass = "";
            if (tonCuoi <= 0) rowClass = "row-red";
            else if (tonCuoi <= 5) rowClass = "row-yellow";
            html += `
                <tr class="${rowClass}">
                    <td>${item.kho || ""}</td>
                    <td class="font-bold">${item.id_sp || ""}</td>
                    <td class="text-right font-bold" style="color:${tonCuoi <= 0 ? '#dc2626' : 'inherit'}">
                        ${tonCuoi.toLocaleString('vi-VN')}
                    </td>
                    <td>${item.ten_sp || ""}</td>
                    <td>${item.thuong_hieu || ""}</td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }, 50);
}
function exportInventoryExcel() {
    const table = document.getElementById("tblTonKho");
    const html = table.outerHTML.replace(/ /g, '%20');
    const a = document.createElement("a");
    a.href = 'data:application/vnd.ms-excel,' + html;
    a.download = 'Ton_Kho_VieAI.xls';
    a.click();
}
// ============================================================
// C√ÅC H√ÄM KH√ÅC
// ============================================================
class VirtualTable {
  constructor(tbody, rowHeight = 48) {
    this.tbody = tbody; this.rowHeight = rowHeight; this.data = [];
    this.container = tbody.parentElement.parentElement;
    this.init();
  }
  init() { this.container.addEventListener("scroll", debounce(() => this.render(), 10)); }
  setData(data) { this.data = data; this.tbody.style.height = `${data.length * this.rowHeight}px`; this.render(); }
  render() {
    const start = Math.max(0, Math.floor(this.container.scrollTop / this.rowHeight) - 5);
    const end = Math.min(start + Math.ceil(this.container.clientHeight / this.rowHeight) + 5, this.data.length);
    this.tbody.innerHTML = "";
    const frag = new DocumentFragment();
    for (let i = start; i < end; i++) {
      const r = this.data[i];
      const tr = document.createElement("tr");
      tr.className = (r.trang_thai||"").includes("H·ª¶Y") ? "row-red" : (r.tinh_trang||"").includes("DVVC L·∫§Y H√ÄNG") ? "row-green" : "";
      tr.style.top = `${i * this.rowHeight}px`;
      tr.style.position = "absolute"; tr.style.width = "100%";
      ["ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","so_luong","ten_sp","tinh_trang","trang_thai","ghi_chu"]
        .forEach(k => { const td = document.createElement("td"); td.textContent = r[k] || ""; tr.appendChild(td); });
      frag.appendChild(tr);
    }
    this.tbody.appendChild(frag);
  }
}
let virtualDon = null;
function renderDon() {
  const loading = $("#loadingDon");
  const tbody = $("#tbodyDon");
  if(loading) loading.style.display = "block";
  setTimeout(() => {
    const f = getFilters("don");
    let filtered = DATA.DON.filter(r => applyFilters(r, f))
      .sort((a,b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
    // Render b·∫£ng
    tbody.innerHTML = "";
    if (filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="13" class="empty-state"><div class="empty-state-icon">üì≠</div><p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p></td></tr>`;
      if(loading) loading.style.display = "none";
      return;
    }
    filtered.forEach((r, i) => {
      const tr = document.createElement("tr");
      // T√¥ m√†u d√≤ng theo t√¨nh tr·∫°ng
      if ((r.trang_thai||"").includes("H·ª¶Y")) tr.classList.add("row-red");
      else if ((r.tinh_trang||"").includes("DVVC L·∫§Y H√ÄNG")) tr.classList.add("row-green");
      else if ((r.tinh_trang||"").includes("ƒê√É IN ƒê∆†N")) tr.style.background = "#eef2ff"; // t√≠m nh·∫°t
      // STT + c√°c c·ªôt
      const cols = [
        i+1,
        r.ngay || "",
        r.san || "",
        r.khung_h || "",
        r.ma_gian || "",
        r.mvd || "",
        r.mdh || "",
        r.id_sp || "",
        r.so_luong || "",
        r.ten_sp || "",
        r.tinh_trang || "",
        r.trang_thai || "",
        r.ghi_chu || ""
      ];
      cols.forEach(text => {
        const td = document.createElement("td");
        td.textContent = text;
        // In ƒë·∫≠m SL v√† ID SP cho d·ªÖ nh√¨n
        if (text === r.id_sp) td.classList.add("font-bold");
        if (text === r.so_luong) td.style.textAlign = "center";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    if(loading) loading.style.display = "none";
  }, 50);
}
function renderStatusTables(auto = false) {
  const lp = $("#loadingPrinted"), lk = $("#loadingPicked");
  if(lp) lp.style.display = "block";
  if(lk) lk.style.display = "block";
 
  setTimeout(() => {
    const f = getFilters("status");
    if (auto && $("#fromDateStatus")) {
      const t = getVNDateString(0);
      $("#fromDateStatus").value = $("#toDateStatus").value = t;
    }
    const all = DATA.DON.filter(r => applyFilters(r, f))
      .sort((a, b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
    const printed = all.filter(r => (r.tinh_trang || "").trim() === "1 ƒê√É IN ƒê∆†N");
    const picked = all.filter(r => (r.tinh_trang || "").trim() === "3 DVVC L·∫§Y H√ÄNG");
    renderSimpleTable("#tblPrinted", printed, ["STT","ngay","ma_gian","mvd","id_sp","tinh_trang","trang_thai","ghi_chu","khung_h"]);
    renderSimpleTable("#tblPicked", picked, ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"], false, "row-green");
    $$("#tblPicked tr").forEach(tr => { if (tr.textContent.includes("H·ª¶Y")) tr.classList.add("row-red"); });
   
    if(lp) lp.style.display = printed.length ? "none" : "block";
    if(lk) lk.style.display = picked.length ? "none" : "block";
  }, 50);
}
function renderHoan() {
  const s = ($("#fShop").value||"").toLowerCase();
  const m = ($("#fMVD").value||"").toLowerCase();
  const sku = ($("#fSKU").value||"").toLowerCase();
  const filtered = DATA.HOAN
    .filter(r =>
      (!s || (r.shop||"").toLowerCase().includes(s)) &&
      (!m || (r.mvd_hoan||"").toLowerCase().includes(m)) &&
      (!sku || (r.sku_hoan||"").toLowerCase().includes(sku))
    )
    .sort((a, b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
  const tbody = $("#tblHoan tbody");
  if(!tbody) return;
 
  tbody.innerHTML = filtered.length ? "" : `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚Ü©Ô∏è</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu</p></td></tr>`;
 
  filtered.forEach(r => {
    const tr = document.createElement("tr");
    ["ngay","shop","mvd_hoan","sku_hoan","slg"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });
    const tdImg = document.createElement("td");
    const link = r.link_anh || r.anh || "";
    if (link) {
      const img = document.createElement("img");
      img.src = link;
      img.style = "width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--border);";
      img.onclick = () => window.open(link, "_blank");
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = "-";
      tdImg.style.color = "#999";
      tdImg.style.textAlign = "center";
    }
    tr.appendChild(tdImg);
    tbody.appendChild(tr);
  });
}
function renderTB() {
  const sorted = [...DATA.TB].sort((a,b) => new Date(b.ngay.split("/").reverse()) - new Date(a.ngay.split("/").reverse()));
  renderSimpleTable("#tblTB", sorted, ["ngay","truong","tb"]);
  $$("#tblTB td:last-child").forEach(td => {
    td.innerHTML = (td.textContent||"").replace(/\n/g, "<br>").replace(/\|/g, "</td><td>").replace(/^(.*)$/gm, "<tr><td style='border:1px solid var(--border);padding:4px 8px'>$1</td></tr>");
    td.innerHTML = `<table style="width:100%;font-size:13px;border-collapse:collapse">${td.innerHTML}</table>`;
  });
}
function renderSimpleTable(id, data, keys, hasSTT = false, defClass = "") {
  const tbody = $(id + " tbody");
  if(!tbody) return;
  tbody.innerHTML = data.length ? "" : `<tr><td colspan="${keys.length}" class="empty-state"><div class="empty-state-icon">üì≠</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu</p></td></tr>`;
  const frag = new DocumentFragment();
  data.forEach((r, i) => {
    const tr = document.createElement("tr");
    if ((r.trang_thai||"").includes("H·ª¶Y")) tr.className = "row-red"; else if (defClass) tr.classList.add(defClass);
    keys.forEach(k => {
      const td = document.createElement("td"); td.textContent = k === "STT" ? i+1 : (r[k] || ""); tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}
function getFilters(tab) {
  const prefix = tab === "don" ? "Don" : "Status";
  const fromEl = $(`#fromDate${prefix}`);
  const toEl = $(`#toDate${prefix}`);
  return {
    from: fromEl && fromEl.value ? new Date(fromEl.value) : null,
    to: toEl && toEl.value ? new Date(toEl.value) : null,
    khung: $(`#fKhung${prefix}`) ? $(`#fKhung${prefix}`).value : "T·∫•t c·∫£",
    gian: $(`#fGian${prefix}`) ? $(`#fGian${prefix}`).value : "",
    mvd: $(`#fMvd${prefix}`) ? $(`#fMvd${prefix}`).value : "",
    tinh_trang: [...$$(`#tab-${tab} button.active-filter`)].find(b => b.dataset.filter === "tinh_trang")?.dataset.value,
    trang_thai: [...$$(`#tab-${tab} button.active-filter`)].find(b => b.dataset.filter === "trang_thai")?.dataset.value
  };
}
function applyFilters(r, f) {
  const d = new Date(r.ngay.split("/").reverse().join("-"));
  if (f.from && d < f.from) return false;
  if (f.to && d > f.to) return false;
  if (f.khung && f.khung !== "T·∫•t c·∫£" && r.khung_h !== f.khung) return false;
  if (f.gian && r.ma_gian !== f.gian) return false;
  if (f.mvd && r.mvd !== f.mvd) return false;
  if (f.tinh_trang) {
    const target = f.tinh_trang === "1" ? "1 ƒê√É IN ƒê∆†N" : "3 DVVC L·∫§Y H√ÄNG";
    if ((r.tinh_trang || "").trim() !== target) return false;
  }
  if (f.trang_thai && !(r.trang_thai || "").includes("H·ª¶Y")) return false;
  return true;
}
function setDatePreset(tab, type) {
  let fromStr, toStr;
  if (type === "today") {
    fromStr = toStr = getVNDateString(0);
  } else if (type === "yesterday") {
    fromStr = toStr = getVNDateString(-1);
  } else if (type === "week") {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const vnTime = new Date(utc + (3600000 * 7));
    const day = vnTime.getDay() || 7;
    fromStr = getVNDateString(1 - day);
    toStr = getVNDateString(7 - day);
  }
  const prefix = tab === "don" ? "Don" : "Status";
  if($(`#fromDate${prefix}`)) $(`#fromDate${prefix}`).value = fromStr;
  if($(`#toDate${prefix}`)) $(`#toDate${prefix}`).value = toStr;
  tab === "don" ? renderDon() : renderStatusTables();
}
function resetFilters(tab) {
  const prefix = tab === "don" ? "Don" : "Status";
  if($(`#fKhung${prefix}`)) $(`#fKhung${prefix}`).value = "T·∫•t c·∫£";
  if($(`#fGian${prefix}`)) $(`#fGian${prefix}`).value = "";
  if($(`#fMvd${prefix}`)) $(`#fMvd${prefix}`).value = "";
  clearStatusFilters(tab);
}
function clearStatusFilters(tab) {
  $$(`#tab-${tab} button[data-filter]`).forEach(b => b.classList.remove("active-filter"));
  tab === "don" ? renderDon() : renderStatusTables();
}
// ================= DARK MODE T·ª∞ ƒê·ªòNG + N√öT B·∫¨T/T·∫ÆT =================
const themeToggle = $('#themeToggle');
if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.body.classList.add('dark-mode');
  themeToggle.textContent = '‚òÄÔ∏è';
} else {
  themeToggle.textContent = 'üåô';
}
themeToggle.onclick = () => {
  document.body.classList.toggle('dark-mode');
  themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
};
// ================= 2 TAB M·ªöI: CH∆ØA IN + H·ª¶Y H√îM NAY =================
function renderChuaIn() {
  const today = getVNDateString(0);
  const yesterday = getVNDateString(-1);
  const data = DATA.DON.filter(r =>
    (r.ngay === today || r.ngay === yesterday) &&
    !["1 ƒê√É IN ƒê∆†N", "3 DVVC L·∫§Y H√ÄNG"].some(s => (r.tinh_trang||"").includes(s))
  ).sort((a,b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
  renderSimpleTable("#tblChuaIn", data, ["STT","ngay","san","khung_h","ma_gian","mvd","id_sp","so_luong","ten_sp","ghi_chu"]);
  $$("#tblChuaIn tbody tr").forEach(tr => tr.classList.add("row-yellow")); // highlight v√†ng
  $("#loadingChuaIn").style.display = data.length ? "none" : "block";
}
function renderDonHuyHomNay() {
  const today = getVNDateString(0);
  const data = DATA.DON.filter(r =>
    r.ngay === today && (r.trang_thai||"").includes("H·ª¶Y")
  ).sort((a,b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
  renderSimpleTable("#tblHuy", data, ["STT","ngay","san","khung_h","ma_gian","mvd","id_sp","so_luong","ten_sp","trang_thai"]);
  $$("#tblHuy tbody tr").forEach(tr => tr.classList.add("row-red"));
  $("#loadingHuy").style.display = data.length ? "none" : "block";
}
// Th√™m v√†o ph·∫ßn render khi chuy·ªÉn tab
const originalTabClick = $$(".tabs button")[0].onclick; // gi·ªØ logic c≈©
$$(".tabs button").forEach(btn => {
  btn.onclick = () => {
    $$(".tabs button, .tab").forEach(el => el.classList.remove("active"));
    btn.classList.add("active");
    $(`#${btn.dataset.tab}`).classList.add("active");
    if (btn.dataset.tab === "tab-chuain") renderChuaIn();
    if (btn.dataset.tab === "tab-huy") renderDonHuyHomNay();
    // c√°c tab c≈© gi·ªØ nguy√™n...
    if (btn.dataset.tab === "tab-don") renderDon();
    if (btn.dataset.tab === "tab-status") renderStatusTables(true);
    if (btn.dataset.tab === "tab-ton") renderTonKho();
    if (btn.dataset.tab === "tab-hoan") renderHoan();
    if (btn.dataset.tab === "tab-tb") renderTB();
  };
});
// ================= T√åM KI·∫æM TO√ÄN DASHBOARD + COPY NHANH =================
const globalSearch = $('#globalSearch');
globalSearch?.addEventListener('input', debounce(() => {
  const query = globalSearch.value.trim().toLowerCase();
  if (!query) {
    // X√≥a highlight c≈©
    $$('.highlight-row').forEach(el => el.classList.remove('highlight-row'));
    return;
  }
  let found = false;
  // Duy·ªát t·∫•t c·∫£ c√°c tab c√≥ b·∫£ng ƒë∆°n h√†ng
  const tabs = [
    { id: 'tab-don', table: '#tblDonChiTiet', cols: [5,6,4] }, // MVD (c·ªôt 6), MDH (7), M√£ gian (5)
    { id: 'tab-status', table: '#tblPrinted', cols: [3] },
    { id: 'tab-status', table: '#tblPicked', cols: [3] },
    { id: 'tab-chuain', table: '#tblChuaIn', cols: [5,6,4] },
    { id: 'tab-huy', table: '#tblHuy', cols: [5,6,4] },
  ];
  tabs.forEach(tab => {
    const rows = $$(`${tab.table} tbody tr`);
    rows.forEach(tr => {
      tr.classList.remove('highlight-row');
      const tds = tr.querySelectorAll('td');
      tab.cols.forEach(colIdx => {
        if (tds[colIdx] && tds[colIdx].textContent.toLowerCase().includes(query)) {
          tr.classList.add('highlight-row');
          if (!found) {
            // Chuy·ªÉn tab t·ª± ƒë·ªông
            $$(`.tabs button`).forEach(b => b.classList.remove('active'));
            $$(`.tab`).forEach(t => t.classList.remove('active'));
            $(`.tabs button[data-tab="${tab.id}"]`)?.classList.add('active');
            $(`#${tab.id}`).classList.add('active');
            $(`#${tab.id}`).scrollIntoView({ behavior: 'smooth' });
            found = true;
          }
          // Cu·ªôn ƒë·∫øn d√≤ng ƒë·∫ßu ti√™n t√¨m th·∫•y
          tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    });
  });
}, 300));
// Highlight d√≤ng t√¨m th·∫•y
const style = document.createElement('style');
style.textContent = `
  .highlight-row td {
    background: #fef3c7 !important;
    animation: pulse 2s infinite;
    font-weight: 600;
  }
  @keyframes pulse {
    0%, 100% { background: #fef3c7; }
    50% { background: #fcd34d; }
  }
`;
document.head.appendChild(style);
// N√∫t Copy nhanh MVD / MDH / M√£ gian
// ================= COPY 1 PH√ÅT 4 TH·ª®: M√£ gian + MVD + MDH + ID SP =================
function addOneClickCopy() {
  const tables = ['#tblDonChiTiet', '#tblPrinted', '#tblPicked', '#tblChuaIn', '#tblHuy'];
 
  tables.forEach(selector => {
    const rows = $$(selector + ' tbody tr');
    rows.forEach(tr => {
      // N·∫øu ƒë√£ c√≥ n√∫t r·ªìi th√¨ b·ªè qua
      if (tr.querySelector('.onecopy-btn')) return;
      const tds = tr.querySelectorAll('td');
      if (tds.length < 9) return;
      const magian = (tds[4]?.textContent || '').trim(); // c·ªôt M√£ gian
      const mvd = (tds[5]?.textContent || '').trim(); // c·ªôt MVD
      const mdh = (tds[6]?.textContent || '').trim(); // c·ªôt MDH
      const idsp = (tds[7]?.textContent || '').trim(); // c·ªôt ID SP
      if (!magian && !mvd && !mdh && !idsp) return;
      // T·∫°o n√∫t copy 1 ph√°t
      const btn = document.createElement('button');
      btn.className = 'onecopy-btn';
      btn.innerHTML = '‚ö° Copy 4';
      btn.title = 'Copy M√£ gian + MVD + MDH + ID SP';
      btn.style = 'margin-left:8px; padding:3px 8px; font-size:11px; background:#8b5cf6; color:white; border:none; border-radius:4px; cursor:pointer;';
      btn.onclick = (e) => {
        e.stopPropagation();
        const text = `M√£ gian: ${magian}\nMVD: ${mvd}\nMDH: ${mdh}\nID SP: ${idsp}`.trim();
        navigator.clipboard.writeText(text).then(() => {
          const old = btn.innerHTML;
          btn.innerHTML = '‚úì ƒê√£ copy!';
          btn.style.background = '#10b981';
          setTimeout(() => {
            btn.innerHTML = old;
            btn.style.background = '#8b5cf6';
          }, 1200);
        });
      };
      // Th√™m n√∫t v√†o c·ªôt ƒë·∫ßu ti√™n (STT)
      tds[0].style.position = 'relative';
      tds[0].appendChild(btn);
    });
  });
}
// G·ªçi l·∫°i sau m·ªói l·∫ßn render b·∫£ng
const oldRenderDon = renderDon;
renderDon = function() { oldRenderDon(); setTimeout(addOneClickCopy, 100); };
const oldRenderStatus = renderStatusTables;
renderStatusTables = function() { oldRenderStatus(); setTimeout(addOneClickCopy, 100); };
const oldChuaIn = renderChuaIn;
renderChuaIn = function() { oldChuaIn(); setTimeout(addOneClickCopy, 100); };
const oldHuy = renderDonHuyHomNay;
renderDonHuyHomNay = function() { oldHuy(); setTimeout(addOneClickCopy, 100); };
// Ch·∫°y l·∫ßn ƒë·∫ßu khi load xong
setTimeout(addOneClickCopy, 2000);
// X·ª≠ l√Ω click copy
document.addEventListener('click', e => {
  if (e.target.classList.contains('copy-btn')) {
    const text = e.target.dataset.clip;
    navigator.clipboard.writeText(text).then(() => {
      const oldText = e.target.textContent;
      e.target.textContent = '‚úì ƒê√£ copy!';
      e.target.style.background = '#10b981';
      e.target.style.color = 'white';
      setTimeout(() => {
        e.target.textContent = oldText;
        e.target.style.background = '';
        e.target.style.color = '';
      }, 1000);
    });
  }
});
// Ch·∫°y l·∫ßn ƒë·∫ßu khi load xong
setTimeout(addCopyButtons, 2000);
initUI();
</script>
</body>
</html>

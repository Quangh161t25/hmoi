<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>B√ÅO C√ÅO D·ªÆ LI·ªÜU</title>
<style>
:root{
  --primary:#4a6ee0;--secondary:#6a3db3;
  --gray-light:#eef3ff;--gray-medium:#d1d9e6;
  --transition:all .3s ease;--box-shadow:0 4px 20px rgba(0,0,0,.08);
  --row-green:#99ff92; --row-blue:#f8f8f8; --row-pink:#fcabab;
}
body{
  font-family:'Segoe UI',sans-serif;
  background:#f5f9ff;margin:0;padding:10px;color:#333;
}
.container{
  background:#fff;border-radius:10px;box-shadow:var(--box-shadow);
  width:100%;max-width:100%;margin:0 auto;overflow:hidden;
}
.header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;text-align:center;padding:16px;
}
.tabs{display:flex;flex-wrap:wrap;background:var(--gray-light);border-bottom:1px solid var(--gray-medium)}
.tab{flex:1;min-width:180px;text-align:center;padding:12px 0;cursor:pointer;font-weight:500;transition:var(--transition)}
.tab.active{background:var(--primary);color:#fff}
.controls{
  display:flex;flex-wrap:wrap;gap:10px;padding:10px 14px;background:#f8fafe;
  border-bottom:1px solid #e1e8f0;align-items:center;
}
.search-box{
  padding:8px 12px;border:1px solid var(--gray-medium);border-radius:6px;font-size:14px;
}
.btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:var(--transition)}
.btn:hover{opacity:.9}
.btn-primary{background:var(--primary);color:#fff}
.btn-preset{background:#e8ecf9;color:#333}
.table-wrapper{
  width:100%;overflow:auto;height:calc(100vh - 160px);
  border-top:1px solid #e1e8f0;
}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:800px}
th,td{border:1px solid #e8edf5;padding:10px;text-align:left;white-space:nowrap;line-height:1.5}
th{background:#f0f3fa;position:sticky;top:0;z-index:2}
tr:nth-child(even){background:#fafcff}
tr:hover{background:#f0f5ff}
.row-green{background:var(--row-green)!important;}
.row-blue{background:var(--row-blue)!important;}
.row-pink{background:var(--row-pink)!important;}
.flex-tables{display:flex;flex-wrap:wrap;gap:20px;padding:20px}
.subtable{flex:1;min-width:600px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:10px;}
.subtable h3{text-align:center;color:#355ad8;margin-top:0;}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h2>üìã B√°o c√°o d·ªØ li·ªáu</h2></div>

  <div class="tabs">
    <div class="tab active" id="tabData" onclick="switchTab('data')">üìã B·∫£ng d·ªØ li·ªáu</div>
    <div class="tab" id="tabStatus" onclick="switchTab('status')">üì¶ Theo tr·∫°ng th√°i ƒë∆°n h√†ng</div>
  </div>

  <!-- TAB 1: B·∫¢NG D·ªÆ LI·ªÜU -->
  <div id="dataSection">
    <div class="controls">
      <input type="date" id="fromData" class="search-box" />
      <input type="date" id="toData" class="search-box" />

      <input list="listKhung" id="filterKhung" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p khung_h" class="search-box" />
      <datalist id="listKhung"></datalist>

      <input list="listGian" id="filterGian" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p ma_gian" class="search-box" />
      <datalist id="listGian"></datalist>

      <input list="listMvd" id="filterMvd" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p mvd" class="search-box" />
      <datalist id="listMvd"></datalist>

      <button class="btn btn-preset" onclick="applyPreset('today','data')">H√¥m nay</button>
      <button class="btn btn-preset" onclick="applyPreset('yesterday','data')">H√¥m qua</button>
      <button class="btn btn-primary" onclick="filterDataTable()">üìÖ L·ªçc</button>
    </div>

    <div class="table-wrapper">
      <table id="data-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB 2: THEO TR·∫†NG TH√ÅI -->
  <div id="statusSection" style="display:none">
    <div class="controls">
      <input type="date" id="fromStatus" class="search-box" />
      <input type="date" id="toStatus" class="search-box" />

      <input list="listKhung" id="filterKhungStatus" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p khung_h" class="search-box" />
      <input list="listGian" id="filterGianStatus" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p ma_gian" class="search-box" />
      <input list="listMvd" id="filterMvdStatus" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p mvd" class="search-box" />

      <button class="btn btn-preset" onclick="applyPreset('today','status')">H√¥m nay</button>
      <button class="btn btn-preset" onclick="applyPreset('yesterday','status')">H√¥m qua</button>
      <button class="btn btn-primary" onclick="filterStatusTables()">üìÖ L·ªçc</button>
    </div>

    <div class="flex-tables">
      <div class="subtable">
        <h3>üßæ ƒê∆†N ƒê√É IN ƒê∆†N</h3>
        <table id="tableInDon">
          <thead>
            <tr>
              <th>STT</th><th>Ng√†y</th><th>M√£_gian</th><th>MVD</th><th>T√¨nh_tr·∫°ng</th><th>Tr·∫°ng_th√°i</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="subtable">
        <h3>üöö ƒê∆†N DVVC L·∫§Y H√ÄNG</h3>
        <table id="tableLayHang">
          <thead>
            <tr>
              <th>STT</th><th>Ng√†y</th><th>M√£_gian</th><th>MVD</th><th>T√¨nh_tr·∫°ng</th><th>Tr·∫°ng_th√°i</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwwR3GI-ZwWKsueXHJX2rehWzjZOW9MfeQsmbY_mPSk0F6asm3BwfBh1Pps3jELfYJ7/exec";
let originalData=[];

/* ===== Date helpers ===== */
function parseVNDate(str){
  if(!str)return null;
  const parts=str.split(/[\/\-]/);
  if(parts.length===3){const[d,m,y]=parts.map(Number);if(y&&m&&d)return new Date(y,m-1,d);}
  const d2=new Date(str);return isNaN(d2)?null:d2;
}
function nowVN(){const now=new Date();const vnOffset=7*60;const localOffset=now.getTimezoneOffset();return new Date(now.getTime()+(vnOffset+localOffset)*60000);}
const fmt=d=>d.toISOString().slice(0,10);
const addDays=(date,n)=>new Date(date.getFullYear(),date.getMonth(),date.getDate()+n);

/* ===== Load Data ===== */
document.addEventListener("DOMContentLoaded",()=>{
  fetch(API_URL).then(r=>r.json()).then(d=>{
    originalData = Array.isArray(d)? d.sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay)):[];
    renderTable(originalData);
    fillUniqueLists(originalData);

    // ‚úÖ L·ªçc m·∫∑c ƒë·ªãnh ng√†y h√¥m nay cho tab tr·∫°ng th√°i
    const today = nowVN();
    const todayStr = fmt(today);
    fromStatus.value = todayStr;
    toStatus.value = todayStr;
    filterStatusTables(); // t·ª± l·ªçc h√¥m nay khi load
  });
});

/* ===== Tabs ===== */
function switchTab(tab){
  ["tabData","tabStatus"].forEach(id=>document.getElementById(id).classList.remove("active"));
  ["dataSection","statusSection"].forEach(id=>document.getElementById(id).style.display="none");
  if(tab==="data"){tabData.classList.add("active");dataSection.style.display="block";}
  if(tab==="status"){tabStatus.classList.add("active");statusSection.style.display="block";}
}

/* ===== Fill unique lists ===== */
function fillUniqueLists(data){
  const khungSet=new Set(),gianSet=new Set(),mvdSet=new Set();
  data.forEach(r=>{
    if(r.khung_h) khungSet.add(r.khung_h.trim());
    if(r.ma_gian) gianSet.add(r.ma_gian.trim());
    if(r.mvd)     mvdSet.add(r.mvd.trim());
  });
  const fill=(id,set)=>{
    const dl=document.getElementById(id);
    if(!dl) return;
    dl.innerHTML="";
    Array.from(set).sort().forEach(v=>{
      const opt=document.createElement("option");
      opt.value=v;dl.appendChild(opt);
    });
  };
  fill("listKhung",khungSet);
  fill("listGian",gianSet);
  fill("listMvd",mvdSet);
}

/* ===== Preset Buttons ===== */
function applyPreset(preset,tab){
  const base=new Date(nowVN().getFullYear(),nowVN().getMonth(),nowVN().getDate());
  let start,end;
  switch(preset){case"today":start=addDays(base,1);end=addDays(base,2);break;case"yesterday":start=base;end=addDays(base,1);break;}
  const s=fmt(start),e=fmt(addDays(end,-1));
  if(tab==="data"){fromData.value=s;toData.value=e;filterDataTable();}
  if(tab==="status"){fromStatus.value=s;toStatus.value=e;filterStatusTables();}
}

/* ===== Table Rendering with color logic ===== */
function rowColor(r){
  const tt=(r.trang_thai||"").trim().toUpperCase();
  const tinh=(r.tinh_trang||"").trim().toUpperCase();
  if(tt==="1 H·ª¶Y")return "row-pink";
  if(tinh==="3 DVVC L·∫§Y H√ÄNG")return "row-green";
  if(tinh==="1 ƒê√É IN ƒê∆†N")return "row-blue";
  return "";
}

/* ===== B·∫¢NG D·ªÆ LI·ªÜU ===== */
const displayCols=["STT","ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","sku_cha","slg_xuat","ten_sp","tinh_trang","trang_thai"];
function renderTable(data){
  const h=document.getElementById("header-row"),b=document.getElementById("data-body");
  h.innerHTML="";b.innerHTML="";
  displayCols.forEach(c=>{const th=document.createElement("th");th.textContent=c;h.appendChild(th);});
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const color=rowColor(r);if(color)tr.classList.add(color);
    displayCols.forEach(c=>{
      const td=document.createElement("td");
      if(c==="STT")td.textContent=i+1;
      else if(c==="ngay"){const d=parseVNDate(r.ngay);td.textContent=d?d.toLocaleDateString('vi-VN'):(r.ngay||"");}
      else td.textContent=r[c]||"";
      tr.appendChild(td);
    });
    b.appendChild(tr);
  });
}

/* ===== Filter b·∫£ng ch√≠nh ===== */
function filterDataTable(){
  const f=fromData.value,t=toData.value;
  const kh=filterKhung.value.trim().toLowerCase(),mg=filterGian.value.trim().toLowerCase(),mv=filterMvd.value.trim().toLowerCase();
  let rows=[...originalData];
  if(f&&t){let from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");if(from>to)[from,to]=[to,from];rows=rows.filter(r=>{const d=parseVNDate(r.ngay);return d&&d>=from&&d<=to;});}
  rows=rows.filter(r=>{
    if(kh&&!(r.khung_h||"").toLowerCase().includes(kh))return false;
    if(mg&&!(r.ma_gian||"").toLowerCase().includes(mg))return false;
    if(mv&&!(r.mvd||"").toLowerCase().includes(mv))return false;
    return true;
  });
  rows.sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
  renderTable(rows);
}

/* ===== TAB 2: THEO TR·∫†NG TH√ÅI ===== */
function fillSubTable(id,data){
  const body=document.querySelector(`#${id} tbody`);body.innerHTML="";
  data.sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
  data.forEach((r,i)=>{
    const tr=document.createElement("tr");const color=rowColor(r);if(color)tr.classList.add(color);
    ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"].forEach(c=>{
      const td=document.createElement("td");
      if(c==="STT")td.textContent=i+1;
      else if(c==="ngay"){const d=parseVNDate(r.ngay);td.textContent=d?d.toLocaleDateString('vi-VN'):(r.ngay||"");}
      else td.textContent=r[c]||"";
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}
function renderStatusTables(filtered=null){
  const data=filtered||originalData;
  const inDon = data.filter(r=>(r.tinh_trang||"").trim().toUpperCase()==="1 ƒê√É IN ƒê∆†N");
  const layHang = data.filter(r=>(r.tinh_trang||"").trim().toUpperCase()==="3 DVVC L·∫§Y H√ÄNG");
  fillSubTable("tableInDon",inDon);
  fillSubTable("tableLayHang",layHang);
}

/* ===== L·ªçc trong TAB 2 ===== */
function filterStatusTables(){
  const f=fromStatus.value,t=toStatus.value;
  const kh=filterKhungStatus.value.trim().toLowerCase();
  const mg=filterGianStatus.value.trim().toLowerCase();
  const mv=filterMvdStatus.value.trim().toLowerCase();
  let rows=[...originalData];
  if(f&&t){let from=new Date(f+"T00:00:00"),to=new Date(t+"T23:59:59");if(from>to)[from,to]=[to,from];rows=rows.filter(r=>{const d=parseVNDate(r.ngay);return d&&d>=from&&d<=to;});}
  rows=rows.filter(r=>{
    if(kh&&!(r.khung_h||"").toLowerCase().includes(kh))return false;
    if(mg&&!(r.ma_gian||"").toLowerCase().includes(mg))return false;
    if(mv&&!(r.mvd||"").toLowerCase().includes(mv))return false;
    return true;
  });
  renderStatusTables(rows);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VieAI Dashboard</title>
<style>
:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --primary-dark: #1d4ed8;
  --secondary: #64748b;
  --success: #16a34a;
  --success-light: #dcfce7;
  --warning: #d97706;
  --warning-light: #f9d958;
  --danger: #dc2626;
  --danger-light: #ffffff;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --white: #ffffff;
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 8px;
  --radius-lg: 12px;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--gray-50);
  margin: 0;
  color: var(--gray-800);
  line-height: 1.5;
}

/* Header */
.header {
  background: var(--primary);
  color: var(--white);
  padding: 16px 24px;
  box-shadow: var(--shadow-md);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header h2::before {
  content: "üìä";
  font-size: 24px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--white);
  padding: 8px 16px;
  border-bottom: 1px solid var(--gray-200);
  position: sticky;
  top: 64px;
  z-index: 90;
  overflow-x: auto;
  scrollbar-width: none;
}

.tabs::-webkit-scrollbar {
  display: none;
}

.tabs button {
  padding: 12px 16px;
  border: none;
  border-radius: var(--radius);
  background: transparent;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--gray-600);
}

.tabs button:hover {
  background: var(--gray-100);
  color: var(--gray-800);
}

.tabs button.active {
  background: var(--primary);
  color: var(--white);
  box-shadow: var(--shadow);
}

.tab {
  display: none;
  padding: 20px;
}

.tab.active {
  display: block;
}

/* Controls */
.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  align-items: center;
  padding: 16px;
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
}

.input {
  padding: 10px 12px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
  min-width: 160px;
  font-size: 14px;
  background: var(--white);
  transition: border-color 0.2s, box-shadow 0.2s;
}

.input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--radius);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: var(--primary);
  color: var(--white);
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-ghost {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.btn-ghost:hover {
  background: var(--gray-200);
}

/* Table */
.table-wrap {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: auto;
  max-height: calc(100vh - 280px);
  box-shadow: var(--shadow);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border: 1px solid var(--gray-200);
  padding: 10px 12px;
  text-align: left;
  white-space: nowrap;
}

th {
  background: var(--gray-50);
  position: sticky;
  top: 0;
  z-index: 1;
  font-weight: 600;
  color: var(--gray-700);
}

tr:hover {
  background: var(--primary-light);
}

/* Status Grid */
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 20px;
}

.status-box {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.status-box h3 {
  margin: 0;
  padding: 16px 20px;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-box table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.status-box th, .status-box td {
  border: 1px solid var(--gray-200);
  padding: 8px 12px;
  text-align: left;
}

/* Row Colors */
tr.row-red td {
  background: var(--danger-light) !important;
}

tr.row-yellow td {
  background: var(--warning-light) !important;
}

tr.row-green td {
  background: var(--success-light) !important;
}

/* Responsive */
@media (max-width: 768px) {
  .tabs {
    padding: 6px 12px;
  }
  
  .tabs button {
    padding: 10px 12px;
    font-size: 14px;
  }
  
  .tab {
    padding: 16px;
  }
  
  .controls {
    padding: 12px;
  }
  
  .input, .btn {
    min-width: 100%;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
  
  .table-wrap {
    max-height: calc(100vh - 320px);
  }
}

/* Loading State */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--white);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Badge */
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.badge-success {
  background: var(--success-light);
  color: var(--success);
}

.badge-warning {
  background: var(--warning-light);
  color: var(--warning);
}

.badge-danger {
  background: var(--danger-light);
  color: var(--danger);
}

.badge-info {
  background: var(--primary-light);
  color: var(--primary);
}

/* Card */
.card {
  background: var(--white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: var(--gray-800);
}

/* Filter Group */
.filter-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
  min-width: 80px;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-500);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 16px;
  margin: 0;
}
</style>
</head>
<body>
<div class="header"><h2>VieAI Dashboard</h2></div>

<!-- Tabs -->
<div class="tabs">
  <button data-tab="tab-don" class="active">üöö ƒê∆°n chi ti·∫øt</button>
  <button data-tab="tab-status">üì¶ Theo tr·∫°ng th√°i ƒë∆°n h√†ng</button>
  <button data-tab="tab-ton">üè∑Ô∏è T·ªìn kho</button>
  <button data-tab="tab-hoan">üîÅ H√†ng ho√†n BH</button>
  <button data-tab="tab-tb">üì¢ Th√¥ng b√°o</button>
</div>

<!-- ========== ƒê∆†N CHI TI·∫æT ========== -->
<div id="tab-don" class="tab active">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">ƒê∆°n chi ti·∫øt</h3>
      <div class="filter-group">
        <span class="filter-label">B·ªô l·ªçc:</span>
        <button class="btn btn-ghost" onclick="setDatePreset('don','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','week')">Tu·∫ßn n√†y</button>
        <button class="btn btn-ghost" onclick="resetDon()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateDon" class="input">
      <input type="date" id="toDateDon" class="input">
      <select id="fKhungDon" class="input"></select>
      <input id="fGianDon" class="input" list="listGianDon" placeholder="Nh·∫≠p m√£ gian...">
      <datalist id="listGianDon"></datalist>
      <input id="fMvdDon" class="input" placeholder="Nh·∫≠p MVD...">
    </div>
    <div class="table-wrap">
      <table id="tblDon">
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>S√¢n</th>
            <th>Khung</th>
            <th>M√£ gian</th>
            <th>MVD</th>
            <th>MDH</th>
            <th>ID SP</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T√™n SP</th>
            <th>T√¨nh tr·∫°ng</th>
            <th>Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========== TR·∫†NG TH√ÅI ƒê∆†N H√ÄNG ========== -->
<div id="tab-status" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
      <div class="filter-group">
        <span class="filter-label">B·ªô l·ªçc:</span>
        <button class="btn btn-ghost" onclick="setDatePreset('status','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','week')">Tu·∫ßn n√†y</button>
        <button class="btn btn-ghost" onclick="resetStatus()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateStatus" class="input">
      <input type="date" id="toDateStatus" class="input">
      <select id="fKhungStatus" class="input"></select>
      <input id="fGianStatus" class="input" list="listGianStatus" placeholder="Nh·∫≠p m√£ gian...">
      <datalist id="listGianStatus"></datalist>
      <input id="fMvdStatus" class="input" placeholder="Nh·∫≠p MVD...">
    </div>
    <div class="status-grid">
      <div class="status-box">
        <h3 style="color: var(--primary);">üìò ƒê∆†N ƒê√É IN ƒê∆†N</h3>
        <div class="table-wrap">
          <table id="tblPrinted">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="status-box">
        <h3 style="color: var(--success);">üöö ƒê∆†N DVVC L·∫§Y H√ÄNG</h3>
        <div class="table-wrap">
          <table id="tblPicked">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== T·ªíN KHO ========== -->
<div id="tab-ton" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">T·ªìn kho</h3>
    </div>
    <div class="controls">
      <input id="filterIdSp" class="input" placeholder="üîç L·ªçc theo ID s·∫£n ph·∫©m..." oninput="renderTonKho()">
      <input id="filterTenSp" class="input" placeholder="üîç L·ªçc theo t√™n s·∫£n ph·∫©m..." oninput="renderTonKho()">
    </div>
    <div class="table-wrap">
      <table id="tblTonKho">
        <thead>
          <tr>
            <th>Kho</th>
            <th>ID SP</th>
            <th>T·ªìn cu·ªëi</th>
            <th>T√™n SP</th>
            <th>Th∆∞∆°ng hi·ªáu</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========== H√ÄNG HO√ÄN BH ========== -->
<div id="tab-hoan" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">H√†ng ho√†n b·∫£o h√†nh</h3>
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="resetHoan()">üîÑ L√†m m·ªõi</button>
      </div>
    </div>
    <div class="controls">
      <input id="fShop" class="input" placeholder="L·ªçc shop..." oninput="renderHoan()">
      <input id="fMVD" class="input" placeholder="L·ªçc MVD..." oninput="renderHoan()">
      <input id="fSKU" class="input" placeholder="L·ªçc SKU..." oninput="renderHoan()">
    </div>
    <div class="table-wrap">
      <table id="tblHoan">
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>Shop</th>
            <th>MVD ho√†n</th>
            <th>SKU ho√†n</th>
            <th>SLG</th>
            <th>·∫¢nh</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========== TH√îNG B√ÅO ========== -->
<div id="tab-tb" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Th√¥ng b√°o</h3>
    </div>
    <div class="table-wrap">
      <table id="tblTB">
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>Tr∆∞·ªùng</th>
            <th>Th√¥ng b√°o</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ========== D·ªÆ LI·ªÜU ==========
const API_URL="https://script.google.com/macros/s/AKfycbzEgZwWIGr_31qDy4ZJjehUVP_-0Tpq2SKrGGgubU28dQZMV7lnYkJVzlRvVXRlL9cR/exec";
let RAW=[],DON=[],TON=[],HOAN=[],TB=[];
const $=s=>document.querySelector(s);

// ========== LOAD ==========
fetch(API_URL).then(r=>r.json()).then(d=>{
 RAW=d;DON=RAW.filter(r=>r.id_up_don);TON=RAW.filter(r=>r.kho);HOAN=RAW.filter(r=>r.mvd_hoan);TB=RAW.filter(r=>r.tb);
 initDropdowns();initDateDefaults();
 renderDon();renderStatusTables(true);renderTonKho();renderHoan();renderTB();
});

// ========== H√ÄM CHUNG ==========
function parseVNDate(d){if(!d)return new Date(0);const[a,b,c]=d.split("/").map(Number);return new Date(c,b-1,a);}
// ‚úÖ Chuy·ªÉn sang m√∫i gi·ªù Vi·ªát Nam tr∆∞·ªõc khi format yyyy-MM-dd
function fmt(d){
  const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0,10);
}

function addDays(dt,n){return new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()+n);}
function setDatePreset(tab,type){
 const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
 let f=today,t=today;if(type==="yesterday"){f=addDays(today,-1);t=addDays(today,-1);}
 if(type==="week"){const d=today.getDay()||7;f=addDays(today,1-d);t=addDays(f,6);}
 if(tab==="don"){$("#fromDateDon").value=fmt(f);$("#toDateDon").value=fmt(t);renderDon();}
 if(tab==="status"){$("#fromDateStatus").value=fmt(f);$("#toDateStatus").value=fmt(t);renderStatusTables();}
}
function initDateDefaults(){const t=new Date(),f=fmt(t);["#fromDateDon","#toDateDon","#fromDateStatus","#toDateStatus"].forEach(id=>$(id).value=f);}
function uniq(a){return["T·∫•t c·∫£",...[...new Set(a.filter(x=>x))]];}

// ========== DROPDOWN ==========
function initDropdowns(){
  const uKhung = uniq(DON.map(r => r.khung_h));
  const uGian  = uniq(DON.map(r => r.ma_gian));

  // G√°n list cho Khung_h
  const fill = (id, arr) => $(id).innerHTML = arr.map(v => `<option value="${v}">`).join("");
  ["#fKhungDon", "#fKhungStatus"].forEach(i => {
    const sel = document.querySelector(i);
    sel.innerHTML = uKhung.map(v => `<option>${v}</option>`).join("");
  });

  // ‚öôÔ∏è G·ª£i √Ω cho m√£ gian
  fill("#listGianDon", uGian);
  fill("#listGianStatus", uGian);

  // G·∫Øn s·ª± ki·ªán l·ªçc
  $("#fKhungDon").onchange = renderDon;
  $("#fKhungStatus").onchange = renderStatusTables;
  $("#fGianDon").oninput = renderDon;
  $("#fGianStatus").oninput = renderStatusTables;
  $("#fMvdDon").oninput = renderDon;
  $("#fMvdStatus").oninput = renderStatusTables;
}

// ========== ƒê∆†N CHI TI·∫æT ==========
function renderDon(){
 const tb=$("#tblDon tbody");tb.innerHTML="";
 const fK=$("#fKhungDon").value,fG=$("#fGianDon").value,fM=$("#fMvdDon").value;
 const from=$("#fromDateDon").value,to=$("#toDateDon").value;
 const f1=new Date(from+"T00:00:00"),f2=new Date(to+"T23:59:59");
 const filtered=DON.filter(r=>{
   const d=parseVNDate(r.ngay);
   return (!fK||fK==="T·∫•t c·∫£"||r.khung_h===fK)&&(!fG||fG==="T·∫•t c·∫£"||r.ma_gian===fG)&&(!fM||fM==="T·∫•t c·∫£"||r.mvd===fM)&&(d>=f1&&d<=f2);
 }).sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
 
 if (filtered.length === 0) {
   tb.innerHTML = `<tr><td colspan="11" class="empty-state">
     <div class="empty-state-icon">üì≠</div>
     <p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng</p>
   </td></tr>`;
   return;
 }
 
 filtered.forEach(r=>{
   const tr=document.createElement("tr");
   if((r.tinh_trang||"").trim()==="3 DVVC L·∫§Y H√ÄNG")tr.classList.add("row-green");
   if((r.trang_thai||"").trim()==="1 H·ª¶Y")tr.classList.add("row-red");
   ["ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","so_luong","ten_sp","tinh_trang","trang_thai"]
     .forEach(k=>{const td=document.createElement("td");td.textContent=r[k]||"";tr.appendChild(td);});
   tb.appendChild(tr);
 });
}
function resetDon(){["#fKhungDon","#fGianDon","#fMvdDon"].forEach(s=>$(s).value="T·∫•t c·∫£");renderDon();}

// ========== TR·∫†NG TH√ÅI ==========
function renderStatusTables(auto=false){
 const pT=$("#tblPrinted tbody"),pK=$("#tblPicked tbody");pT.innerHTML="";pK.innerHTML="";
 let fK=$("#fKhungStatus").value,fG=$("#fGianStatus").value,fM=$("#fMvdStatus").value;
 let from=$("#fromDateStatus").value,to=$("#toDateStatus").value;
 if(auto){const t=fmt(new Date());from=to=t;$("#fromDateStatus").value=t;$("#toDateStatus").value=t;}
 const f1=new Date(from+"T00:00:00"),f2=new Date(to+"T23:59:59");
 const filtered=DON.filter(r=>{
   const d=parseVNDate(r.ngay);
   return (!fK||fK==="T·∫•t c·∫£"||r.khung_h===fK)&&(!fG||fG==="T·∫•t c·∫£"||r.ma_gian===fG)&&(!fM||fM==="T·∫•t c·∫£"||r.mvd===fM)&&(d>=f1&&d<=f2);
 });
 const printed=filtered.filter(r=>(r.tinh_trang||"").trim()==="1 ƒê√É IN ƒê∆†N"),picked=filtered.filter(r=>(r.tinh_trang||"").trim()==="3 DVVC L·∫§Y H√ÄNG");
 
 // Empty state for printed table
 if (printed.length === 0) {
   pT.innerHTML = `<tr><td colspan="6" class="empty-state">
     <div class="empty-state-icon">üìÑ</div>
     <p class="empty-state-text">Kh√¥ng c√≥ ƒë∆°n ƒë√£ in</p>
   </td></tr>`;
 } else {
   printed.forEach((r,i)=>{const tr=document.createElement("tr");if((r.trang_thai||"").trim()==="1 H·ª¶Y")tr.classList.add("row-red");
   ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"].forEach(k=>{const td=document.createElement("td");td.textContent=k==="STT"?i+1:(r[k]||"");tr.appendChild(td);});pT.appendChild(tr);});
 }
 
 // Empty state for picked table
 if (picked.length === 0) {
   pK.innerHTML = `<tr><td colspan="6" class="empty-state">
     <div class="empty-state-icon">üöö</div>
     <p class="empty-state-text">Kh√¥ng c√≥ ƒë∆°n DVVC l·∫•y h√†ng</p>
   </td></tr>`;
 } else {
   picked.forEach((r,i)=>{const tr=document.createElement("tr");tr.classList.add("row-green");if((r.trang_thai||"").trim()==="1 H·ª¶Y")tr.classList.add("row-red");
   ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"].forEach(k=>{const td=document.createElement("td");td.textContent=k==="STT"?i+1:(r[k]||"");tr.appendChild(td);});pK.appendChild(tr);});
 }
}
function resetStatus(){["#fKhungStatus","#fGianStatus","#fMvdStatus"].forEach(s=>$(s).value="T·∫•t c·∫£");renderStatusTables();}

// ========== T·ªíN KHO ==========
function renderTonKho() {
  const tb = document.querySelector("#tblTonKho tbody");
  tb.innerHTML = "";

  // L·∫•y gi√° tr·ªã l·ªçc (vi·∫øt th∆∞·ªùng, b·ªè kho·∫£ng tr·∫Øng)
  const idVal = ($("#filterIdSp").value || "").trim().toLowerCase();
  const tenVal = ($("#filterTenSp").value || "").trim().toLowerCase();

  // L·ªçc d·ªØ li·ªáu theo text nh·∫≠p
  const filtered = TON.filter(r => {
    const idMatch = !idVal || (r.id_sp || "").toLowerCase().includes(idVal);
    const tenMatch = !tenVal || (r.ten_sp || "").toLowerCase().includes(tenVal);
    return idMatch && tenMatch;
  });

  if (filtered.length === 0) {
    tb.innerHTML = `<tr><td colspan="5" class="empty-state">
      <div class="empty-state-icon">üì¶</div>
      <p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</p>
    </td></tr>`;
    return;
  }

  // S·∫Øp x·∫øp kho ‚Üí id_sp (A‚ÜíZ)
  filtered.sort((a, b) => {
    const khoA = (a.kho || "").toUpperCase();
    const khoB = (b.kho || "").toUpperCase();
    if (khoA > khoB) return -1;
    if (khoA < khoB) return 1;

    const idA = (a.id_sp || "").toUpperCase();
    const idB = (b.id_sp || "").toUpperCase();
    if (idA < idB) return -1;
    if (idA > idB) return 1;

    return 0;
  });

  // Render d·ªØ li·ªáu + t√¥ m√†u
  filtered.forEach(r => {
    const tr = document.createElement("tr");
    const ton = Number(r.ton_cuoi) || 0;

    // T√¥ m√†u
    if (ton <= 0) tr.classList.add("row-red");
    else if (ton <= 4) tr.classList.add("row-yellow");

    ["kho", "id_sp","ton_cuoi", "ten_sp", "thuong_hieu"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

function resetTon(){$("#filterIdSp").value=$("#filterTenSp").value="";renderTonKho();}

// ========== H√ÄNG HO√ÄN ==========
function renderHoan(){
  const tb = document.querySelector("#tblHoan tbody");
  tb.innerHTML = "";

  const s = ($("#fShop").value || "").toLowerCase();
  const m = ($("#fMVD").value || "").toLowerCase();
  const sku = ($("#fSKU").value || "").toLowerCase();

  // L·ªçc theo shop / mvd / sku
  const data = HOAN.filter(r =>
    (!s || (r.shop || "").toLowerCase().includes(s)) &&
    (!m || (r.mvd_hoan || "").toLowerCase().includes(m)) &&
    (!sku || (r.sku_hoan || "").toLowerCase().includes(sku))
  ).sort((a, b) => parseVNDate(b.ngay) - parseVNDate(a.ngay));

  if (data.length === 0) {
    tb.innerHTML = `<tr><td colspan="6" class="empty-state">
      <div class="empty-state-icon">üîÅ</div>
      <p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu h√†ng ho√†n</p>
    </td></tr>`;
    return;
  }

  // Render t·ª´ng d√≤ng
  data.forEach(r => {
    const tr = document.createElement("tr");

    ["ngay", "shop", "mvd_hoan", "sku_hoan", "slg"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });

    // üñºÔ∏è C·ªôt ·∫£nh
    const tdImg = document.createElement("td");
    const link = r.link_anh || r.anh || ""; // ∆Øu ti√™n link_anh n·∫øu c√≥
    if (link) {
      const img = document.createElement("img");
      img.src = link;
      img.style.width = "80px";
      img.style.height = "80px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "6px";
      img.style.cursor = "pointer";
      img.title = "B·∫•m ƒë·ªÉ xem ·∫£nh l·ªõn";
      img.onclick = () => window.open(link, "_blank");
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = "(Kh√¥ng c√≥ ·∫£nh)";
      tdImg.style.color = "#999";
      tdImg.style.fontStyle = "italic";
    }

    tr.appendChild(tdImg);
    tb.appendChild(tr);
  });
}

function resetHoan(){$("#fShop").value=$("#fMVD").value=$("#fSKU").value="";renderHoan();}

// ========== TH√îNG B√ÅO ==========
function renderTB(){
 const tb=$("#tblTB tbody");tb.innerHTML="";
 const sorted=[...TB].sort((a,b)=>parseVNDate(b.ngay)-parseVNDate(a.ngay));
 
 if (sorted.length === 0) {
   tb.innerHTML = `<tr><td colspan="3" class="empty-state">
     <div class="empty-state-icon">üì¢</div>
     <p class="empty-state-text">Kh√¥ng c√≥ th√¥ng b√°o</p>
   </td></tr>`;
   return;
 }
 
 sorted.forEach(r=>{const tr=document.createElement("tr");const td1=document.createElement("td");td1.textContent=r.ngay||"";tr.appendChild(td1);
 const td2=document.createElement("td");td2.textContent=r.truong||"";tr.appendChild(td2);
 const td3=document.createElement("td");td3.innerHTML=formatTB(r.tb||"");tr.appendChild(td3);tb.appendChild(tr);});
}
function formatTB(t){return"<table style='border-collapse:collapse;width:100%;font-size:12px'>"+t.split(/\n+/).filter(Boolean).map(r=>"<tr>"+r.split("|").map(c=>`<td style='border:1px solid #ddd;padding:3px'>${c}</td>`).join("")+"</tr>").join("")+"</table>";}

// ========== TAB ==========
document.querySelectorAll(".tabs button").forEach(btn=>{
 btn.onclick=()=>{document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 btn.classList.add("active");document.getElementById(btn.dataset.tab).classList.add("active");
 if(btn.dataset.tab==="tab-status")renderStatusTables(true);}
});
</script>
</body>
</html>

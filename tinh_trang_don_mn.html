<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VieAI Dashboard</title>
<!-- Import Font Inter cho hi·ªán ƒë·∫°i -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  /* Palette m√†u hi·ªán ƒë·∫°i h∆°n (Indigo theme) */
  --primary: #4f46e5;       --primary-hover: #4338ca; --primary-bg: #eef2ff;
  --success: #10b981;       --success-bg: #d1fae5;
  --warning: #f59e0b;       --warning-bg: #fef3c7;
  --danger: #ef4444;        --danger-bg: #fee2e2;
  
  /* Grayscale & Backgrounds */
  --bg-body: #f3f4f6;
  --bg-card: #ffffff;
  --text-main: #111827;
  --text-secondary: #6b7280;
  --border: #e5e7eb;

  /* Effects */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --radius: 8px;
  --radius-lg: 16px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body { 
    font-family: 'Inter', system-ui, -apple-system, sans-serif; 
    background: var(--bg-body); 
    color: var(--text-main); 
    line-height: 1.6; 
    font-size: 14px;
}

/* Header Gradient ƒë·∫πp h∆°n */
.header { 
    background: linear-gradient(135deg, var(--primary), #6366f1); 
    color: white; 
    padding: 16px 24px; 
    position: sticky; 
    top: 0; 
    z-index: 100; 
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; letter-spacing: -0.025em; }
.header h2::before { content: "üìä"; font-size: 22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }

/* Tabs Style d·∫°ng Pills n·ªïi */
.tabs { 
    display: flex; 
    gap: 8px; 
    padding: 12px 24px; 
    background: rgba(255,255,255,0.9); 
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border); 
    position: sticky; 
    top: 60px; 
    z-index: 90; 
    overflow-x: auto; 
    scrollbar-width: none; 
}
.tabs button { 
    padding: 8px 16px; 
    border: 1px solid transparent; 
    border-radius: 20px; /* Pill shape */
    background: transparent; 
    font-weight: 600; 
    cursor: pointer; 
    white-space: nowrap; 
    color: var(--text-secondary); 
    transition: var(--transition);
    font-size: 13px;
}
.tabs button:hover { background: var(--gray-100); color: var(--primary); }
.tabs button.active { 
    background: var(--primary-bg); 
    color: var(--primary); 
    border-color: rgba(79, 70, 229, 0.1);
    box-shadow: var(--shadow-sm);
}

.tab { display: none; padding: 24px; max-width: 1600px; margin: 0 auto; }
.tab.active { display: block; animation: fadeIn 0.3s ease-out; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* Card Design */
.card { 
    background: var(--bg-card); 
    border-radius: var(--radius-lg); 
    box-shadow: var(--shadow); 
    margin-bottom: 24px; 
    border: 1px solid rgba(0,0,0,0.02);
    overflow: hidden; 
}
.card-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 20px 24px; 
    border-bottom: 1px solid var(--border);
    background: #fafafa;
}
.card-title { font-size: 16px; font-weight: 700; color: var(--text-main); }

/* Controls Area */
.controls { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
    padding: 20px 24px; 
    background: var(--bg-card); 
    align-items: center;
}

/* Inputs & Selects */
.input, .btn, select.input { 
    padding: 10px 14px; 
    border: 1px solid var(--border); 
    border-radius: var(--radius); 
    font-size: 14px; 
    background: white; 
    transition: var(--transition);
    color: var(--text-main);
}
.input:focus { 
    outline: none; 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px var(--primary-bg); 
}

/* Buttons */
.btn { 
    cursor: pointer; 
    font-weight: 600; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center;
    gap: 8px; 
}
.btn-success { 
    background: linear-gradient(to bottom, #10b981, #059669); 
    color: white; 
    border: none; 
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
}
.btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }

.btn-ghost { 
    background: transparent; 
    color: var(--text-secondary); 
    border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--bg-body); border-color: var(--text-secondary); color: var(--text-main); }
.btn.active-filter { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary);
    box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
}

/* Table Styles */
.table-container { position: relative; overflow: auto; max-height: calc(100vh - 300px); border-top: 1px solid var(--border); }
table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
th { 
    background: #f8fafc; 
    position: sticky; 
    top: 0; 
    z-index: 10; 
    font-weight: 600; 
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.05em;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
}
td { 
    padding: 14px 16px; 
    border-bottom: 1px solid var(--border); 
    color: var(--text-main);
    white-space: nowrap; 
    transition: background 0.1s;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: #f8fafc; }

/* Status Highlights */
tr.row-red td { background: #fef2f2; color: #991b1b; }
tr.row-yellow td { background: #fffbeb; color: #92400e; }
tr.row-green td { background: #f0fdf4; color: #166534; }
.text-right { text-align: right; }
.font-bold { font-weight: 600; }

/* Empty State */
.empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
.empty-state-icon { font-size: 56px; margin-bottom: 16px; display: block; filter: grayscale(100%); opacity: 0.3; }

/* Filter Group */
.filter-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.filter-label { font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; margin-right: 4px; }

/* Status Grid */
.status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; }
.status-box { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
.status-box h3 { margin: 0; padding: 16px 24px; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; background: #fafafa; border-bottom: 1px solid var(--border); }

/* Loading */
.loading {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary);
  border-radius: 50%; animation: spin 0.8s linear infinite; z-index: 10;
}
@keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

/* Responsive */
@media (max-width: 768px) {
  .header { padding: 12px 16px; }
  .tabs { top: 56px; padding: 8px 16px; }
  .tab { padding: 16px 0; }
  .card { border-radius: 0; box-shadow: none; border: none; border-bottom: 1px solid var(--border); }
  .controls, .card-header { flex-direction: column; align-items: stretch; gap: 12px; }
  .input, .btn { width: 100%; }
  .status-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="header">
    <h2>VieAI Dashboard</h2>
</div>

<div class="tabs">
  <button data-tab="tab-don" class="active">üìÑ ƒê∆°n chi ti·∫øt</button>
  <button data-tab="tab-status">üìä Tr·∫°ng th√°i</button>
  <button data-tab="tab-ton">üì¶ T·ªìn kho</button>
  <button data-tab="tab-hoan">‚Ü©Ô∏è H√†ng ho√†n</button>
  <button data-tab="tab-tb">üîî Th√¥ng b√°o</button>
</div>

<!-- TAB ƒê∆†N CHI TI·∫æT -->
<div id="tab-don" class="tab active">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Danh s√°ch ƒê∆°n h√†ng</h3>
    </div>
    <div class="controls">
      <div class="filter-group">
        <span class="filter-label">Th·ªùi gian:</span>
        <button class="btn btn-ghost" onclick="setDatePreset('don','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('don','week')">Tu·∫ßn n√†y</button>
      </div>
      <div style="flex: 1"></div>
      <button class="btn btn-ghost" onclick="resetFilters('don')">‚Ü∫ L√†m m·ªõi</button>
    </div>
    <div class="controls" style="border-top: 1px dashed var(--border); background: #fdfdfd;">
      <input type="date" id="fromDateDon" class="input" style="width: 140px;">
      <span style="color: var(--text-secondary);">-</span>
      <input type="date" id="toDateDon" class="input" style="width: 140px;">
      <select id="fKhungDon" class="input" style="width: 120px;"></select>
      <input id="fGianDon" class="input" list="listGianDon" placeholder="M√£ gian..." debounce="300" style="width: 120px;">
      <datalist id="listGianDon"></datalist>
      <input id="fMvdDon" class="input" placeholder="T√¨m MVD..." debounce="300" style="flex-grow: 1;">
      
      <div class="filter-group">
        <span class="filter-label">L·ªçc nhanh:</span>
        <button class="btn btn-ghost" data-filter="tinh_trang" data-value="1">ƒê√£ in</button>
        <button class="btn btn-ghost" data-filter="tinh_trang" data-value="3">ƒê√£ l·∫•y</button>
        <button class="btn btn-ghost" data-filter="trang_thai" data-value="1" style="color: var(--danger);">H·ªßy</button>
        <button class="btn btn-ghost" onclick="clearStatusFilters('don')">X</button>
      </div>
    </div>
    <div class="table-container" id="donContainer">
      <div class="loading"></div>
      <table id="tblDon">
        <thead>
          <tr>
            <th>Ng√†y</th><th>S√¢n</th><th>Khung</th><th>M√£ gian</th><th>MVD</th><th>MDH</th>
            <th>ID SP</th><th>SL</th><th>T√™n SP</th><th>T√¨nh tr·∫°ng</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody class="virtual-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TAB THEO TR·∫†NG TH√ÅI -->
<div id="tab-status" class="tab">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Theo d√µi Tr·∫°ng th√°i</h3>
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="setDatePreset('status','today')">H√¥m nay</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','yesterday')">H√¥m qua</button>
        <button class="btn btn-ghost" onclick="setDatePreset('status','week')">Tu·∫ßn n√†y</button>
      </div>
    </div>
    <div class="controls">
      <input type="date" id="fromDateStatus" class="input">
      <input type="date" id="toDateStatus" class="input">
      <select id="fKhungStatus" class="input"></select>
      <input id="fGianStatus" class="input" list="listGianStatus" placeholder="M√£ gian..." debounce="300">
      <datalist id="listGianStatus"></datalist>
      <input id="fMvdStatus" class="input" placeholder="MVD..." debounce="300">
      <div class="filter-group">
        <button class="btn btn-ghost" onclick="resetFilters('status')">L√†m m·ªõi</button>
      </div>
    </div>

    <div class="status-grid">
      <div class="status-box">
        <h3 style="color: var(--primary);">üìã ƒê∆†N ƒê√É IN ƒê∆†N</h3>
        <div class="table-container">
          <div class="loading" id="loadingPrinted"></div>
          <table id="tblPrinted">
            <thead>
              <tr>
                <th>STT</th><th>Ng√†y</th><th>M√£ gian</th><th>MVD</th><th>ID SP</th>
                <th>T√¨nh tr·∫°ng</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th><th>Khung</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="status-box">
        <h3 style="color: var(--success);">üöö ƒê∆†N DVVC L·∫§Y H√ÄNG</h3>
        <div class="table-container">
          <div class="loading" id="loadingPicked"></div>
          <table id="tblPicked">
            <thead>
              <tr>
                <th>STT</th><th>Ng√†y</th><th>M√£ gian</th><th>MVD</th>
                <th>T√¨nh tr·∫°ng</th><th>Tr·∫°ng th√°i</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TAB T·ªíN KHO (API Google Sheet) -->
<div id="tab-ton" class="tab">
  <div class="card">
    <div class="card-header">
        <h3 class="card-title">D·ªØ li·ªáu T·ªìn kho (API)</h3>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-success" onclick="exportInventoryExcel()">üì• Xu·∫•t Excel</button>
        </div>
    </div>

    <!-- B·ªô l·ªçc -->
    <div class="controls">
      <input id="filterIdSp" class="input" placeholder="üîç T√¨m theo ID s·∫£n ph·∫©m..." onkeyup="renderTonKho()" style="flex: 1;">
      <input id="filterTenSp" class="input" placeholder="üîç T√¨m theo t√™n s·∫£n ph·∫©m..." onkeyup="renderTonKho()" style="flex: 2;">
    </div>

    <div class="table-container">
      <div class="loading" id="loadingTon"></div>
      <table id="tblTonKho">
        <thead>
            <tr>
                <th>Kho</th>
                <th>ID SP</th>
                <th class="text-right">T·ªìn cu·ªëi</th>
                <th>T√™n SP</th>
                <th>Th∆∞∆°ng hi·ªáu</th>
            </tr>
        </thead>
        <tbody id="tbodyTonKho"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TAB H√ÄNG HO√ÄN -->
<div id="tab-hoan" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">Qu·∫£n l√Ω H√†ng ho√†n</h3></div>
    <div class="controls">
      <input id="fShop" class="input" placeholder="L·ªçc shop..." debounce="300">
      <input id="fMVD" class="input" placeholder="L·ªçc MVD..." debounce="300">
      <input id="fSKU" class="input" placeholder="L·ªçc SKU..." debounce="300">
    </div>
    <div class="table-container">
      <table id="tblHoan">
        <thead><tr><th>Ng√†y</th><th>Shop</th><th>MVD ho√†n</th><th>SKU ho√†n</th><th>SLG</th><th>·∫¢nh</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TAB TH√îNG B√ÅO -->
<div id="tab-tb" class="tab">
  <div class="card">
    <div class="card-header"><h3 class="card-title">Th√¥ng b√°o H·ªá th·ªëng</h3></div>
    <div class="table-container">
      <table id="tblTB">
        <thead><tr><th>Ng√†y</th><th>Tr∆∞·ªùng</th><th>N·ªôi dung th√¥ng b√°o</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ========== D·ªÆ LI·ªÜU API ==========
const API_URL = "https://script.google.com/macros/s/AKfycbzEgZwWIGr_31qDy4ZJjehUVP_-0Tpq2SKrGGgubU28dQZMV7lnYkJVzlRvVXRlL9cR/exec";
let DATA = { DON: [], TON: [], HOAN: [], TB: [] };

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ========== HELPER L·∫§Y NG√ÄY GI·ªú VN (GMT+7) ==========
function getVNDateString(offsetDays = 0) {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const vnTime = new Date(utc + (3600000 * 7));
  vnTime.setDate(vnTime.getDate() + offsetDays);
  const y = vnTime.getFullYear();
  const m = String(vnTime.getMonth() + 1).padStart(2, '0');
  const d = String(vnTime.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

// ========== DEBOUNCE ==========
function debounce(fn, delay) {
  let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); };
}

// ========== INPUT DEBOUNCE ==========
document.addEventListener("input", e => {
  if (e.target.hasAttribute("debounce")) {
    e.target._debounce ||= debounce(() => {
      const tab = e.target.closest(".tab").id;
      if (tab === "tab-don") renderDon();
      else if (tab === "tab-status") renderStatusTables();
      else if (tab === "tab-hoan") renderHoan();
    }, +e.target.getAttribute("debounce"));
    e.target._debounce();
  }
});

// ========== LOAD DATA T·ª™ API ==========
fetch(API_URL)
  .then(r => r.json())
  .then(raw => {
    DATA.DON = raw.filter(r => r.id_up_don);
    // L·∫•y d·ªØ li·ªáu t·ªìn kho t·ª´ API
    DATA.TON = raw.filter(r => r.kho); 
    DATA.HOAN = raw.filter(r => r.mvd_hoan);
    DATA.TB = raw.filter(r => r.tb);
    initUI();
    renderAll();
  })
  .catch(e => console.log("API Load Error: " + e));

// ========== INIT UI ==========
function initUI() {
  const todayVN = getVNDateString(0);
  
  ["#fromDateDon","#toDateDon","#fromDateStatus","#toDateStatus"].forEach(id => {
    if($(id)) $(id).value = todayVN;
  });

  const khung = ["T·∫•t c·∫£", ...new Set(DATA.DON.map(r => r.khung_h).filter(Boolean))];
  const gian = [...new Set(DATA.DON.map(r => r.ma_gian).filter(Boolean))];

  ["#fKhungDon", "#fKhungStatus"].forEach(sel => {
    if($(sel)) $(sel).innerHTML = khung.map(v => `<option>${v}</option>`).join("");
  });
  ["#listGianDon", "#listGianStatus"].forEach(dl => {
    if($(dl)) $(dl).innerHTML = gian.map(v => `<option value="${v}">`).join("");
  });

  $$("button[data-filter]").forEach(btn => {
    btn.onclick = () => {
      const filter = btn.dataset.filter;
      const tab = btn.closest(".tab").id;
      $$(`#${tab} button[data-filter="${filter}"]`).forEach(b => b.classList.remove("active-filter"));
      btn.classList.toggle("active-filter");
      tab === "tab-don" ? renderDon() : renderStatusTables();
    };
  });
}

// ========== RENDER ALL ==========
function renderAll() {
  renderDon();
  renderStatusTables(true);
  renderTonKho(); 
  renderHoan();
  renderTB();
}

// ============================================================
// LOGIC T·ªíN KHO (API + SORT Z-A KHO, A-Z ID)
// ============================================================

function renderTonKho() {
    const tbody = $('#tbodyTonKho');
    const loading = $('#loadingTon');
    const filterId = ($('#filterIdSp').value || "").toLowerCase();
    const filterName = ($('#filterTenSp').value || "").toLowerCase();

    if(loading) loading.style.display = "block";

    // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ nh·∫π ƒë·ªÉ UI m∆∞·ª£t
    setTimeout(() => {
        // L·ªçc d·ªØ li·ªáu t·ª´ DATA.TON
        let filtered = DATA.TON.filter(item => 
            (!filterId || (item.id_sp || "").toLowerCase().includes(filterId)) && 
            (!filterName || (item.ten_sp || "").toLowerCase().includes(filterName))
        );

        // S·∫ÆP X·∫æP: Kho (Z -> A) sau ƒë√≥ t·ªõi ID SP (A -> Z)
        filtered.sort((a, b) => {
            const khoA = (a.kho || "").toLowerCase();
            const khoB = (b.kho || "").toLowerCase();
            if (khoA < khoB) return 1; // Z l√™n ƒë·∫ßu
            if (khoA > khoB) return -1;
            
            const idA = (a.id_sp || "").toLowerCase();
            const idB = (b.id_sp || "").toLowerCase();
            if (idA < idB) return -1; // A l√™n ƒë·∫ßu
            if (idA > idB) return 1;
            
            return 0;
        });

        if(loading) loading.style.display = "none";

        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üì¶</div><p>Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho</p></td></tr>`;
            return;
        }

        let html = '';
        filtered.forEach(item => {
            const tonCuoi = parseInt(item.ton_cuoi) || 0;
            let rowClass = "";
            if (tonCuoi <= 0) rowClass = "row-red";
            else if (tonCuoi <= 5) rowClass = "row-yellow";

            html += `
                <tr class="${rowClass}">
                    <td>${item.kho || ""}</td>
                    <td class="font-bold">${item.id_sp || ""}</td>
                    <td class="text-right font-bold" style="color:${tonCuoi <= 0 ? '#dc2626' : 'inherit'}">
                        ${tonCuoi.toLocaleString('vi-VN')}
                    </td>
                    <td>${item.ten_sp || ""}</td>
                    <td>${item.thuong_hieu || ""}</td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }, 50);
}

function exportInventoryExcel() {
    const table = document.getElementById("tblTonKho");
    const html = table.outerHTML.replace(/ /g, '%20');
    const a = document.createElement("a");
    a.href = 'data:application/vnd.ms-excel,' + html;
    a.download = 'Ton_Kho_VieAI.xls';
    a.click();
}

// ============================================================
// C√ÅC H√ÄM KH√ÅC
// ============================================================

class VirtualTable {
  constructor(tbody, rowHeight = 48) {
    this.tbody = tbody; this.rowHeight = rowHeight; this.data = [];
    this.container = tbody.parentElement.parentElement;
    this.init();
  }
  init() { this.container.addEventListener("scroll", debounce(() => this.render(), 10)); }
  setData(data) { this.data = data; this.tbody.style.height = `${data.length * this.rowHeight}px`; this.render(); }
  render() {
    const start = Math.max(0, Math.floor(this.container.scrollTop / this.rowHeight) - 5);
    const end = Math.min(start + Math.ceil(this.container.clientHeight / this.rowHeight) + 5, this.data.length);
    this.tbody.innerHTML = "";
    const frag = new DocumentFragment();
    for (let i = start; i < end; i++) {
      const r = this.data[i];
      const tr = document.createElement("tr");
      tr.className = (r.trang_thai||"").includes("H·ª¶Y") ? "row-red" : (r.tinh_trang||"").includes("DVVC L·∫§Y H√ÄNG") ? "row-green" : "";
      tr.style.top = `${i * this.rowHeight}px`;
      tr.style.position = "absolute"; tr.style.width = "100%";
      ["ngay","san","khung_h","ma_gian","mvd","mdh","id_sp","so_luong","ten_sp","tinh_trang","trang_thai","ghi_chu"]
        .forEach(k => { const td = document.createElement("td"); td.textContent = r[k] || ""; tr.appendChild(td); });
      frag.appendChild(tr);
    }
    this.tbody.appendChild(frag);
  }
}
let virtualDon = null;

function renderDon() {
  const loading = $("#donContainer .loading");
  if(loading) loading.style.display = "block";
  setTimeout(() => {
    const f = getFilters("don");
    const filtered = DATA.DON.filter(r => applyFilters(r, f))
      .sort((a,b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));
    if (!virtualDon && $(".virtual-tbody")) virtualDon = new VirtualTable($(".virtual-tbody"));
    if(virtualDon) virtualDon.setData(filtered);
    if(loading) loading.style.display = filtered.length ? "none" : "block";
    if (!filtered.length && $(".virtual-tbody")) $(".virtual-tbody").innerHTML = `<tr><td colspan="12" class="empty-state"><div class="empty-state-icon">üì≠</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu</p></td></tr>`;
  }, 10);
}

function renderStatusTables(auto = false) {
  const lp = $("#loadingPrinted"), lk = $("#loadingPicked");
  if(lp) lp.style.display = "block"; 
  if(lk) lk.style.display = "block";
  
  setTimeout(() => {
    const f = getFilters("status");
    if (auto && $("#fromDateStatus")) { 
      const t = getVNDateString(0);
      $("#fromDateStatus").value = $("#toDateStatus").value = t; 
    }

    const all = DATA.DON.filter(r => applyFilters(r, f))
      .sort((a, b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));

    const printed = all.filter(r => (r.tinh_trang || "").trim() === "1 ƒê√É IN ƒê∆†N");
    const picked = all.filter(r => (r.tinh_trang || "").trim() === "3 DVVC L·∫§Y H√ÄNG");

    renderSimpleTable("#tblPrinted", printed, ["STT","ngay","ma_gian","mvd","id_sp","tinh_trang","trang_thai","ghi_chu","khung_h"]);
    renderSimpleTable("#tblPicked", picked, ["STT","ngay","ma_gian","mvd","tinh_trang","trang_thai"], false, "row-green");
    $$("#tblPicked tr").forEach(tr => { if (tr.textContent.includes("H·ª¶Y")) tr.classList.add("row-red"); });
    
    if(lp) lp.style.display = printed.length ? "none" : "block";
    if(lk) lk.style.display = picked.length ? "none" : "block";
  }, 50);
}

function renderHoan() {
  const s = ($("#fShop").value||"").toLowerCase();
  const m = ($("#fMVD").value||"").toLowerCase();
  const sku = ($("#fSKU").value||"").toLowerCase();

  const filtered = DATA.HOAN
    .filter(r => 
      (!s || (r.shop||"").toLowerCase().includes(s)) &&
      (!m || (r.mvd_hoan||"").toLowerCase().includes(m)) &&
      (!sku || (r.sku_hoan||"").toLowerCase().includes(sku))
    )
    .sort((a, b) => new Date(b.ngay.split("/").reverse().join("-")) - new Date(a.ngay.split("/").reverse().join("-")));

  const tbody = $("#tblHoan tbody");
  if(!tbody) return;
  
  tbody.innerHTML = filtered.length ? "" : `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚Ü©Ô∏è</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu</p></td></tr>`;
  
  filtered.forEach(r => {
    const tr = document.createElement("tr");
    ["ngay","shop","mvd_hoan","sku_hoan","slg"].forEach(k => {
      const td = document.createElement("td");
      td.textContent = r[k] || "";
      tr.appendChild(td);
    });
    const tdImg = document.createElement("td");
    const link = r.link_anh || r.anh || "";
    if (link) {
      const img = document.createElement("img");
      img.src = link;
      img.style = "width:50px;height:50px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--border);";
      img.onclick = () => window.open(link, "_blank");
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = "-";
      tdImg.style.color = "#999";
      tdImg.style.textAlign = "center";
    }
    tr.appendChild(tdImg);
    tbody.appendChild(tr);
  });
}

function renderTB() {
  const sorted = [...DATA.TB].sort((a,b) => new Date(b.ngay.split("/").reverse()) - new Date(a.ngay.split("/").reverse()));
  renderSimpleTable("#tblTB", sorted, ["ngay","truong","tb"]);
  $$("#tblTB td:last-child").forEach(td => {
    td.innerHTML = (td.textContent||"").replace(/\n/g, "<br>").replace(/\|/g, "</td><td>").replace(/^(.*)$/gm, "<tr><td style='border:1px solid var(--border);padding:4px 8px'>$1</td></tr>");
    td.innerHTML = `<table style="width:100%;font-size:13px;border-collapse:collapse">${td.innerHTML}</table>`;
  });
}

function renderSimpleTable(id, data, keys, hasSTT = false, defClass = "") {
  const tbody = $(id + " tbody");
  if(!tbody) return;
  tbody.innerHTML = data.length ? "" : `<tr><td colspan="${keys.length}" class="empty-state"><div class="empty-state-icon">üì≠</div><p class="empty-state-text">Kh√¥ng c√≥ d·ªØ li·ªáu</p></td></tr>`;
  const frag = new DocumentFragment();
  data.forEach((r, i) => {
    const tr = document.createElement("tr");
    if ((r.trang_thai||"").includes("H·ª¶Y")) tr.className = "row-red"; else if (defClass) tr.classList.add(defClass);
    keys.forEach(k => {
      const td = document.createElement("td"); td.textContent = k === "STT" ? i+1 : (r[k] || ""); tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

function getFilters(tab) {
  const prefix = tab === "don" ? "Don" : "Status";
  const fromEl = $(`#fromDate${prefix}`);
  const toEl = $(`#toDate${prefix}`);
  return {
    from: fromEl && fromEl.value ? new Date(fromEl.value) : null,
    to: toEl && toEl.value ? new Date(toEl.value) : null,
    khung: $(`#fKhung${prefix}`) ? $(`#fKhung${prefix}`).value : "T·∫•t c·∫£",
    gian: $(`#fGian${prefix}`) ? $(`#fGian${prefix}`).value : "",
    mvd: $(`#fMvd${prefix}`) ? $(`#fMvd${prefix}`).value : "",
    tinh_trang: [...$$(`#tab-${tab} button.active-filter`)].find(b => b.dataset.filter === "tinh_trang")?.dataset.value,
    trang_thai: [...$$(`#tab-${tab} button.active-filter`)].find(b => b.dataset.filter === "trang_thai")?.dataset.value
  };
}

function applyFilters(r, f) {
  const d = new Date(r.ngay.split("/").reverse().join("-"));
  if (f.from && d < f.from) return false;
  if (f.to && d > f.to) return false;
  if (f.khung && f.khung !== "T·∫•t c·∫£" && r.khung_h !== f.khung) return false;
  if (f.gian && r.ma_gian !== f.gian) return false;
  if (f.mvd && r.mvd !== f.mvd) return false;
  if (f.tinh_trang) {
    const target = f.tinh_trang === "1" ? "1 ƒê√É IN ƒê∆†N" : "3 DVVC L·∫§Y H√ÄNG";
    if ((r.tinh_trang || "").trim() !== target) return false;
  }
  if (f.trang_thai && !(r.trang_thai || "").includes("H·ª¶Y")) return false;
  return true;
}

function setDatePreset(tab, type) {
  let fromStr, toStr;
  if (type === "today") {
    fromStr = toStr = getVNDateString(0);
  } else if (type === "yesterday") {
    fromStr = toStr = getVNDateString(-1);
  } else if (type === "week") {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const vnTime = new Date(utc + (3600000 * 7));
    const day = vnTime.getDay() || 7;
    fromStr = getVNDateString(1 - day); 
    toStr = getVNDateString(7 - day);   
  }
  const prefix = tab === "don" ? "Don" : "Status";
  if($(`#fromDate${prefix}`)) $(`#fromDate${prefix}`).value = fromStr;
  if($(`#toDate${prefix}`)) $(`#toDate${prefix}`).value = toStr;
  tab === "don" ? renderDon() : renderStatusTables();
}

function resetFilters(tab) {
  const prefix = tab === "don" ? "Don" : "Status";
  if($(`#fKhung${prefix}`)) $(`#fKhung${prefix}`).value = "T·∫•t c·∫£";
  if($(`#fGian${prefix}`)) $(`#fGian${prefix}`).value = "";
  if($(`#fMvd${prefix}`)) $(`#fMvd${prefix}`).value = "";
  clearStatusFilters(tab);
}

function clearStatusFilters(tab) {
  $$(`#tab-${tab} button[data-filter]`).forEach(b => b.classList.remove("active-filter"));
  tab === "don" ? renderDon() : renderStatusTables();
}

$$(".tabs button").forEach(btn => {
  btn.onclick = () => {
    $$(".tabs button, .tab").forEach(el => el.classList.remove("active"));
    btn.classList.add("active");
    $(`#${btn.dataset.tab}`).classList.add("active");
    if (btn.dataset.tab === "tab-status") renderStatusTables(true);
    if (btn.dataset.tab === "tab-don") renderDon();
    if (btn.dataset.tab === "tab-ton") renderTonKho(); 
    if (btn.dataset.tab === "tab-hoan") renderHoan();
    if (btn.dataset.tab === "tab-tb") renderTB();
  };
});

initUI();
</script>
</body>
</html>

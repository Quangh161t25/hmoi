<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> KHO MI·ªÄN NAM</title>
  <!-- Import Font Inter cho hi·ªán ƒë·∫°i -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Brand Colors - Modern Indigo/Slate Palette */
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #eef2ff;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;

      /* Neutral Palette */
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --bg-header: rgba(255, 255, 255, 0.8);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;

      /* Effects */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius-md: 10px;
      --radius-lg: 16px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
      font-size: 14px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Header & Glassmorphism */
    .header {
      background: var(--bg-header);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary-dark), #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .global-search-container {
      position: relative;
      width: 320px;
    }

    .global-search-container input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      border-radius: 24px;
      border: 1px solid var(--border);
      background: #f1f5f9;
      font-size: 14px;
      transition: var(--transition);
    }

    .global-search-container input:focus {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-light);
      outline: none;
    }

    .global-search-container::before {
      content: "üîç";
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    /* Tabs UI */
    .nav-container {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 65px;
      z-index: 900;
      display: flex;
      padding: 0 24px;
      overflow-x: auto;
    }

    .tab-btn {
      padding: 16px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--primary);
      background: var(--primary-light);
    }

    .tab-btn.active {
      color: var(--primary-dark);
      border-bottom-color: var(--primary-dark);
    }

    /* Layout Main Content */
    .main-content {
      padding: 24px;
      max-width: 100%;
      margin: 0 auto;
    }

    .tab-pane {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-pane.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dashboard Cards */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Filters & Controls */
    .toolbar {
      padding: 16px 24px;
      background: #fbfcfd;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input {
      padding: 8px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font-size: 13.5px;
      background: #fff;
      transition: var(--transition);
    }

    .form-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }

    .btn {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-main);
    }

    .btn:hover {
      background: #f1f5f9;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* Table Design */
    .table-container {
      overflow: auto;
      max-height: 700px;
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      background: #f8fafc;
      padding: 12px 16px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      text-align: left;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      transition: var(--transition);
    }

    tr:hover td {
      background: #f1f5f9;
    }

    /* Status Badges */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .badge-success {
      background: #dcfce7;
      color: #166534;
    }

    .badge-warning {
      background: #fef9c3;
      color: #854d0e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-info {
      background: #e0f2fe;
      color: #075985;
    }

    /* Row Highlighting */
    tr.status-cancel td {
      background: #fff1f2;
      color: #991b1b;
    }

    tr.status-shipping td {
      background: #f0fdf4;
    }

    /* Dashboard Summary Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-main);
    }

    .stat-trend {
      font-size: 12px;
      margin-top: 8px;
      font-weight: 600;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .global-search-container {
        width: 100%;
      }
    }

    /* Sync UI */
    .sync-status {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 13px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.05);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .sync-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--primary);
    }

    input:checked+.slider:before {
      transform: translateX(14px);
    }

    @keyframes pulse-sync {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .syncing {
      animation: pulse-sync 1s infinite;
    }

    /* Loading Progress Bar */
    .progress-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      z-index: 9999;
      display: none;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4f46e5, #8b5cf6, #ec4899);
      box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="progress-container" id="pageLoader">
    <div class="progress-bar" id="pageLoaderBar"></div>
  </div>
  <!-- New Glassmorphism Header -->
  <header class="header">
    <div style="display:flex; align-items:center; gap:15px;">
      <h1><span>üì¶</span> KHO MI·ªÄN NAM</h1>
      <div class="sync-status">
        <label class="sync-toggle">
          <span style="font-weight:500;">T·ª± ƒë·ªông b·ªô</span>
          <div class="switch">
            <input type="checkbox" id="autoSyncCheck" onchange="toggleAutoSync()">
            <span class="slider"></span>
          </div>
        </label>
        <span id="lastUpdated">C·∫≠p nh·∫≠t: --:--:--</span>
        <button class="btn btn-sm" onclick="loadData()" title="L√†m m·ªõi ngay">üîÑ</button>
      </div>
    </div>
    <div class="global-search-container">
      <input type="text" id="globalSearch" placeholder="T√¨m MVD, MDH, M√£ gian...">
    </div>
  </header>

  <!-- Improved Navigation Tabs -->
  <nav class="nav-container" id="mainTabs">
    <button class="tab-btn active" data-tab="tab-don"><span>üìÑ</span> ƒê∆°n chi ti·∫øt</button>
    <button class="tab-btn" data-tab="tab-status"><span>üìä</span> Tr·∫°ng th√°i</button>
    <button class="tab-btn" data-tab="tab-ton"><span>üì¶</span> T·ªìn kho</button>
    <button class="tab-btn" data-tab="tab-hoan"><span>‚Ü©Ô∏è</span> H√†ng ho√†n</button>
    <button class="tab-btn" data-tab="tab-chuain"><span>üìë</span> 1 ƒê√É IN ƒê∆†N</button>
    <button class="tab-btn" data-tab="tab-huy"><span>‚ùå</span> ƒê∆°n h·ªßy</button>
    <button class="tab-btn" data-tab="tab-tb"><span>üîî</span> Th√¥ng b√°o</button>
  </nav>

  <main class="main-content">
    <!-- Stats Briefing -->

    <!-- TAB: ƒê∆†N CHI TI·∫æT -->
    <div id="tab-don" class="tab-pane active">
      <div class="card">
        <div class="toolbar">
          <div class="input-group">
            <label class="label">T·ª´ ng√†y</label>
            <input type="date" id="fromDateDon" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">ƒê·∫øn ng√†y</label>
            <input type="date" id="toDateDon" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">Khung gi·ªù</label>
            <select id="fKhungDon" class="form-input" style="min-width:120px;"></select>
          </div>
          <div class="input-group" style="flex:1;">
            <label class="label">M√£ gian h√†ng</label>
            <input id="fGianDon" class="form-input" list="listGianDon" placeholder="L·ªçc theo m√£ gian...">
            <datalist id="listGianDon"></datalist>
          </div>
          <div class="input-group" style="flex:2;">
            <label class="label">T√¨m nhanh MVD/MDH</label>
            <input id="fMvdDon" class="form-input" placeholder="Nh·∫≠p m√£ v·∫≠n ƒë∆°n ho·∫∑c m√£ ƒë∆°n h√†ng...">
          </div>
          <div style="display:flex; gap:8px; align-self: flex-end; padding-bottom: 2px;">
            <button class="btn" onclick="setDatePreset('today')">H√¥m nay</button>
            <button class="btn" onclick="setDatePreset('yesterday')">H√¥m qua</button>
            <button class="btn" onclick="setDatePreset('week')">Tu·∫ßn n√†y</button>
            <button class="btn btn-primary" onclick="renderDon()">üîç L·ªçc d·ªØ li·ªáu</button>
            <button class="btn" onclick="resetFilters('don')">‚Ü∫ ƒê·∫∑t l·∫°i</button>
          </div>
        </div>

        <div class="table-container">
          <table id="tblDonChiTiet">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>S√¢n</th>
                <th>Khung</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>MDH</th>
                <th>ID SP</th>
                <th>SL</th>
                <th>T√™n SP</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody id="tbodyDon"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: T·ªíN KHO -->
    <div id="tab-ton" class="tab-pane">
      <div class="stats-grid" style="grid-template-columns: 320px 1fr;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üè∑Ô∏è Th∆∞∆°ng hi·ªáu</h3>
          </div>
          <div class="table-container" style="max-height: 500px;">
            <table id="tblThuongHieu">
              <thead>
                <tr>
                  <th>T√™n</th>
                  <th>SP</th>
                  <th style="text-align:right">T·ªìn</th>
                </tr>
              </thead>
              <tbody id="tbodyThuongHieu"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <input id="filterIdSp" class="form-input" placeholder="T√¨m ID s·∫£n ph·∫©m..." style="flex:1">
            <input id="filterTenSp" class="form-input" placeholder="T√¨m t√™n s·∫£n ph·∫©m..." style="flex:2">
            <button class="btn btn-primary" onclick="exportInventoryExcel()">üì• Xu·∫•t Excel</button>
          </div>
          <div class="table-container">
            <table id="tblTonKho">
              <thead>
                <tr>
                  <th>Kho</th>
                  <th>ID SP</th>
                  <th style="text-align:right">T·ªìn cu·ªëi</th>
                  <th>T√™n s·∫£n ph·∫©m</th>
                  <th>Th∆∞∆°ng hi·ªáu</th>
                </tr>
              </thead>
              <tbody id="tbodyTonKho"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- C√°c tab kh√°c b·ªï sung t∆∞∆°ng t·ª± v·ªõi c√πng style... -->
    <div id="tab-status" class="tab-pane">
      <div class="card">
        <div class="toolbar">
          <div class="input-group">
            <label class="label">T·ª´ ng√†y</label>
            <input type="date" id="fromDateStatus" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">ƒê·∫øn ng√†y</label>
            <input type="date" id="toDateStatus" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">Khung gi·ªù</label>
            <select id="fKhungStatus" class="form-input" style="min-width:120px;"></select>
          </div>
          <div class="input-group" style="flex:1;">
            <label class="label">M√£ gian h√†ng</label>
            <input id="fGianStatus" class="form-input" list="listGianStatus" placeholder="L·ªçc theo m√£ gian...">
            <datalist id="listGianStatus"></datalist>
          </div>
          <div class="input-group" style="flex:2;">
            <label class="label">T√¨m MVD/MDH</label>
            <input id="fMvdStatus" class="form-input" placeholder="Nh·∫≠p m√£ v·∫≠n ƒë∆°n...">
          </div>
          <div style="display:flex; gap:8px; align-self: flex-end; padding-bottom: 2px;">
            <button class="btn btn-primary" onclick="renderStatusTables()">üîç L·ªçc</button>
          </div>
        </div>
      </div>
      <div class="stats-grid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìã ƒêang in ƒë∆°n</h3>
          </div>
          <div class="table-container">
            <table id="tblPrinted">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Ng√†y</th>
                  <th>M√£ gian</th>
                  <th>MVD</th>
                  <th>ID SP</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üöö ƒê√£ l·∫•y h√†ng</h3>
          </div>
          <div class="table-container">
            <table id="tblPicked">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Ng√†y</th>
                  <th>M√£ gian</th>
                  <th>MVD</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: H√ÄNG HO√ÄN -->
    <div id="tab-hoan" class="tab-pane">
      <div class="card">
        <div class="toolbar">
          <input id="fShopHoan" class="form-input" placeholder="L·ªçc shop..." style="flex:1">
          <input id="fMvdHoan" class="form-input" placeholder="L·ªçc MVD..." style="flex:1">
          <input id="fSkuHoan" class="form-input" placeholder="L·ªçc SKU..." style="flex:1">
        </div>
        <div class="table-container">
          <table id="tblHoan">
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>Shop</th>
                <th>MVD Ho√†n</th>
                <th>SKU Ho√†n</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>·∫¢nh</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card-header"
          style="justify-content: center; padding: 12px; gap: 20px; border-top: 1px solid var(--border)">
          <button class="btn" onclick="changeHoanPage(-1)">‚óÄ Trang tr∆∞·ªõc</button>
          <span id="hoanPageInfo" style="font-weight: 600; font-size: 13px;">Trang 1</span>
          <button class="btn" onclick="changeHoanPage(1)">Trang sau ‚ñ∂</button>
        </div>
      </div>
    </div>

    <!-- TAB: CH∆ØA IN -->
    <div id="tab-chuain" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìë Danh s√°ch ƒê∆°n h√†ng: 1 ƒê√É IN ƒê∆†N</h3>
        </div>
        <div class="toolbar">
          <div class="input-group">
            <label class="label">T·ª´ ng√†y</label>
            <input type="date" id="fromDateChuaIn" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">ƒê·∫øn ng√†y</label>
            <input type="date" id="toDateChuaIn" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">Khung gi·ªù</label>
            <select id="fKhungChuaIn" class="form-input" style="min-width:120px;"></select>
          </div>
          <div class="input-group" style="flex:1;">
            <label class="label">M√£ gian h√†ng</label>
            <input id="fGianChuaIn" class="form-input" list="listGianChuaIn" placeholder="L·ªçc theo m√£ gian...">
            <datalist id="listGianChuaIn"></datalist>
          </div>
          <div class="input-group" style="flex:2;">
            <label class="label">T√¨m nhanh MVD/MDH</label>
            <input id="fMvdChuaIn" class="form-input" placeholder="Nh·∫≠p m√£ v·∫≠n ƒë∆°n...">
          </div>
          <div style="display:flex; gap:8px; align-self: flex-end; padding-bottom: 2px;">
            <button class="btn btn-primary" onclick="renderChuaIn()">üîç L·ªçc</button>
          </div>
        </div>
        <div class="table-container">
          <table id="tblChuaIn">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>S√¢n</th>
                <th>Khung</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>ID SP</th>
                <th>SL</th>
                <th>T√™n SP</th>
                <th>Ghi ch√∫</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: ƒê∆†N H·ª¶Y -->
    <div id="tab-huy" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">‚ùå ƒê∆°n h·ªßy trong ng√†y</h3>
        </div>
        <div class="toolbar">
          <div class="input-group">
            <label class="label">T·ª´ ng√†y</label>
            <input type="date" id="fromDateHuy" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">ƒê·∫øn ng√†y</label>
            <input type="date" id="toDateHuy" class="form-input">
          </div>
          <div class="input-group">
            <label class="label">Khung gi·ªù</label>
            <select id="fKhungHuy" class="form-input" style="min-width:120px;"></select>
          </div>
          <div class="input-group" style="flex:1;">
            <label class="label">M√£ gian h√†ng</label>
            <input id="fGianHuy" class="form-input" list="listGianHuy" placeholder="L·ªçc theo m√£ gian...">
            <datalist id="listGianHuy"></datalist>
          </div>
          <div class="input-group" style="flex:2;">
            <label class="label">T√¨m nhanh MVD/MDH</label>
            <input id="fMvdHuy" class="form-input" placeholder="Nh·∫≠p m√£ v·∫≠n ƒë∆°n...">
          </div>
          <div style="display:flex; gap:8px; align-self: flex-end; padding-bottom: 2px;">
            <button class="btn btn-primary" onclick="renderDonHuyHomNay()">üîç L·ªçc</button>
          </div>
        </div>
        <div class="table-container">
          <table id="tblHuy">
            <thead>
              <tr>
                <th>STT</th>
                <th>Ng√†y</th>
                <th>S√¢n</th>
                <th>Khung</th>
                <th>M√£ gian</th>
                <th>MVD</th>
                <th>ID SP</th>
                <th>SL</th>
                <th>T√™n SP</th>
                <th>L√Ω do h·ªßy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: TH√îNG B√ÅO -->
    <div id="tab-tb" class="tab-pane">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üîî Th√¥ng b√°o h·ªá th·ªëng</h3>
        </div>
        <div class="table-container">
          <table id="tblTB">
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>Tr∆∞·ªùng</th>
                <th>N·ªôi dung</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </main>
  <script>
    // ========== CORE DATA MANAGER ==========
    const API_URL = "https://script.google.com/macros/s/AKfycbzEgZwWIGr_31qDy4ZJjehUVP_-0Tpq2SKrGGgubU28dQZMV7lnYkJVzlRvVXRlL9cR/exec";

    const State = {
      raw: [],
      don: [],
      ton: [],
      hoan: [],
      tb: [],
      filters: {
        don: { from: "", to: "", khung: "T·∫•t c·∫£", gian: "", search: "" },
        status: { from: "", to: "", khung: "T·∫•t c·∫£", gian: "", search: "" }
      },
      hoanPage: 1,
      hoanLimit: 50,
      selectedBrand: null,
      syncInterval: null,
      currentTab: 'tab-don'
    };

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // ========== DATE HELPERS ==========
    function getTodayVN() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const vnTime = new Date(utc + (3600000 * 7));
      return vnTime.toISOString().split('T')[0];
    }

    // ========== TAB SYSTEM ==========
    function initTabs() {
      $$('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          const target = btn.dataset.tab;
          $$('.tab-btn').forEach(b => b.classList.remove('active'));
          $$('.tab-pane').forEach(p => p.classList.remove('active'));
          btn.classList.add('active');
          $(`#${target}`).classList.add('active');
          State.currentTab = target;

          if (target === 'tab-ton') renderTonKho();
          if (target === 'tab-status') renderStatusTables();
          if (target === 'tab-hoan') renderHoan();
          if (target === 'tab-chuain') renderChuaIn();
          if (target === 'tab-huy') renderDonHuyHomNay();
          if (target === 'tab-tb') renderTB();
        };
      });
    }

    // ========== DATA FETCHING ==========
    async function loadData() {
      const loader = $('#pageLoader');
      const bar = $('#pageLoaderBar');
      const timeEl = $('#lastUpdated');
      const syncStatus = $('.sync-status');

      try {
        loader.style.display = 'block';
        syncStatus.classList.add('syncing');
        bar.style.width = '20%';

        const response = await fetch(API_URL);
        bar.style.width = '60%';

        const raw = await response.json();
        bar.style.width = '90%';

        State.raw = raw;
        processData();
        initFilters();

        // Render current tab
        if (State.currentTab === 'tab-don') renderDon();
        if (State.currentTab === 'tab-status') renderStatusTables();
        if (State.currentTab === 'tab-hoan') renderHoan();
        if (State.currentTab === 'tab-chuain') renderChuaIn();
        if (State.currentTab === 'tab-huy') renderDonHuyHomNay();
        if (State.currentTab === 'tab-tb') renderTB();

        bar.style.width = '100%';
        const now = new Date();
        timeEl.textContent = `C·∫≠p nh·∫≠t: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

        setTimeout(() => {
          loader.style.display = 'none';
          syncStatus.classList.remove('syncing');
          bar.style.width = '0%';
        }, 500);
      } catch (e) {
        console.error("Fetch Error:", e);
        syncStatus.classList.remove('syncing');
        loader.style.display = 'none';
      }
    }

    function toggleAutoSync() {
      const isChecked = $('#autoSyncCheck').checked;
      if (isChecked) {
        // Refresh every 30 seconds
        State.syncInterval = setInterval(() => loadData(), 30000);
        loadData(); // Sync immediately when turned on
      } else {
        clearInterval(State.syncInterval);
        State.syncInterval = null;
      }
    }

    function processData() {
      State.don = State.raw.filter(r => r.id_up_don);
      State.ton = State.raw.filter(r => r.kho);
      State.hoan = State.raw.filter(r => r.mvd_hoan);
      State.tb = State.raw.filter(r => r.tb);
    }


    // ========== FILTER UI & LOGIC ==========
    function initFilters() {
      const today = getTodayVN();
      ['#fromDateDon', '#toDateDon', '#fromDateStatus', '#toDateStatus', '#fromDateChuaIn', '#toDateChuaIn', '#fromDateHuy', '#toDateHuy'].forEach(id => {
        const el = $(id);
        if (el) el.value = today;
      });

      const khung = ["T·∫•t c·∫£", ...new Set(State.don.map(r => r.khung_h).filter(Boolean))];
      $('#fKhungDon').innerHTML = khung.map(v => `<option>${v}</option>`).join("");
      $('#fKhungStatus').innerHTML = khung.map(v => `<option>${v}</option>`).join("");
      const elChuaIn = $('#fKhungChuaIn'); if (elChuaIn) elChuaIn.innerHTML = khung.map(v => `<option>${v}</option>`).join("");
      const elHuy = $('#fKhungHuy'); if (elHuy) elHuy.innerHTML = khung.map(v => `<option>${v}</option>`).join("");

      const gians = [...new Set(State.don.map(r => r.ma_gian).filter(Boolean))];
      $('#listGianDon').innerHTML = gians.map(v => `<option value="${v}">`).join("");
      $('#listGianStatus').innerHTML = gians.map(v => `<option value="${v}">`).join("");
      const elListChuaIn = $('#listGianChuaIn'); if (elListChuaIn) elListChuaIn.innerHTML = gians.map(v => `<option value="${v}">`).join("");
      const elListHuy = $('#listGianHuy'); if (elListHuy) elListHuy.innerHTML = gians.map(v => `<option value="${v}">`).join("");

      // Search Debounce
      $('#fMvdDon').oninput = debounce(() => renderDon(), 300);
      $('#fMvdStatus').oninput = debounce(() => renderStatusTables(), 300);
      $('#fMvdChuaIn').oninput = debounce(() => renderChuaIn(), 300);
      $('#fMvdHuy').oninput = debounce(() => renderDonHuyHomNay(), 300);
      $('#globalSearch').oninput = debounce(() => handleGlobalSearch(), 300);

      // Filters for Returns tab
      ['#fShopHoan', '#fMvdHoan', '#fSkuHoan'].forEach(id => {
        const el = $(id);
        if (el) el.oninput = debounce(() => renderHoan(), 300);
      });
    }

    function handleGlobalSearch() {
      const val = $('#globalSearch').value.toLowerCase();
      if (!val) return;

      const results = State.don.filter(r =>
        (r.mvd || "").toLowerCase().includes(val) ||
        (r.mdh || "").toLowerCase().includes(val)
      );

      if (results.length > 0) {
        $('.tab-btn[data-tab="tab-don"]').click();
        $('#fMvdDon').value = val;
        renderDon();
      }
    }

    // ========== RENDER LOGIC (Optimized) ==========
    function renderDon(globalSearch = null) {
      const tbody = $('#tbodyDon');
      const from = $('#fromDateDon').value;
      const to = $('#toDateDon').value;
      const khung = $('#fKhungDon').value;
      const gian = $('#fGianDon').value.toLowerCase();
      const search = globalSearch || $('#fMvdDon').value.toLowerCase();

      const filtered = State.don.filter(r => {
        // Basic date range (need to handle DD/MM/YYYY format)
        const [d, m, y] = r.ngay.split('/');
        const rDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;

        const matchDate = (!from || rDate >= from) && (!to || rDate <= to);
        const matchKhung = khung === "T·∫•t c·∫£" || r.khung_h === khung;
        const matchGian = !gian || (r.ma_gian || "").toLowerCase().includes(gian);
        const matchSearch = !search ||
          (r.mvd || "").toLowerCase().includes(search) ||
          (r.mdh || "").toLowerCase().includes(search) ||
          (r.id_sp || "").toLowerCase().includes(search);

        return matchDate && matchKhung && matchGian && matchSearch;
      }).sort((a, b) => {
        const [da, ma, ya] = a.ngay.split('/');
        const [db, mb, yb] = b.ngay.split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_up_don || 0) - (a.id_up_don || 0);
      }); // Sort by date newest

      tbody.innerHTML = "";
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding:40px; color:var(--text-muted)">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o kh·ªõp v·ªõi b·ªô l·ªçc.</td></tr>`;
        return;
      }

      // Render first 100 rows for performance, use virtual scroll concept if needed
      const fragment = document.createDocumentFragment();
      filtered.slice(0, 500).forEach((r, i) => {
        const tr = document.createElement('tr');
        if ((r.trang_thai || "").includes("H·ª¶Y")) tr.classList.add("status-cancel");
        if ((r.tinh_trang || "").includes("DVVC L·∫§Y H√ÄNG")) tr.classList.add("status-shipping");

        const badgeClass = (r.tinh_trang || "").includes("ƒê√É IN ƒê∆†N") ? "badge-info" :
          (r.tinh_trang || "").includes("DVVC L·∫§Y H√ÄNG") ? "badge-success" : "badge-warning";

        tr.innerHTML = `
      <td>${i + 1}</td>
      <td style="white-space:nowrap">${r.ngay}</td>
      <td>${r.san || ""}</td>
      <td>${r.khung_h || ""}</td>
      <td style="font-weight:600">${r.ma_gian || ""}</td>
      <td>${r.mvd || ""}</td>
      <td>${r.mdh || ""}</td>
      <td style="font-weight:700; color:var(--primary-dark)">${r.id_sp || ""}</td>
      <td style="text-align:center; font-weight:700">${r.so_luong || ""}</td>
      <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${r.ten_sp || ""}</td>
      <td><span class="badge ${badgeClass}">${r.tinh_trang || "Ch·ªù x·ª≠ l√Ω"}</span></td>
      <td style="font-style:italic; font-size:12px">${r.ghi_chu || ""}</td>
    `;
        fragment.appendChild(tr);
      });
      tbody.appendChild(fragment);
    }

    // ========== INVENTORY RENDER ==========
    function renderTonKho() {
      const tbody = $('#tbodyTonKho');
      const searchId = $('#filterIdSp').value.toLowerCase();
      const searchName = $('#filterTenSp').value.toLowerCase();

      const filtered = State.ton.filter(r =>
        (!searchId || (r.id_sp || "").toLowerCase().includes(searchId)) &&
        (!searchName || (r.ten_sp || "").toLowerCase().includes(searchName)) &&
        (!State.selectedBrand || r.thuong_hieu === State.selectedBrand)
      ).sort((a, b) => (parseInt(b.ton_cuoi) || 0) - (parseInt(a.ton_cuoi) || 0));

      tbody.innerHTML = filtered.map(r => `
    <tr class="${(parseInt(r.ton_cuoi) || 0) <= 0 ? 'status-cancel' : ''}">
      <td>${r.kho || ""}</td>
      <td style="font-weight:700">${r.id_sp || ""}</td>
      <td style="text-align:right; font-weight:800; color:${(parseInt(r.ton_cuoi) || 0) <= 5 ? 'var(--danger)' : 'inherit'}">
        ${(parseInt(r.ton_cuoi) || 0).toLocaleString('vi-VN')}
      </td>
      <td>${r.ten_sp || ""}</td>
      <td style="color:var(--primary); font-weight:600">${r.thuong_hieu || ""}</td>
    </tr>
  `).join("");

      if (State.selectedBrand) {
        // Only re-render brand summary if no brand is currently selected to avoid infinite loops or confusing UI
        // Actually, we want to keep the brand list but highlight the selected one or show a clear button.
      }

      // Update brand list with highlights
      renderBrands(State.ton);
    }

    function renderBrands(items) {
      const brands = {};
      items.forEach(r => {
        const b = r.thuong_hieu || "Kh√°c";
        if (!brands[b]) brands[b] = { count: 0, ton: 0 };
        brands[b].count++;
        brands[b].ton += (parseInt(r.ton_cuoi) || 0);
      });

      const tbody = $('#tbodyThuongHieu');
      tbody.innerHTML = Object.entries(brands)
        .sort((a, b) => b[1].ton - a[1].ton)
        .map(([name, data]) => {
          const isActive = State.selectedBrand === name;
          return `
            <tr onclick="filterByBrand('${name}')" style="cursor:pointer; ${isActive ? 'background:var(--primary-light); border-left:4px solid var(--primary)' : ''}">
              <td style="font-weight:600; color:${isActive ? 'var(--primary-dark)' : 'inherit'}">
                ${isActive ? 'üìç ' : ''}${name}
              </td>
              <td>${data.count}</td>
              <td style="text-align:right; font-weight:700">${data.ton.toLocaleString('vi-VN')}</td>
            </tr>
          `;
        }).join("");
    }

    function filterByBrand(brand) {
      if (State.selectedBrand === brand) {
        State.selectedBrand = null; // Toggle off if clicked again
      } else {
        State.selectedBrand = brand;
      }
      renderTonKho();
    }

    // ========== UTILITIES ==========
    function debounce(fn, delay) {
      let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); };
    }

    function setDatePreset(type) {
      const today = getTodayVN();
      let from = today, to = today;

      if (type === 'yesterday') {
        const d = new Date(Date.now() - 86400000);
        from = to = d.toISOString().split('T')[0];
      } else if (type === 'week') {
        const d = new Date();
        const day = d.getDay() || 7;
        const monday = new Date(d.getTime() - (day - 1) * 86400000);
        from = monday.toISOString().split('T')[0];
        to = today;
      }

      $('#fromDateDon').value = from;
      $('#toDateDon').value = to;
      renderDon();
    }

    function exportInventoryExcel() {
      const table = document.getElementById("tblTonKho");
      const html = table.outerHTML;
      const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
      const a = document.createElement("a");
      a.href = url;
      a.download = 'TonKho_Dashboard.xls';
      a.click();
    }

    function renderStatusTables() {
      const from = $('#fromDateStatus').value;
      const to = $('#toDateStatus').value;
      const khung = $('#fKhungStatus').value;
      const gian = $('#fGianStatus').value.toLowerCase();
      const mvd = $('#fMvdStatus').value.toLowerCase();

      const filtered = State.don.filter(r => {
        const [d, m, y] = r.ngay.split('/');
        const rDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return (!from || rDate >= from) && (!to || rDate <= to) &&
          (khung === "T·∫•t c·∫£" || r.khung_h === khung) &&
          (!gian || (r.ma_gian || "").toLowerCase().includes(gian)) &&
          (!mvd || (r.mvd || "").toLowerCase().includes(mvd) || (r.mdh || "").toLowerCase().includes(mvd));
      }).sort((a, b) => {
        const [da, ma, ya] = a.ngay.split('/');
        const [db, mb, yb] = b.ngay.split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_up_don || 0) - (a.id_up_don || 0);
      });

      const printed = filtered.filter(r => (r.tinh_trang || "").includes("ƒê√É IN ƒê∆†N"));
      const picked = filtered.filter(r => (r.tinh_trang || "").includes("DVVC L·∫§Y H√ÄNG"));

      $('#tblPrinted tbody').innerHTML = printed.map((r, i) => `
        <tr><td>${i + 1}</td><td>${r.ngay}</td><td>${r.ma_gian}</td><td>${r.mvd}</td><td>${r.id_sp}</td><td><span class="badge badge-info">${r.tinh_trang}</span></td></tr>
      `).join("");

      $('#tblPicked tbody').innerHTML = picked.map((r, i) => `
        <tr><td>${i + 1}</td><td>${r.ngay}</td><td>${r.ma_gian}</td><td>${r.mvd}</td><td><span class="badge badge-success">${r.tinh_trang}</span></td></tr>
      `).join("");
    }

    function renderHoan() {
      const s = ($("#fShopHoan").value || "").toLowerCase();
      const m = ($("#fMvdHoan").value || "").toLowerCase();
      const sku = ($("#fSkuHoan").value || "").toLowerCase();

      const filtered = State.hoan.filter(r =>
        (!s || (r.shop || "").toLowerCase().includes(s)) &&
        (!m || (r.mvd_hoan || "").toLowerCase().includes(m)) &&
        (!sku || (r.sku_hoan || "").toLowerCase().includes(sku))
      ).sort((a, b) => {
        const [da, ma, ya] = a.ngay.split('/');
        const [db, mb, yb] = b.ngay.split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_hoan || 0) - (a.id_hoan || 0);
      });

      const total = filtered.length;
      const pages = Math.ceil(total / State.hoanLimit) || 1;
      if (State.hoanPage > pages) State.hoanPage = pages;

      const start = (State.hoanPage - 1) * State.hoanLimit;
      const displayItems = filtered.slice(start, start + State.hoanLimit);

      $('#hoanPageInfo').textContent = `Trang ${State.hoanPage} / ${pages}`;

      $('#tblHoan tbody').innerHTML = displayItems.map(r => `
        <tr>
          <td>${r.ngay}</td><td>${r.shop}</td><td>${r.mvd_hoan}</td><td>${r.sku_hoan}</td><td>${r.slg}</td>
          <td>${r.link_anh ? `<img src="${r.link_anh}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="window.open('${r.link_anh}')">` : '-'}</td>
        </tr>
      `).join("");
    }

    function changeHoanPage(dir) {
      State.hoanPage += dir;
      if (State.hoanPage < 1) State.hoanPage = 1;
      renderHoan();
    }

    function renderChuaIn() {
      const from = $('#fromDateChuaIn').value;
      const to = $('#toDateChuaIn').value;
      const khung = $('#fKhungChuaIn').value;
      const gian = $('#fGianChuaIn').value.toLowerCase();
      const mvd = $('#fMvdChuaIn').value.toLowerCase();

      const data = State.don.filter(r => {
        const [d, m, y] = r.ngay.split('/');
        const rDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return (r.tinh_trang || "").includes("1 ƒê√É IN ƒê∆†N") &&
          (!from || rDate >= from) && (!to || rDate <= to) &&
          (khung === "T·∫•t c·∫£" || r.khung_h === khung) &&
          (!gian || (r.ma_gian || "").toLowerCase().includes(gian)) &&
          (!mvd || (r.mvd || "").toLowerCase().includes(mvd) || (r.mdh || "").toLowerCase().includes(mvd));
      }).sort((a, b) => {
        const [da, ma, ya] = a.ngay.split('/');
        const [db, mb, yb] = b.ngay.split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_up_don || 0) - (a.id_up_don || 0);
      });

      $('#tblChuaIn tbody').innerHTML = data.slice(0, 500).map((r, i) => `
        <tr>
          <td>${i + 1}</td><td>${r.ngay}</td><td>${r.san}</td><td>${r.khung_h}</td><td>${r.ma_gian}</td><td>${r.mvd}</td><td>${r.id_sp}</td><td>${r.so_luong}</td><td>${r.ten_sp}</td><td>${r.ghi_chu || ""}</td>
        </tr>
      `).join("");
    }

    function renderDonHuyHomNay() {
      const from = $('#fromDateHuy').value;
      const to = $('#toDateHuy').value;
      const khung = $('#fKhungHuy').value;
      const gian = $('#fGianHuy').value.toLowerCase();
      const mvd = $('#fMvdHuy').value.toLowerCase();

      const data = State.don.filter(r => {
        const [d, m, y] = r.ngay.split('/');
        const rDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        return (r.trang_thai || "").includes("H·ª¶Y") &&
          (!from || rDate >= from) && (!to || rDate <= to) &&
          (khung === "T·∫•t c·∫£" || r.khung_h === khung) &&
          (!gian || (r.ma_gian || "").toLowerCase().includes(gian)) &&
          (!mvd || (r.mvd || "").toLowerCase().includes(mvd) || (r.mdh || "").toLowerCase().includes(mvd));
      }).sort((a, b) => {
        const [da, ma, ya] = a.ngay.split('/');
        const [db, mb, yb] = b.ngay.split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_up_don || 0) - (a.id_up_don || 0);
      });

      $('#tblHuy tbody').innerHTML = data.map((r, i) => `
        <tr class="status-cancel">
          <td>${i + 1}</td><td>${r.ngay}</td><td>${r.san}</td><td>${r.khung_h}</td><td>${r.ma_gian}</td><td>${r.mvd}</td><td>${r.id_sp}</td><td>${r.so_luong}</td><td>${r.ten_sp}</td><td>${r.trang_thai}</td>
        </tr>
      `).join("");
    }

    function renderTB() {
      const data = [...State.tb].sort((a, b) => {
        const [da, ma, ya] = (a.ngay || "").split('/');
        const [db, mb, yb] = (b.ngay || "").split('/');
        const sA = `${ya}${ma.padStart(2, '0')}${da.padStart(2, '0')}`;
        const sB = `${yb}${mb.padStart(2, '0')}${db.padStart(2, '0')}`;
        if (sA !== sB) return sB.localeCompare(sA);
        return (b.id_tb || 0) - (a.id_tb || 0);
      });

      $('#tblTB tbody').innerHTML = data.map(r => `
        <tr><td>${r.ngay}</td><td>${r.truong || ""}</td><td>${r.tb || ""}</td></tr>
      `).join("");
    }

    function resetFilters(type) {
      if (type === 'don') {
        $('#fromDateDon').value = $('#toDateDon').value = getTodayVN();
        $('#fKhungDon').value = "T·∫•t c·∫£";
        $('#fGianDon').value = "";
        $('#fMvdDon').value = "";
        renderDon();
      }
    }

    // ========== INITIALIZE ==========
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      loadData();
    });
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Labels ‚Äì Gi·∫£i th√≠ch chi ti·∫øt (2x4)</title>
  <!-- Th∆∞ vi·ªán QRCode t·ª´ CDN ƒë·ªÉ t·∫°o m√£ QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
  <!-- Font Google Fonts ƒë·ªÉ giao di·ªán ƒë·∫πp h∆°n -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ===== PH·∫¶N CSS VARIABLES - ƒê·ªãnh nghƒ©a m√†u s·∫Øc v√† k√≠ch th∆∞·ªõc c∆° b·∫£n ===== */
    :root {
      --gap: 2mm;                 /* Kho·∫£ng c√°ch gi·ªØa c√°c nh√£n khi in */
      --primary-color: #2563eb;   /* M√†u ch√≠nh (xanh d∆∞∆°ng) */
      --primary-hover: #1d4ed8;   /* M√†u khi hover button */
      --secondary-color: #4b5563; /* M√†u ph·ª• (x√°m ƒë·∫≠m) */
      --border-color: #e5e7eb;    /* M√†u vi·ªÅn */
      --bg-color: #f9fafb;        /* M√†u n·ªÅn */
      --text-color: #111827;      /* M√†u ch·ªØ ch√≠nh */
      --success-color: #10b981;   /* M√†u th√†nh c√¥ng (xanh l√°) */
      --error-color: #ef4444;     /* M√†u l·ªói (ƒë·ªè) */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);        /* ƒê·ªï b√≥ng nh·∫π */
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* ƒê·ªï b√≥ng v·ª´a */
      --radius-sm: 4px;  /* Bo g√≥c nh·ªè */
      --radius-md: 6px;  /* Bo g√≥c v·ª´a */
      --radius-lg: 8px;  /* Bo g√≥c l·ªõn */
    }

    /* ===== PH·∫¶N CSS CHO IN ·∫§N ===== */
    @page { 
      size: A5 portrait;  /* Kh·ªï gi·∫•y A5 d·ªçc */
      margin: 3mm;        /* L·ªÅ trang khi in */
    }
    @media print {
      /* Khi in, ·∫©n c√°c element kh√¥ng c·∫ßn thi·∫øt */
      body { margin: 0; padding: 0; }
      h1 { display: none !important; }
      #controls, #modeSwitcher, #qrTextDisplay, #datePickerLabel, #datePicker, #runTestsBtn, #testOutput, #sendToSheetBtn { display: none !important; }
      
      /* Layout l∆∞·ªõi 2x4 cho 8 nh√£n tr√™n 1 trang A5 */
      .grid {
        grid-template-columns: repeat(2, 72mm); /* 2 c·ªôt, m·ªói c·ªôt ~72mm */
        grid-template-rows: repeat(4, 48mm);    /* 4 h√†ng, m·ªói h√†ng ~48mm */
        gap: 1.5mm;                             /* Kho·∫£ng c√°ch gi·ªØa c√°c nh√£n */
        padding: 1.5mm;                         /* Padding xung quanh l∆∞·ªõi */
        page-break-after: always;               /* Xu·ªëng trang m·ªõi sau m·ªói l∆∞·ªõi */
        justify-content: center;                /* CƒÉn gi·ªØa l∆∞·ªõi */
      }
      
      /* K√≠ch th∆∞·ªõc v√† style c·ªßa t·ª´ng nh√£n khi in */
      .label {
        width: 72mm; height: 48mm;              /* K√≠ch th∆∞·ªõc nh√£n ƒë√£ ƒëi·ªÅu ch·ªânh */
        padding: 3mm;                           /* Padding trong nh√£n */
        border: 1px solid #d1d5db;              /* Vi·ªÅn nh√£n */
        border-radius: var(--radius-sm);        /* Bo g√≥c */
        box-shadow: var(--shadow-sm);           /* ƒê·ªï b√≥ng */
        background: white;                      /* N·ªÅn tr·∫Øng */
        display: flex; flex-direction: column;  /* Flexbox d·ªçc */
        justify-content: space-between;         /* Ph√¢n b·ªë ƒë·ªÅu c√°c element */
        font-size: 10px;                        /* C·ª° ch·ªØ khi in */
      }
      
      /* QR code khi in */
      .qrcode {
        width: 28mm; height: 28mm;              /* K√≠ch th∆∞·ªõc QR code tƒÉng ch√∫t ƒë·ªÉ d·ªÖ scan */
        border: 1px solid var(--border-color);  /* Vi·ªÅn QR */
        border-radius: var(--radius-sm);        /* Bo g√≥c QR */
        margin-bottom: 2mm;                     /* Kho·∫£ng c√°ch d∆∞·ªõi QR */
      }
      
      /* C√°c class CSS kh√°c cho c√°c ph·∫ßn t·ª≠ trong nh√£n khi in */
      .sku { font-weight: 600; font-size: 13px; text-align: left; color: var(--text-color); margin-bottom: 1mm; }
      .desc { font-size: 11px; text-align: left; color: var(--secondary-color); margin-bottom: 1mm; line-height: 1.2; }
      .serial-block { display: flex; flex-direction: column; justify-content: flex-end; font-size: 15px; font-weight: 600; text-align: right; line-height: 1.3; }
      .serial-number { margin-bottom: 1mm; color: var(--primary-color); }
      .date, .warehouse { font-size: 15px; text-align: right; color: var(--secondary-color); }
      .qr-row { display: flex; flex-direction: row; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 2mm; }
      .left-block { display: flex; flex-direction: column; gap: 4px; align-items: flex-start; }
    }
    
    /* ===== PH·∫¶N CSS CHO GIAO DI·ªÜN WEB ===== */
    body {
      font-family: 'Inter', Arial, sans-serif; /* Font ch·ªØ */
      line-height: 1.5;                        /* ƒê·ªô cao d√≤ng */
      color: var(--text-color);                /* M√†u ch·ªØ */
      background-color: var(--bg-color);       /* M√†u n·ªÅn */
      padding: 16px;                           /* Padding body */
      max-width: 1200px;                       /* Gi·ªõi h·∫°n ƒë·ªô r·ªông */
      margin: 0 auto;                          /* CƒÉn gi·ªØa */
    }
    
    /* C√°c utility classes */
    .hidden { display: none !important; }                    /* ·∫®n element */
    .stack { display: grid; gap: 12px; }                    /* Layout d·ªçc v·ªõi gap */
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; } /* Layout ngang */
    .card { background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); padding: 16px; border: 1px solid var(--border-color); } /* Card component */

    /* Layout l∆∞·ªõi cho preview nh√£n tr√™n web */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);   /* 2 c·ªôt b·∫±ng nhau (preview tr√™n web) */
      grid-template-rows: repeat(4, auto);     /* 4 h√†ng t·ª± ƒë·ªông */
      gap: var(--gap);                         /* Kho·∫£ng c√°ch */
      padding: var(--gap);                     /* Padding */
      justify-items: start;                    /* CƒÉn tr√°i */
    }
    
    /* Style nh√£n tr√™n web (kh√°c v·ªõi khi in) */
    .label {
      width: 100%; border: 1px solid var(--border-color); padding: 8px; box-sizing: border-box;
      display: flex; flex-direction: column; gap: 4px; align-items: flex-start; justify-content: flex-start;
      page-break-inside: avoid; border-radius: var(--radius-sm); background: white;
    }
    
    /* QR code tr√™n web */
    .qrcode { width: 60px; height: 60px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); }
    
    /* C√°c class cho n·ªôi dung nh√£n tr√™n web */
    .sku { font-weight: 600; font-size: 16px; text-align: left; color: var(--text-color); }
    .serial-block { display: flex; flex-direction: column; justify-content: center; font-size: 15px; font-weight: 600; line-height: 1.4; text-align: right; }
    .serial-number { margin-bottom: 2px; color: var(--primary-color); }
    .date { text-align: right; color: var(--secondary-color); font-size: 15px; }
    .warehouse { text-align: right; font-size: 15px; margin-top: 2px; color: var(--secondary-color); }
    .qr-row { display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; width: 100%; }
    .left-block { display: flex; flex-direction: column; gap: 4px; align-items: flex-start; }
    .desc { font-size: 13px; text-align: left; color: var(--secondary-color); }

    /* ===== STYLE CHO C√ÅC CONTROL ELEMENTS ===== */
    /* Button styling */
    button {
      padding: 8px 16px; border-radius: var(--radius-sm); border: none; font-weight: 500; font-size: 14px;
      cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;
    }
    button:hover { transform: translateY(-1px); }   /* Hi·ªáu ·ª©ng n√¢ng l√™n khi hover */
    button:active { transform: translateY(0); }     /* Hi·ªáu ·ª©ng nh·∫•n xu·ªëng */
    
    /* C√°c lo·∫°i button kh√°c nhau */
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); box-shadow: var(--shadow-md); }
    .btn-secondary { background-color: white; color: var(--secondary-color); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: var(--bg-color); box-shadow: var(--shadow-sm); }
    .btn-danger { background-color: var(--error-color); color: white; }
    .btn-danger:hover { background-color: #dc2626; }
    .btn-success { background-color: var(--success-color); color: white; }
    .btn-success:hover { background-color: #0d9488; }

    /* Input styling */
    textarea, input {
      border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 8px 12px;
      font-family: inherit; font-size: 14px; transition: border-color 0.2s;
    }
    textarea:focus, input:focus {
      outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    textarea { width: 100%; min-height: 120px; resize: vertical; }
    input[type="date"] { height: 36px; }
    input[type="radio"] { margin-right: 6px; }

    /* Table styling */
    table#inputTable { border-collapse: collapse; width: 100%; margin: 8px 0; border-radius: var(--radius-sm); overflow: hidden; }
    table#inputTable th, table#inputTable td { border: 1px solid var(--border-color); padding: 8px 10px; text-align: left; }
    table#inputTable th { background-color: var(--bg-color); font-weight: 500; font-size: 14px; }
    table#inputTable input { width: 100%; box-sizing: border-box; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); }
    .table-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Mode switcher */
    #modeSwitcher { margin: 8px 0; display: flex; gap: 16px; align-items: center; }
    #modeSwitcher label { display: flex; align-items: center; cursor: pointer; }

    /* Test output v√† QR display */
    #testOutput { border: 1px dashed var(--border-color); padding: 12px; font-size: 13px; white-space: pre-wrap; max-height: 180px; overflow: auto; border-radius: var(--radius-sm); background-color: white; }
    #qrTextDisplay { width: 100%; margin: 8px 0 0 0; font-size: 13px; padding: 12px; border: 1px solid var(--border-color); min-height: 120px; white-space: pre-wrap; overflow-y: auto; border-radius: var(--radius-sm); background-color: white; font-family: 'Courier New', monospace; }

    /* C√°c element kh√°c */
    .hint { font-size: 13px; color: var(--secondary-color); margin-top: -8px; }
    .section-title { font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--text-color); }
    
    /* Status messages */
    .status-message { padding: 8px 12px; border-radius: var(--radius-sm); margin: 8px 0; font-size: 14px; display: none; }
    .status-success { background-color: #ecfdf5; color: var(--success-color); border: 1px solid #a7f3d0; display: block; }
    .status-error { background-color: #fef2f2; color: var(--error-color); border: 1px solid #fecaca; display: block; }
    
    .icon { width: 16px; height: 16px; vertical-align: middle; }
  
/* ===== LAYOUT OVERRIDES cho b·ªë c·ª•c theo y√™u c·∫ßu h√¨nh v·∫Ω ===== */
/* √Åp d·ª•ng cho c·∫£ preview v√† in (c√°c gi√° tr·ªã in mm ∆∞u ti√™n trong @media print) */
.left-block { display: flex; flex-direction: column; gap: 4px; align-items: flex-start; }
.serial-block { display: flex; flex-direction: column; gap: 2mm; align-items: flex-end; text-align: right; }
.serial-block .sku { order: 0; font-size: 13px; }
.serial-block .serial-number { order: 1; font-weight: 600; }
.serial-block .date, .serial-block .warehouse { order: 2; font-size: 15px; color: var(--secondary-color); }
.serial-block .meta-row { order: 2; display: flex; gap: 4px; align-items: center; font-size: 9px; color: var(--secondary-color); }
.meta-sep { opacity: 0.6; margin: 0 4px; }

/* Desc (t√™n s·∫£n ph·∫©m) chi·∫øm c·∫£ chi·ªÅu ngang, n·∫±m d∆∞·ªõi qrRow */
.label .desc { width: 100%; margin-top: 4mm; text-align: left; }

/* K√≠ch th∆∞·ªõc khuy·∫øn ngh·ªã cho QR: in l·ªõn, preview v·ª´a ph·∫£i */
@media print {
  .left-block { width: 40mm; }
  .qrcode { width: 36mm; height: 36mm; }
  .label .desc { margin-top: 3mm; font-size: 11px; }
}

/* Preview (web) */
.left-block { width: 90px; }
.qrcode { width: 90px; height: 90px; }
.label { gap: 6px; }

</style>
</head>
<body>
  <h1 style="margin-bottom: 24px;">T·∫°o nh√£n QR Code (2x4)</h1>
  
  <!-- PH·∫¶N CONTROLS - Giao di·ªán ƒëi·ªÅu khi·ªÉn -->
  <div class="card stack" id="controls">
    <!-- Mode Switcher - Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô textarea v√† table -->
    <div id="modeSwitcher" class="row">
      <strong class="section-title">Ch·∫ø ƒë·ªô nh·∫≠p:</strong>
      <label><input type="radio" name="mode" value="textarea" checked /> Textarea</label> <!-- Radio button cho ch·∫ø ƒë·ªô textarea -->
      <label><input type="radio" name="mode" value="table" /> B·∫£ng</label> <!-- Radio button cho ch·∫ø ƒë·ªô b·∫£ng -->
    </div>

    <!-- Textarea mode - Ch·∫ø ƒë·ªô nh·∫≠p b·∫±ng textarea -->
    <div id="textareaMode" class="stack">
      <label for="inputData" class="section-title">Nh·∫≠p d·ªØ li·ªáu</label>
      <textarea id="inputData" rows="6" placeholder="Nh·∫≠p t·ª´ng d√≤ng theo ƒë·ªãnh d·∫°ng: SKU|T√™n s·∫£n ph·∫©m|S·ªë l∆∞·ª£ng|Kho (tu·ª≥ ch·ªçn)
      
V√≠ d·ª•:
N009-SI-00*1|Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c|3|HH
ABC-123|S·∫£n ph·∫©m m·∫´u|1-5|KHO1"></textarea>
      <div class="hint">M·∫πo: C√≥ th·ªÉ d√πng n√∫t "D√°n t·ª´ textarea" ·ªü ch·∫ø ƒë·ªô B·∫£ng ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu sang d·∫°ng b·∫£ng.</div>
    </div>

    <!-- Table mode - Ch·∫ø ƒë·ªô nh·∫≠p b·∫±ng b·∫£ng -->
    <div id="tableMode" class="stack hidden">
      <label class="section-title">Nh·∫≠p d·ªØ li·ªáu d·∫°ng b·∫£ng</label>
      <div class="table-actions">
        <button type="button" id="addRowBtn" class="btn-secondary">‚ûï Th√™m d√≤ng</button>          <!-- N√∫t th√™m d√≤ng m·ªõi -->
        <button type="button" id="clearTableBtn" class="btn-secondary">üßπ X√≥a h·∫øt</button>        <!-- N√∫t x√≥a to√†n b·ªô b·∫£ng -->
        <button type="button" id="pasteFromTextareaBtn" class="btn-secondary">üì• D√°n t·ª´ textarea</button> <!-- N√∫t import t·ª´ textarea -->
      </div>
      <table id="inputTable">
        <thead>
          <tr>
            <th style="width: 22%">SKU</th>      <!-- C·ªôt m√£ s·∫£n ph·∫©m -->
            <th>T√™n s·∫£n ph·∫©m</th>                <!-- C·ªôt t√™n s·∫£n ph·∫©m -->
            <th style="width: 12%">S·ªë l∆∞·ª£ng</th> <!-- C·ªôt s·ªë l∆∞·ª£ng -->
            <th style="width: 12%">Kho</th>      <!-- C·ªôt kho -->
            <th style="width: 6%"></th>          <!-- C·ªôt n√∫t x√≥a -->
          </tr>
        </thead>
        <tbody></tbody> <!-- Tbody s·∫Ω ƒë∆∞·ª£c populate b·∫±ng JavaScript -->
      </table>
    </div>

    <!-- Date picker - Ch·ªçn ng√†y cho nh√£n -->
    <div class="row">
      <label for="datePicker" id="datePickerLabel" style="font-weight: 500;">Ng√†y tr√™n nh√£n:</label>
      <input type="date" id="datePicker" /> <!-- Input ch·ªçn ng√†y -->
    </div>

    <!-- Action buttons - C√°c n√∫t ch·ª©c nƒÉng ch√≠nh -->
    <div class="row" style="margin-top: 12px;">
      <button id="generateButton" type="button" class="btn-primary">üì¶ T·∫°o m√£ QR</button>           <!-- N√∫t t·∫°o QR -->
      <button id="printButton" type="button" class="btn-secondary">üñ®Ô∏è In A5 d·ªçc</button>          <!-- N√∫t in -->
      <button id="copyQRButton" type="button" class="btn-secondary">üìã Copy m√£ QR</button>         <!-- N√∫t copy QR text -->
      <button id="runTestsBtn" type="button" class="btn-secondary" title="Ch·∫°y ki·ªÉm th·ª≠ n·ªôi b·ªô">üß™ Ch·∫°y test</button> <!-- N√∫t ch·∫°y test -->
    </div>

    <!-- Status messages - Hi·ªÉn th·ªã th√¥ng b√°o -->
    <div id="statusMessage" class="status-message"></div>

    <!-- QR Text Display - Hi·ªÉn th·ªã danh s√°ch m√£ QR d·∫°ng text -->
    <label class="section-title">Danh s√°ch m√£ QR</label>
    <pre id="qrTextDisplay" placeholder="Danh s√°ch m√£ QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></pre>
    
    <!-- Test Output - Hi·ªÉn th·ªã k·∫øt qu·∫£ test (·∫©n m·∫∑c ƒë·ªãnh) -->
    <pre id="testOutput" class="hidden"></pre>
  </div>

  <!-- GRID CONTAINER - N∆°i hi·ªÉn th·ªã c√°c nh√£n QR -->
  <div class="grid" id="labelContainer"></div>

  <script>
    // ====== C·∫§U H√åNH (thay gi√° tr·ªã b√™n d∆∞·ªõi) ======
    // ƒê√£ b·ªè bi·∫øn WEBAPP_URL
    // ============================================
    let currentQRData = [];      // M·∫£ng ch·ª©a c√°c m√£ QR text hi·ªán t·∫°i

    // --- QRCode loader with fallback ---
    // Danh s√°ch c√°c URL CDN ƒë·ªÉ t·∫£i th∆∞ vi·ªán QRCode (c√≥ fallback)
    const QR_LIB_URLS = [
      'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',  // CDN ch√≠nh
      'https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js'         // CDN d·ª± ph√≤ng
    ];

    // H√†m t·∫£i script v·ªõi timeout
    function loadScript(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script'); // T·∫°o element script
        let done = false;                           // Flag ƒë·ªÉ tr√°nh multiple callback
        
        // Timer ƒë·ªÉ timeout n·∫øu t·∫£i qu√° l√¢u
        const timer = setTimeout(() => {
          if (!done) {
            done = true; 
            reject(new Error('timeout')); 
            s.remove(); // X√≥a script element
          }
        }, timeoutMs);
        
        s.src = url;        // Set URL
        s.async = false;    // Load ƒë·ªìng b·ªô ƒë·ªÉ maintain order
        
        // Callback khi t·∫£i th√†nh c√¥ng
        s.onload = () => { 
          if (!done) { 
            done = true; 
            clearTimeout(timer); 
            resolve(); 
          } 
        };
        
        // Callback khi t·∫£i th·∫•t b·∫°i
        s.onerror = () => { 
          if (!done) { 
            done = true; 
            clearTimeout(timer); 
            reject(new Error('load error')); 
          } 
        };
        
        document.head.appendChild(s); // Th√™m script v√†o head
      });
    }

    // H√†m ƒë·∫£m b·∫£o th∆∞ vi·ªán QRCode ƒë√£ ƒë∆∞·ª£c t·∫£i
    async function ensureQRCodeLib() {
      if (window.QRCode) return true; // ƒê√£ c√≥ r·ªìi th√¨ return true
      
      // Th·ª≠ t·∫£i t·ª´ t·ª´ng URL trong danh s√°ch
      for (const url of QR_LIB_URLS) {
        try {
          await loadScript(url, 8000); // Timeout 8 gi√¢y
          if (window.QRCode) return true; // T·∫£i th√†nh c√¥ng
        } catch (e) {
          console.warn('Kh√¥ng th·ªÉ t·∫£i QRCode lib t·ª´', url, e); // Log warning
        }
      }
      return !!window.QRCode; // Return true n·∫øu cu·ªëi c√πng v·∫´n c√≥ QRCode
    }

    // --- Utility Functions ---
    
    // H√†m chuy·ªÉn ƒë·ªïi ng√†y th√†nh Excel date number (s·ªë ng√†y t·ª´ 1899-12-30)
    function getExcelDateNumber(selectedDateStr) {
      let dateObj;
      
      if (selectedDateStr) {
        // Parse ng√†y t·ª´ string YYYY-MM-DD
        const [year, month, day] = selectedDateStr.split('-').map(Number);
        dateObj = new Date(year, month - 1, day); // month - 1 v√¨ JS Date d√πng 0-based month
      } else {
        // N·∫øu kh√¥ng c√≥ ng√†y ƒë∆∞·ª£c ch·ªçn, d√πng h√¥m nay
        const today = new Date();
        dateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      }
      
      // Excel epoch b·∫Øt ƒë·∫ßu t·ª´ 1899-12-30 (kh√¥ng ph·∫£i 1900-01-01)
      const excelEpoch = new Date(1899, 11, 30); // 11 = December (0-based)
      const diffTime = dateObj - excelEpoch;     // T√≠nh diff theo milliseconds
      const msPerDay = 24 * 60 * 60 * 1000;     // Milliseconds trong 1 ng√†y
      return Math.round(diffTime / msPerDay);    // Convert th√†nh s·ªë ng√†y v√† l√†m tr√≤n
    }

    // H√†m parse chu·ªói s·ªë l∆∞·ª£ng th√†nh m·∫£ng s·ªë
    function parseQty(qtyStr) {
      if (!qtyStr) return []; // N·∫øu empty th√¨ return m·∫£ng r·ªóng
      
      if (qtyStr.includes('-')) {
        // N·∫øu l√† range (VD: "1-5")
        const [start, end] = qtyStr.split('-').map(Number); // Split v√† convert th√†nh number
        
        // Validate range
        if (isNaN(start) || isNaN(end) || end < start || start <= 0) return [];
        
        // T·∫°o m·∫£ng t·ª´ start ƒë·∫øn end
        return Array.from({ length: end - start + 1 }, (_, i) => start + i);
      } else {
        // N·∫øu l√† s·ªë ƒë∆°n (VD: "3")
        const count = parseInt(qtyStr);
        if (isNaN(count) || count <= 0) return []; // Validate
        
        // T·∫°o m·∫£ng t·ª´ 1 ƒë·∫øn count
        return Array.from({ length: count }, (_, i) => i + 1);
      }
    }

    // H√†m l·∫•y ch·∫ø ƒë·ªô hi·ªán t·∫°i (textarea ho·∫∑c table)
    function currentMode() {
      return document.querySelector('input[name="mode"]:checked').value;
    }

    // H√†m th√™m d√≤ng m·ªõi v√†o b·∫£ng
    function addRow(values = { sku: '', name: '', qty: '', wh: '' }) {
      const tbody = document.querySelector('#inputTable tbody');
      const tr = document.createElement('tr'); // T·∫°o element tr m·ªõi
      
      // Set innerHTML cho tr v·ªõi c√°c input field v√† n√∫t delete
      tr.innerHTML = `
        <td><input type="text" value="${values.sku || ''}" placeholder="VD: N009-SI-00*1" /></td>
        <td><input type="text" value="${values.name || ''}" placeholder="VD: Vung 22 ch·∫£o" /></td>
        <td><input type="text" value="${values.qty || ''}" placeholder="VD: 3 ho·∫∑c 1-5" /></td>
        <td><input type="text" value="${values.wh || ''}" placeholder="VD: HH" /></td>
        <td style="text-align:center"><button type="button" class="delRow btn-secondary" style="padding: 4px 8px;">‚úñ</button></td>
      `;
      tbody.appendChild(tr); // Th√™m tr v√†o tbody
    }

    // H√†m x√≥a to√†n b·ªô b·∫£ng
    function clearTable() {
      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = ''; // Clear n·ªôi dung tbody
    }

    // H√†m import d·ªØ li·ªáu t·ª´ textarea v√†o b·∫£ng
    function importFromTextareaToTable() {
      const raw = document.getElementById('inputData').value.trim(); // L·∫•y raw text t·ª´ textarea
      if (!raw) return; // N·∫øu empty th√¨ kh√¥ng l√†m g√¨
      
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean); // Split th√†nh lines v√† filter empty
      clearTable(); // Clear b·∫£ng hi·ªán t·∫°i
      
      // Process t·ª´ng line
      for (const line of lines) {
        const parts = line.split('|'); // Split b·∫±ng |
        const [sku = '', name = '', qty = '', wh = ''] = parts; // Destructure v·ªõi default values
        addRow({ sku, name, qty, wh }); // Th√™m d√≤ng v√†o b·∫£ng
      }
      
      showStatus('ƒê√£ nh·∫≠p d·ªØ li·ªáu t·ª´ textarea v√†o b·∫£ng', 'success'); // Show th√¥ng b√°o
    }

    // H√†m collect d·ªØ li·ªáu t·ª´ textarea mode
    function collectDataFromTextarea(excelDate, out) {
      const input = document.getElementById('inputData').value.trim();
      if (!input) return; // N·∫øu empty th√¨ return
      
      const lines = input.split('\n'); // Split th√†nh lines
      
      lines.forEach(line => {
        const parts = line.split('|'); // Split line b·∫±ng |
        if (parts.length < 3) return; // C·∫ßn √≠t nh·∫•t 3 parts (SKU, name, qty)
        
        const [sku, name, qtyStr, warehouse = ''] = parts.map(s => s.trim()); // Parse v√† trim whitespace
        const numbers = parseQty(qtyStr); // Parse s·ªë l∆∞·ª£ng th√†nh m·∫£ng
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num })); // T·∫°o nh√£n cho m·ªói s·ªë
      });
    }

    // H√†m collect d·ªØ li·ªáu t·ª´ table mode
    function collectDataFromTable(excelDate, out) {
      const rows = document.querySelectorAll('#inputTable tbody tr'); // L·∫•y t·∫•t c·∫£ rows
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('input'); // L·∫•y t·∫•t c·∫£ input trong row
        if (cells.length < 4) return; // C·∫ßn √≠t nh·∫•t 4 cells
        
        // L·∫•y gi√° tr·ªã t·ª´ c√°c input
        const sku = cells[0].value.trim();
        const name = cells[1].value.trim();
        const qtyStr = cells[2].value.trim();
        const warehouse = cells[3].value.trim();
        
        if (!sku || !name || !qtyStr) return; // Validate required fields
        
        const numbers = parseQty(qtyStr); // Parse s·ªë l∆∞·ª£ng
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num })); // T·∫°o nh√£n cho m·ªói s·ªë
      });
    }

    // H√†m t·∫°o m·ªôt nh√£n v√† th√™m v√†o output array
    function pushOne(out, { excelDate, sku, name, warehouse, num }) {
      const serialDate = `${excelDate}`;     // Convert Excel date th√†nh string
      const serialNum = `${num}`;            // Convert s·ªë th√†nh string
      
      // T·∫°o serial number ƒë·∫ßy ƒë·ªß: date*number*warehouse (n·∫øu c√≥ warehouse)
      const serialFull = warehouse ? `${serialDate}*${serialNum}*${warehouse}` : `${serialDate}*${serialNum}`;
      
      // T·∫°o QR text theo format: SKU_serialFull
      const qrText = `${sku}_${serialFull}`;
      
      currentQRData.push(qrText); // Th√™m v√†o m·∫£ng QR data ƒë·ªÉ copy
      
      // Th√™m object v√†o output array v·ªõi t·∫•t c·∫£ th√¥ng tin c·∫ßn thi·∫øt
      out.push({
        qrText,           // Text cho QR code
        skuText: sku,     // SKU ƒë·ªÉ hi·ªÉn th·ªã
        serialDate,       // Ng√†y serial
        serialNum,        // S·ªë serial
        descText: name,   // T√™n s·∫£n ph·∫©m
        warehouseText: warehouse // T√™n kho
      });
    }

    // H√†m render c√°c nh√£n ra HTML
    function renderLabels(data) {
      const container = document.getElementById('labelContainer');
      container.innerHTML = ''; // Clear container
      
      // N·∫øu kh√¥ng c√≥ data, hi·ªÉn th·ªã th√¥ng b√°o
      if (data.length === 0) {
        container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--secondary-color);">Ch∆∞a c√≥ d·ªØ li·ªáu nh√£n. Vui l√≤ng nh·∫≠p th√¥ng tin v√† b·∫•m "T·∫°o m√£ QR"</p>';
        return;
      }
      
      // Render t·ª´ng nh√£n
      data.forEach((item, index) => {
        // T·∫°o div ch·ª©a nh√£n
        const div = document.createElement('div');
        div.className = 'label';

        // T·∫°o block ch·ª©a th√¥ng tin serial (b√™n ph·∫£i)
        const serialBlock = document.createElement('div');
        serialBlock.className = 'serial-block';

        // SKU (hi·ªÉn th·ªã tr√™n c√πng trong serial block)
        const skuDiv = document.createElement('div');
        skuDiv.className = 'sku';
        skuDiv.innerText = item.skuText;

        // S·ªë serial
        const serialNumDiv = document.createElement('div');
        serialNumDiv.className = 'serial-number';
        serialNumDiv.innerText = item.serialNum;

        // Ng√†y v√† Kho tr√™n c√πng m·ªôt h√†ng: "ng√†y -- kho"
        const metaDiv = document.createElement('div');
        metaDiv.className = 'meta-row';

        const dateSpan = document.createElement('span');
        dateSpan.className = 'date';
        dateSpan.innerText = item.serialDate;

      

        const warehouseSpan = document.createElement('span');
        warehouseSpan.className = 'warehouse';
        warehouseSpan.innerText = item.warehouseText;

      

        metaDiv.appendChild(dateSpan);
        metaDiv.appendChild(warehouseSpan);
      


        // Th√™m c√°c element v√†o serial block (SKU tr√™n c√πng)
        serialBlock.appendChild(skuDiv);
        serialBlock.appendChild(serialNumDiv);
        serialBlock.appendChild(metaDiv);

        // T·∫°o div ch·ª©a QR code (b√™n tr√°i) v√† t√™n s·∫£n ph·∫©m d∆∞·ªõi QR
        const leftBlock = document.createElement('div');
        leftBlock.className = 'left-block';

        // T·∫°o div ch·ª©a QR code
        const qrDiv = document.createElement('div');
        qrDiv.className = 'qrcode';
        qrDiv.id = 'qrcode-' + index; // Unique ID cho m·ªói QR

        // T·∫°o div hi·ªÉn th·ªã description (t√™n s·∫£n ph·∫©m) v√† ƒë·∫∑t d∆∞·ªõi QR
        const descDiv = document.createElement('div');
        descDiv.className = 'desc';
        descDiv.innerText = item.descText;

        leftBlock.appendChild(qrDiv);
        leftBlock.appendChild(descDiv);

        // T·∫°o row ch·ª©a QR (b√™n tr√°i) v√† serial info (b√™n ph·∫£i)
        const qrRow = document.createElement('div');
        qrRow.className = 'qr-row';
        qrRow.appendChild(leftBlock);      // QR + t√™n (tr√°i)
        qrRow.appendChild(serialBlock);    // SKU + STT (ph·∫£i)

        // Th√™m to√†n b·ªô v√†o label
        div.appendChild(qrRow);   // QR row ·ªü tr√™n
        // ƒê·∫∑t t√™n s·∫£n ph·∫©m (desc) xu·ªëng h√†ng d∆∞·ªõi, chi·∫øm c·∫£ chi·ªÅu ngang nh√£n
        div.appendChild(descDiv);
        container.appendChild(div); // Th√™m label v√†o container // Th√™m label v√†o container // Th√™m label v√†o container

        // T·∫°o QR code th·ª±c t·∫ø (n·∫øu c√≥ th∆∞ vi·ªán)
        if (window.QRCode) {
          new QRCode(qrDiv, { 
            text: item.qrText,  // Text ƒë·ªÉ encode
            width: 90,          // ƒê·ªô r·ªông QR (px)
            height: 90          // ƒê·ªô cao QR (px)
          });
        } else {
          // Fallback n·∫øu kh√¥ng c√≥ th∆∞ vi·ªán
          qrDiv.textContent = '(QR kh√¥ng kh·∫£ d·ª•ng)';
          qrDiv.title = item.qrText; // Set title ƒë·ªÉ xem QR text
        }
      });
    }

    // H√†m hi·ªÉn th·ªã status message
    function showStatus(message, type = 'success') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;                        // Set text
      el.className = `status-message status-${type}`; // Set CSS class
      
      // Auto hide sau 5 gi√¢y
      setTimeout(() => {
        el.className = 'status-message';
      }, 5000);
    }

    // H√†m ch√≠nh t·∫°o nh√£n
    async function generateLabels() {
      // ƒê·∫£m b·∫£o th∆∞ vi·ªán QRCode ƒë√£ ƒë∆∞·ª£c t·∫£i
      const libOk = await ensureQRCodeLib();
      if (!libOk) {
        showStatus('Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán t·∫°o QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.', 'error');
        return;
      }

      // L·∫•y ng√†y ƒë∆∞·ª£c ch·ªçn v√† convert th√†nh Excel date
      const selectedDateStr = document.getElementById('datePicker').value;
      const excelDate = getExcelDateNumber(selectedDateStr);
      
      // Reset data arrays
      currentQRData = [];
      const data = [];

      // Collect data t·ª´ mode hi·ªán t·∫°i
      if (currentMode() === 'textarea') {
        collectDataFromTextarea(excelDate, data);
      } else {
        collectDataFromTable(excelDate, data);
      }

      // Validate c√≥ data kh√¥ng
      if (data.length === 0) {
        showStatus('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ t·∫°o nh√£n. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin nh·∫≠p.', 'error');
        return;
      }

      // Update UI
      document.getElementById('qrTextDisplay').textContent = currentQRData.join('\n'); // Hi·ªÉn th·ªã QR text
      renderLabels(data); // Render c√°c nh√£n
      showStatus(`ƒê√£ t·∫°o ${data.length} nh√£n QR th√†nh c√¥ng!`, 'success'); // Show success message
    }

    // --- Self test functions ---
    
    // H√†m so s√°nh 2 m·∫£ng
    function arraysEqual(a, b) {
      return Array.isArray(a) && Array.isArray(b) && 
             a.length === b.length && 
             a.every((v, i) => v === b[i]); // Check t·ª´ng ph·∫ßn t·ª≠
    }
    
    // H√†m t·∫°o test case
    function test(title, ok, details = '') {
      const line = `${ok ? '‚úÖ' : '‚ùå'} ${title}${details ? ' ‚Äî ' + details : ''}`;
      console[ok ? 'log' : 'error'](line); // Log k·∫øt qu·∫£
      return line;
    }
    
    // H√†m ch·∫°y t·∫•t c·∫£ self tests
    function runSelfTests() {
      const out = [];
      
      // Test parseQty function
      out.push(test('parseQty("3") => [1,2,3]', arraysEqual(parseQty('3'), [1,2,3])));
      out.push(test('parseQty("1-5") => [1..5]', arraysEqual(parseQty('1-5'), [1,2,3,4,5])));
      out.push(test('parseQty("5-1") => [] (range ng∆∞·ª£c)', arraysEqual(parseQty('5-1'), [])));
      out.push(test('parseQty("0") => []', arraysEqual(parseQty('0'), [])));
      out.push(test('parseQty("-2") => []', arraysEqual(parseQty('-2'), [])));

      // Test Excel date function
      out.push(test('Excel serial 1899-12-30 => 0', getExcelDateNumber('1899-12-30') === 0));
      out.push(test('Excel serial 1899-12-31 => 1', getExcelDateNumber('1899-12-31') === 1));
      out.push(test('Excel serial 1900-01-01 => 2', getExcelDateNumber('1900-01-01') === 2));

      // Test QRCode library availability
      out.push(test('QRCode lib available (may be false if offline)', !!window.QRCode));

      // Hi·ªÉn th·ªã k·∫øt qu·∫£ test
      const box = document.getElementById('testOutput');
      box.classList.remove('hidden'); // Show test output
      box.textContent = out.join('\n'); // Join t·∫•t c·∫£ test results
      showStatus('ƒê√£ ch·∫°y ki·ªÉm th·ª≠, xem k·∫øt qu·∫£ b√™n d∆∞·ªõi', 'success');
    }

    // --- Event Listeners - G·∫Øn c√°c s·ª± ki·ªán cho UI elements ---
    
    // Event listener cho n√∫t "T·∫°o m√£ QR"
    document.getElementById('generateButton').addEventListener('click', () => { 
      void generateLabels(); // Call async function (void ƒë·ªÉ tr√°nh warning)
    });
    
    // Event listener cho n√∫t "In A5 d·ªçc"
    document.getElementById('printButton').addEventListener('click', () => window.print());
    
    // Event listener cho n√∫t "Copy m√£ QR"
    document.getElementById('copyQRButton').addEventListener('click', () => {
      if (currentQRData.length === 0) { 
        showStatus('Vui l√≤ng t·∫°o m√£ QR tr∆∞·ªõc ƒë√£!', 'error'); 
        return; 
      }
      
      const text = currentQRData.join('\n'); // Join t·∫•t c·∫£ QR text
      
      // Copy v√†o clipboard
      navigator.clipboard.writeText(text).then(() => {
        showStatus(`ƒê√£ copy ${currentQRData.length} m√£ QR v√†o clipboard!`, 'success');
      }, () => { 
        showStatus('Kh√¥ng th·ªÉ copy v√†o clipboard. H√£y th·ª≠ l·∫°i.', 'error');
      });
    });
    
    // Event listener cho n√∫t "Ch·∫°y test"
    document.getElementById('runTestsBtn').addEventListener('click', runSelfTests);
    
    // Event listener cho mode switcher (textarea vs table)
    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener('change', () => {
        const isTextarea = currentMode() === 'textarea';
        
        // Show/hide t∆∞∆°ng ·ª©ng mode
        document.getElementById('textareaMode').classList.toggle('hidden', !isTextarea);
        document.getElementById('tableMode').classList.toggle('hidden', isTextarea);
      });
    });

    // Event listeners cho table controls
    document.getElementById('addRowBtn').addEventListener('click', () => addRow());                    // Th√™m d√≤ng
    document.getElementById('clearTableBtn').addEventListener('click', clearTable);                  // Clear table
    document.getElementById('pasteFromTextareaBtn').addEventListener('click', importFromTextareaToTable); // Import t·ª´ textarea

    // Event delegation cho n√∫t x√≥a row trong table
    document.querySelector('#inputTable tbody').addEventListener('click', (e) => {
      if (e.target.classList.contains('delRow')) { // Check n·∫øu click v√†o n√∫t delete row
        e.target.closest('tr').remove();            // T√¨m tr g·∫ßn nh·∫•t v√† x√≥a
        showStatus('ƒê√£ x√≥a d√≤ng kh·ªèi b·∫£ng', 'success');
      }
    });

    // ===== INITIALIZATION - Kh·ªüi t·∫°o ·ª©ng d·ª•ng =====
    
    // Set ng√†y h√¥m nay l√†m default cho date picker
    document.getElementById('datePicker').valueAsDate = new Date();
    
    // Seed: th√™m m·ªôt d√≤ng m·∫´u v√†o table khi kh·ªüi ƒë·ªông
    addRow({ 
      sku: 'N009-SI-00*1', 
      name: 'Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c', 
      qty: '3', 
      wh: 'HH' 
    });
  </script>

  <!-- ===== PH·∫¶N JAVASCRIPT CHO X·ª¨ L√ù FILE (t·ª´ document ƒë·∫ßu) ===== -->
  <script type="text/javascript">
    // C√°c bi·∫øn global cho vi·ªác x·ª≠ l√Ω file Excel
    var gk_isXlsx = false;           // Flag check file c√≥ ph·∫£i Excel kh√¥ng
    var gk_xlsxFileLookup = {};      // Lookup table cho file Excel
    var gk_fileData = {};            // Data c·ªßa c√°c files

    // H√†m check cell c√≥ d·ªØ li·ªáu kh√¥ng
    function filledCell(cell) {
      return cell !== '' && cell != null; // Cell kh√°c r·ªóng v√† kh√¥ng null
    }

    // H√†m load data t·ª´ file (ch·ªß y·∫øu cho Excel)
    function loadFileData(filename) {
      // N·∫øu l√† file Excel v√† c√≥ trong lookup
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          // ƒê·ªçc workbook t·ª´ base64 data
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];  // L·∫•y sheet ƒë·∫ßu ti√™n
          var worksheet = workbook.Sheets[firstSheetName]; // L·∫•y worksheet

          // Convert sheet th√†nh JSON ƒë·ªÉ filter blank rows
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { 
            header: 1,        // D√πng s·ªë thay v√¨ header names
            blankrows: false, // Kh√¥ng include blank rows
            defval: ''        // Default value cho empty cells
          });
          
          // Filter ra c√°c rows tr·ªëng (rows m√† t·∫•t c·∫£ cells ƒë·ªÅu empty)
          var filteredData = jsonData.filter(row => row.some(filledCell));

          // Heuristic t√¨m header row: t√¨m row c√≥ s·ªë cells filled >= row ti·∫øp theo
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          
          // Fallback n·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c header ho·∫∑c header qu√° xa
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0; // D√πng row ƒë·∫ßu ti√™n
          }

          // Convert filtered data tr·ªü l·∫°i CSV format
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // T·∫°o sheet m·ªõi t·ª´ filtered array
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 }); // Convert sheet th√†nh CSV string
          return csv;
        } catch (e) {
          console.error(e); // Log l·ªói
          return "";        // Return empty string n·∫øu c√≥ l·ªói
        }
      }
      
      // N·∫øu kh√¥ng ph·∫£i Excel ho·∫∑c kh√¥ng c√≥ file, return raw data
      return gk_fileData[filename] || "";
    }
  </script>
</body>
</html>

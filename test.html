<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Labels ‚Äì Textarea + B·∫£ng + G·ª≠i Google Sheet</title>
  <!-- Primary CDN (synchronous). We'll also have a JS fallback loader just in case this fails. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
  <style>
    :root { --gap: 5mm; }

    @page { size: A5 portrait; margin: 5mm; }
    @media print {
      body { margin: 0; }
      #controls, #modeSwitcher, #qrTextDisplay, #datePickerLabel, #datePicker, #runTestsBtn, #testOutput, #sendToSheetBtn { display: none !important; }
    }
    body { font-family: Arial, sans-serif; }
    .hidden { display: none !important; }
    .stack { display: grid; gap: 8px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(5, auto);
      gap: var(--gap);
      padding: var(--gap);
      justify-items: start;
    }
    .label {
      width: 100%;
      border: 1px solid #000;
      padding: 5px;
      box-sizing: border-box;
      display: flex; flex-direction: column; gap: 3px; align-items: flex-start; justify-content: flex-start;
      page-break-inside: avoid;
    }
    .qrcode { width: 60px; height: 60px; }
    .sku { font-weight: bold; font-size: 12.5px; text-align: left; }
    .serial-block { display: flex; flex-direction: column; justify-content: center; font-size: 16px; font-weight: bold; line-height: 1.4; text-align: right; }
    .serial-number { margin-bottom: 2px; }
    .date { text-align: right; }
    .warehouse { text-align: right; font-size: 14px; margin-top: 2px; }
    .qr-row { display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; width: 100%; }
    .desc { font-size: 10.5px; text-align: left; }

    /* Controls */
    #controls button { margin: 6px 4px; padding: 8px 14px; font-size: 14px; cursor: pointer; }
    #qrTextDisplay { width: 100%; margin: 6px 0 0 0; font-size: 13px; padding: 8px; border: 1px solid #ccc; height: 150px; white-space: pre-wrap; overflow-y: auto; }

    /* Table input */
    table#inputTable { border-collapse: collapse; width: 100%; margin: 8px 0; }
    table#inputTable th, table#inputTable td { border: 1px solid #ccc; padding: 6px; }
    table#inputTable input { width: 100%; box-sizing: border-box; padding: 6px; }
    .table-actions { display: flex; gap: 6px; }

    /* Mode switcher */
    #modeSwitcher { margin: 6px 0; }
    #modeSwitcher label { margin-right: 14px; }

    /* Test output */
    #testOutput { border: 1px dashed #bbb; padding: 8px; font-size: 12px; white-space: pre-wrap; max-height: 180px; overflow: auto; }

    .hint { font-size: 12px; color: #666; }
  </style>
</head>
<body>

  <div class="stack" id="controls">
    <!-- Mode Switcher -->
    <div id="modeSwitcher" class="row">
      <strong>Ch·∫ø ƒë·ªô nh·∫≠p:</strong>
      <label><input type="radio" name="mode" value="textarea" checked /> Textarea</label>
      <label><input type="radio" name="mode" value="table" /> B·∫£ng</label>
    </div>

    <!-- Textarea mode -->
    <div id="textareaMode" class="stack">
      <textarea id="inputData" rows="6" placeholder="Nh·∫≠p t·ª´ng d√≤ng: SKU|T√™n|S·ªë l∆∞·ª£ng|Kho
V√≠ d·ª•:
N009-SI-00*1|Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c|3|HH"></textarea>
      <div class="hint">M·∫πo: C√≥ th·ªÉ d√πng n√∫t ‚Äúüì• D√°n t·ª´ textarea‚Äù ·ªü ch·∫ø ƒë·ªô B·∫£ng ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu sang d·∫°ng b·∫£ng.</div>
    </div>

    <!-- Table mode -->
    <div id="tableMode" class="stack hidden">
      <div class="table-actions">
        <button type="button" id="addRowBtn">‚ûï Th√™m d√≤ng</button>
        <button type="button" id="clearTableBtn">üßπ X√≥a h·∫øt</button>
        <button type="button" id="pasteFromTextareaBtn">üì• D√°n t·ª´ textarea</button>
      </div>
      <table id="inputTable">
        <thead>
          <tr>
            <th style="width: 22%">SKU</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th style="width: 10%">S·ªë l∆∞·ª£ng</th>
            <th style="width: 10%">Kho</th>
            <th style="width: 6%">X√≥a</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Actions row -->
    <div class="row">
      <button id="generateButton" type="button">üì¶ T·∫°o m√£ QR</button>
      <button id="printButton" type="button">üñ®Ô∏è In A5 d·ªçc</button>
      <button id="copyQRButton" type="button">üìã Copy to√†n b·ªô m√£ QR</button>
      <button id="runTestsBtn" type="button" title="Ch·∫°y ki·ªÉm th·ª≠ n·ªôi b·ªô">üß™ Ch·∫°y test</button>
      <button id="sendToSheetBtn" type="button" title="G·ª≠i d·ªØ li·ªáu sang Google Sheet">üì§ G·ª≠i Google Sheet</button>
    </div>

    <!-- Date row moved below action buttons -->
    <div class="row">
      <label for="datePicker" id="datePickerLabel">Ch·ªçn ng√†y:</label>
      <input type="date" id="datePicker" />
    </div>

    <pre id="qrTextDisplay" placeholder="Danh s√°ch m√£ QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></pre>
    <pre id="testOutput" class="hidden"></pre>
  </div>

  <div class="grid" id="labelContainer"></div>

  <script>
    // ====== C·∫§U H√åNH (thay gi√° tr·ªã b√™n d∆∞·ªõi) ======
    // D√°n URL Web App b·∫°n v·ª´a deploy t·∫°i Apps Script v√†o ƒë√¢y
    const WEBAPP_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhsc6_p65kdQxJDoxaW5SMmUTDBrLy0fkftMHiAgDlAaz1t_9WNg3pEjGNqeJQYJe8dxKWXppKmTi40AdqmphDUqKTH-KFP_DG6AOfeZ-eg5SPxdMA-BBSDPHfTYVmIyBhCxfQiP7WSwpNQmWsrrpA5njSpbZoY6nLWKAbzCTZtRO9XvRMNVS7jhxw7km75FzMwExv9eMnQyETjI0Cb80KRJTIDeEscClqGBxLybeP3hptBm8WFXkTOCZSKr5DQTJcByQ-N1hTINctFYfvWbvHSzmDJ7Co0JNOK63m8&lib=MaMZdCsnl_NQ26YddpdBAcY1n0BzfRUfT';
    // ==============================================

    let currentQRData = [];
    let dataCacheForExport = []; // gi·ªØ payload m·ªõi nh·∫•t ƒë·ªÉ g·ª≠i l√™n Google Sheet

    // --- QRCode loader with fallback ---
    const QR_LIB_URLS = [
      // Primary (already included in <head> as well)
      'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
      // Fallback from GitHub via jsDelivr
      'https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js'
    ];

    function loadScript(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        let done = false;
        const timer = setTimeout(() => {
          if (!done) {
            done = true; reject(new Error('timeout')); s.remove();
          }
        }, timeoutMs);
        s.src = url;
        s.async = false; // maintain order if needed
        s.onload = () => { if (!done) { done = true; clearTimeout(timer); resolve(); } };
        s.onerror = () => { if (!done) { done = true; clearTimeout(timer); reject(new Error('load error')); } };
        document.head.appendChild(s);
      });
    }

    async function ensureQRCodeLib() {
      if (window.QRCode) return true;
      for (const url of QR_LIB_URLS) {
        try {
          await loadScript(url, 8000);
          if (window.QRCode) return true;
        } catch (e) {
          console.warn('Kh√¥ng th·ªÉ t·∫£i QRCode lib t·ª´', url, e);
        }
      }
      return !!window.QRCode;
    }

    // --- Utilities ---
    function getExcelDateNumber(selectedDateStr) {
      let dateObj;
      if (selectedDateStr) {
        const [year, month, day] = selectedDateStr.split('-').map(Number);
        dateObj = new Date(year, month - 1, day);
      } else {
        const today = new Date();
        dateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      }
      const excelEpoch = new Date(1899, 11, 30);
      const diffTime = dateObj - excelEpoch;
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.round(diffTime / msPerDay);
    }

    function parseQty(qtyStr) {
      if (!qtyStr) return [];
      if (qtyStr.includes('-')) {
        const [start, end] = qtyStr.split('-').map(Number);
        if (isNaN(start) || isNaN(end) || end < start || start <= 0) return [];
        return Array.from({ length: end - start + 1 }, (_, i) => start + i);
      } else {
        const count = parseInt(qtyStr);
        if (isNaN(count) || count <= 0) return [];
        return Array.from({ length: count }, (_, i) => i + 1);
      }
    }

    function currentMode() {
      return document.querySelector('input[name="mode"]:checked').value; // 'textarea' | 'table'
    }

    function addRow(values = { sku: '', name: '', qty: '', wh: '' }) {
      const tbody = document.querySelector('#inputTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${values.sku || ''}" /></td>
        <td><input type="text" value="${values.name || ''}" /></td>
        <td><input type="text" value="${values.qty || ''}" /></td>
        <td><input type="text" value="${values.wh || ''}" /></td>
        <td style="text-align:center"><button type="button" class="delRow">‚úñ</button></td>
      `;
      tbody.appendChild(tr);
    }

    function clearTable() {
      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
    }

    function importFromTextareaToTable() {
      const raw = document.getElementById('inputData').value.trim();
      if (!raw) return;
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
      clearTable();
      for (const line of lines) {
        const parts = line.split('|');
        const [sku = '', name = '', qty = '', wh = ''] = parts;
        addRow({ sku, name, qty, wh });
      }
    }

    function collectDataFromTextarea(excelDate, out) {
      const input = document.getElementById('inputData').value.trim();
      if (!input) return;
      const lines = input.split('\n');
      lines.forEach(line => {
        const parts = line.split('|');
        if (parts.length < 3) return;
        const [sku, name, qtyStr, warehouse = ''] = parts.map(s => s.trim());
        const numbers = parseQty(qtyStr);
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num }));
      });
    }

    function collectDataFromTable(excelDate, out) {
      const rows = document.querySelectorAll('#inputTable tbody tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('input');
        if (cells.length < 4) return;
        const sku = cells[0].value.trim();
        const name = cells[1].value.trim();
        const qtyStr = cells[2].value.trim();
        const warehouse = cells[3].value.trim();
        if (!sku || !name || !qtyStr) return;
        const numbers = parseQty(qtyStr);
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num }));
      });
    }

    function pushOne(out, { excelDate, sku, name, warehouse, num }) {
      const serialDate = `${excelDate}`;
      const serialNum = `${num}`;
      const serialFull = warehouse ? `${serialDate}*${serialNum}*${warehouse}` : `${serialDate}*${serialNum}`;
      const qrText = `${sku}_${serialFull}`;
      currentQRData.push(qrText);
      out.push({
        qrText,
        skuText: sku,
        serialDate,
        serialNum,
        descText: name,
        warehouseText: warehouse
      });
    }

    function renderLabels(data) {
      const container = document.getElementById('labelContainer');
      container.innerHTML = '';
      data.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'label';

        const serialBlock = document.createElement('div');
        serialBlock.className = 'serial-block';

        const serialNumDiv = document.createElement('div');
        serialNumDiv.className = 'serial-number';
        serialNumDiv.innerText = item.serialNum;

        const dateDiv = document.createElement('div');
        dateDiv.className = 'date';
        dateDiv.innerText = item.serialDate;

        const warehouseDiv = document.createElement('div');
        warehouseDiv.className = 'warehouse';
        warehouseDiv.innerText = item.warehouseText;

        serialBlock.appendChild(serialNumDiv);
        serialBlock.appendChild(dateDiv);
        serialBlock.appendChild(warehouseDiv);

        const qrDiv = document.createElement('div');
        qrDiv.className = 'qrcode';
        qrDiv.id = 'qrcode-' + index;

        const qrRow = document.createElement('div');
        qrRow.className = 'qr-row';
        qrRow.appendChild(qrDiv);
        qrRow.appendChild(serialBlock);

        const skuDiv = document.createElement('div');
        skuDiv.className = 'sku';
        skuDiv.innerText = item.skuText;

        const descDiv = document.createElement('div');
        descDiv.className = 'desc';
        descDiv.innerText = item.descText;

        div.appendChild(qrRow);
        div.appendChild(skuDiv);
        div.appendChild(descDiv);
        container.appendChild(div);

        // Guard: n·∫øu thi·∫øu th∆∞ vi·ªán, tr√°nh throw
        if (window.QRCode) {
          new QRCode(qrDiv, { text: item.qrText, width: 60, height: 60 });
        } else {
          qrDiv.textContent = '(QR kh√¥ng kh·∫£ d·ª•ng)';
          qrDiv.title = item.qrText;
        }
      });
    }

    async function generateLabels() {
      const libOk = await ensureQRCodeLib();
      if (!libOk) {
        alert('Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán t·∫°o QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.');
      }

      const selectedDateStr = document.getElementById('datePicker').value;
      const excelDate = getExcelDateNumber(selectedDateStr);
      currentQRData = [];
      const data = [];

      if (currentMode() === 'textarea') {
        collectDataFromTextarea(excelDate, data);
      } else {
        collectDataFromTable(excelDate, data);
      }

      // c·∫≠p nh·∫≠t cache ƒë·ªÉ g·ª≠i Google Sheet
      dataCacheForExport = data.map(d => ({
        skuText: d.skuText,
        descText: d.descText,
        serialDate: d.serialDate,
        serialNum: d.serialNum,
        warehouseText: d.warehouseText,
        qrText: d.qrText
      }));

      document.getElementById('qrTextDisplay').textContent = currentQRData.join('\n');
      renderLabels(data);
    }

    async function sendToGoogleSheet() {
      if (!WEBAPP_URL || WEBAPP_URL.includes('YOUR_DEPLOYMENT_ID')) {
        alert('Vui l√≤ng c·∫•u h√¨nh WEBAPP_URL v·ªõi URL Web App c·ªßa Google Apps Script.');
        return;
      }
      if (!Array.isArray(dataCacheForExport) || dataCacheForExport.length === 0) {
        alert('Vui l√≤ng t·∫°o QR tr∆∞·ªõc khi g·ª≠i Google Sheet.');
        return;
      }

      try {
        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataCacheForExport)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json().catch(() => ({ status: 'ok' }));
        if (json.status === 'ok') {
          alert('ƒê√£ g·ª≠i d·ªØ li·ªáu v√†o Google Sheet th√†nh c√¥ng!');
        } else {
          alert('Ph·∫£n h·ªìi kh√¥ng nh∆∞ k·ª≥ v·ªçng: ' + JSON.stringify(json));
        }
      } catch (err) {
        alert('L·ªói khi g·ª≠i d·ªØ li·ªáu: ' + err.message + '\n‚Ä¢ Ki·ªÉm tra quy·ªÅn truy c·∫≠p c·ªßa Web App (Anyone/Anyone with link)\n‚Ä¢ Ki·ªÉm tra Triggers/Deploy ƒë√∫ng phi√™n b·∫£n');
      }
    }

    // --- Self tests ---
    function arraysEqual(a, b) {
      return Array.isArray(a) && Array.isArray(b) && a.length === b.length && a.every((v, i) => v === b[i]);
    }
    function test(title, ok, details = '') {
      const line = `${ok ? '‚úÖ' : '‚ùå'} ${title}${details ? ' ‚Äî ' + details : ''}`;
      console[ok ? 'log' : 'error'](line);
      return line;
    }
    function runSelfTests() {
      const out = [];
      out.push(test('parseQty("3") => [1,2,3]', arraysEqual(parseQty('3'), [1,2,3])));
      out.push(test('parseQty("1-5") => [1..5]', arraysEqual(parseQty('1-5'), [1,2,3,4,5])));
      out.push(test('parseQty("5-1") => [] (range ng∆∞·ª£c)', arraysEqual(parseQty('5-1'), [])));
      out.push(test('parseQty("0") => []', arraysEqual(parseQty('0'), [])));
      out.push(test('parseQty("-2") => []', arraysEqual(parseQty('-2'), [])));

      out.push(test('Excel serial 1899-12-30 => 0', getExcelDateNumber('1899-12-30') === 0));
      out.push(test('Excel serial 1899-12-31 => 1', getExcelDateNumber('1899-12-31') === 1));
      out.push(test('Excel serial 1900-01-01 => 2', getExcelDateNumber('1900-01-01') === 2));

      out.push(test('QRCode lib available (may be false if offline)', !!window.QRCode));

      const box = document.getElementById('testOutput');
      box.classList.remove('hidden');
      box.textContent = out.join('\n');
    }

    // --- Event wiring ---
    document.getElementById('generateButton').addEventListener('click', () => { void generateLabels(); });
    document.getElementById('printButton').addEventListener('click', () => window.print());
    document.getElementById('copyQRButton').addEventListener('click', () => {
      if (currentQRData.length === 0) { alert('Vui l√≤ng t·∫°o m√£ QR tr∆∞·ªõc ƒë√£!'); return; }
      const text = currentQRData.join('\n');
      navigator.clipboard.writeText(text).then(() => {
        alert('ƒê√£ copy to√†n b·ªô m√£ QR v√†o clipboard!');
      }, () => { alert('Kh√¥ng th·ªÉ copy v√†o clipboard. H√£y th·ª≠ l·∫°i.'); });
    });
    document.getElementById('runTestsBtn').addEventListener('click', runSelfTests);
    document.getElementById('sendToSheetBtn').addEventListener('click', () => { void sendToGoogleSheet(); });

    // Switch modes
    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener('change', () => {
        const isTextarea = currentMode() === 'textarea';
        document.getElementById('textareaMode').classList.toggle('hidden', !isTextarea);
        document.getElementById('tableMode').classList.toggle('hidden', isTextarea);
      });
    });

    // Table buttons
    document.getElementById('addRowBtn').addEventListener('click', () => addRow());
    document.getElementById('clearTableBtn').addEventListener('click', clearTable);
    document.getElementById('pasteFromTextareaBtn').addEventListener('click', importFromTextareaToTable);

    // Row delete via event delegation
    document.querySelector('#inputTable tbody').addEventListener('click', (e) => {
      if (e.target.classList.contains('delRow')) {
        e.target.closest('tr').remove();
      }
    });

    // Seed: m·ªôt d√≤ng m·∫´u khi m·ªü b·∫£ng l·∫ßn ƒë·∫ßu
    addRow({ sku: 'N009-SI-00*1', name: 'Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c', qty: '3', wh: 'HH' });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thu Chi C√° Nh√¢n 2025 + Gemini AI</title>
    <meta name="theme-color" content="#3498db">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Th√™m th∆∞ vi·ªán cho Sankey v√† Heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey@0.10.2/dist/chartjs-chart-sankey.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-light: #5dade2;
            --primary-dark: #21618c;
            --success: #27ae60;
            --success-light: #52be80;
            --danger: #e74c3c;
            --danger-light: #ec7063;
            --warning: #f39c12;
            --warning-light: #f8c471;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #95a5a6;
            --gray-light: #ecf0f1;
            --card: #ffffff;
            --text: #333333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        .dark {
            --primary: #2980b9;
            --primary-light: #3498db;
            --success: #229954;
            --success-light: #27ae60;
            --danger: #c0392b;
            --danger-light: #e74c3c;
            --warning: #d68910;
            --warning-light: #f39c12;
            --dark: #1a252f;
            --light: #121212;
            --gray: #7f8c8d;
            --gray-light: #2c3e50;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--light);
            color: var(--text);
            min-height: 100vh;
            transition: var(--transition);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            font-size: 1.6rem;
            font-weight: 700;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Main Layout: 1/4 left, 3/4 right */
        .main-layout {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Left Sidebar - Filters (1/4 width) */
        .sidebar {
            flex: 0 0 25%; /* 1/4 width */
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Right Content - Data Display (3/4 width) */
        .content {
            flex: 0 0 75%; /* 3/4 width */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Filter Card Styling */
        .filter-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .filter-card h3 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-card h3::before {
            content: 'üîç';
            font-size: 1rem;
        }

        /* Filter Chips in Sidebar */
        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .filter-chip {
            padding: 10px 15px;
            background: var(--gray-light);
            border: 2px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            user-select: none;
            text-align: left;
        }

        .dark .filter-chip {
            background: #2c3e50;
        }

        .filter-chip:hover {
            background: var(--primary-light);
            color: white;
            transform: translateX(5px);
        }

        .filter-chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.3);
        }

        /* Action Buttons in Sidebar */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: var(--success-light);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: var(--warning-light);
        }

        .btn-dark {
            background: var(--dark);
            color: white;
        }

        .btn-dark:hover {
            background: #34495e;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--card);
            color: var(--text);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Custom Prompt */
        .prompt-box {
            margin-top: 15px;
        }

        .prompt-box textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--card);
            color: var(--text);
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .prompt-box textarea:focus {
            outline: none;
            border-color: var(--warning);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.2);
        }

        /* Content Cards */
        .content-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .content-card h3 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
            font-weight: 600;
        }

        /* Dashboard KPI Styles */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .kpi-item {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            border-radius: var(--radius);
            padding: 20px;
            color: white;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary-dark);
        }

        .dark .kpi-item {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
        }

        .kpi-item:nth-child(2) {
            background: linear-gradient(135deg, var(--success-light) 0%, var(--success) 100%);
            border-left-color: var(--success);
        }

        .dark .kpi-item:nth-child(2) {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
        }

        .kpi-item:nth-child(3) {
            background: linear-gradient(135deg, var(--warning-light) 0%, var(--warning) 100%);
            border-left-color: var(--warning);
        }

        .dark .kpi-item:nth-child(3) {
            background: linear-gradient(135deg, #d68910 0%, #f39c12 100%);
        }

        .kpi-item:nth-child(4) {
            background: linear-gradient(135deg, var(--danger-light) 0%, var(--danger) 100%);
            border-left-color: var(--danger);
        }

        .dark .kpi-item:nth-child(4) {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }

        .kpi-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .kpi-content {
            display: flex;
            flex-direction: column;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            line-height: 1.2;
        }

        .kpi-list {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 5px;
        }

        .kpi-list div {
            padding: 3px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
        }

        .kpi-list div:last-child {
            border-bottom: none;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: 400px;
            position: relative;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: 'üìä';
            font-size: 1.1rem;
        }

        .chart-wrapper {
            width: 100%;
            height: calc(100% - 40px);
            position: relative;
        }

        /* Bi·ªÉu ƒë·ªì Sankey c·∫ßn chi·ªÅu cao l·ªõn h∆°n */
        .chart-container.sankey {
            height: 500px;
        }

        .chart-container.heatmap {
            height: 450px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 80px; /* Adjusted for header */
            z-index: 50;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .dark .data-table td {
            border-bottom-color: #34495e;
        }

        .data-table tr:hover {
            background: rgba(52, 152, 219, 0.08);
        }

        .data-table tr.thu {
            background: rgba(39, 174, 96, 0.05);
        }

        .data-table tr.chi {
            background: rgba(231, 76, 60, 0.05);
        }

        /* CƒÉn ph·∫£i cho c·ªôt s·ªë ti·ªÅn */
        .money {
            text-align: right !important;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            padding-right: 20px !important;
        }

        .money-header {
            text-align: right !important;
            padding-right: 20px !important;
        }

        /* Total row */
        .total-row {
            background: rgba(52, 152, 219, 0.1) !important;
            font-weight: 700;
            border-top: 2px solid var(--primary);
        }

        .dark .total-row {
            background: rgba(52, 152, 219, 0.2) !important;
        }

        /* AI Analysis Box */
        .analysis-box {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }

        .dark .analysis-box {
            background: linear-gradient(135deg, #4a3e2e, #5d4a2e);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .analysis-header h3 {
            font-size: 1.3rem;
            color: var(--warning);
            margin: 0;
            font-weight: 700;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .dark .analysis-content {
            background: rgba(0, 0, 0, 0.3);
        }

        .analysis-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 16px 28px;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transform: translateX(100px);
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 350px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
            border-left: 4px solid var(--success-light);
        }

        .notification.error {
            background: var(--danger);
            border-left: 4px solid var(--danger-light);
        }

        .notification.warning {
            background: var(--warning);
            border-left: 4px solid var(--warning-light);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Sort Indicator */
        .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8em;
            color: white;
        }

        /* Tab Navigation for Charts */
        .chart-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .chart-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
        }

        .chart-tab:hover {
            color: var(--primary);
        }

        .chart-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(52, 152, 219, 0.05);
        }

        .dark .chart-tab.active {
            background: rgba(52, 152, 219, 0.1);
        }

        .chart-tab-content {
            display: none;
        }

        .chart-tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar, .content {
                flex: 1;
                width: 100%;
            }
            
            .sidebar {
                min-width: 100%;
            }
            
            .filter-container {
                max-height: 200px;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .chart-container.sankey {
                height: 450px;
            }
            
            .chart-container.heatmap {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                padding: 15px;
                gap: 15px;
            }
            
            .header {
                font-size: 1.4rem;
                padding: 15px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-value {
                font-size: 1.3rem;
            }
            
            .chart-container {
                height: 300px;
                padding: 15px;
            }
            
            .chart-container.sankey {
                height: 400px;
            }
            
            .chart-container.heatmap {
                height: 350px;
            }
            
            .chart-tabs {
                flex-wrap: wrap;
            }
            
            .chart-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Footer note */
        .footer-note {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 20px;
            border-top: 1px solid var(--gray-light);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        üìä Thu Chi C√° Nh√¢n 2025 v·ªõi Gemini AI
    </div>

    <!-- Main Layout: 1/4 left for filters, 3/4 right for data -->
    <div class="main-layout">
        <!-- Left Sidebar - Filters (1/4) -->
        <div class="sidebar">
            <!-- Search Card -->
            <div class="filter-card">
                <h3>T√¨m Ki·∫øm</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm giao d·ªãch...">
                </div>
            </div>

            <!-- Month/Year Filter Card -->
            <div class="filter-card">
                <h3>üìÖ L·ªçc Theo Th√°ng/NƒÉm</h3>
                <div id="monthFilterContainer" class="filter-container" data-filter-type="month">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Category Filter Card -->
            <div class="filter-card">
                <h3>üìÅ L·ªçc Theo Danh M·ª•c</h3>
                <div id="categoryFilterContainer" class="filter-container" data-filter-type="category">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Wallet Filter Card -->
            <div class="filter-card">
                <h3>üí∞ L·ªçc Theo V√≠ Ti·ªÅn</h3>
                <div id="walletFilterContainer" class="filter-container" data-filter-type="wallet">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- Custom Prompt Card -->
            <div class="filter-card">
                <h3>üéØ T√πy Ch·ªânh Ph√¢n T√≠ch AI</h3>
                <div class="prompt-box">
                    <textarea id="customPrompt" placeholder="V√≠ d·ª•: Ph√¢n t√≠ch chi ti√™u ƒÉn u·ªëng c·ªßa t√¥i v√† ƒë∆∞a ra 3 c√°ch ti·∫øt ki·ªám..."></textarea>
                </div>
            </div>

            <!-- Action Buttons Card -->
            <div class="filter-card">
                <h3>‚ö° Thao T√°c</h3>
                <div class="action-buttons">
                    <button class="btn btn-warning" id="analyzeBtn">
                        <span>‚ú® Ph√¢n t√≠ch v·ªõi AI</span>
                        <div id="loadingIndicator" class="loading" style="display: none;"></div>
                    </button>
                    <button class="btn btn-success" id="exportBtn">
                        üìä Xu·∫•t Excel
                    </button>
                    <button class="btn btn-primary" id="refreshBtn">
                        üîÑ L√†m m·ªõi d·ªØ li·ªáu
                    </button>
                    <button class="btn btn-dark" id="darkModeBtn">
                        üåô Ch·∫ø ƒë·ªô t·ªëi
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Content - Data Display (3/4) -->
        <div class="content">
            <!-- Wallet Summary Card -->
            <div class="content-card">
                <h3>üí∞ T·ªïng K·∫øt Theo V√≠</h3>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>T√™n V√≠</th>
                                <th>T·ªïng Thu</th>
                                <th>T·ªïng Chi</th>
                                <th class="money-header">Ti·ªÅn C√≤n</th>
                            </tr>
                        </thead>
                        <tbody id="walletTbody">
                            <tr><td colspan="4" class="empty-state">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                        <tfoot id="walletTotalRow">
                            <!-- Total row will be added by JavaScript -->
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Dashboard KPI -->
            <div class="content-card">
                <h3>üìä Dashboard Ch·ªâ S·ªë KPI</h3>
                <div class="kpi-grid" id="kpiDashboard">
                    <div class="kpi-item">
                        <div class="kpi-icon">üí∞</div>
                        <div class="kpi-content">
                            <div class="kpi-label">Chi ti√™u TB/th√°ng</div>
                            <div class="kpi-value" id="avgMonthlyExpense">ƒêang t√≠nh...</div>
                        </div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-icon">üíµ</div>
                        <div class="kpi-content">
                            <div class="kpi-label">Thu nh·∫≠p TB/th√°ng</div>
                            <div class="kpi-value" id="avgMonthlyIncome">ƒêang t√≠nh...</div>
                        </div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-icon">üìà</div>
                        <div class="kpi-content">
                            <div class="kpi-label">Xu h∆∞·ªõng 6 th√°ng</div>
                            <div class="kpi-value" id="trendStatus">ƒêang ph√¢n t√≠ch...</div>
                        </div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-icon">üî•</div>
                        <div class="kpi-content">
                            <div class="kpi-label">Top 3 chi ti√™u</div>
                            <div class="kpi-list" id="top3Expense">ƒêang t√≠nh...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category & Monthly Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <!-- Category Summary -->
                <div class="content-card">
                    <h3>üìÅ T·ªïng K·∫øt Theo Danh M·ª•c</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Danh M·ª•c</th>
                                    <th>T·ªïng Thu</th>
                                    <th>T·ªïng Chi</th>
                                    <th class="money-header">Ti·ªÅn C√≤n</th>
                                </tr>
                            </thead>
                            <tbody id="categoryTbody">
                                <tr><td colspan="4" class="empty-state">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="content-card">
                    <h3>üìÖ D√≤ng Ti·ªÅn Theo Th√°ng</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Th√°ng/NƒÉm</th>
                                    <th>Ti·ªÅn Thu</th>
                                    <th>Ti·ªÅn Chi</th>
                                    <th class="money-header">C√≤n L·∫°i</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyTbody">
                                <tr><td colspan="4" class="empty-state">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Advanced Charts Section with Tabs -->
            <div class="content-card">
                <h3>üìà Ph√¢n T√≠ch Bi·ªÉu ƒê·ªì N√¢ng Cao</h3>
                
                <!-- Tab Navigation -->
                <div class="chart-tabs">
                    <div class="chart-tab active" data-tab="basic">Bi·ªÉu ƒê·ªì C∆° B·∫£n</div>
                    <div class="chart-tab" data-tab="trend">Xu H∆∞·ªõng Th·ªùi Gian</div>
                    <div class="chart-tab" data-tab="comparison">So S√°nh Th√°ng</div>
                    <div class="chart-tab" data-tab="flow">D√≤ng Ti·ªÅn Sankey</div>
                    <div class="chart-tab" data-tab="heatmap">Heatmap Chi Ti√™u</div>
                </div>

                <!-- Tab Contents -->
                <div class="chart-tab-content active" id="tab-basic">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">üìà Thu Theo Danh M·ª•c</div>
                            <div class="chart-wrapper">
                                <canvas id="chartThu"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">üìâ Chi Theo Danh M·ª•c</div>
                            <div class="chart-wrapper">
                                <canvas id="chartChi"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-tab-content" id="tab-trend">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">üìä Xu H∆∞·ªõng Thu Chi Theo Th√°ng</div>
                            <div class="chart-wrapper">
                                <canvas id="chartTrend"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-tab-content" id="tab-comparison">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">üìä So S√°nh Thu/Chi Theo Th√°ng</div>
                            <div class="chart-wrapper">
                                <canvas id="chartComparison"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-tab-content" id="tab-flow">
                    <div class="chart-container sankey">
                        <div class="chart-title">üåä D√≤ng Ti·ªÅn Sankey (V√≠ ‚Üí Danh M·ª•c)</div>
                        <div class="chart-wrapper">
                            <canvas id="chartSankey"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-tab-content" id="tab-heatmap">
                    <div class="chart-container heatmap">
                        <div class="chart-title">üî• M·ª©c ƒê·ªô Chi Ti√™u Theo Ng√†y Trong Tu·∫ßn</div>
                        <div class="chart-wrapper">
                            <canvas id="chartHeatmap"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Transactions -->
            <div class="content-card">
                <h3>üìã Chi Ti·∫øt Giao D·ªãch <span style="font-size: 0.9rem; color: var(--gray);">(S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t)</span></h3>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ng√†y <span class="sort-indicator">‚ñº</span></th>
                                <th>Lo·∫°i</th>
                                <th>TK Thu</th>
                                <th>TK Chi</th>
                                <th>Danh M·ª•c</th>
                                <th>Chi Ti·∫øt</th>
                                <th class="money-header">S·ªë Ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <tr><td colspan="7" class="empty-state">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI Analysis Box -->
            <div id="analysisBox" class="analysis-box" style="display: none;">
                <div class="analysis-header">
                    <h3>‚ú® Ph√¢n T√≠ch & G·ª£i √Ω T·ª´ Gemini AI</h3>
                </div>
                <div class="analysis-content" id="analysisText">
                    B·∫•m n√∫t "Ph√¢n t√≠ch v·ªõi AI" ƒë·ªÉ nh·∫≠n ph√¢n t√≠ch th√¥ng minh t·ª´ Gemini AI.
                </div>
                <div class="analysis-actions">
                    <button class="btn btn-primary btn-sm" id="readAnalysisBtn" style="display: none;">
                        üîä Nghe ph√¢n t√≠ch
                    </button>
                    <audio id="audioPlayer" controls style="display:none; width: 100%;"></audio>
                </div>
            </div>

            <!-- Footer Note -->
            <div class="footer-note">
                ·ª®ng d·ª•ng Thu Chi C√° Nh√¢n 2025 v·ªõi Gemini AI | D·ªØ li·ªáu ƒë∆∞·ª£c ƒë·ªìng b·ªô v√† l∆∞u tr·ªØ c·ª•c b·ªô
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notif" class="notification"></div>

    <!-- JavaScript Code -->
    <script>
        // C·∫•u h√¨nh API v√† bi·∫øn to√†n c·ª•c
        const GEMINI_API_KEY = "AIzaSyCoQBuMPg_HuZEvPG6R3dHIr";
        const GEMINI_LLM_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        const GEMINI_TTS_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        const API_URL = "https://script.google.com/macros/s/AKfycbyL4KLJWSslGe5EHCJ6W8dfsIAwV7SptwYEoqBjV0kdXMoWZ2WljMMj8Moyyp0rbBvKbQ/exec";
        let data = [], chartThu = null, chartChi = null;
        let chartTrend = null, chartComparison = null, chartSankey = null, chartHeatmap = null;
        let audioContext = null;
        let currentAnalysisText = "";

        // Bi·∫øn ƒë·ªÉ theo d√µi tr·∫°ng th√°i s·∫Øp x·∫øp
        let sortOrder = 'desc';

        // --- UTILITY FUNCTIONS ---

        const notify = (msg, type='success') => {
            const n = document.getElementById('notif');
            n.textContent = msg; 
            n.className = `notification ${type} show`;
            setTimeout(() => n.className = 'notification', 3000);
        };
        
        const formatMoney = v => {
            const num = Number(v) || 0;
            if (num < 0) {
                return '-' + Math.abs(num).toLocaleString('vi-VN') + ' ‚Ç´';
            }
            return num.toLocaleString('vi-VN') + ' ‚Ç´';
        };

        const getAbsoluteAmount = (r) => Math.abs(Number(r.so_tien || r.so_tien_am || 0));

        // H√†m chuy·ªÉn ƒë·ªïi Base64 sang ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // H√†m chuy·ªÉn ƒë·ªïi PCM sang WAV Blob
        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2;

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            let offset = 0;

            view.setUint32(offset, 0x52494646, false); offset += 4;
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4;
            view.setUint32(offset, 0x57415645, false); offset += 4;

            view.setUint32(offset, 0x666d7420, false); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4;
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            view.setUint16(offset, bytesPerSample * 8, true); offset += 2;

            view.setUint32(offset, 0x64617461, false); offset += 4;
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4;

            const pcmView = new Int16Array(buffer, offset);
            pcmView.set(pcm16);

            return new Blob([buffer], { type: 'audio/wav' });
        }

        // H√†m th·ª±c hi·ªán cu·ªôc g·ªçi API TTS
        async function speakAnalysis(text) {
            document.getElementById('readAnalysisBtn').disabled = true;
            document.getElementById('readAnalysisBtn').textContent = "ƒêang t·∫°o √¢m thanh...";
            
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: `ƒê·ªçc to c√¢u sau b·∫±ng gi·ªçng n·ªØ t√≠nh, ·∫•m √°p, s·ª≠ d·ª•ng ti·∫øng Vi·ªát: ${text}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Achird" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(GEMINI_TTS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                            const rateMatch = mimeType.match(/rate=(\d+)/);
                            const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                            
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            
                            const audioPlayer = document.getElementById('audioPlayer');
                            audioPlayer.src = audioUrl;
                            audioPlayer.style.display = 'block';
                            audioPlayer.play();
                            
                            notify('ƒê√£ t·∫°o v√† ƒëang ph√°t √¢m thanh!', 'success');
                            document.getElementById('readAnalysisBtn').textContent = "üîä ƒê·ªçc L·∫°i";
                            return;
                        } else {
                            throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu √¢m thanh h·ª£p l·ªá t·ª´ API.");
                        }
                    } catch (e) {
                        console.error("TTS API call failed:", e);
                        if (i === maxRetries - 1) throw e;
                    }
                }
            } catch (e) {
                notify('L·ªói: Kh√¥ng th·ªÉ t·∫°o √¢m thanh. ' + (e.message || 'Ki·ªÉm tra console.'), 'error');
                document.getElementById('audioPlayer').style.display = 'none';
            } finally {
                document.getElementById('readAnalysisBtn').disabled = false;
            }
        }

        // H√†m s·∫Øp x·∫øp ng√†y CH√çNH X√ÅC - x·ª≠ l√Ω c·∫£ ƒë·ªãnh d·∫°ng dd/mm/yyyy
        function sortByDate(arr, order = 'desc') {
            return [...arr].sort((a, b) => {
                // H√†m chuy·ªÉn ƒë·ªïi ng√†y dd/mm/yyyy th√†nh timestamp
                const getTimestamp = (dateStr) => {
                    if (!dateStr) return 0;
                    
                    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng dd/mm/yyyy
                    if (typeof dateStr === 'string') {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1; // Th√°ng t·ª´ 0-11
                            const year = parseInt(parts[2], 10);
                            
                            // Ki·ªÉm tra xem c√≥ ph·∫£i s·ªë h·ª£p l·ªá kh√¥ng
                            if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                                return new Date(year, month, day).getTime();
                            }
                        }
                        
                        // Th·ª≠ parse tr·ª±c ti·∫øp n·∫øu kh√¥ng ph·∫£i dd/mm/yyyy
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            return date.getTime();
                        }
                    }
                    
                    return 0;
                };
                
                const timeA = getTimestamp(a.ngay);
                const timeB = getTimestamp(b.ngay);
                
                if (order === 'desc') {
                    return timeB - timeA; // M·ªõi nh·∫•t l√™n ƒë·∫ßu
                } else {
                    return timeA - timeB; // C≈© nh·∫•t l√™n ƒë·∫ßu
                }
            });
        }

        // H√†m l·∫•y th√°ng hi·ªán t·∫°i (ƒë·ªãnh d·∫°ng: YYYY | MM)
        function getCurrentMonthYear() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            return `${year} | ${month}`;
        }

        // H√†m chuy·ªÉn ƒë·ªïi t√™n th√°ng
        function getMonthName(monthStr) {
            const [year, month] = monthStr.split(' | ');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        // H√†m l·∫•y t√™n ng√†y trong tu·∫ßn t·ª´ ng√†y
        function getDayOfWeek(dateStr) {
            if (!dateStr) return 'Unknown';
            
            try {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    
                    const date = new Date(year, month, day);
                    const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                    return days[date.getDay()];
                }
            } catch (e) {
                console.error('Error parsing date:', dateStr, e);
            }
            return 'Unknown';
        }

        // --- DASHBOARD KPI FUNCTIONS ---
        function updateKPIDashboard(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                document.getElementById('avgMonthlyExpense').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                document.getElementById('avgMonthlyIncome').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                document.getElementById('trendStatus').textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                document.getElementById('top3Expense').innerHTML = "Kh√¥ng c√≥ d·ªØ li·ªáu";
                return;
            }

            // 1. T√≠nh chi ti√™u trung b√¨nh h√†ng th√°ng
            const monthlyExpenses = {};
            const monthlyIncomes = {};
            
            filteredData.forEach(r => {
                const monthKey = r.nam_thang ? String(r.nam_thang).trim() : null;
                if (!monthKey || monthKey === 'Kh√¥ng r√µ' || monthKey === ' ') return;
                
                const amount = getAbsoluteAmount(r);
                
                if (r.thu_chi === 'CHI') {
                    monthlyExpenses[monthKey] = (monthlyExpenses[monthKey] || 0) + amount;
                } else if (r.thu_chi === 'THU') {
                    monthlyIncomes[monthKey] = (monthlyIncomes[monthKey] || 0) + amount;
                }
            });
            
            // T√≠nh trung b√¨nh
            const totalMonths = Object.keys(monthlyExpenses).length;
            const totalExpense = Object.values(monthlyExpenses).reduce((sum, val) => sum + val, 0);
            const avgMonthlyExpense = totalMonths > 0 ? totalExpense / totalMonths : 0;
            
            const totalIncome = Object.values(monthlyIncomes).reduce((sum, val) => sum + val, 0);
            const avgMonthlyIncome = totalMonths > 0 ? totalIncome / totalMonths : 0;
            
            // Hi·ªÉn th·ªã
            document.getElementById('avgMonthlyExpense').textContent = formatMoney(avgMonthlyExpense);
            document.getElementById('avgMonthlyIncome').textContent = formatMoney(avgMonthlyIncome);
            
            // 2. Top 3 danh m·ª•c chi ti√™u nhi·ªÅu nh·∫•t
            const categoryExpenses = {};
            
            filteredData.forEach(r => {
                if (r.thu_chi === 'CHI') {
                    const category = r.danh_muc ? String(r.danh_muc).trim() : 'Kh√¥ng ph√¢n lo·∫°i';
                    const amount = getAbsoluteAmount(r);
                    categoryExpenses[category] = (categoryExpenses[category] || 0) + amount;
                }
            });
            
            // S·∫Øp x·∫øp v√† l·∫•y top 3
            const sortedCategories = Object.entries(categoryExpenses)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            const top3Html = sortedCategories.map(([category, amount], index) => 
                `<div>${index + 1}. ${category}: <strong>${formatMoney(amount)}</strong></div>`
            ).join('');
            
            document.getElementById('top3Expense').innerHTML = top3Html || "Kh√¥ng c√≥ chi ti√™u";
            
            // 3. Xu h∆∞·ªõng thu chi 6 th√°ng g·∫ßn nh·∫•t
            const allMonths = [...new Set(Object.keys(monthlyExpenses).concat(Object.keys(monthlyIncomes)))];
            const sortedMonths = allMonths.sort().reverse().slice(0, 6); // 6 th√°ng g·∫ßn nh·∫•t
            
            if (sortedMonths.length >= 2) {
                // L·∫•y d·ªØ li·ªáu 2 th√°ng g·∫ßn nh·∫•t ƒë·ªÉ so s√°nh
                const recentMonths = sortedMonths.slice(0, 2);
                
                const expense1 = monthlyExpenses[recentMonths[0]] || 0;
                const expense2 = monthlyExpenses[recentMonths[1]] || 0;
                const income1 = monthlyIncomes[recentMonths[0]] || 0;
                const income2 = monthlyIncomes[recentMonths[1]] || 0;
                
                // T√≠nh % thay ƒë·ªïi
                const expenseChange = expense2 > 0 ? ((expense1 - expense2) / expense2 * 100) : 0;
                const incomeChange = income2 > 0 ? ((income1 - income2) / income2 * 100) : 0;
                
                let trendText = "";
                
                if (expenseChange < -10 && incomeChange > 10) {
                    trendText = "üìà C·∫£i thi·ªán t·ªët";
                } else if (expenseChange < 0 && incomeChange > 0) {
                    trendText = "‚ÜóÔ∏è ƒêang c·∫£i thi·ªán";
                } else if (expenseChange > 10 && incomeChange < -10) {
                    trendText = "üìâ C·∫ßn xem x√©t";
                } else if (expenseChange > 0 && incomeChange < 0) {
                    trendText = "‚ÜòÔ∏è Gi·∫£m s√∫t";
                } else {
                    trendText = "‚û°Ô∏è ·ªîn ƒë·ªãnh";
                }
                
                // Th√™m chi ti·∫øt s·ªë %
                const detailText = `Chi: ${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}%, Thu: ${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}%`;
                
                document.getElementById('trendStatus').innerHTML = `
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">${trendText}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">${detailText}</div>
                `;
            } else {
                document.getElementById('trendStatus').textContent = "C·∫ßn th√™m d·ªØ li·ªáu";
            }
        }

        // --- NEW CHART FUNCTIONS ---
        
        // 1. Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng - Xu h∆∞·ªõng thu chi theo th·ªùi gian
        function renderTrendChart(filteredData) {
            const ctx = document.getElementById('chartTrend');
            if (chartTrend) chartTrend.destroy();
            
            const monthlyData = {};
            
            filteredData.forEach(r => {
                const monthKey = r.nam_thang ? String(r.nam_thang).trim() : null;
                if (!monthKey || monthKey === 'Kh√¥ng r√µ' || monthKey === ' ') return;
                
                const amount = getAbsoluteAmount(r);
                
                if (!monthlyData[monthKey]) monthlyData[monthKey] = { thu: 0, chi: 0 };
                
                if (r.thu_chi === 'THU') {
                    monthlyData[monthKey].thu += amount;
                } else if (r.thu_chi === 'CHI') {
                    monthlyData[monthKey].chi += amount;
                }
            });
            
            // S·∫Øp x·∫øp theo th√°ng
            const sortedMonths = Object.keys(monthlyData).sort();
            
            const labels = sortedMonths.map(getMonthName);
            const thuData = sortedMonths.map(month => monthlyData[month].thu);
            const chiData = sortedMonths.map(month => monthlyData[month].chi);
            
            const isDark = document.body.classList.contains('dark');
            
            chartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Thu Nh·∫≠p',
                            data: thuData,
                            borderColor: isDark ? '#27ae60' : '#2ecc71',
                            backgroundColor: isDark ? 'rgba(39, 174, 96, 0.1)' : 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Chi Ti√™u',
                            data: chiData,
                            borderColor: isDark ? '#e74c3c' : '#ec7063',
                            backgroundColor: isDark ? 'rgba(231, 76, 60, 0.1)' : 'rgba(236, 112, 99, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += formatMoney(context.raw);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 2. Bi·ªÉu ƒë·ªì c·ªôt - So s√°nh thu/chi gi·ªØa c√°c th√°ng
        function renderComparisonChart(filteredData) {
            const ctx = document.getElementById('chartComparison');
            if (chartComparison) chartComparison.destroy();
            
            const monthlyData = {};
            
            filteredData.forEach(r => {
                const monthKey = r.nam_thang ? String(r.nam_thang).trim() : null;
                if (!monthKey || monthKey === 'Kh√¥ng r√µ' || monthKey === ' ') return;
                
                const amount = getAbsoluteAmount(r);
                
                if (!monthlyData[monthKey]) monthlyData[monthKey] = { thu: 0, chi: 0, net: 0 };
                
                if (r.thu_chi === 'THU') {
                    monthlyData[monthKey].thu += amount;
                    monthlyData[monthKey].net += amount;
                } else if (r.thu_chi === 'CHI') {
                    monthlyData[monthKey].chi += amount;
                    monthlyData[monthKey].net -= amount;
                }
            });
            
            // S·∫Øp x·∫øp theo th√°ng (l·∫•y 12 th√°ng g·∫ßn nh·∫•t)
            const sortedMonths = Object.keys(monthlyData).sort().reverse().slice(0, 12).reverse();
            
            const labels = sortedMonths.map(getMonthName);
            const thuData = sortedMonths.map(month => monthlyData[month].thu);
            const chiData = sortedMonths.map(month => monthlyData[month].chi);
            const netData = sortedMonths.map(month => monthlyData[month].net);
            
            const isDark = document.body.classList.contains('dark');
            
            chartComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Thu Nh·∫≠p',
                            data: thuData,
                            backgroundColor: isDark ? 'rgba(39, 174, 96, 0.7)' : 'rgba(46, 204, 113, 0.7)',
                            borderColor: isDark ? '#27ae60' : '#2ecc71',
                            borderWidth: 1
                        },
                        {
                            label: 'Chi Ti√™u',
                            data: chiData,
                            backgroundColor: isDark ? 'rgba(231, 76, 60, 0.7)' : 'rgba(236, 112, 99, 0.7)',
                            borderColor: isDark ? '#e74c3c' : '#ec7063',
                            borderWidth: 1
                        },
                        {
                            label: 'L·ªùi/L·ªó',
                            data: netData,
                            type: 'line',
                            borderColor: isDark ? '#f39c12' : '#f8c471',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: isDark ? '#f39c12' : '#f8c471',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += formatMoney(context.raw);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 3. Bi·ªÉu ƒë·ªì Sankey - D√≤ng ti·ªÅn t·ª´ v√≠ ‚Üí danh m·ª•c
        function renderSankeyChart(filteredData) {
            const ctx = document.getElementById('chartSankey');
            if (chartSankey) chartSankey.destroy();
            
            // Ch·ªâ l·∫•y d·ªØ li·ªáu CHI ƒë·ªÉ hi·ªÉn th·ªã d√≤ng ti·ªÅn
            const chiData = filteredData.filter(r => r.thu_chi === 'CHI');
            
            if (chiData.length === 0) {
                ctx.parentElement.innerHTML = '<div class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti√™u ƒë·ªÉ hi·ªÉn th·ªã d√≤ng ti·ªÅn</div>';
                return;
            }
            
            // T·∫°o nodes: V√≠ v√† Danh m·ª•c
            const wallets = new Set();
            const categories = new Set();
            const flows = [];
            
            chiData.forEach(r => {
                const wallet = r.tk_chi ? String(r.tk_chi).trim() : 'Kh√¥ng x√°c ƒë·ªãnh';
                const category = r.danh_muc ? String(r.danh_muc).trim() : 'Kh√¥ng ph√¢n lo·∫°i';
                const amount = getAbsoluteAmount(r);
                
                if (amount > 0) {
                    wallets.add(wallet);
                    categories.add(category);
                    
                    flows.push({
                        from: wallet,
                        to: category,
                        flow: amount
                    });
                }
            });
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu cho Sankey
            const nodes = [...wallets, ...categories].map(name => ({ name }));
            
            // Gom nh√≥m flows n·∫øu c√≥ nhi·ªÅu d√≤ng gi·ªØa c√πng c·∫∑p
            const flowMap = new Map();
            flows.forEach(flow => {
                const key = `${flow.from}->${flow.to}`;
                flowMap.set(key, (flowMap.get(key) || 0) + flow.flow);
            });
            
            const sankeyData = {
                datasets: [{
                    label: 'D√≤ng ti·ªÅn t·ª´ V√≠ ‚Üí Danh m·ª•c',
                    data: Array.from(flowMap.entries()).map(([key, flow]) => {
                        const [from, to] = key.split('->');
                        return {
                            from: nodes.findIndex(n => n.name === from),
                            to: nodes.findIndex(n => n.name === to),
                            flow: flow
                        };
                    }),
                    colorFrom: (context) => {
                        const isDark = document.body.classList.contains('dark');
                        const walletIndex = context.dataset.data[context.dataIndex].from;
                        return walletIndex < wallets.size ? 
                            (isDark ? '#3498db' : '#5dade2') : 
                            (isDark ? '#e74c3c' : '#ec7063');
                    },
                    colorTo: (context) => {
                        const isDark = document.body.classList.contains('dark');
                        const categoryIndex = context.dataset.data[context.dataIndex].to;
                        return categoryIndex >= wallets.size ? 
                            (isDark ? '#e74c3c' : '#ec7063') : 
                            (isDark ? '#3498db' : '#5dade2');
                    },
                    borderWidth: 0,
                    borderColor: 'rgba(0,0,0,0)'
                }]
            };
            
            const isDark = document.body.classList.contains('dark');
            
            try {
                chartSankey = new Chart(ctx, {
                    type: 'sankey',
                    data: sankeyData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const from = nodes[context.raw.from].name;
                                        const to = nodes[context.raw.to].name;
                                        return `${from} ‚Üí ${to}: ${formatMoney(context.raw.flow)}`;
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 20,
                                bottom: 20,
                                left: 20,
                                right: 20
                            }
                        },
                        color: isDark ? '#e0e0e0' : '#333333',
                        font: {
                            size: 12,
                            family: "'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif"
                        }
                    }
                });
            } catch (e) {
                console.error('Error creating Sankey chart:', e);
                ctx.parentElement.innerHTML = '<div class="empty-state">Kh√¥ng th·ªÉ t·∫°o bi·ªÉu ƒë·ªì Sankey. D·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng ph√π h·ª£p.</div>';
            }
        }
        
        // 4. Heatmap - M·ª©c ƒë·ªô chi ti√™u theo ng√†y trong tu·∫ßn
        function renderHeatmapChart(filteredData) {
            const ctx = document.getElementById('chartHeatmap');
            if (chartHeatmap) chartHeatmap.destroy();
            
            // Ch·ªâ l·∫•y d·ªØ li·ªáu CHI
            const chiData = filteredData.filter(r => r.thu_chi === 'CHI');
            
            if (chiData.length === 0) {
                ctx.parentElement.innerHTML = '<div class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti√™u ƒë·ªÉ hi·ªÉn th·ªã heatmap</div>';
                return;
            }
            
            // T·∫°o d·ªØ li·ªáu heatmap: 7 ng√†y trong tu·∫ßn
            const daysOfWeek = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            const dayData = Array(7).fill(0);
            const dayCount = Array(7).fill(0);
            
            chiData.forEach(r => {
                const dayName = getDayOfWeek(r.ngay);
                const dayIndex = daysOfWeek.indexOf(dayName);
                
                if (dayIndex !== -1) {
                    const amount = getAbsoluteAmount(r);
                    dayData[dayIndex] += amount;
                    dayCount[dayIndex]++;
                }
            });
            
            // T√≠nh trung b√¨nh chi ti√™u theo ng√†y
            const avgData = dayData.map((total, index) => 
                dayCount[index] > 0 ? total / dayCount[index] : 0
            );
            
            // T√¨m gi√° tr·ªã l·ªõn nh·∫•t ƒë·ªÉ chu·∫©n h√≥a m√†u
            const maxValue = Math.max(...avgData.filter(v => !isNaN(v)));
            
            const isDark = document.body.classList.contains('dark');
            
            chartHeatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: daysOfWeek,
                    datasets: [{
                        label: 'Chi ti√™u trung b√¨nh',
                        data: avgData,
                        backgroundColor: avgData.map(value => {
                            if (value === 0) return isDark ? '#2c3e50' : '#ecf0f1';
                            
                            const intensity = maxValue > 0 ? value / maxValue : 0;
                            
                            if (isDark) {
                                // Dark mode: t·ª´ xanh nh·∫°t ƒë·∫øn ƒë·ªè ƒë·∫≠m
                                if (intensity < 0.3) return 'rgba(52, 152, 219, 0.6)';
                                if (intensity < 0.6) return 'rgba(243, 156, 18, 0.7)';
                                return 'rgba(231, 76, 60, 0.8)';
                            } else {
                                // Light mode: t·ª´ xanh nh·∫°t ƒë·∫øn ƒë·ªè ƒë·∫≠m
                                if (intensity < 0.3) return 'rgba(52, 152, 219, 0.4)';
                                if (intensity < 0.6) return 'rgba(243, 156, 18, 0.6)';
                                return 'rgba(231, 76, 60, 0.7)';
                            }
                        }),
                        borderColor: avgData.map(value => {
                            if (value === 0) return isDark ? '#34495e' : '#bdc3c7';
                            
                            const intensity = maxValue > 0 ? value / maxValue : 0;
                            
                            if (isDark) {
                                if (intensity < 0.3) return '#3498db';
                                if (intensity < 0.6) return '#f39c12';
                                return '#e74c3c';
                            } else {
                                if (intensity < 0.3) return '#2980b9';
                                if (intensity < 0.6) return '#d68910';
                                return '#c0392b';
                            }
                        }),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const day = daysOfWeek[context.dataIndex];
                                    const value = context.raw;
                                    const count = dayCount[context.dataIndex];
                                    
                                    if (value === 0) {
                                        return `${day}: Kh√¥ng c√≥ chi ti√™u`;
                                    }
                                    
                                    return `${day}: ${formatMoney(value)} (${count} giao d·ªãch)`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: isDark ? '#e0e0e0' : '#333333',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: function(value, context) {
                                if (value === 0) return '';
                                
                                if (value >= 1000000) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return (value / 1000).toFixed(0) + 'K';
                                }
                                return Math.round(value).toLocaleString();
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e0e0e0' : '#333333',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // --- FILTER & RENDER LOGIC ---

        function handleFilterClick(event) {
            const chip = event.target.closest('.filter-chip');
            if (!chip) return;
            
            chip.classList.toggle('selected');
            document.getElementById('analysisBox').style.display = 'none';
            renderAll();
        }
        
        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            const selectedChips = container.querySelectorAll('.filter-chip.selected');
            return Array.from(selectedChips).map(chip => chip.getAttribute('data-value'));
        }

        function getFilteredData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const selectedMonths = getSelectedValues('monthFilterContainer');
            const selectedCategories = getSelectedValues('categoryFilterContainer');
            const selectedWallets = getSelectedValues('walletFilterContainer');

            let filtered = data.slice(); 

            if (selectedMonths.length > 0) {
                filtered = filtered.filter(r => {
                    const monthYear = String(r.nam_thang || '').trim();
                    return selectedMonths.includes(monthYear);
                });
            }

            if (selectedCategories.length > 0) {
                filtered = filtered.filter(r => {
                    const category = String(r.danh_muc || 'Kh√°c').trim();
                    return selectedCategories.includes(category);
                });
            }
            
            if (selectedWallets.length > 0) {
                filtered = filtered.filter(r => {
                    const tkThu = String(r.tk_thu || '').trim();
                    const tkChi = String(r.tk_chi || '').trim();
                    return selectedWallets.includes(tkThu) || selectedWallets.includes(tkChi);
                });
            }
            
            if (search) {
                filtered = filtered.filter(r => JSON.stringify(Object.values(r)).toLowerCase().includes(search));
            }

            // LU√îN s·∫Øp x·∫øp ng√†y t·ª´ l·ªõn t·ªõi nh·ªè (m·ªõi nh·∫•t l√™n ƒë·∫ßu) - CHO T·∫§T C·∫¢ B·ªò L·ªåC
            filtered = sortByDate(filtered, 'desc');

            return filtered;
        }

        function createFilterChip(value, containerId, isSelected) {
            const chip = document.createElement('div');
            chip.classList.add('filter-chip');
            chip.setAttribute('data-value', value);
            
            if (containerId === 'monthFilterContainer') {
                chip.textContent = value.replace(' | ', ' / ');
            } else {
                chip.textContent = value;
            }

            if (isSelected) {
                chip.classList.add('selected');
            }

            chip.addEventListener('click', handleFilterClick);
            return chip;
        }

        function populateSpecificFilter(containerId, sourceData, fieldName, currentSelections) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const uniqueValues = new Set();
            sourceData.forEach(r => {
                const value = String(r[fieldName] || '').trim();
                if (value && value !== 'TR·ªêNG' && value !== ' ') uniqueValues.add(value);
            });

            const sortedValues = Array.from(uniqueValues);
            if (fieldName === 'nam_thang') {
                sortedValues.sort().reverse(); 
            } else {
                sortedValues.sort();
            }

            sortedValues.forEach(value => {
                const isSelected = currentSelections.includes(value);
                container.appendChild(createFilterChip(value, containerId, isSelected));
            });
        }

        function populateSpecificFilterWallets(containerId, sourceData, currentSelections) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const wallets = new Set();
            sourceData.forEach(r => {
                const tkThu = String(r.tk_thu || '').trim();
                if (tkThu && tkThu !== 'TR·ªêNG' && tkThu !== ' ') wallets.add(tkThu);
                const tkChi = String(r.tk_chi || '').trim();
                if (tkChi && tkChi !== 'TR·ªêNG' && tkChi !== ' ') wallets.add(tkChi);
            });
            
            const sortedWallets = Array.from(wallets).sort();

            sortedWallets.forEach(wallet => {
                const isSelected = currentSelections.includes(wallet);
                container.appendChild(createFilterChip(wallet, containerId, isSelected));
            });
        }

        function updateInterdependentFilterOptions() {
            const allSelections = {
                months: getSelectedValues('monthFilterContainer'),
                categories: getSelectedValues('categoryFilterContainer'),
                wallets: getSelectedValues('walletFilterContainer'),
            };

            let dataForMonthOptions = data.slice();
            if (allSelections.categories.length > 0) {
                dataForMonthOptions = dataForMonthOptions.filter(r => allSelections.categories.includes(String(r.danh_muc || '').trim()));
            }
            if (allSelections.wallets.length > 0) {
                dataForMonthOptions = dataForMonthOptions.filter(r => allSelections.wallets.includes(String(r.tk_thu || '').trim()) || allSelections.wallets.includes(String(r.tk_chi || '').trim()));
            }
            populateSpecificFilter('monthFilterContainer', dataForMonthOptions, 'nam_thang', allSelections.months);

            let dataForCategoryOptions = data.slice();
            if (allSelections.months.length > 0) {
                dataForCategoryOptions = dataForCategoryOptions.filter(r => allSelections.months.includes(String(r.nam_thang || '').trim()));
            }
            if (allSelections.wallets.length > 0) {
                dataForCategoryOptions = dataForCategoryOptions.filter(r => allSelections.wallets.includes(String(r.tk_thu || '').trim()) || allSelections.wallets.includes(String(r.tk_chi || '').trim()));
            }
            populateSpecificFilter('categoryFilterContainer', dataForCategoryOptions, 'danh_muc', allSelections.categories);

            let dataForWalletOptions = data.slice();
            if (allSelections.months.length > 0) {
                dataForWalletOptions = dataForWalletOptions.filter(r => allSelections.months.includes(String(r.nam_thang || '').trim()));
            }
            if (allSelections.categories.length > 0) {
                dataForWalletOptions = dataForWalletOptions.filter(r => allSelections.categories.includes(String(r.danh_muc || '').trim()));
            }
            populateSpecificFilterWallets('walletFilterContainer', dataForWalletOptions, allSelections.wallets);
        }
        
        async function loadData() {
            try {
                const res = await fetch(API_URL + '?action=read');
                const json = await res.json();
                data = json.filter(r => r.sheetName === "CHI_TIEU").map((r,i) => ({...r, id: r.row || i}));
                await localforage.setItem('thuchi_data', data);
                document.getElementById('analysisBox').style.display = 'none';
                
                // T·ª± ƒë·ªông ch·ªçn th√°ng hi·ªán t·∫°i khi load
                autoSelectCurrentMonth();
                
                updateInterdependentFilterOptions();
                renderAll();
                notify('ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t');
            } catch (e) {
                const cached = await localforage.getItem('thuchi_data');
                if (cached) { 
                    data = cached; 
                    
                    // T·ª± ƒë·ªông ch·ªçn th√°ng hi·ªán t·∫°i khi load t·ª´ cache
                    autoSelectCurrentMonth();
                    
                    updateInterdependentFilterOptions();
                    renderAll(); 
                    notify('ƒêang offline'); 
                }
                else notify('Kh√¥ng c√≥ m·∫°ng!', 'error');
            }
        }
        
        // H√†m t·ª± ƒë·ªông ch·ªçn th√°ng hi·ªán t·∫°i
        function autoSelectCurrentMonth() {
            const currentMonth = getCurrentMonthYear();
            const monthContainer = document.getElementById('monthFilterContainer');
            
            // X√≥a t·∫•t c·∫£ selection tr∆∞·ªõc ƒë√≥
            const allMonthChips = monthContainer.querySelectorAll('.filter-chip');
            allMonthChips.forEach(chip => chip.classList.remove('selected'));
            
            // T√¨m v√† ch·ªçn th√°ng hi·ªán t·∫°i n·∫øu c√≥
            const currentMonthChip = monthContainer.querySelector(`.filter-chip[data-value="${currentMonth}"]`);
            if (currentMonthChip) {
                currentMonthChip.classList.add('selected');
            } else {
                // N·∫øu kh√¥ng c√≥ th√°ng hi·ªán t·∫°i, ch·ªçn th√°ng m·ªõi nh·∫•t
                const firstChip = monthContainer.querySelector('.filter-chip');
                if (firstChip) {
                    firstChip.classList.add('selected');
                }
            }
        }

        function renderWalletSummary() {
            const walletData = {};
            const ignoredWalletNames = ['TR·ªêNG', '']; 

            data.forEach(r => {
                const amount = getAbsoluteAmount(r);
                if (amount <= 0) return;

                const tkThu = String(r.tk_thu || '').trim();
                const tkChi = String(r.tk_chi || '').trim();

                if (tkThu && !ignoredWalletNames.includes(tkThu.toUpperCase())) {
                    if (!walletData[tkThu]) walletData[tkThu] = { income: 0, expense: 0, balance: 0 };
                    walletData[tkThu].income += amount;
                }
                
                if (tkChi && !ignoredWalletNames.includes(tkChi.toUpperCase())) {
                    if (!walletData[tkChi]) walletData[tkChi] = { income: 0, expense: 0, balance: 0 };
                    walletData[tkChi].expense += amount;
                }
            });

            const wallets = Object.keys(walletData).sort();
            let totalIncome = 0;
            let totalExpense = 0;
            let totalBalance = 0;

            wallets.forEach(walletName => {
                const w = walletData[walletName];
                w.balance = w.income - w.expense;
                totalIncome += w.income;
                totalExpense += w.expense;
                totalBalance += w.balance;
            });

            const tbody = document.getElementById('walletTbody');
            const tfoot = document.getElementById('walletTotalRow');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            if (!wallets.length) { 
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu v√≠ kh·∫£ d·ª•ng</td></tr>`; 
                return; 
            }

            wallets.forEach(accountName => {
                const w = walletData[accountName];
                const isPositive = w.balance > 0;
                const isZero = w.balance === 0;
                const balanceClass = isPositive ? 'balance-positive' : (isZero ? 'balance-zero' : 'balance-negative');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${accountName}</td>
                    <td class="thu-color">${formatMoney(w.income)}</td>
                    <td class="chi-color">${formatMoney(w.expense)}</td>
                    <td class="money ${balanceClass}">${formatMoney(w.balance)}</td>
                `;
                tbody.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td><strong>T·ªîNG C·ªòNG</strong></td>
                <td class="thu-color"><strong>${formatMoney(totalIncome)}</strong></td>
                <td class="chi-color"><strong>${formatMoney(totalExpense)}</strong></td>
                <td class="money"><strong>${formatMoney(totalBalance)}</strong></td>
            `;
            tfoot.appendChild(totalRow);
        }

        function renderCategorySummary(filteredData) {
            const categoryData = {};
            const ignoredCategoryNames = ['TR·ªêNG', ''];

            filteredData.forEach(r => {
                const cat = r.danh_muc ? String(r.danh_muc).trim() : 'Kh√¥ng ph√¢n lo·∫°i';
                if (ignoredCategoryNames.includes(cat.toUpperCase())) return;

                if (!categoryData[cat]) categoryData[cat] = { income: 0, expense: 0, balance: 0 };
                
                const amount = getAbsoluteAmount(r);

                if (r.thu_chi === 'THU') {
                    categoryData[cat].income += amount;
                } else if (r.thu_chi === 'CHI') {
                    categoryData[cat].expense += amount;
                }
            });
            
            const categories = Object.keys(categoryData).sort();
            categories.forEach(catName => {
                const c = categoryData[catName];
                c.balance = c.income - c.expense;
            });

            const tbody = document.getElementById('categoryTbody');
            tbody.innerHTML = '';

            if (!categories.length) { 
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c theo b·ªô l·ªçc</td></tr>`; 
                return; 
            }

            categories.forEach(catName => {
                const c = categoryData[catName];
                const isPositive = c.balance > 0;
                const isZero = c.balance === 0;
                const balanceClass = isPositive ? 'balance-positive' : (isZero ? 'balance-zero' : 'balance-negative');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${catName}</td>
                    <td class="thu-color">${formatMoney(c.income)}</td>
                    <td class="chi-color">${formatMoney(c.expense)}</td>
                    <td class="money ${balanceClass}">${formatMoney(c.balance)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderMonthlySummary(filteredData) {
    const monthlyData = {};
    
    filteredData.forEach(r => {
        const monthKey = r.nam_thang ? String(r.nam_thang).trim() : 'Kh√¥ng r√µ';
        if (monthKey === 'Kh√¥ng r√µ' || monthKey === ' ') return;
        
        const amount = getAbsoluteAmount(r);

        if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expense: 0, balance: 0 };
        
        if (r.thu_chi === 'THU') {
            monthlyData[monthKey].income += amount;
        } else if (r.thu_chi === 'CHI') {
            monthlyData[monthKey].expense += amount;
        }
    });

    const months = Object.keys(monthlyData).sort().reverse(); 
    
    // T√≠nh t·ªïng c·ªông
    let totalIncome = 0;
    let totalExpense = 0;
    let totalBalance = 0;
    
    months.forEach(monthKey => {
        const m = monthlyData[monthKey];
        m.balance = m.income - m.expense;
        totalIncome += m.income;
        totalExpense += m.expense;
        totalBalance += m.balance;
    });

    const tbody = document.getElementById('monthlyTbody');
    tbody.innerHTML = '';

    if (!months.length) { 
        tbody.innerHTML = `<tr><td colspan="4" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu th√°ng n√†o theo b·ªô l·ªçc</td></tr>`; 
        return; 
    }

    // Hi·ªÉn th·ªã t·ª´ng th√°ng
    months.forEach(monthKey => {
        const m = monthlyData[monthKey];
        const isPositive = m.balance >= 0;
        const balanceClass = isPositive ? 'balance-positive' : 'balance-negative';
        const displayKey = monthKey.replace(' | ', ' / '); 

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${displayKey}</td>
            <td class="thu-color">${formatMoney(m.income)}</td>
            <td class="chi-color">${formatMoney(m.expense)}</td>
            <td class="money ${balanceClass}">${formatMoney(m.balance)}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Th√™m h√†ng t·ªïng c·ªông
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td><strong>T·ªîNG C·ªòNG</strong></td>
        <td class="thu-color"><strong>${formatMoney(totalIncome)}</strong></td>
        <td class="chi-color"><strong>${formatMoney(totalExpense)}</strong></td>
        <td class="money"><strong>${formatMoney(totalBalance)}</strong></td>
    `;
    tbody.appendChild(totalRow);
}
        

        function renderCharts(filteredData) {
            // 1. Bi·ªÉu ƒë·ªì c∆° b·∫£n (Thu/Chi theo danh m·ª•c)
            const thuByCat = {}, chiByCat = {};
            filteredData.forEach(r => {
                const cat = r.danh_muc ? String(r.danh_muc).trim() : 'Kh√°c';
                const tien = r.thu_chi === 'THU' 
                    ? Number(r.so_tien) || 0 
                    : getAbsoluteAmount(r);

                if (r.thu_chi === 'THU') thuByCat[cat] = (thuByCat[cat]||0) + tien;
                else chiByCat[cat] = (chiByCat[cat]||0) + tien;
            });
            
            const isDark = document.body.classList.contains('dark');
            const thuColors = isDark ? 
                ['#27ae60','#2ecc71','#95d600','#1abc9c','#16a085'] :
                ['#27ae60','#52be80','#82e0aa','#abebc6','#d5f5e3'];
            
            const chiColors = isDark ?
                ['#e74c3c','#c0392b','#e67e22','#f39c12','#d35400'] :
                ['#e74c3c','#ec7063','#f1948a','#f5b7b1','#fadbd8'];
            
            if (chartThu) chartThu.destroy();
            chartThu = new Chart(document.getElementById('chartThu'), {
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(thuByCat), 
                    datasets: [{ 
                        data: Object.values(thuByCat), 
                        backgroundColor: thuColors,
                        borderWidth: 1,
                        borderColor: isDark ? '#2c3e50' : '#ffffff'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom', 
                            labels: {
                                font: { size: 11 },
                                color: isDark ? '#e0e0e0' : '#333333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    label += formatMoney(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            if (chartChi) chartChi.destroy();
            chartChi = new Chart(document.getElementById('chartChi'), {
                type: 'doughnut', 
                data: { 
                    labels: Object.keys(chiByCat), 
                    datasets: [{ 
                        data: Object.values(chiByCat), 
                        backgroundColor: chiColors,
                        borderWidth: 1,
                        borderColor: isDark ? '#2c3e50' : '#ffffff'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom', 
                            labels: {
                                font: { size: 11 },
                                color: isDark ? '#e0e0e0' : '#333333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    label += formatMoney(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. C√°c bi·ªÉu ƒë·ªì m·ªõi
            renderTrendChart(filteredData);
            renderComparisonChart(filteredData);
            renderSankeyChart(filteredData);
            renderHeatmapChart(filteredData);
        }
        
        function renderTable(filteredData) {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';
            
            if (!filteredData.length) { 
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state">Kh√¥ng c√≥ giao d·ªãch n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</td></tr>`; 
                return; 
            }
            
            // ƒê√£ ƒë∆∞·ª£c s·∫Øp x·∫øp trong getFilteredData() v·ªõi ng√†y m·ªõi nh·∫•t l√™n ƒë·∫ßu
            filteredData.forEach(r => {
                const tien = r.thu_chi === 'THU' ? r.so_tien : (r.so_tien_am || r.so_tien);
                const tr = document.createElement('tr');
                tr.className = r.thu_chi === 'THU' ? 'thu' : 'chi';
                tr.innerHTML = `
                    <td>${r.ngay}</td>
                    <td><span class="${r.thu_chi === 'THU' ? 'thu-color' : 'chi-color'}">${r.thu_chi}</span></td>
                    <td>${r.tk_thu||''}</td>
                    <td>${r.tk_chi||''}</td>
                    <td>${r.danh_muc||''}</td>
                    <td>${r.chi_tiet||''}</td>
                    <td class="money ${r.thu_chi === 'THU' ? 'thu-color' : 'chi-color'}">${formatMoney(tien)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderAll() {
            updateInterdependentFilterOptions();
            const filteredData = getFilteredData();
            
            renderWalletSummary();
            updateKPIDashboard(filteredData);
            renderCategorySummary(filteredData);
            renderMonthlySummary(filteredData);
            renderCharts(filteredData);
            renderTable(filteredData);
        }

        // --- GEMINI AI FUNCTIONALITY ---
        async function analyzeFinanceData() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const analysisTextElement = document.getElementById('analysisText');
            const analysisBox = document.getElementById('analysisBox');
            const readAnalysisBtn = document.getElementById('readAnalysisBtn');
            const customPromptInput = document.getElementById('customPrompt').value.trim();
            
            analysisTextElement.textContent = "ƒêang ph√¢n t√≠ch d·ªØ li·ªáu... Vui l√≤ng ch·ªù...";
            analysisBox.style.display = 'block';
            readAnalysisBtn.style.display = 'none';
            analyzeBtn.disabled = true;
            loadingIndicator.style.display = 'inline-block';
            
            try {
                const filteredData = getFilteredData();
                if (filteredData.length === 0) {
                    analysisTextElement.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c l·ªçc ƒë·ªÉ ph√¢n t√≠ch. Vui l√≤ng ch·ªçn b·ªô l·ªçc.";
                    notify("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.", 'error');
                    return;
                }

                const monthlyData = {};
                let totalIncome = 0;
                let totalExpense = 0;
                let categoryIncome = {};
                let categoryExpense = {};

                filteredData.forEach(r => {
                    const monthKey = r.nam_thang ? String(r.nam_thang).trim() : 'Kh√¥ng r√µ';
                    const cat = r.danh_muc ? String(r.danh_muc).trim() : 'Kh√¥ng ph√¢n lo·∫°i';
                    const amount = getAbsoluteAmount(r);

                    if (r.thu_chi === 'THU') {
                        totalIncome += amount;
                        categoryIncome[cat] = (categoryIncome[cat] || 0) + amount;
                    } else if (r.thu_chi === 'CHI') {
                        totalExpense += amount;
                        categoryExpense[cat] = (categoryExpense[cat] || 0) + amount;
                    }

                    if (monthKey !== 'Kh√¥ng r√µ') {
                        if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expense: 0 };
                        if (r.thu_chi === 'THU') monthlyData[monthKey].income += amount;
                        else monthlyData[monthKey].expense += amount;
                    }
                });

                let dataSummary = `D·ªØ li·ªáu t√†i ch√≠nh ƒë√£ l·ªçc (Ti·ªÅn t·ªá: VND):\n`;
                dataSummary += `T·ªîNG QUAN: T·ªïng Thu: ${formatMoney(totalIncome)}, T·ªïng Chi: ${formatMoney(totalExpense)}, L·ªùi/L·ªó: ${formatMoney(totalIncome - totalExpense)}\n\n`;

                dataSummary += `CHI THEO DANH M·ª§C (S·∫Øp x·∫øp gi·∫£m d·∫ßn):\n`;
                const sortedExpenseCats = Object.entries(categoryExpense).sort((a, b) => b[1] - a[1]);
                sortedExpenseCats.forEach(([cat, amount]) => {
                    dataSummary += `  - ${cat}: ${formatMoney(amount)}\n`;
                });
                dataSummary += `\n`;

                dataSummary += `THU THEO DANH M·ª§C (S·∫Øp x·∫øp gi·∫£m d·∫ßn):\n`;
                const sortedIncomeCats = Object.entries(categoryIncome).sort((a, b) => b[1] - a[1]);
                sortedIncomeCats.forEach(([cat, amount]) => {
                    dataSummary += `  - ${cat}: ${formatMoney(amount)}\n`;
                });
                dataSummary += `\n`;
                
                dataSummary += `D√íNG TI·ªÄN THEO TH√ÅNG (NƒÉm | Th√°ng, S·∫Øp x·∫øp gi·∫£m d·∫ßn theo th√°ng):\n`;
                const sortedMonths = Object.keys(monthlyData).sort().reverse();
                sortedMonths.forEach(monthKey => {
                    const m = monthlyData[monthKey];
                    dataSummary += `  - ${monthKey.replace(' | ', '/')}: Thu ${formatMoney(m.income)}, Chi ${formatMoney(m.expense)}, L·ªùi/L·ªó ${formatMoney(m.income - m.expense)}\n`;
                });
                
                let userQuery;
                let systemPrompt;
                
                if (customPromptInput) {
                    systemPrompt = "B·∫°n l√† m·ªôt Chuy√™n gia T√†i ch√≠nh c√° nh√¢n. Nhi·ªám v·ª• c·ªßa b·∫°n l√† th·ª±c hi·ªán y√™u c·∫ßu ph√¢n t√≠ch c·ª• th·ªÉ c·ªßa ng∆∞·ªùi d√πng d·ª±a tr√™n d·ªØ li·ªáu t√†i ch√≠nh ƒë∆∞·ª£c cung c·∫•p. Lu√¥n tr·∫£ l·ªùi b·∫±ng Ti·∫øng Vi·ªát, s·ª≠ d·ª•ng c√°c k√Ω t·ª± xu·ªëng d√≤ng ƒë·ªÉ ƒëo·∫°n vƒÉn d·ªÖ ƒë·ªçc. B·∫Øt ƒë·∫ßu b·∫±ng vi·ªác x√°c nh·∫≠n y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng, ƒë∆∞a ra ph√¢n t√≠ch chi ti·∫øt, v√† k·∫øt th√∫c b·∫±ng m·ªôt t√≥m t·∫Øt ng·∫Øn.";
                    userQuery = `D·ªØ li·ªáu t√†i ch√≠nh chi ti·∫øt:\n\n${dataSummary}\n\n=====================\n\nY√äU C·∫¶U PH√ÇN T√çCH C·ª§ TH·ªÇ: ${customPromptInput}`;
                } else {
                    systemPrompt = "B·∫°n l√† m·ªôt Chuy√™n gia T√†i ch√≠nh c√° nh√¢n th√¥ng minh v√† th√¢n thi·ªán. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch d·ªØ li·ªáu thu chi ƒë∆∞·ª£c cung c·∫•p v√† ƒë∆∞a ra m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu v·ªÅ t√¨nh h√¨nh t√†i ch√≠nh hi·ªán t·∫°i (v√≠ d·ª•: Xu h∆∞·ªõng chi ti√™u, c√°c danh m·ª•c chi ti√™u l·ªõn nh·∫•t/b·∫•t th∆∞·ªùng). Sau ƒë√≥, h√£y ƒë∆∞a ra 2-3 l·ªùi khuy√™n t√†i ch√≠nh c·ª• th·ªÉ, d·ªÖ √°p d·ª•ng ƒë·ªÉ c·∫£i thi·ªán t√¨nh h√¨nh. Lu√¥n tr·∫£ l·ªùi b·∫±ng Ti·∫øng Vi·ªát, s·ª≠ d·ª•ng c√°c k√Ω t·ª± xu·ªëng d√≤ng ƒë·ªÉ ƒëo·∫°n vƒÉn d·ªÖ ƒë·ªçc. B·∫Øt ƒë·∫ßu b·∫±ng m·ªôt l·ªùi ch√†o v√† k·∫øt th√∫c b·∫±ng m·ªôt c√¢u ƒë·ªông vi√™n.";
                    userQuery = `H√£y ph√¢n t√≠ch d·ªØ li·ªáu t√†i ch√≠nh sau ƒë√¢y v√† ƒë∆∞a ra l·ªùi khuy√™n:\n\n${dataSummary}`;
                }

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const maxRetries = 5;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(GEMINI_LLM_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const result = await response.json();
                        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (generatedText) {
                            currentAnalysisText = generatedText;
                            analysisTextElement.textContent = generatedText;
                            readAnalysisBtn.style.display = 'block';
                            readAnalysisBtn.textContent = "üîä Nghe ph√¢n t√≠ch";
                            notify("Ph√¢n t√≠ch t·ª´ Gemini AI ƒë√£ s·∫µn s√†ng!", 'success');
                            return;
                        } else {
                            throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi text t·ª´ API.");
                        }
                    } catch (e) {
                        console.error("LLM API call failed:", e);
                        if (i === maxRetries - 1) throw e;
                    }
                }

            } catch (e) {
                analysisTextElement.textContent = `L·ªói ph√¢n t√≠ch: ${e.message}. Vui l√≤ng ki·ªÉm tra console.`;
                notify('L·ªói ph√¢n t√≠ch d·ªØ li·ªáu AI.', 'error');
                readAnalysisBtn.style.display = 'none';
            } finally {
                analyzeBtn.disabled = false;
                loadingIndicator.style.display = 'none';
            }
        }

        // --- EVENT LISTENERS ---

        document.getElementById('refreshBtn').onclick = loadData;
        document.getElementById('analyzeBtn').onclick = analyzeFinanceData;
        document.getElementById('readAnalysisBtn').onclick = () => {
            if (currentAnalysisText) {
                speakAnalysis(currentAnalysisText);
            } else {
                notify("Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ ƒë·ªçc.", 'error');
            }
        };
        
        document.getElementById('exportBtn').onclick = () => {
            const dataToExport = getFilteredData();

            const ws = XLSX.utils.json_to_sheet(dataToExport.map(r=>({Ng√†y:r.ngay,Lo·∫°i:r.thu_chi,'TK Thu':r.tk_thu,'TK Chi':r.tk_chi,'Danh m·ª•c':r.danh_muc,'Chi ti·∫øt':r.chi_tiet,'S·ªë ti·ªÅn':r.thu_chi==='THU'?r.so_tien:r.so_tien_am})));
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "ThuChiDaLoc");
            XLSX.writeFile(wb, `ThuChiDaLoc_${new Date().toISOString().slice(0,10)}.xlsx`);
            notify('ƒê√£ xu·∫•t Excel d·ªØ li·ªáu ƒë√£ l·ªçc');
        };

        document.getElementById('darkModeBtn').onclick = () => {
            document.body.classList.toggle('dark');
            const filteredData = getFilteredData();
            renderCharts(filteredData);
        };
        
        document.getElementById('searchInput').oninput = () => {
            document.getElementById('analysisBox').style.display = 'none'; 
            setTimeout(renderAll, 300);
        }
        
        document.getElementById('customPrompt').oninput = () => {
            document.getElementById('analysisBox').style.display = 'none';
        }
        
        // Click v√†o ti√™u ƒë·ªÅ c·ªôt Ng√†y ƒë·ªÉ ƒë·ªïi h∆∞·ªõng s·∫Øp x·∫øp (t√πy ch·ªçn)
        document.addEventListener('DOMContentLoaded', function() {
            const dateHeader = document.querySelector('.data-table th:first-child');
            if (dateHeader) {
                dateHeader.style.cursor = 'pointer';
                dateHeader.addEventListener('click', function() {
                    sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
                    const indicator = this.querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.textContent = sortOrder === 'desc' ? '‚ñº' : '‚ñ≤';
                    }
                    renderAll();
                    notify(`ƒê√£ s·∫Øp x·∫øp theo ng√†y ${sortOrder === 'desc' ? 'm·ªõi nh·∫•t l√™n ƒë·∫ßu' : 'c≈© nh·∫•t l√™n ƒë·∫ßu'}`);
                });
            }
            
            // Tab switching for charts
            const chartTabs = document.querySelectorAll('.chart-tab');
            chartTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    chartTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.chart-tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    
                    // Force chart resize for active tab
                    setTimeout(() => {
                        const filteredData = getFilteredData();
                        renderCharts(filteredData);
                    }, 100);
                });
            });
        });
        
        (async () => {
            const cached = await localforage.getItem('thuchi_data');
            if (cached) { 
                data = cached; 
                // T·ª± ƒë·ªông ch·ªçn th√°ng hi·ªán t·∫°i khi load t·ª´ cache
                setTimeout(() => {
                    autoSelectCurrentMonth();
                    updateInterdependentFilterOptions();
                    renderAll(); 
                }, 100);
            }
            loadData();
        })();
    </script>
</body>
</html>

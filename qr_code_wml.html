<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Labels ‚Äì Textarea + B·∫£ng + G·ª≠i Google Sheet</title>
  <!-- Primary CDN (synchronous). We'll also have a JS fallback loader just in case this fails. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --gap: 5mm;
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-color: #4b5563;
      --border-color: #e5e7eb;
      --bg-color: #f9fafb;
      --text-color: #111827;
      --success-color: #10b981;
      --error-color: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
    }

    @page { 
      size: A5 portrait; 
      margin: 3mm; /* Gi·∫£m l·ªÅ ƒë·ªÉ t·ªëi ∆∞u kh√¥ng gian */
    }
    @media print {
      body { margin: 0; padding: 0; }
      h1 { display: none !important; }
      #controls, #modeSwitcher, #qrTextDisplay, #datePickerLabel, #datePicker, #runTestsBtn, #testOutput, #sendToSheetBtn { display: none !important; }
      .grid {
        grid-template-columns: repeat(3, 46mm); /* TƒÉng k√≠ch th∆∞·ªõc c·ªôt ƒë·ªÉ v·ª´a A5 */
        grid-template-rows: repeat(5, 38mm); /* TƒÉng k√≠ch th∆∞·ªõc h√†ng */
        gap: 1.5mm; /* Gi·∫£m kho·∫£ng c√°ch ƒë·ªÉ v·ª´a 15 nh√£n */
        padding: 1.5mm;
        page-break-after: always;
        justify-content: center;
      }
      .label {
        width: 46mm;
        height: 38mm;
        padding: 3mm;
        border: 1px solid #d1d5db;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-sm);
        background: white;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        font-size: 10px;
      }
      .qrcode {
        width: 22mm;
        height: 22mm;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        margin-bottom: 2mm;
      }
      .sku {
        font-weight: 600;
        font-size: 11px;
        text-align: left;
        color: var(--text-color);
        margin-bottom: 1mm;
      }
      .desc {
        font-size: 9px;
        text-align: left;
        color: var(--secondary-color);
        margin-bottom: 1mm;
        line-height: 1.2;
      }
      .serial-block {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        font-size: 11px;
        font-weight: 600;
        text-align: right;
        line-height: 1.3;
      }
      .serial-number {
        margin-bottom: 1mm;
        color: var(--primary-color);
      }
      .date, .warehouse {
        font-size: 9px;
        text-align: right;
        color: var(--secondary-color);
      }
      .qr-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 2mm;
      }
    }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      line-height: 1.5;
      color: var(--text-color);
      background-color: var(--bg-color);
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .hidden { display: none !important; }
    .stack { display: grid; gap: 12px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card {
      background: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 16px;
      border: 1px solid var(--border-color);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(5, auto);
      gap: var(--gap);
      padding: var(--gap);
      justify-items: start;
    }
    
    .label {
      width: 100%;
      border: 1px solid var(--border-color);
      padding: 8px;
      box-sizing: border-box;
      display: flex; 
      flex-direction: column; 
      gap: 4px; 
      align-items: flex-start; 
      justify-content: flex-start;
      page-break-inside: avoid;
      border-radius: var(--radius-sm);
      background: white;
    }
    
    .qrcode { 
      width: 60px; 
      height: 60px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
    }
    
    .sku { 
      font-weight: 600; 
      font-size: 12.5px; 
      text-align: left;
      color: var(--text-color);
    }
    
    .serial-block { 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      font-size: 16px; 
      font-weight: 600; 
      line-height: 1.4; 
      text-align: right; 
    }
    
    .serial-number { 
      margin-bottom: 2px;
      color: var(--primary-color);
    }
    
    .date { 
      text-align: right;
      color: var(--secondary-color);
      font-size: 14px;
    }
    
    .warehouse { 
      text-align: right; 
      font-size: 14px; 
      margin-top: 2px;
      color: var(--secondary-color);
    }
    
    .qr-row { 
      display: flex; 
      flex-direction: row; 
      align-items: flex-start; 
      justify-content: space-between; 
      width: 100%; 
    }
    
    .desc { 
      font-size: 10.5px; 
      text-align: left;
      color: var(--secondary-color);
    }

    /* Controls */
    button {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    button:hover {
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-hover);
      box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
      background-color: white;
      color: var(--secondary-color);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background-color: var(--bg-color);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-danger {
      background-color: var(--error-color);
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #dc2626;
    }
    
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-success:hover {
      background-color: #0d9488;
    }

    /* Inputs */
    textarea, input {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    textarea:focus, input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
    }
    
    input[type="date"] {
      height: 36px;
    }
    
    input[type="radio"] {
      margin-right: 6px;
    }

    /* Table input */
    table#inputTable { 
      border-collapse: collapse; 
      width: 100%; 
      margin: 8px 0;
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    table#inputTable th, table#inputTable td { 
      border: 1px solid var(--border-color); 
      padding: 8px 10px; 
      text-align: left;
    }
    
    table#inputTable th {
      background-color: var(--bg-color);
      font-weight: 500;
      font-size: 14px;
    }
    
    table#inputTable input { 
      width: 100%; 
      box-sizing: border-box; 
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
    }
    
    .table-actions { 
      display: flex; 
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Mode switcher */
    #modeSwitcher { 
      margin: 8px 0;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    #modeSwitcher label { 
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    /* Test output */
    #testOutput { 
      border: 1px dashed var(--border-color); 
      padding: 12px; 
      font-size: 13px; 
      white-space: pre-wrap; 
      max-height: 180px; 
      overflow: auto;
      border-radius: var(--radius-sm);
      background-color: white;
    }
    
    #qrTextDisplay {
      width: 100%;
      margin: 8px 0 0 0;
      font-size: 13px;
      padding: 12px;
      border: 1px solid var(--border-color);
      min-height: 120px;
      white-space: pre-wrap;
      overflow-y: auto;
      border-radius: var(--radius-sm);
      background-color: white;
      font-family: 'Courier New', monospace;
    }

    .hint { 
      font-size: 13px; 
      color: var(--secondary-color);
      margin-top: -8px;
    }
    
    .section-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    
    .status-message {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      margin: 8px 0;
      font-size: 14px;
      display: none;
    }
    
    .status-success {
      background-color: #ecfdf5;
      color: var(--success-color);
      border: 1px solid #a7f3d0;
      display: block;
    }
    
    .status-error {
      background-color: #fef2f2;
      color: var(--error-color);
      border: 1px solid #fecaca;
      display: block;
    }
    
    .icon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1 style="margin-bottom: 24px;">T·∫°o nh√£n QR Code</h1>
  
  <div class="card stack" id="controls">
    <!-- Mode Switcher -->
    <div id="modeSwitcher" class="row">
      <strong class="section-title">Ch·∫ø ƒë·ªô nh·∫≠p:</strong>
      <label><input type="radio" name="mode" value="textarea" checked /> Textarea</label>
      <label><input type="radio" name="mode" value="table" /> B·∫£ng</label>
    </div>

    <!-- Textarea mode -->
    <div id="textareaMode" class="stack">
      <label for="inputData" class="section-title">Nh·∫≠p d·ªØ li·ªáu</label>
      <textarea id="inputData" rows="6" placeholder="Nh·∫≠p t·ª´ng d√≤ng theo ƒë·ªãnh d·∫°ng: SKU|T√™n s·∫£n ph·∫©m|S·ªë l∆∞·ª£ng|Kho (tu·ª≥ ch·ªçn)
      
V√≠ d·ª•:
N009-SI-00*1|Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c|3|HH
ABC-123|S·∫£n ph·∫©m m·∫´u|1-5|KHO1"></textarea>
      <div class="hint">M·∫πo: C√≥ th·ªÉ d√πng n√∫t "D√°n t·ª´ textarea" ·ªü ch·∫ø ƒë·ªô B·∫£ng ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu sang d·∫°ng b·∫£ng.</div>
    </div>

    <!-- Table mode -->
    <div id="tableMode" class="stack hidden">
      <label class="section-title">Nh·∫≠p d·ªØ li·ªáu d·∫°ng b·∫£ng</label>
      <div class="table-actions">
        <button type="button" id="addRowBtn" class="btn-secondary">‚ûï Th√™m d√≤ng</button>
        <button type="button" id="clearTableBtn" class="btn-secondary">üßπ X√≥a h·∫øt</button>
        <button type="button" id="pasteFromTextareaBtn" class="btn-secondary">üì• D√°n t·ª´ textarea</button>
      </div>
      <table id="inputTable">
        <thead>
          <tr>
            <th style="width: 22%">SKU</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th style="width: 12%">S·ªë l∆∞·ª£ng</th>
            <th style="width: 12%">Kho</th>
            <th style="width: 6%"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Date row -->
    <div class="row">
      <label for="datePicker" id="datePickerLabel" style="font-weight: 500;">Ng√†y tr√™n nh√£n:</label>
      <input type="date" id="datePicker" />
    </div>

    <!-- Actions row -->
    <div class="row" style="margin-top: 12px;">
      <button id="generateButton" type="button" class="btn-primary">üì¶ T·∫°o m√£ QR</button>
      <button id="printButton" type="button" class="btn-secondary">üñ®Ô∏è In A5 d·ªçc</button>
      <button id="copyQRButton" type="button" class="btn-secondary">üìã Copy m√£ QR</button>
      <button id="sendToSheetBtn" type="button" class="btn-success" title="G·ª≠i d·ªØ li·ªáu sang Google Sheet">üì§ G·ª≠i Google Sheet</button>
      <button id="runTestsBtn" type="button" class="btn-secondary" title="Ch·∫°y ki·ªÉm th·ª≠ n·ªôi b·ªô">üß™ Ch·∫°y test</button>
    </div>

    <!-- Status messages -->
    <div id="statusMessage" class="status-message"></div>

    <!-- QR Text Display -->
    <label class="section-title">Danh s√°ch m√£ QR</label>
    <pre id="qrTextDisplay" placeholder="Danh s√°ch m√£ QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></pre>
    
    <!-- Test Output -->
    <pre id="testOutput" class="hidden"></pre>
  </div>

  <div class="grid" id="labelContainer"></div>

  <script>
    // ====== C·∫§U H√åNH (thay gi√° tr·ªã b√™n d∆∞·ªõi) ======
    // D√°n URL Web App b·∫°n v·ª´a deploy t·∫°i Apps Script v√†o ƒë√¢y
    const WEBAPP_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhsc6_p65kdQxJDoxaW5SMmUTDBrLy0fkftMHiAgDlAaz1t_9WNg3pEjGNqeJQYJe8dxKWXppKmTi40AdqmphDUqKTH-KFP_DG6AOfeZ-eg5SPxdMA-BBSDPHfTYVmIyBhCxfQiP7WSwpNQmWsrrpA5njSpbZoY6nLWKAbzCTZtRO9XvRMNVS7jhxw7km75FzMwExv9eMnQyETjI0Cb80KRJTIDeEscClqGBxLybeP3hptBm8WFXkTOCZSKr5DQTJcByQ-N1hTINctFYfvWbvHSzmDJ7Co0JNOK63m8&lib=MaMZdCsnl_NQ26YddpdBAcY1n0BzfRUfT';
    // ==============================================

    let currentQRData = [];
    let dataCacheForExport = []; // gi·ªØ payload m·ªõi nh·∫•t ƒë·ªÉ g·ª≠i l√™n Google Sheet

    // --- QRCode loader with fallback ---
    const QR_LIB_URLS = [
      // Primary (already included in <head> as well)
      'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js',
      // Fallback from GitHub via jsDelivr
      'https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js'
    ];

    function loadScript(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        let done = false;
        const timer = setTimeout(() => {
          if (!done) {
            done = true; reject(new Error('timeout')); s.remove();
          }
        }, timeoutMs);
        s.src = url;
        s.async = false; // maintain order if needed
        s.onload = () => { if (!done) { done = true; clearTimeout(timer); resolve(); } };
        s.onerror = () => { if (!done) { done = true; clearTimeout(timer); reject(new Error('load error')); } };
        document.head.appendChild(s);
      });
    }

    async function ensureQRCodeLib() {
      if (window.QRCode) return true;
      for (const url of QR_LIB_URLS) {
        try {
          await loadScript(url, 8000);
          if (window.QRCode) return true;
        } catch (e) {
          console.warn('Kh√¥ng th·ªÉ t·∫£i QRCode lib t·ª´', url, e);
        }
      }
      return !!window.QRCode;
    }

    // --- Utilities ---
    function getExcelDateNumber(selectedDateStr) {
      let dateObj;
      if (selectedDateStr) {
        const [year, month, day] = selectedDateStr.split('-').map(Number);
        dateObj = new Date(year, month - 1, day);
      } else {
        const today = new Date();
        dateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      }
      const excelEpoch = new Date(1899, 11, 30);
      const diffTime = dateObj - excelEpoch;
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.round(diffTime / msPerDay);
    }

    function parseQty(qtyStr) {
      if (!qtyStr) return [];
      if (qtyStr.includes('-')) {
        const [start, end] = qtyStr.split('-').map(Number);
        if (isNaN(start) || isNaN(end) || end < start || start <= 0) return [];
        return Array.from({ length: end - start + 1 }, (_, i) => start + i);
      } else {
        const count = parseInt(qtyStr);
        if (isNaN(count) || count <= 0) return [];
        return Array.from({ length: count }, (_, i) => i + 1);
      }
    }

    function currentMode() {
      return document.querySelector('input[name="mode"]:checked').value; // 'textarea' | 'table'
    }

    function addRow(values = { sku: '', name: '', qty: '', wh: '' }) {
      const tbody = document.querySelector('#inputTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${values.sku || ''}" placeholder="VD: N009-SI-00*1" /></td>
        <td><input type="text" value="${values.name || ''}" placeholder="VD: Vung 22 ch·∫£o" /></td>
        <td><input type="text" value="${values.qty || ''}" placeholder="VD: 3 ho·∫∑c 1-5" /></td>
        <td><input type="text" value="${values.wh || ''}" placeholder="VD: HH" /></td>
        <td style="text-align:center"><button type="button" class="delRow btn-secondary" style="padding: 4px 8px;">‚úñ</button></td>
      `;
      tbody.appendChild(tr);
    }

    function clearTable() {
      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
    }

    function importFromTextareaToTable() {
      const raw = document.getElementById('inputData').value.trim();
      if (!raw) return;
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
      clearTable();
      for (const line of lines) {
        const parts = line.split('|');
        const [sku = '', name = '', qty = '', wh = ''] = parts;
        addRow({ sku, name, qty, wh });
      }
      showStatus('ƒê√£ nh·∫≠p d·ªØ li·ªáu t·ª´ textarea v√†o b·∫£ng', 'success');
    }

    function collectDataFromTextarea(excelDate, out) {
      const input = document.getElementById('inputData').value.trim();
      if (!input) return;
      const lines = input.split('\n');
      lines.forEach(line => {
        const parts = line.split('|');
        if (parts.length < 3) return;
        const [sku, name, qtyStr, warehouse = ''] = parts.map(s => s.trim());
        const numbers = parseQty(qtyStr);
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num }));
      });
    }

    function collectDataFromTable(excelDate, out) {
      const rows = document.querySelectorAll('#inputTable tbody tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('input');
        if (cells.length < 4) return;
        const sku = cells[0].value.trim();
        const name = cells[1].value.trim();
        const qtyStr = cells[2].value.trim();
        const warehouse = cells[3].value.trim();
        if (!sku || !name || !qtyStr) return;
        const numbers = parseQty(qtyStr);
        numbers.forEach(num => pushOne(out, { excelDate, sku, name, warehouse, num }));
      });
    }

    function pushOne(out, { excelDate, sku, name, warehouse, num }) {
      const serialDate = `${excelDate}`;
      const serialNum = `${num}`;
      const serialFull = warehouse ? `${serialDate}*${serialNum}*${warehouse}` : `${serialDate}*${serialNum}`;
      const qrText = `${sku}_${serialFull}`;
      currentQRData.push(qrText);
      out.push({
        qrText,
        skuText: sku,
        serialDate,
        serialNum,
        descText: name,
        warehouseText: warehouse
      });
    }

    function renderLabels(data) {
      const container = document.getElementById('labelContainer');
      container.innerHTML = '';
      
      if (data.length === 0) {
        container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--secondary-color);">Ch∆∞a c√≥ d·ªØ li·ªáu nh√£n. Vui l√≤ng nh·∫≠p th√¥ng tin v√† b·∫•m "T·∫°o m√£ QR"</p>';
        return;
      }
      
      data.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'label';

        const serialBlock = document.createElement('div');
        serialBlock.className = 'serial-block';

        const serialNumDiv = document.createElement('div');
        serialNumDiv.className = 'serial-number';
        serialNumDiv.innerText = item.serialNum;

        const dateDiv = document.createElement('div');
        dateDiv.className = 'date';
        dateDiv.innerText = item.serialDate;

        const warehouseDiv = document.createElement('div');
        warehouseDiv.className = 'warehouse';
        warehouseDiv.innerText = item.warehouseText;

        serialBlock.appendChild(serialNumDiv);
        serialBlock.appendChild(dateDiv);
        serialBlock.appendChild(warehouseDiv);

        const qrDiv = document.createElement('div');
        qrDiv.className = 'qrcode';
        qrDiv.id = 'qrcode-' + index;

        const qrRow = document.createElement('div');
        qrRow.className = 'qr-row';
        qrRow.appendChild(qrDiv);
        qrRow.appendChild(serialBlock);

        const skuDiv = document.createElement('div');
        skuDiv.className = 'sku';
        skuDiv.innerText = item.skuText;

        const descDiv = document.createElement('div');
        descDiv.className = 'desc';
        descDiv.innerText = item.descText;

        div.appendChild(qrRow);
        div.appendChild(skuDiv);
        div.appendChild(descDiv);
        container.appendChild(div);

        // Guard: n·∫øu thi·∫øu th∆∞ vi·ªán, tr√°nh throw
        if (window.QRCode) {
          new QRCode(qrDiv, { text: item.qrText, width: 60, height: 60 });
        } else {
          qrDiv.textContent = '(QR kh√¥ng kh·∫£ d·ª•ng)';
          qrDiv.title = item.qrText;
        }
      });
    }

    function showStatus(message, type = 'success') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = `status-message status-${type}`;
      setTimeout(() => {
        el.className = 'status-message';
      }, 5000);
    }

    async function generateLabels() {
      const libOk = await ensureQRCodeLib();
      if (!libOk) {
        showStatus('Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán t·∫°o QR. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau.', 'error');
        return;
      }

      const selectedDateStr = document.getElementById('datePicker').value;
      const excelDate = getExcelDateNumber(selectedDateStr);
      currentQRData = [];
      const data = [];

      if (currentMode() === 'textarea') {
        collectDataFromTextarea(excelDate, data);
      } else {
        collectDataFromTable(excelDate, data);
      }

      if (data.length === 0) {
        showStatus('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ t·∫°o nh√£n. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin nh·∫≠p.', 'error');
        return;
      }

      // c·∫≠p nh·∫≠t cache ƒë·ªÉ g·ª≠i Google Sheet
      dataCacheForExport = data.map(d => ({
        skuText: d.skuText,
        descText: d.descText,
        serialDate: d.serialDate,
        serialNum: d.serialNum,
        warehouseText: d.warehouseText,
        qrText: d.qrText
      }));

      document.getElementById('qrTextDisplay').textContent = currentQRData.join('\n');
      renderLabels(data);
      showStatus(`ƒê√£ t·∫°o ${data.length} nh√£n QR th√†nh c√¥ng!`, 'success');
    }

    async function sendToGoogleSheet() {
      if (!WEBAPP_URL || WEBAPP_URL.includes('YOUR_DEPLOYMENT_ID')) {
        showStatus('Vui l√≤ng c·∫•u h√¨nh WEBAPP_URL v·ªõi URL Web App c·ªßa Google Apps Script.', 'error');
        return;
      }
      if (!Array.isArray(dataCacheForExport) || dataCacheForExport.length === 0) {
        showStatus('Vui l√≤ng t·∫°o QR tr∆∞·ªõc khi g·ª≠i Google Sheet.', 'error');
        return;
      }

      try {
        const btn = document.getElementById('sendToSheetBtn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ ƒêang g·ª≠i...';
        
        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataCacheForExport)
        });
        
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json().catch(() => ({ status: 'ok' }));
        
        if (json.status === 'ok') {
          showStatus(`ƒê√£ g·ª≠i ${dataCacheForExport.length} b·∫£n ghi v√†o Google Sheet th√†nh c√¥ng!`, 'success');
        } else {
          showStatus('Ph·∫£n h·ªìi kh√¥ng nh∆∞ k·ª≥ v·ªçng: ' + JSON.stringify(json), 'error');
        }
      } catch (err) {
        showStatus('L·ªói khi g·ª≠i d·ªØ li·ªáu: ' + err.message + '\n‚Ä¢ Ki·ªÉm tra quy·ªÅn truy c·∫≠p c·ªßa Web App\n‚Ä¢ Ki·ªÉm tra Triggers/Deploy ƒë√∫ng phi√™n b·∫£n', 'error');
      } finally {
        const btn = document.getElementById('sendToSheetBtn');
        btn.disabled = false;
        btn.innerHTML = 'üì§ G·ª≠i Google Sheet';
      }
    }

    // --- Self tests ---
    function arraysEqual(a, b) {
      return Array.isArray(a) && Array.isArray(b) && a.length === b.length && a.every((v, i) => v === b[i]);
    }
    function test(title, ok, details = '') {
      const line = `${ok ? '‚úÖ' : '‚ùå'} ${title}${details ? ' ‚Äî ' + details : ''}`;
      console[ok ? 'log' : 'error'](line);
      return line;
    }
    function runSelfTests() {
      const out = [];
      out.push(test('parseQty("3") => [1,2,3]', arraysEqual(parseQty('3'), [1,2,3])));
      out.push(test('parseQty("1-5") => [1..5]', arraysEqual(parseQty('1-5'), [1,2,3,4,5])));
      out.push(test('parseQty("5-1") => [] (range ng∆∞·ª£c)', arraysEqual(parseQty('5-1'), [])));
      out.push(test('parseQty("0") => []', arraysEqual(parseQty('0'), [])));
      out.push(test('parseQty("-2") => []', arraysEqual(parseQty('-2'), [])));

      out.push(test('Excel serial 1899-12-30 => 0', getExcelDateNumber('1899-12-30') === 0));
      out.push(test('Excel serial 1899-12-31 => 1', getExcelDateNumber('1899-12-31') === 1));
      out.push(test('Excel serial 1900-01-01 => 2', getExcelDateNumber('1900-01-01') === 2));

      out.push(test('QRCode lib available (may be false if offline)', !!window.QRCode));

      const box = document.getElementById('testOutput');
      box.classList.remove('hidden');
      box.textContent = out.join('\n');
      showStatus('ƒê√£ ch·∫°y ki·ªÉm th·ª≠, xem k·∫øt qu·∫£ b√™n d∆∞·ªõi', 'success');
    }

    // --- Event wiring ---
    document.getElementById('generateButton').addEventListener('click', () => { void generateLabels(); });
    document.getElementById('printButton').addEventListener('click', () => window.print());
    document.getElementById('copyQRButton').addEventListener('click', () => {
      if (currentQRData.length === 0) { 
        showStatus('Vui l√≤ng t·∫°o m√£ QR tr∆∞·ªõc ƒë√£!', 'error'); 
        return; 
      }
      const text = currentQRData.join('\n');
      navigator.clipboard.writeText(text).then(() => {
        showStatus(`ƒê√£ copy ${currentQRData.length} m√£ QR v√†o clipboard!`, 'success');
      }, () => { 
        showStatus('Kh√¥ng th·ªÉ copy v√†o clipboard. H√£y th·ª≠ l·∫°i.', 'error');
      });
    });
    document.getElementById('runTestsBtn').addEventListener('click', runSelfTests);
    document.getElementById('sendToSheetBtn').addEventListener('click', () => { void sendToGoogleSheet(); });

    // Switch modes
    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener('change', () => {
        const isTextarea = currentMode() === 'textarea';
        document.getElementById('textareaMode').classList.toggle('hidden', !isTextarea);
        document.getElementById('tableMode').classList.toggle('hidden', isTextarea);
      });
    });

    // Table buttons
    document.getElementById('addRowBtn').addEventListener('click', () => addRow());
    document.getElementById('clearTableBtn').addEventListener('click', clearTable);
    document.getElementById('pasteFromTextareaBtn').addEventListener('click', importFromTextareaToTable);

    // Row delete via event delegation
    document.querySelector('#inputTable tbody').addEventListener('click', (e) => {
      if (e.target.classList.contains('delRow')) {
        e.target.closest('tr').remove();
        showStatus('ƒê√£ x√≥a d√≤ng kh·ªèi b·∫£ng', 'success');
      }
    });

    // Set today's date as default
    document.getElementById('datePicker').valueAsDate = new Date();
    
    // Seed: m·ªôt d√≤ng m·∫´u khi m·ªü b·∫£ng l·∫ßn ƒë·∫ßu
    addRow({ sku: 'N009-SI-00*1', name: 'Vung 22 ch·∫£o s√¢u l√≤ng Engler - m√†u b·∫°c', qty: '3', wh: 'HH' });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>H·ªá th·ªëng Qu·∫£n l√Ω ƒê∆°n h√†ng</title>
  <style>
    /* CSS CHU·∫®N */
    :root {
      --primary-color: #3498db;
      --primary-hover: #2980b9;
      --success-color: #27ae60;
      --success-hover: #219150;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --dark-color: #2c3e50;
      --light-gray: #ecf0f1;
      --medium-gray: #bdc3c7;
      --text-color: #333;
      --border-radius: 8px;
      --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: var(--text-color);
      line-height: 1.5;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      min-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--dark-color);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    /* Tabs Navigation */
    .tabs {
      display: flex;
      background: var(--light-gray);
      border-bottom: 1px solid #ddd;
      overflow-x: auto;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      transition: var(--transition);
      user-select: none;
      white-space: nowrap;
    }

    .tab:hover {
      background: #e0e0e0;
    }

    .tab.active {
      background: #fff;
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
    }

    /* Tabs Content */
    .tab-content {
      display: none;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    /* Controls & Buttons */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 250px;
      outline: none;
      font-size: 14px;
      transition: var(--transition);
    }

    .search-box:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .btn-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: var(--transition);
      color: #fff;
    }

    .btn-primary {
      background-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .btn-success {
      background-color: var(--success-color);
    }

    .btn-success:hover {
      background-color: var(--success-hover);
    }

    .btn:disabled {
      background-color: var(--medium-gray);
      cursor: not-allowed;
    }

    /* Table Styles */
    .table-wrapper {
      overflow-x: auto;
      border: 1px solid #eee;
      border-radius: 4px;
      max-height: 65vh;
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      white-space: nowrap;
    }

    th {
      background: #f8f9fa;
      color: #444;
      font-weight: 600;
      padding: 10px;
      text-align: left;
      border-bottom: 2px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      color: #555;
    }

    tr:hover {
      background-color: #f1f7ff;
    }

    tr.cancelled-order td {
      text-decoration: line-through;
      color: #999;
      background-color: #fff5f5;
    }

    /* Loading & Stats */
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-bottom: 5px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .stats {
      margin-top: 15px;
      display: flex;
      gap: 15px;
      font-size: 13px;
      color: #666;
      background: #fafafa;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #eee;
      flex-wrap: wrap;
    }

    .stats-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stats-badge {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 10px;
      background: #eee;
      font-size: 11px;
    }

    .stats-badge.huy {
      background: #f8d7da;
      color: #721c24;
    }

    /* Split Panels (Tab 2 & 3) */
    .panel-container {
      display: flex;
      gap: 20px;
      height: calc(100vh - 160px);
    }

    .panel {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-left {
      width: 350px;
      flex-shrink: 0;
    }

    .panel-right {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* T·ª∑ l·ªá 1:2 cho Tab 2 */
    #tab2 .panel-left {
      width: auto;
      flex: 1;
    }

    #tab2 .panel-right {
      flex: 2;
    }

    .text-right {
      text-align: right !important;
    }

    /* Styles for Date Grouping */
    .date-group-row {
      background-color: #f8f9fa !important;
      font-weight: bold;
      color: #333;
      pointer-events: none;
    }

    .date-group-row td {
      padding: 10px 15px !important;
      border-bottom: 2px solid #dee2e6 !important;
      font-size: 14px;
    }

    .count-badge {
      display: inline-block;
      background-color: #ced4da;
      color: #495057;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }

    .copy-row-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .copy-row-btn:hover {
      background-color: #e9ecef;
    }

    .panel-header {
      padding: 10px 15px;
      background: #f1f3f5;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .panel-table {
      width: 100%;
      border-collapse: collapse;
    }

    .panel-table th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 5;
      padding: 8px 10px;
      border-bottom: 2px solid #eee;
      text-align: left;
      font-size: 12px;
      color: #666;
    }

    .panel-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #f5f5f5;
      font-size: 13px;
      cursor: pointer;
    }

    .panel-table tr:hover {
      background-color: #f8f9fa;
    }

    .panel-table tr.selected {
      background-color: #e3f2fd;
      border-left: 4px solid var(--primary-color);
    }

    .text-right {
      text-align: right !important;
    }

    .empty-state {
      padding: 30px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    /* Badges */
    .row-xuat {
      color: #2ecc71;
    }

    .row-nhap {
      color: #e67e22;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
    }

    .badge-xuat {
      background-color: #ff822f;
    }

    .badge-nhap {
      background-color: #40ff27;
    }

    .badge-hoan {
      background-color: var(--danger-color);
    }

    .row-empty-date td {
      font-weight: bold;
      background-color: #ffebee;
    }

    /* Pagination for Tab 2 Right Panel */
    .pagination-tab2-right {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #fafafa;
      border-top: 1px solid #eee;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .panel-container {
        flex-direction: column;
        height: auto;
      }

      .panel-left,
      .panel-right {
        width: 100%;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }

      .btn-group {
        width: 100%;
        justify-content: center;
      }

      .pagination-tab2-right {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 4px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }

    .notification.success {
      background-color: var(--success-color);
    }

    .notification.error {
      background-color: var(--danger-color);
    }

    .notification.info {
      background-color: var(--primary-color);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h2>H·ªá th·ªëng Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="tab1">UP_DON_CT + C·ªôt b·ªï sung</div>
      <div class="tab" data-tab="tab2">Qu·∫£n l√Ω ƒê∆°n h√†ng</div>
      <div class="tab" data-tab="tab3">H√†ng Ho√†n</div>
    </div>

    <div id="tab1" class="tab-content active">
      <div class="controls">
        <input type="text" id="searchInput" class="search-box" placeholder="üîç T√¨m ki·∫øm...">
        <div class="btn-group" style="align-items: center;">
          <button class="btn btn-primary" id="prevDayBtn" style="padding: 8px 12px; font-weight: bold;">‚Üê</button>
          <input type="date" id="dateFilter" class="search-box" style="max-width:160px; margin: 0 5px;">
          <button class="btn btn-primary" id="nextDayBtn" style="padding: 8px 12px; font-weight: bold;">‚Üí</button>
        </div>

        <div style="display: flex; align-items: center; gap: 5px;">
          <label for="rowsPerPage" style="font-size: 14px; font-weight: 600;">D√≤ng/Trang:</label>
          <select id="rowsPerPage" class="search-box" style="width: auto; min-width: 80px;">
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="300">300</option>
            <option value="500">500</option>
            <option value="99999">T·∫•t c·∫£</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="refreshBtn"><span>üîÑ</span> L√†m m·ªõi</button>
          <button class="btn btn-success" id="exportCsvBtn"><span>üìä</span> Xu·∫•t CSV</button>
          <button class="btn btn-success" id="exportExcelBtn"><span>üìã</span> Xu·∫•t Excel</button>
        </div>

        <div id="paginationControls" class="btn-group" style="margin-left: auto;">
          <button class="btn btn-primary" id="prevPageBtn" disabled>‚Üê Tr∆∞·ªõc</button>
          <span id="pageInfo"
            style="padding: 8px 15px; font-weight: 600; background: #ecf0f1; border-radius: 4px;">Trang 0 / 0</span>
          <button class="btn btn-primary" id="nextPageBtn" disabled>Sau ‚Üí</button>
        </div>
      </div>

      <div id="loadingDiv" class="loading"><span class="spinner"></span>
        <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
      </div>
      <div id="errorDiv" class="error" style="display:none; color: red; text-align:center; margin-bottom:10px;"></div>

      <div class="table-wrapper" id="tableWrapper" style="display:none;">
        <table id="data-table">
          <thead>
            <tr id="header-row"></tr>
          </thead>
          <tbody id="data-body"></tbody>
        </table>
      </div>
      <div class="stats" id="statsDiv" style="display:none;"></div>
    </div>

    <div id="tab2" class="tab-content">
      <div class="controls" style="margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <label for="filterDateTab2" style="font-weight: 600; font-size: 13px;">L·ªçc Ng√†y:</label>
          <input type="date" id="filterDateTab2" class="search-box" style="max-width: 140px; padding: 6px;">
        </div>

        <div style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
          <label for="filterNccTab2" style="font-weight: 600; font-size: 13px;">L·ªçc NCC:</label>
          <select id="filterNccTab2" class="search-box" style="max-width: 200px; padding: 6px;">
            <option value="">-- T·∫•t c·∫£ NCC --</option>
          </select>
        </div>

        <button class="btn btn-primary" id="btnRefreshTab2" style="padding: 6px 12px; margin-left: auto;">
          <span>üîÑ</span> L√†m m·ªõi
        </button>
      </div>

      <div class="panel-container">
        <div class="panel panel-left">
          <div class="panel-header"><span>Danh s√°ch ƒë∆°n h√†ng (ID)</span></div>
          <div class="panel-body">
            <table class="panel-table" id="tblIdDH">
              <thead>
                <tr>
                  <th>ID ƒê∆°n</th>
                  <th>Ng√†y</th>
                  <th class="text-right">SL</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="panel panel-right">
          <div class="panel-header">
            <span>Chi ti·∫øt ƒë∆°n h√†ng</span>
            <div class="panel-actions">
              <div style="display: flex; align-items: center; gap: 5px;">
                <label for="rowsPerPageTab2Right" style="font-size: 12px; font-weight: 600;">D√≤ng/Trang:</label>
                <select id="rowsPerPageTab2Right" class="search-box"
                  style="width: auto; min-width: 70px; font-size: 12px; padding: 4px 8px;">
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                  <option value="300">300</option>
                  <option value="500">500</option>
                  <option value="99999">T·∫•t c·∫£</option>
                </select>
              </div>
              <button class="btn btn-success" id="btnExport" style="display:none;"><span>üìã</span> Xu·∫•t Excel</button>
            </div>
          </div>
          <div class="panel-body">
            <table class="panel-table" id="tblChiTiet">
              <thead>
                <tr>
                  <th>Ng√†y</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>NCC</th>
                  <th>Kho</th>
                  <th>ID SP</th>
                  <th class="text-right">S·ªë l∆∞·ª£ng</th>
                  <th>Th∆∞∆°ng hi·ªáu</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- PAGINATION FOR RIGHT PANEL (CHI TI·∫æT ƒê∆†N H√ÄNG) -->
          <div class="pagination-tab2-right">
            <div style="display: flex; align-items: center; gap: 5px;">
              <span style="font-size: 13px; font-weight: 600;">Hi·ªÉn th·ªã:</span>
              <span id="pageStatsTab2Right" style="font-size: 13px;">0-0 c·ªßa 0</span>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" id="prevPageBtnTab2Right" disabled>‚Üê Tr∆∞·ªõc</button>
              <span id="pageInfoTab2Right"
                style="padding: 6px 12px; font-weight: 600; background: #ecf0f1; border-radius: 4px; font-size: 12px;">Trang
                0 / 0</span>
              <button class="btn btn-primary" id="nextPageBtnTab2Right" disabled>Sau ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tab3" class="tab-content">
      <div class="panel-container">
        <div class="panel panel-left">
          <div class="panel-header"><span>Danh s√°ch Ng√†y Ho√†n</span></div>
          <div class="panel-body">
            <table class="panel-table" id="tblNgayHoan">
              <thead>
                <tr>
                  <th>Ng√†y ho√†n MISA</th>
                  <th class="text-right">S·ªë d√≤ng</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="panel panel-right">
          <div class="panel-header">
            <span>Chi ti·∫øt ƒê∆°n Ho√†n (MISA)</span>
            <div class="panel-actions">
              <button class="btn btn-success" id="btnExportHoan" style="display:none;"><span>üìã</span> Xu·∫•t Excel
                MISA</button>
            </div>
          </div>
          <div class="panel-body">
            <table class="panel-table" id="tblChiTietHoan">
              <thead id="headerHoan"></thead>
              <tbody id="bodyHoan"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <script>
    /* ======================= C·∫§U H√åNH & TR·∫†NG TH√ÅI ======================= */
    const API_URL = "https://script.google.com/macros/s/AKfycbxgZdpFA8V6DDZvz3hUjIsAah7zEeL0VYjdI8wRwMKN-7vtOh-bnNpR3P01RgEaowGAVw/exec";
    const NO_DATE_GROUP = "NO_DATE_GROUP";

    // Bi·∫øn to√†n c·ª•c
    let originalData = [];
    let filteredData = [];
    let donHangData = [];
    let hangHoanData = [];

    // State cho Ph√¢n trang Tab 1
    let currentPage = 1;
    let rowsPerPage = 100;

    // State cho Ph√¢n trang Tab 2 RIGHT PANEL (B·∫¢NG CHI TI·∫æT)
    let currentPageTab2Right = 1;
    let rowsPerPageTab2Right = 50;
    let currentDonHangDetails = []; // L∆∞u chi ti·∫øt ƒë∆°n h√†ng hi·ªán t·∫°i

    let selectedIdDH = null;
    let selectedDateHoan = null;

    // Debounce timer
    let debounceTimer;

    /* ======================= C·ªòT TAB 1 ======================= */
    const extraColumns = [
      { name: "Hi·ªÉn th·ªã tr√™n s·ªï", default: "0" }, { name: "H√¨nh th·ª©c b√°n h√†ng", default: "0" }, { name: "Ph∆∞∆°ng th·ª©c thanh to√°n", default: "0" },
      { name: "Ki√™m phi·∫øu xu·∫•t kho", default: "1" }, { name: "L·∫≠p k√®m h√≥a ƒë∆°n", default: "0" }, { name: "ƒê√£ l·∫≠p h√≥a ƒë∆°n", default: "0" },
      { name: "Ng√†y h·∫°ch to√°n (*)", default: "" }, { name: "Ng√†y ch·ª©ng t·ª´ (*)", default: "" }, { name: "S·ªë ch·ª©ng t·ª´ (*)", default: "" },
      { name: "S·ªë phi·∫øu xu·∫•t", default: "" }, { name: "L√Ω do xu·∫•t", default: "" }, { name: "S·ªë h√≥a ƒë∆°n", default: "" },
      { name: "Ng√†y h√≥a ƒë∆°n", default: "" }, { name: "M√£ ƒë∆°n h√†ng", default: "" }, { name: "M√£ th·ªëng k√™", default: "" },
      { name: "M√£ kh√°ch h√†ng", default: "" }, { name: "T√™n kh√°ch h√†ng", default: "" }, { name: "ƒê·ªãa ch·ªâ", default: "" },
      { name: "M√£ s·ªë thu·∫ø", default: "" }, { name: "Di·ªÖn gi·∫£i", default: "" }, { name: "N·ªôp v√†o TK", default: "" },
      { name: "NV b√°n h√†ng", default: "" }, { name: "M√£ h√†ng (*)", default: "" }, { name: "T√™n h√†ng", default: "" },
      { name: "H√†ng khuy·∫øn m·∫°i", default: "" }, { name: "TK Ti·ªÅn/Chi ph√≠/N·ª£ (*)", default: "131" }, { name: "TK Doanh thu/C√≥ (*)", default: "5111" },
      { name: "ƒêVT", default: "" }, { name: "S·ªë l∆∞·ª£ng", default: "" }, { name: "ƒê∆°n gi√° sau thu·∫ø", default: "" },
      { name: "ƒê∆°n gi√°", default: "" }, { name: "Th√†nh ti·ªÅn", default: "" }, { name: "T·ª∑ l·ªá CK (%)", default: "" },
      { name: "Ti·ªÅn chi·∫øt kh·∫•u", default: "" }, { name: "TK chi·∫øt kh·∫•u", default: "" }, { name: "Gi√° t√≠nh thu·∫ø XK", default: "" },
      { name: "% thu·∫ø XK", default: "" }, { name: "Ti·ªÅn thu·∫ø XK", default: "" }, { name: "TK thu·∫ø XK", default: "" },
      { name: "% thu·∫ø GTGT", default: "" }, { name: "Ti·ªÅn thu·∫ø GTGT", default: "" }, { name: "TK thu·∫ø GTGT", default: "" },
      { name: "HH kh√¥ng TH tr√™n t·ªù khai thu·∫ø GTGT", default: "" }, { name: "Kho", default: "KMN" }, { name: "TK gi√° v·ªën", default: "632" },
      { name: "TK Kho", default: "1561" }, { name: "ƒê∆°n gi√° v·ªën", default: "" }, { name: "Ti·ªÅn v·ªën", default: "" }, { name: "H√†ng h√≥a gi·ªØ h·ªô/b√°n h·ªô", default: "" }
    ];

    /* ======================= C·ªòT TAB 3 (H√ÄNG HO√ÄN) ======================= */
    const HOAN_HEADERS = [
      "Hi·ªÉn th·ªã tr√™n s·ªï", "H√¨nh th·ª©c b√°n h√†ng", "Ph∆∞∆°ng th·ª©c thanh to√°n", "Ki√™m phi·∫øu nh·∫≠p kho",
      "Ng√†y h·∫°ch to√°n (*)", "Ng√†y ch·ª©ng t·ª´ (*)", "S·ªë ch·ª©ng t·ª´ (*)", "Ng√†y phi·∫øu nh·∫≠p", "S·ªë phi·∫øu nh·∫≠p",
      "M·∫´u s·ªë Hƒê", "K√Ω hi·ªáu Hƒê", "S·ªë h√≥a ƒë∆°n", "Ng√†y h√≥a ƒë∆°n", "M√£ kh√°ch h√†ng", "T√™n kh√°ch h√†ng",
      "ƒê·ªãa ch·ªâ", "M√£ s·ªë thu·∫ø", "Di·ªÖn gi·∫£i/L√Ω do chi", "NV b√°n h√†ng", "Ng∆∞·ªùi giao h√†ng", "Di·ªÖn gi·∫£i phi·∫øu nh·∫≠p",
      "K√®m theo ch·ª©ng t·ª´ g·ªëc (Phi·∫øu nh·∫≠p)", "C√°ch l·∫•y ƒë∆°n gi√° nh·∫≠p", "M√£ h√†ng (*)", "T√™n h√†ng",
      "H√†ng khuy·∫øn m·∫°i", "TK tr·∫£ l·∫°i/TK n·ª£ (*)", "TK c√¥ng n·ª£/TK ti·ªÅn/TK c√≥ (*)", "ƒêVT", "S·ªë l∆∞·ª£ng",
      "ƒê∆°n gi√° sau thu·∫ø", "ƒê∆°n gi√°", "Th√†nh ti·ªÅn", "T·ª∑ l·ªá CK (%)", "Ti·ªÅn chi·∫øt kh·∫•u", "TK chi·∫øt kh·∫•u",
      "% thu·∫ø GTGT", "Ti·ªÅn thu·∫ø GTGT", "TK thu·∫ø GTGT", "HH kh√¥ng TH tr√™n t·ªù khai thu·∫ø GTGT",
      "Kho", "TK Kho", "TK gi√° v·ªën", "ƒê∆°n gi√° v·ªën", "Ti·ªÅn v·ªën", "H√†ng ho√° gi·ªØ h·ªô/b√°n h·ªô", "M√£ ƒë∆°n h√†ng", "M√£ th·ªëng k√™"
    ];

    /* ======================= HELPERS ======================= */

    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Debounce function ƒë·ªÉ t·ªëi ∆∞u h√≥a t√¨m ki·∫øm
    function debounce(func, delay) {
      return function () {
        const context = this;
        const args = arguments;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => func.apply(context, args), delay);
      };
    }

    function toNumber(v) {
      const n = parseFloat(String(v ?? "").replace(/[\s,]/g, ""));
      return isNaN(n) ? 0 : n;
    }

    function parseDateVN(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split('/');
      if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
      return null;
    }

    function formatDateShortFromStr(dateStr) {
      if (!dateStr) return "";
      const parts = dateStr.split('/');
      if (parts.length === 3) return `${parts[0]}${parts[1]}${parts[2].slice(-2)}`;
      return "";
    }

    /* --- LOGIC CELL VALUE TAB 1 --- */
    // Helper ƒë·ªÉ l·∫•y gi√° tr·ªã s·ªë c·ªßa Th√†nh ti·ªÅn (d√πng cho s·∫Øp x·∫øp)
    function getNumericThanhTien(row) {
      return toNumber(row["don_gia_1"]) * toNumber(row["slg_xuat"]);
    }

    function getCellValue(row, colName) {
      if (colName === "Ng√†y h·∫°ch to√°n (*)" || colName === "Ng√†y ch·ª©ng t·ª´ (*)") return row["ngay"] || "";
      if (colName === "S·ªë ch·ª©ng t·ª´ (*)" || colName === "S·ªë phi·∫øu xu·∫•t") {
        let prefix = "";
        const san = (row["san"] || "").toUpperCase().trim();
        const kh = (row["khung_h"] || "").trim();

        if (san === "SHOPEE") prefix = (kh === "10H" ? "N " : "") + "SPE";
        else if (san === "LAZADA") prefix = "LDZ";
        else if (san === "BEST") prefix = "GHN";
        else if (san === "ƒê∆†N NGO√ÄI") prefix = "XDN";

        const mg = (row["ma_gian"] || "").trim();
        const nf = formatDateShortFromStr(row["ngay"]);
        return prefix && mg && nf ? `${prefix}-${mg}-${nf}.MN` : "";
      }
      if (colName === "M√£ ƒë∆°n h√†ng") return (row["mdh"] && row["mvd"]) ? `${row["mdh"]}/${row["mvd"]}` : (row["mdh"] || row["mvd"] || "");
      if (colName === "M√£ kh√°ch h√†ng") return row["ma_gian"] || "";
      if (colName === "Di·ªÖn gi·∫£i") {
        const san = (row["san"] || "").trim();
        const kh = (row["khung_h"] || "").trim();
        const p = (san === "ƒê∆†N NGO√ÄI") ? " " : (kh === "10H" ? " NOW " : " ");
        return `MN${p}${san} NG√ÄY ${row["ngay"] || ""}`;
      }
      if (colName === "M√£ h√†ng (*)") return row["sku_cha"] || "";
      if (colName === "S·ªë l∆∞·ª£ng") return row["slg_xuat"] || "";
      if (colName === "ƒê∆°n gi√°") return toNumber(row["don_gia_1"]).toLocaleString('vi-VN') || "";
      if (colName === "Th√†nh ti·ªÅn") return getNumericThanhTien(row).toLocaleString('vi-VN') || "";

      const ex = extraColumns.find(c => c.name === colName);
      return ex ? ex.default : (row[colName] || "");
    }

    /* --- LOGIC CELL VALUE TAB 3 --- */
    function getHangHoanValue(row, colName) {
      const sl = toNumber(row["slg"]);
      const dg = toNumber(row["don_gia"]);

      switch (colName) {
        case "Hi·ªÉn th·ªã tr√™n s·ªï":
        case "H√¨nh th·ª©c b√°n h√†ng":
        case "Ph∆∞∆°ng th·ª©c thanh to√°n":
          return "0";
        case "Ki√™m phi·∫øu nh·∫≠p kho":
          return "1";
        case "Ng√†y h·∫°ch to√°n (*)":
        case "Ng√†y ch·ª©ng t·ª´ (*)":
          return row["ngay_hoan_misa"] || "";
        case "S·ªë ch·ª©ng t·ª´ (*)":
        case "S·ªë phi·∫øu nh·∫≠p":
          return row["mvd_hoan"] || "";
        case "M√£ kh√°ch h√†ng":
          return row["shop"] || "";
        case "M√£ h√†ng (*)":
          return row["sku"] || "";
        case "TK tr·∫£ l·∫°i/TK n·ª£ (*)":
          return "5212";
        case "TK c√¥ng n·ª£/TK ti·ªÅn/TK c√≥ (*)":
          return "131";
        case "Kho":
          return "KMN";
        case "TK Kho":
          return "1561";
        case "TK gi√° v·ªën":
          return "632";
        case "S·ªë l∆∞·ª£ng":
          return sl || 0;
        case "ƒê∆°n gi√°":
          return dg || 0;
        case "Th√†nh ti·ªÅn":
          return sl * dg;
        default:
          return "";
      }
    }

    /* ======================= LOAD D·ªÆ LI·ªÜU ======================= */
    function loadData() {
      document.getElementById('loadingDiv').style.display = 'block';
      document.getElementById('tableWrapper').style.display = 'none';
      document.getElementById('errorDiv').style.display = 'none';

      fetch(API_URL)
        .then(resp => {
          if (!resp.ok) {
            throw new Error(`HTTP error! status: ${resp.status}`);
          }
          return resp.json();
        })
        .then(data => {
          const allData = Array.isArray(data) ? data : [];
          originalData = allData.filter(i => i._sheet === "UP_DON_CT");
          donHangData = allData.filter(i => i._sheet === "DON_HANG_CT");
          hangHoanData = allData.filter(i => i._sheet === "HANG_HOAN_BH");

          // Set Date Filter for Tab 1
          const d = new Date();
          const localDate = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
          document.getElementById('dateFilter').value = localDate;

          // Populate NCC Dropdown for Tab 2
          populateNccDropdown();

          // Render All Tabs
          processFilterAndRender(1); // Tab 1
          renderTab2();             // Tab 2
          renderTab3();             // Tab 3

          showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng', 'success');
        })
        .catch(err => {
          console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', err);
          document.getElementById('errorDiv').textContent = "L·ªói k·∫øt n·ªëi: " + err.message;
          document.getElementById('errorDiv').style.display = 'block';
          showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + err.message, 'error');
        })
        .finally(() => {
          document.getElementById('loadingDiv').style.display = 'none';
          if (originalData.length) document.getElementById('tableWrapper').style.display = 'block';
        });
    }

    /* ======================= RENDER TAB 1 (Sorting & Pagination) ======================= */

    function processFilterAndRender(page = currentPage) {
      const dateInput = document.getElementById('dateFilter').value;
      const searchVal = document.getElementById('searchInput').value.toLowerCase();
      let result = [...originalData];

      // 1. Filtering
      if (dateInput) {
        const [y, m, d] = dateInput.split('-');
        const target = `${d}/${m}/${y}`;
        result = result.filter(r => r.ngay === target);
      }
      if (searchVal) {
        result = result.filter(r =>
          Object.values(r).some(v =>
            String(v).toLowerCase().includes(searchVal)
          )
        );
      }

      // 2. Sorting (Sort by Th√†nh ti·ªÅn ascending - Nh·ªè t·ªõi L·ªõn)
      result.sort((a, b) => {
        const tt_a = getNumericThanhTien(a);
        const tt_b = getNumericThanhTien(b);

        if (tt_a !== tt_b) return tt_a - tt_b; // Sort Th√†nh ti·ªÅn ASC

        // Fallback: Sort by Date Descending
        const da = parseDateVN(a.ngay) || new Date(0);
        const db = parseDateVN(b.ngay) || new Date(0);
        return db - da;
      });

      filteredData = result; // L∆∞u l·∫°i to√†n b·ªô d·ªØ li·ªáu ƒë√£ l·ªçc & s·∫Øp x·∫øp

      // 3. Pagination Logic
      rowsPerPage = parseInt(document.getElementById('rowsPerPage')?.value || 100);
      const totalRows = filteredData.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage);

      currentPage = page;
      if (currentPage < 1) currentPage = 1;
      if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
      if (totalPages === 0) currentPage = 0;

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginatedData = filteredData.slice(start, end);

      // 4. Render Table
      const tbody = document.getElementById("data-body");
      const thead = document.getElementById("header-row");
      tbody.innerHTML = "";
      thead.innerHTML = "";

      if (!paginatedData.length) {
        tbody.innerHTML = '<tr><td colspan="100" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        renderPaginationControls(totalRows, totalPages);
        return;
      }

      const keys = Object.keys(originalData[0] || {}); // L·∫•y keys t·ª´ originalData (v√¨ filteredData c√≥ th·ªÉ r·ªóng)
      const allCols = extraColumns.map(c => c.name).concat(keys.filter(k => k !== '_sheet')); // Lo·∫°i b·ªè _sheet

      allCols.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        thead.appendChild(th);
      });

      const frag = new DocumentFragment();
      paginatedData.forEach(row => { // Render d·ªØ li·ªáu ƒë√£ ph√¢n trang
        const tr = document.createElement("tr");
        if (String(row.trang_thai).toUpperCase().includes("H·ª¶Y")) tr.classList.add('cancelled-order');

        allCols.forEach(col => {
          const td = document.createElement("td");
          td.textContent = getCellValue(row, col);
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);

      // 5. Render Stats & Pagination Controls
      const huy = filteredData.filter(r => String(r.trang_thai).toUpperCase().includes("H·ª¶Y")).length;
      document.getElementById('statsDiv').innerHTML = `
      <div class="stats-item"><span>T·ªïng:</span><span class="stats-badge">${originalData.length}</span></div>
      <div class="stats-item"><span>Hi·ªÉn th·ªã:</span><span class="stats-badge">${filteredData.length}</span></div>
      <div class="stats-item"><span>H·ªßy:</span><span class="stats-badge huy">${huy}</span></div>
    `;
      document.getElementById('statsDiv').style.display = 'flex';

      renderPaginationControls(totalRows, totalPages);
    }

    // Pagination Handlers
    function renderPaginationControls(totalRows, totalPages) {
      const controlsDiv = document.getElementById('paginationControls');
      const pageInfoSpan = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      if (totalRows > rowsPerPage && rowsPerPage !== 99999) {
        controlsDiv.style.display = 'flex';
        pageInfoSpan.textContent = `Trang ${currentPage} / ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
      } else {
        controlsDiv.style.display = 'none';
      }
    }

    function changePage(delta) {
      const newPage = currentPage + delta;
      processFilterAndRender(newPage);
    }

    function changeRowsPerPage(value) {
      rowsPerPage = parseInt(value);
      processFilterAndRender(1); // Lu√¥n v·ªÅ trang 1 khi ƒë·ªïi s·ªë d√≤ng/trang
    }

    function exportToCSV() {
      if (!filteredData.length) {
        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      const data = filteredData.filter(r => !String(r.trang_thai).toUpperCase().includes("H·ª¶Y"));
      if (!data.length) {
        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      const keys = Object.keys(data[0] || {});
      const cols = extraColumns.map(c => c.name).concat(keys.filter(k => k !== '_sheet'));
      let csv = cols.map(h => `"${h}"`).join(',') + '\n';

      data.forEach(r => {
        csv += cols.map(c => {
          const val = String(getCellValue(r, c)).replace(/"/g, '""');
          return `"${val}"`;
        }).join(',') + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `UP_DON_${document.getElementById('dateFilter').value}.csv`;
      link.click();

      showNotification('Xu·∫•t CSV th√†nh c√¥ng', 'success');
    }

    function exportToExcel() {
      const data = filteredData.filter(r => !String(r.trang_thai).toUpperCase().includes("H·ª¶Y"));
      if (!data.length) {
        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      const cols = extraColumns.map(c => c.name);
      const exData = data.map(r => {
        const o = {};
        cols.forEach(c => o[c] = getCellValue(r, c));
        return o;
      });

      const ws = XLSX.utils.json_to_sheet(exData, { header: cols });
      ws['!cols'] = cols.map(() => ({ wch: 20 }));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "UP_DON");
      XLSX.writeFile(wb, `UP_DON_${document.getElementById('dateFilter').value}.xlsx`);

      showNotification('Xu·∫•t Excel th√†nh c√¥ng', 'success');
    }

    /* ======================= TAB 2 - QU·∫¢N L√ù ƒê∆†N H√ÄNG ======================= */

    function renderTab2() {
      renderTab2LeftPanel();
      renderTab2RightPanel();
    }

    // Render danh s√°ch ƒë∆°n h√†ng b√™n tr√°i (Nh√≥m theo Ng√†y)
    function renderTab2LeftPanel() {
      const filterDate = document.getElementById('filterDateTab2').value;
      const filterNcc = document.getElementById('filterNccTab2').value;

      const groupMap = {};

      // 1. First pass: Identify valid Orders based on filters
      // N·∫øu c√≥ l·ªçc NCC, ta c·∫ßn bi·∫øt nh·ªØng ƒê∆°n h√†ng n√†o c√≥ ch·ª©a SP c·ªßa NCC ƒë√≥
      let validOrderIds = null;
      if (filterNcc) {
        validOrderIds = new Set();
        donHangData.forEach(r => {
          if (r.ncc === filterNcc && r.id_dh) {
            validOrderIds.add(r.id_dh.toString());
          }
        });
      }

      donHangData.forEach(r => {
        if (!r.id_dh || !r.id_sp) return;
        const id = r.id_dh.toString();

        // Filter Logic
        // a. Filter by Date (Exact match on Order Date)
        if (filterDate) {
          // Gi·∫£ s·ª≠ r.ngay l√† dd/mm/yyyy. C·∫ßn convert filterDate (yyyy-mm-dd) sang dd/mm/yyyy ho·∫∑c ng∆∞·ª£c l·∫°i ƒë·ªÉ so s√°nh
          // convert r.ngay to yyyy-mm-dd
          const parts = (r.ngay || "").split('/');
          if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            const rDateISO = `${year}-${month}-${day}`;
            if (rDateISO !== filterDate) return;
          } else {
            return; // Invalid date in data, skip if filtering
          }
        }

        // b. Filter by NCC (Order must contain at least one item from this NCC)
        if (validOrderIds !== null && !validOrderIds.has(id)) {
          return;
        }

        if (!groupMap[id]) groupMap[id] = { id, ngay: [], sl: 0, type: new Set() };
        groupMap[id].ngay.push(r.ngay);
        groupMap[id].sl += toNumber(r.so_luong);
        if (r.tr∆∞∆°ng) groupMap[id].type.add(r.tr∆∞∆°ng);
      });

      const groups = Object.values(groupMap);

      // Gom nh√≥m theo ng√†y hi·ªÉn th·ªã
      const dateGroups = {};
      groups.forEach(g => {
        const d = g.ngay[0] || NO_DATE_GROUP;
        if (!dateGroups[d]) dateGroups[d] = [];
        dateGroups[d].push(g);
      });

      // S·∫Øp x·∫øp c√°c ng√†y (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
      const sortedDates = Object.keys(dateGroups).sort((a, b) => {
        if (a === NO_DATE_GROUP) return 1;
        if (b === NO_DATE_GROUP) return -1;
        return (parseDateVN(b) || new Date(0)) - (parseDateVN(a) || new Date(0));
      });

      const tbodyL = document.getElementById("tblIdDH").querySelector("tbody");
      tbodyL.innerHTML = "";
      const fragL = new DocumentFragment();

      sortedDates.forEach(dateStr => {
        // 1. Th√™m d√≤ng ti√™u ƒë·ªÅ ng√†y
        const headerTr = document.createElement("tr");
        headerTr.className = "date-group-row";
        const displayDate = dateStr === NO_DATE_GROUP ? "(Ch∆∞a c√≥ ng√†y)" : dateStr;

        headerTr.innerHTML = `
          <td colspan="4">
            ${displayDate} <span class="count-badge">${dateGroups[dateStr].length}</span>
          </td>
        `;
        fragL.appendChild(headerTr);

        // 2. Th√™m c√°c ƒë∆°n h√†ng c·ªßa ng√†y ƒë√≥
        const items = dateGroups[dateStr];
        items.sort((a, b) => b.id.localeCompare(a.id));
        items.forEach(g => {
          const tr = document.createElement("tr");
          if (selectedIdDH === g.id) tr.classList.add("selected");
          let cls = "";
          if (g.type.has("XU·∫§T")) cls = "row-xuat";
          else if (g.type.has("NH·∫¨P")) cls = "row-nhap";
          tr.className = cls;

          // C·ªôt 1: N√∫t copy
          const copyCell = document.createElement("td");
          const displayDate = g.ngay[0] || "";
          const copyText = `${displayDate} - ${g.id}`;

          copyCell.innerHTML = `
       <button class="copy-row-btn" title="Copy: ${displayDate} - ${g.id}" data-copy="${copyText}">
         üìã
       </button>
     `;

          // C·ªôt 2: ID ƒë∆°n h√†ng
          const idCell = document.createElement("td");
          idCell.innerHTML = `<strong>${g.id}</strong>`;

          // C·ªôt 3: Ng√†y
          const dateCell = document.createElement("td");
          dateCell.textContent = displayDate;

          // C·ªôt 4: S·ªë l∆∞·ª£ng
          const qtyCell = document.createElement("td");
          qtyCell.className = "text-right";
          qtyCell.innerHTML = `<strong>${g.sl}</strong>`;

          // Th√™m c√°c cell v√†o row
          tr.appendChild(copyCell);
          tr.appendChild(idCell);
          tr.appendChild(dateCell);
          tr.appendChild(qtyCell);

          // S·ª± ki·ªán click v√†o row
          tr.onclick = (e) => {
            // Kh√¥ng ch·ªçn n·∫øu click v√†o n√∫t copy
            if (e.target.closest('.copy-row-btn')) {
              e.stopPropagation();
              return;
            }
            selectedIdDH = g.id;
            renderTab2RightPanel();
          };

          fragL.appendChild(tr);
        });
      });

      tbodyL.appendChild(fragL);

      // Th√™m s·ª± ki·ªán cho c√°c n√∫t copy
      addCopyButtonEvents();
    }

    // H√†m x·ª≠ l√Ω s·ª± ki·ªán cho n√∫t copy (CH·ªà M·ªòT H√ÄM DUY NH·∫§T)
    function addCopyButtonEvents() {
      document.querySelectorAll('.copy-row-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          const copyText = this.getAttribute('data-copy');
          copyToClipboard(copyText, this);
        });
      });
    }

    // H√†m copy v√†o clipboard (CH·ªà M·ªòT H√ÄM DUY NH·∫§T)
    function copyToClipboard(text, buttonElement) {
      navigator.clipboard.writeText(text).then(() => {
        // Hi·ªÉn th·ªã feedback t·∫°m th·ªùi
        const originalHTML = buttonElement.innerHTML;
        buttonElement.innerHTML = '‚úì';
        buttonElement.classList.add('copied');

        showNotification(`ƒê√£ copy: ${text}`, 'success');

        setTimeout(() => {
          buttonElement.innerHTML = originalHTML;
          buttonElement.classList.remove('copied');
        }, 1500);
      }).catch(err => {
        console.error('Copy failed:', err);
        showNotification('L·ªói khi copy', 'error');
      });
    }
    // Th√™m h√†m x·ª≠ l√Ω s·ª± ki·ªán copy
    // H√†m x·ª≠ l√Ω s·ª± ki·ªán cho n√∫t copy


    // H√†m copy v√†o clipboard

    // Render b·∫£ng chi ti·∫øt ƒë∆°n h√†ng b√™n ph·∫£i (C√ì ph√¢n trang)
    function renderTab2RightPanel(page = currentPageTab2Right) {
      const filterDate = document.getElementById('filterDateTab2').value;
      const filterNcc = document.getElementById('filterNccTab2').value;

      let allDetails = donHangData.filter(r => r.id_sp);

      // L·ªçc theo ƒë∆°n h√†ng ƒë∆∞·ª£c ch·ªçn
      if (selectedIdDH) {
        allDetails = allDetails.filter(r => r.id_dh && r.id_dh.toString() === selectedIdDH);
      }

      // Apply Filters to Right Panel
      allDetails = allDetails.filter(r => {
        // Filter by NCC
        if (filterNcc && r.ncc !== filterNcc) return false;

        // Filter by Date
        if (filterDate) {
          const parts = (r.ngay || "").split('/');
          if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            const rDateISO = `${year}-${month}-${day}`;
            if (rDateISO !== filterDate) return false;
          } else {
            return false;
          }
        }
        return true;
      });

      // S·∫Øp x·∫øp theo ng√†y (m·ªõi nh·∫•t tr∆∞·ªõc)
      allDetails.sort((a, b) => (b.ngay ? parseDateVN(b.ngay) : new Date(0)) - (a.ngay ? parseDateVN(a.ngay) : new Date(0)));

      // L∆∞u chi ti·∫øt ƒë∆°n h√†ng hi·ªán t·∫°i
      currentDonHangDetails = allDetails;

      // Ph√¢n trang cho b·∫£ng chi ti·∫øt
      rowsPerPageTab2Right = parseInt(document.getElementById('rowsPerPageTab2Right')?.value || 50);
      const totalRows = currentDonHangDetails.length;
      const totalPages = Math.ceil(totalRows / rowsPerPageTab2Right);

      currentPageTab2Right = page;
      if (currentPageTab2Right < 1) currentPageTab2Right = 1;
      if (currentPageTab2Right > totalPages && totalPages > 0) currentPageTab2Right = totalPages;
      if (totalPages === 0) currentPageTab2Right = 0;

      const start = (currentPageTab2Right - 1) * rowsPerPageTab2Right;
      const end = start + rowsPerPageTab2Right;
      const paginatedDetails = currentDonHangDetails.slice(start, end);

      // Render b·∫£ng chi ti·∫øt
      const tbodyR = document.getElementById("tblChiTiet").querySelector("tbody");
      tbodyR.innerHTML = "";
      const fragR = new DocumentFragment();

      if (!paginatedDetails.length) {
        tbodyR.innerHTML = `<tr><td colspan="7" class="empty-state">${selectedIdDH ? "Kh√¥ng c√≥ chi ti·∫øt ph√π h·ª£p" : "Ch·ªçn ƒë∆°n h√†ng"}</td></tr>`;
        document.getElementById("btnExport").style.display = "none";
      } else {
        paginatedDetails.forEach(r => {
          const tr = document.createElement("tr");
          const stt = r.tr∆∞∆°ng === "XU·∫§T" ? "badge-xuat" : r.tr∆∞∆°ng === "NH·∫¨P" ? "badge-nhap" : "badge-hoan";
          tr.innerHTML = `
          <td>${r.ngay || ""}</td>
          <td><span class="badge ${stt}">${r.tr∆∞∆°ng || ""}</span></td>
          <td>${r.ncc || ""}</td>
          <td>${r.kho || ""}</td>
          <td><strong>${r.id_sp}</strong></td>
          <td class="text-right"><strong>${r.so_luong || 0}</strong></td>
          <td>${r.thuong_hieu || ""}</td>
        `;
          fragR.appendChild(tr);
        });
        tbodyR.appendChild(fragR);
        document.getElementById("btnExport").style.display = "inline-block";
      }

      // Render ph√¢n trang cho b·∫£ng chi ti·∫øt
      renderTab2RightPagination(totalRows, totalPages);
    }

    // Render ph√¢n trang cho b·∫£ng chi ti·∫øt
    function renderTab2RightPagination(totalRows, totalPages) {
      const pageStats = document.getElementById('pageStatsTab2Right');
      const pageInfo = document.getElementById('pageInfoTab2Right');
      const prevBtn = document.getElementById('prevPageBtnTab2Right');
      const nextBtn = document.getElementById('nextPageBtnTab2Right');

      if (totalRows > rowsPerPageTab2Right && rowsPerPageTab2Right !== 99999) {
        const start = (currentPageTab2Right - 1) * rowsPerPageTab2Right + 1;
        const end = Math.min(currentPageTab2Right * rowsPerPageTab2Right, totalRows);

        pageStats.textContent = `${start}-${end} c·ªßa ${totalRows}`;
        pageInfo.textContent = `Trang ${currentPageTab2Right} / ${totalPages}`;
        prevBtn.disabled = currentPageTab2Right <= 1;
        nextBtn.disabled = currentPageTab2Right >= totalPages;
      } else {
        pageStats.textContent = `1-${totalRows} c·ªßa ${totalRows}`;
        pageInfo.textContent = `Trang 1 / 1`;
        prevBtn.disabled = true;
        nextBtn.disabled = true;
      }
    }

    // Chuy·ªÉn trang cho b·∫£ng chi ti·∫øt
    function changePageTab2Right(delta) {
      const newPage = currentPageTab2Right + delta;
      renderTab2RightPanel(newPage);
    }

    // Thay ƒë·ªïi s·ªë d√≤ng/trang cho b·∫£ng chi ti·∫øt
    function changeRowsPerPageTab2Right(value) {
      rowsPerPageTab2Right = parseInt(value);
      renderTab2RightPanel(1); // Lu√¥n v·ªÅ trang 1 khi ƒë·ªïi s·ªë d√≤ng/trang
    }

    function exportDonHangExcel() {
      if (!selectedIdDH) {
        showNotification('Vui l√≤ng ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      // S·ª≠ d·ª•ng currentDonHangDetails ƒë·ªÉ ƒë·∫£m b·∫£o xu·∫•t ƒë√∫ng nh·ªØng g√¨ ƒëang l·ªçc
      // Tuy nhi√™n currentDonHangDetails ch·ª©a t·∫•t c·∫£ detail c·ªßa ƒë∆°n h√†ng ƒê√É L·ªåC
      // N·∫øu user mu·ªën xu·∫•t nh·ªØng d√≤ng n√†y th√¨ d√πng currentDonHangDetails l√† chu·∫©n.

      const sum = {};
      currentDonHangDetails.forEach(r => {
        sum[r.id_sp] = (sum[r.id_sp] || 0) + toNumber(r.so_luong);
      });

      const arr = Object.entries(sum).map(([k, v]) => ({ "ID SP": k, "S·ªë l∆∞·ª£ng": v }));
      if (!arr.length) {
        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(arr);
      ws['!cols'] = [{ wch: 20 }, { wch: 12 }];
      XLSX.utils.book_append_sheet(wb, ws, "SP");
      XLSX.writeFile(wb, `${selectedIdDH}_SP.xlsx`);

      showNotification('Xu·∫•t Excel ƒë∆°n h√†ng th√†nh c√¥ng', 'success');
    }

    // Populate NCC Dropdown
    function populateNccDropdown() {
      const nccSet = new Set();
      donHangData.forEach(r => {
        if (r.ncc) nccSet.add(r.ncc);
      });

      const sortedNcc = Array.from(nccSet).sort();
      const select = document.getElementById('filterNccTab2');
      // Keep the first option (-- T·∫•t c·∫£ NCC --)
      select.innerHTML = '<option value="">-- T·∫•t c·∫£ NCC --</option>';

      sortedNcc.forEach(ncc => {
        const opt = document.createElement('option');
        opt.value = ncc;
        opt.textContent = ncc;
        select.appendChild(opt);
      });
    }

    function refreshTab2Filters() {
      document.getElementById('filterDateTab2').value = "";
      document.getElementById('filterNccTab2').value = "";
      renderTab2LeftPanel();
      renderTab2RightPanel(1);
    }

    /* ======================= RENDER TAB 3 (H√ÄNG HO√ÄN) ======================= */

    // 1. Render B·∫£ng Tr√°i: Danh s√°ch Ng√†y (bao g·ªìm ng√†y tr·ªëng)
    function renderTab3() {
      renderTab3Left();
      renderTab3Right();
    }

    function renderTab3Left() {
      const tbody = document.getElementById("tblNgayHoan").querySelector("tbody");
      tbody.innerHTML = "";

      const dateMap = {};
      hangHoanData.forEach(row => {
        // Gom nh√≥m ng√†y tr·ªëng v√†o key NO_DATE_GROUP
        const dateStr = row["ngay_hoan_misa"] || NO_DATE_GROUP;
        if (!dateMap[dateStr]) dateMap[dateStr] = 0;
        dateMap[dateStr]++;
      });

      // Chuy·ªÉn th√†nh m·∫£ng v√† s·∫Øp x·∫øp
      const dates = Object.keys(dateMap).sort((a, b) => {
        // ƒê·∫∑t NO_DATE_GROUP l√™n ƒë·∫ßu ti√™n
        if (a === NO_DATE_GROUP) return -1;
        if (b === NO_DATE_GROUP) return 1;

        // S·∫Øp x·∫øp c√°c ng√†y c√≤n l·∫°i t·ª´ M·ªõi nh·∫•t -> C≈© nh·∫•t (db - da)
        const da = parseDateVN(a) || new Date(0);
        const db = parseDateVN(b) || new Date(0);
        return db - da;
      });

      if (dates.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu h√†ng ho√†n</td></tr>`;
        return;
      }

      const frag = new DocumentFragment();
      dates.forEach(d => {
        const tr = document.createElement("tr");
        const displayDate = d === NO_DATE_GROUP ? "(Ch∆∞a c√≥ ng√†y)" : d;

        if (selectedDateHoan === d) tr.classList.add("selected");
        if (d === NO_DATE_GROUP) tr.classList.add("row-empty-date");

        tr.innerHTML = `
        <td><strong>${displayDate}</strong></td>
        <td class="text-right">${dateMap[d]} d√≤ng</td>
      `;
        tr.onclick = () => {
          selectedDateHoan = d;
          renderTab3();
        };
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    // 2. Render B·∫£ng Ph·∫£i: Chi ti·∫øt mapping (c√≥ s·∫Øp x·∫øp theo ngay_xly)
    function renderTab3Right() {
      const thead = document.getElementById("headerHoan");
      const tbody = document.getElementById("bodyHoan");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      document.getElementById("btnExportHoan").style.display = "none";

      const trHead = document.createElement("tr");
      HOAN_HEADERS.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      if (!selectedDateHoan) {
        tbody.innerHTML = `<tr><td colspan="${HOAN_HEADERS.length}" class="empty-state">Vui l√≤ng ch·ªçn ng√†y ho√†n</td></tr>`;
        return;
      }

      // 1. Filtering Logic
      const filteredRows = hangHoanData.filter(r => {
        if (selectedDateHoan === NO_DATE_GROUP) {
          return !r["ngay_hoan_misa"]; // L·ªçc c√°c d√≤ng thi·∫øu ng√†y
        }
        return r["ngay_hoan_misa"] === selectedDateHoan;
      });

      // 2. Sorting Logic (ngay_xly L·ªõn t·ªõi B√©)
      filteredRows.sort((a, b) => {
        const da = parseDateVN(a.ngay_xly) || new Date(0);
        const db = parseDateVN(b.ngay_xly) || new Date(0);
        return db - da; // Descending (L·ªõn nh·∫•t l√™n ƒë·∫ßu)
      });

      if (filteredRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${HOAN_HEADERS.length}" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        return;
      }

      // 3. Rendering Logic
      const frag = new DocumentFragment();
      filteredRows.forEach(row => {
        const tr = document.createElement("tr");
        HOAN_HEADERS.forEach(colName => {
          const td = document.createElement("td");
          let val = getHangHoanValue(row, colName);
          if (["Th√†nh ti·ªÅn", "ƒê∆°n gi√°", "S·ªë l∆∞·ª£ng"].includes(colName)) val = Number(val).toLocaleString('vi-VN');
          td.textContent = val;
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
      document.getElementById("btnExportHoan").style.display = "inline-block";
    }

    // 3. Xu·∫•t Excel Tab 3
    function exportTab3Excel() {
      if (!selectedDateHoan) {
        showNotification('Vui l√≤ng ch·ªçn ng√†y ho√†n ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      // 1. Filtering Logic
      const rows = hangHoanData.filter(r => {
        if (selectedDateHoan === NO_DATE_GROUP) {
          return !r["ngay_hoan_misa"];
        }
        return r["ngay_hoan_misa"] === selectedDateHoan;
      });

      // 2. Sorting Logic (C·∫ßn s·∫Øp x·∫øp l·∫°i tr∆∞·ªõc khi xu·∫•t)
      rows.sort((a, b) => {
        const da = parseDateVN(a.ngay_xly) || new Date(0);
        const db = parseDateVN(b.ngay_xly) || new Date(0);
        return db - da;
      });

      if (!rows.length) {
        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'error');
        return;
      }

      // 3. Mapping and Export
      const exportData = rows.map(r => {
        const o = {};
        HOAN_HEADERS.forEach(c => o[c] = getHangHoanValue(r, c));
        return o;
      });

      const ws = XLSX.utils.json_to_sheet(exportData, { header: HOAN_HEADERS });
      ws['!cols'] = HOAN_HEADERS.map(() => ({ wch: 15 }));

      const wb = XLSX.utils.book_new();
      const safeName = selectedDateHoan === NO_DATE_GROUP ? "Chua_co_ngay" : selectedDateHoan.replace(/\//g, '-');
      XLSX.utils.book_append_sheet(wb, ws, "HANG_HOAN");

      XLSX.writeFile(wb, `MISA_HOAN_${safeName}.xlsx`);

      showNotification('Xu·∫•t Excel h√†ng ho√†n th√†nh c√¥ng', 'success');
    }

    /* ======================= INIT ======================= */
    document.addEventListener('DOMContentLoaded', () => {
      // L·∫•y gi√° tr·ªã m·∫∑c ƒë·ªãnh khi DOMContentLoaded
      rowsPerPage = parseInt(document.getElementById('rowsPerPage')?.value || 100);
      rowsPerPageTab2Right = parseInt(document.getElementById('rowsPerPageTab2Right')?.value || 50);

      // Tab Navigation
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(t.getAttribute('data-tab')).classList.add('active');
      }));

      // Event listeners cho Tab 1
      document.getElementById('dateFilter').addEventListener('change', () => processFilterAndRender(1));
      document.getElementById('searchInput').addEventListener('input',
        debounce(() => processFilterAndRender(1), 300)
      );
      document.getElementById('rowsPerPage').addEventListener('change', (e) => changeRowsPerPage(e.target.value));

      // Button Event Listeners Tab 1
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
      document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
      document.getElementById('prevPageBtn').addEventListener('click', () => changePage(-1));
      document.getElementById('nextPageBtn').addEventListener('click', () => changePage(1));

      // Event listeners cho N√∫t tƒÉng gi·∫£m ng√†y Tab 1
      document.getElementById('prevDayBtn').addEventListener('click', () => adjustDate(-1));
      document.getElementById('nextDayBtn').addEventListener('click', () => adjustDate(1));

      function adjustDate(days) {
        const input = document.getElementById('dateFilter');
        if (!input.value) return;
        const current = new Date(input.value);
        current.setDate(current.getDate() + days);
        const y = current.getFullYear();
        const m = String(current.getMonth() + 1).padStart(2, '0');
        const d = String(current.getDate()).padStart(2, '0');
        input.value = `${y}-${m}-${d}`;
        processFilterAndRender(1);
      }

      // Event listeners cho Tab 2 RIGHT PANEL (B·∫¢NG CHI TI·∫æT)
      document.getElementById("rowsPerPageTab2Right").addEventListener("change", (e) => changeRowsPerPageTab2Right(e.target.value));
      document.getElementById("prevPageBtnTab2Right").addEventListener("click", () => changePageTab2Right(-1));
      document.getElementById("nextPageBtnTab2Right").addEventListener("click", () => changePageTab2Right(1));
      document.getElementById("btnExport").addEventListener("click", exportDonHangExcel);

      // Event listeners for Tab 2 Filters
      function handleTab2FilterChange() {
        renderTab2LeftPanel();
        renderTab2RightPanel(1); // Reset to page 1 of right panel
      }

      document.getElementById('filterDateTab2').addEventListener('change', handleTab2FilterChange);
      document.getElementById('filterNccTab2').addEventListener('change', handleTab2FilterChange);
      document.getElementById('btnRefreshTab2').addEventListener('click', refreshTab2Filters);

      // Tab 3 Event Listeners
      document.getElementById("btnExportHoan").addEventListener("click", exportTab3Excel);

      // Load data initially
      loadData();
    });
  </script>
</body>

</html>

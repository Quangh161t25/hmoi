<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Google Sheets - Premium Edition</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- JSRSAsign for JWT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.27/jsrsasign-all-min.js"></script>
    <!-- HTML5 QRCode Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-slate: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-slate);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        /* Animated Background Blobs */
        .blobs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            filter: blur(80px);
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            animation: move 20s infinite alternate;
            will-change: transform;
            transform: translateZ(0);
        }

        .blob-1 {
            width: 500px;
            height: 500px;
            background: rgba(99, 102, 241, 0.3);
            top: -100px;
            left: -100px;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: rgba(168, 85, 247, 0.2);
            bottom: -50px;
            right: -50px;
            animation-duration: 25s;
        }

        .blob-3 {
            width: 300px;
            height: 300px;
            background: rgba(45, 212, 191, 0.2);
            top: 40%;
            left: 50%;
            animation-duration: 30s;
        }

        @keyframes move {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(100px, 50px) scale(1.1);
            }
        }

        /* Container & Glassmorphism */
        .container {
            width: 100%;
            max-width: 98%;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #818cf8, #c084fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.8rem 1rem;
            color: white;
            outline: none;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        button {
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-main);
        }

        .btn-outline.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: rgba(255, 255, 255, 0.03);
            padding: 1rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem;
            border-top: 1px solid var(--glass-border);
            font-size: 0.95rem;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .btn-edit {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .btn-edit:hover {
            background: var(--primary);
            color: white;
        }

        .btn-save {
            background: #10b981;
            color: white;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .btn-save:hover {
            background: #059669;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 8px;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        .text-input-inline {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            color: white;
            font-size: 0.9rem;
        }

        .action-cell {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--glass-border);
        }

        .page-info {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* Sorting */
        th {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem !important;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.08) !important;
        }

        .sort-icon {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            opacity: 0.3;
        }

        th.sorted-asc .sort-icon::after {
            content: "▲";
            opacity: 1;
        }

        th.sorted-desc .sort-icon::after {
            content: "▼";
            opacity: 1;
        }

        th:not(.sorted-asc):not(.sorted-desc) .sort-icon::after {
            content: "↕";
        }

        /* Auto-save status */
        .save-status {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.8rem 1.5rem;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal {
            background: #1e293b;
            border: 1px solid var(--glass-border);
            padding: 2rem;
            border-radius: 20px;
            width: 100%;
            max-width: 95%;
            /* Mở rộng tối đa */
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            animation: modalIn 0.3s ease-out;
        }

        /* Responsive max-widths for different modal types */
        #settingsModal .modal {
            max-width: 500px;
        }

        #addModal .modal {
            max-width: 1200px;
        }


        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .modal-footer {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            color: var(--text-dim);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Settings Icon */
        .icon {
            width: 20px;
            height: 200px;
        }

        /* Upload Button in Table */
        .btn-upload-inline {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 4px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .btn-upload-inline:hover {
            background: #10b981;
            color: white;
        }

        /* Image Preview Styles */
        .img-preview {
            max-width: 60px;
            max-height: 40px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: cover;
            border: 1px solid var(--glass-border);
        }

        .img-preview:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        /* Fullscreen Image Overlay */
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            cursor: zoom-out;
        }

        .image-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.3s ease-out;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* QR Scanner Modal Styles */
        #qrModal .modal {
            max-width: 600px;
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
                margin-bottom: 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px !important;
                margin-bottom: 1.5rem;
            }

            .search-box {
                max-width: none;
                width: 100%;
            }

            .sort-buttons {
                margin-right: 0 !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr;
            }

            .btn-primary,
            .btn-outline {
                width: 100%;
                justify-content: center;
                padding: 12px;
                font-size: 0.95rem;
            }

            /* Ẩn bảng HTML trên mobile */
            .table-container {
                display: none;
            }

            /* Container cho Card View */
            #mobileCardsContainer {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 1.5rem;
            }

            .mobile-card {
                background: var(--glass-bg);
                border: 1px solid var(--glass-border);
                border-radius: 16px;
                padding: 15px;
                position: relative;
                transition: transform 0.2s;
            }

            .mobile-card.selected {
                border-color: var(--primary);
                background: rgba(99, 102, 241, 0.05);
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 10px;
                border-bottom: 1px solid var(--glass-border);
                padding-bottom: 8px;
            }

            .card-mvd {
                font-weight: 700;
                color: var(--primary);
                font-size: 1.1rem;
            }

            .card-date {
                font-size: 0.85rem;
                color: var(--text-dim);
            }

            .card-body {
                display: grid;
                grid-template-columns: 80px 1fr;
                gap: 15px;
            }

            .card-image img {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 12px;
                border: 1px solid var(--glass-border);
            }

            .card-info {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .info-item {
                font-size: 0.9rem;
            }

            .info-label {
                color: var(--text-dim);
                margin-right: 4px;
            }

            .card-actions {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                margin-top: 10px;
                padding-top: 8px;
                border-top: 1px solid var(--glass-border);
            }

            .card-checkbox {
                position: absolute;
                top: 10px;
                left: -10px;
                width: 24px;
                height: 24px;
                z-index: 5;
            }

            .modal {
                padding: 1.5rem;
                border-radius: 0;
                height: 100%;
                max-height: 100%;
                top: 0;
                transform: none;
                margin: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .blob {
                display: none;
            }
        }

        .btn-qr-helper {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .btn-qr-helper:hover {
            background: var(--primary);
            color: white;
        }

        .btn-date-helper {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .btn-date-helper:hover {
            background: #10b981;
            color: white;
        }

        /* Input Group Helpers */
        .input-group {
            display: flex;
            align-items: center;
            gap: 2px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 2px;
            width: fit-content;
        }

        .input-group input {
            border: none !important;
            background: transparent !important;
            padding: 4px 8px !important;
            width: 80px !important;
            text-align: center;
            box-shadow: none !important;
        }

        .btn-qty {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            font-weight: bold;
        }

        .btn-qty:hover {
            background: var(--primary);
        }



        /* Checkbox styling */
        .custom-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .btn-bulk-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            display: none;
            /* Hiện khi có dòng được chọn */
            align-items: center;
            gap: 8px;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-bulk-delete:hover {
            background: #ef4444;
            color: white;
        }

        .btn-copy-inline {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-copy-inline:hover {
            background: #6366f1;
            color: white;
        }


        /* Modal Form Add */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .form-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-item label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .form-item input {
            width: 100% !important;
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(12px);
            padding: 1rem 2rem;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            display: none;
            align-items: center;
            gap: 1.5rem;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease-out;
        }

        .bulk-info {
            font-weight: 600;
            color: white;
        }

        /* Checkbox styling */
        .custom-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }
    </style>
</head>

<body>
    <div class="blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="container">
        <header>
            <h1>Google Sheets Manager</h1>
            <button class="btn-outline" onclick="openSettings()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                Cài đặt
            </button>
        </header>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Tìm kiếm nhanh..." oninput="handleSearchInput()">
            </div>
            <div class="sort-buttons" style="display: flex; gap: 8px; margin-right: 10px;">
                <button id="btnSortMVD" class="btn-outline" onclick="sortByMVD()" title="Sắp xếp theo Mã vận đơn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 5L6 9l5 4M6 9h12"></path>
                    </svg>
                    Theo MVD
                </button>
                <button id="btnSortRow" class="btn-outline active" onclick="sortByRowOrder()"
                    title="Sắp xếp theo dòng mới nhất">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18"></path>
                    </svg>
                    Dòng mới nhất
                </button>
            </div>
            <div id="saveStatus" class="save-status"
                style="display: none; margin-right: 10px; color: var(--primary); font-weight: bold;">Đang lưu thay
                đổi...</div>
            <button class="btn-primary" onclick="exportToExcel()" style="background: #10b981;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Xuất Excel
            </button>
            <button class="btn-primary" onclick="exportToMisa()" style="background: #f59e0b;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Xuất Misa
            </button>
            <button class="btn-primary" onclick="addRow()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Thêm dòng
            </button>
            <button class="btn-primary" onclick="fetchData()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 4v6h-6"></path>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                Làm mới
            </button>
            <button id="btnBulkDelete" class="btn-bulk-delete" onclick="deleteSelectedRows()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                Xóa (<span id="selectedCountText">0</span>)
            </button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHead">
                        <!-- Headers injected here -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data rows injected here -->
                </tbody>
            </table>
        </div>

        <!-- Container cho Card-View trên Mobile -->
        <div id="mobileCardsContainer"></div>

        <div class="pagination" id="pagination">
            <button class="btn-outline" id="prevPage" onclick="changePage(-1)">Trước</button>
            <span class="page-info" id="pageInfo">Trang 1 / 1</span>
            <button class="btn-outline" id="nextPage" onclick="changePage(1)">Tiếp</button>
        </div>
    </div>



    <!-- No more Edit Modal, using Inline Editing -->

    <!-- Dynamic Add Row Modal -->
    <div id="addModal" class="modal-overlay"> <!-- Sử dụng modal-overlay để đè lên toàn bộ bảng -->
        <div class="modal">
            <div class="modal-header">
                <h2>Thêm dữ liệu mới</h2>
                <button class="btn-outline" style="padding: 0.5rem;" onclick="closeModal('addModal')">✕</button>
            </div>
            <div id="addFormGrid" class="form-grid">
                <!-- Nội dung được sinh động bằng JS -->
            </div>
            <div class="modal-footer">
                <button class="btn-edit" style="background: rgba(255,255,255,0.1); color: white;"
                    onclick="closeModal('addModal')">Hủy</button>
                <button class="btn-primary" onclick="saveNewRow()">Lưu dữ liệu</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Cấu hình hệ thống</h2>
                <button class="btn-outline" style="padding: 0.5rem;" onclick="closeModal('settingsModal')">✕</button>
            </div>
            <div class="form-group">
                <label>Spreadsheet ID</label>
                <input type="text" id="inputSpreadsheetId">
            </div>
            <div class="form-group">
                <label>Tên Sheet</label>
                <input type="text" id="inputSheetName">
            </div>
            <div class="form-group">
                <label>Danh sách cột (cách nhau bằng dấu phẩy)</label>
                <input type="text" id="inputDisplayColumns" placeholder="ví dụ: tk, trường, tg, anh">
            </div>
            <div class="modal-footer">
                <button class="btn-outline" onclick="resetSettings()">Cài đặt lại</button>
                <button class="btn-primary" onclick="applySettings()">Áp dụng</button>
            </div>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div id="saveStatus" class="save-status">Đang lưu thay đổi...</div>

    <!-- Image Fullscreen Overlay -->
    <div id="imageOverlay" class="image-overlay" onclick="closeImageOverlay()">
        <img id="overlayImage" src="" alt="Full view">
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Quét mã QR / Barcode</h2>
                <button class="btn-outline" style="padding: 0.5rem;" onclick="stopQRScanner()">✕</button>
            </div>
            <div id="reader"></div>
            <div class="modal-footer">
                <button class="btn-outline" onclick="stopQRScanner()">Đóng</button>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH MẶC ĐỊNH ---
        const CONFIG = {
            spreadsheetId: "1cnA33cHHMhcOSaXa9l4Jeu6qw8QnXlUnEU4Bqtkj9wo",
            sheetName: "HH_BH",
            serviceAccountEmail: "test-gia-ason@api-test-sheet-161.iam.gserviceaccount.com",
            privateKey: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC3NN84hLTkQPZd\nLj7niXZTICq7nHsuTn3J6r2Paq12m70/lYSmrwh1i0EStr9bO19QM8cevGlslwGr\nWSVOLJlc6+w1HGPKvRXtA41kYV9MYIvpzIPQtkFE7Hxq71QyBARcv39Lfzze6Ioj\n3G8VBvAKFLAnCUr97GHRv+KbCTFxPZupd3PEB+xS5ZUlzdBCEZvDid3iXaaEJJ+l\nTd1apAGQHjtnDTLOkiTa8zf7X5ebALwnI9MziOdN8VyprHXGhkachPbKyrG0QwEs\n2jtiI6Y5ULsBPjNefoavH8MKU5DEAT9h0fZ7KfsKYVMDuXqmEKBs0D3B4Z6aDZQW\nwT2dDRZDAgMBAAECggEAEIuVoSzZVuFhaz1GI9ji0IacjvO50cIq7M8Zrj4/F756\nEw6PIhKENafAb7U4INm2AnzUMO8CqL9Jpxs85qUM3W4JysSByqLUiRW2184amIyb\nj7jCXfLBTQn8AbHgrUepl5d/vBmFYMgon/mqjbNiGDb4FZgEQSkie5o6fi/dWp5d\nNahbZl+WTOB/znhAfKh/zferHNxldR/ERmwOubZUerkqysWiBigc3ovpLSUof9ur\nz3hNPPp0CKQjF40xuQc6FYTHUHMLuMvp78PXuc/mYqQmZ8VOGhU+faGtZ4m+QJly\ndF5dS8U5cwKEF+ptuAUiWSahn6INb9yKn3+FcsW0UQKBgQDb8N4eWFvbgpRo/vxo\nwBN2u2TWubj6clcrq/1a+VR0njC28Can0ogJHhrFhPxVs5D/rugs3HlbyAXJFptY\nV0DZPCwBxGU5P5RbGjXWWEUXjp4ISKQD8WKfVlXNr79TqLdOg2NZBYQAi06Cpo/T\nPV9l7LSG2Tj/9WdvD7W2wvrpaQKBgQDVPjpJN6xh7+sHtSU0mjKvrqigpHbuSQ/o\nXpUaWSIpJffm5QpFPAOcTT5mHZCyllicJQIrfPSY+sH8n+sF03CUqVkV4Q2UqfOf\npFaLDB4P6SQ8iesZyF4VKFrj/cAvRJmp0e5W/DRnFkoEp+8c+nrru2+Dzm9kb7Uq\n0CiltqYAywKBgBtcfrV1to+7Ue0x84KwintV2rifyDRX7yI+tjkQFYKgf1zyyUxN\nc6D2vsvdvGqI+TvlrXqPPwW8/4NBrbeyux2LT8o0fYc+sp0WyKXOu2Gv21caelUH\nPYam/eultn6Y2Z0J2V0kw4Qx0GWOhQv5cZnDdb3k3iNxixmU8b03ynEpAoGBAKEA\n7O0fNe50QRZ+tOq0ihSPYQ55XrqnO3WNBDLynZJH8pbI1CpWF7vJrpVXOUs9rQWo\nA61mGR/wJMtiywaJEHWOL48PbzuR3jno0NcHfSMyOoPi9jlvSWncIFQH4TVPLF5F\n/Rh8L+ytrZE6YpWUoX6e9KGmGgDRPw5mQGpuL4RlAoGADe9n080SXlsUk4nHVjUz\nEfv7EBoBkgOpqb9T1foRfJl46NxmmTOYV3iGIhjwcDskEg284k4iq/gH6EEFyEBc\nVz13jzB1nBgjfezFesVQz7bA/+Wik6HZtxAxVg38BKMt+Q1tYw9wOjbGPqOn++VC\nsR2Sh8e3h3Knd6j1tceRIFU=\n-----END PRIVATE KEY-----\n",
            tokenUrl: "https://oauth2.googleapis.com/token",
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
            // Tên các cột bạn muốn hiển thị (Để trống [] nếu muốn hiển thị tất cả)
            displayColumns: ["ngay_nhan", "mvd", "ma_gian", "sku", "slg", "ghi_chu", "tinh_trang", "trang_thai", "anh_1", "_virtual_summary"],
            // API Key cho ImgBB
            imgbbApiKey: "1bad1429a242d7040fda3f2cfddb3a25"

        };

        let currentData = []; // [headers, row1, row2, ...]
        let displayData = []; // Dữ liệu đã filter và sort
        let selectedRows = new Set(); // Lưu index của các dòng được chọn
        let lastSelectedIndex = null; // Index cuối cùng được click trong displayData
        let isSelectionMode = false; // Chế độ chọn (hiện/ẩn checkbox)
        let accessToken = null;
        let tokenExpiry = 0;
        let editingRowIndex = null;
        let isAddingNewRow = false;
        let searchTimeout = null;
        let isUploading = false; // Cờ theo dõi trạng thái upload ảnh
        let isSaving = false; // Cờ ngăn lưu chồng chéo
        let html5QrCode = null; // Đối tượng trình quét QR
        let currentTargetInput = null; // Ô nhập liệu đang được quét cho

        // Phân trang & Sắp xếp
        let currentPage = 1;
        const rowsPerPage = 20;
        let sortConfig = { col: null, dir: 'asc' };

        // --- AUTHENTICATION ---
        async function getAccessToken() {
            // Kiểm tra token cũ còn hạn không (trừ hao 5 phút)
            if (accessToken && Date.now() < tokenExpiry - 300000) {
                return accessToken;
            }

            const header = { alg: "RS256", typ: "JWT" };
            const now = Math.floor(Date.now() / 1000);
            const payload = {
                iss: CONFIG.serviceAccountEmail,
                scope: CONFIG.scopes.join(" "),
                aud: CONFIG.tokenUrl,
                exp: now + 3600,
                iat: now
            };

            const sHeader = JSON.stringify(header);
            const sPayload = JSON.stringify(payload);
            const sJWT = KJUR.jws.JWS.sign("RS256", sHeader, sPayload, CONFIG.privateKey);

            try {
                const response = await fetch(CONFIG.tokenUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}`
                });
                const data = await response.json();
                accessToken = data.access_token;
                tokenExpiry = Date.now() + (data.expires_in * 1000);
                return accessToken;
            } catch (err) {
                console.error("Lỗi lấy token:", err);
                alert("Không thể xác thực với Google API");
            }
        }

        // --- UTILS & DATA OPERATIONS ---
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            if (dateStr instanceof Date) return dateStr;

            // Handle DD/MM/YYYY
            const parts = dateStr.toString().split(/[\/-]/);
            if (parts.length === 3) {
                if (parts[0].length === 4) { // YYYY/MM/DD
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                } else { // DD/MM/YYYY
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }

            const parsed = new Date(dateStr);
            return isNaN(parsed.getTime()) ? new Date(0) : parsed;
        }

        async function fetchData() {
            // Đừng refresh bảng khi đang có dòng sửa/thêm
            if (editingRowIndex !== null) return;

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            try {
                const token = await getAccessToken();
                const sid = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
                const sname = localStorage.getItem('gs_name') || CONFIG.sheetName;

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${sname}!A:Z`;
                const response = await fetch(url, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.values) {
                    currentData = result.values;
                    try { localStorage.setItem('gs_cached_data', JSON.stringify(currentData)); } catch (e) { }
                    currentPage = 1;
                    sortConfig = { col: null, dir: 'asc' };
                    filterAndSortData();
                } else {
                    alert("Sheet không có dữ liệu hoặc lỗi cấu hình.");
                }
            } catch (err) {
                console.error("Fetch error:", err);
            } finally {
                loading.style.display = 'none';
            }
        }

        function filterAndSortData() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const rawHeaders = currentData[0];
            const sheetHeaders = rawHeaders.map(h => h.toString().trim().toLowerCase());
            const mvdIdx = sheetHeaders.indexOf("mvd");
            const skuIdx = sheetHeaders.indexOf("sku");
            const slgIdx = sheetHeaders.indexOf("slg");
            const ngayNhanIdx = sheetHeaders.indexOf("ngay_nhan");

            // Lưu mvdIdx global để renderTable dùng được
            window.mvdIdx = mvdIdx;

            // Tính toán cột ảo: Gộp SKU | SLG theo MVD
            window.mvdSummaries = new Map();
            if (mvdIdx !== -1 && skuIdx !== -1 && slgIdx !== -1) {
                const tempMap = new Map();
                currentData.slice(1).forEach(row => {
                    const mvd = (row[mvdIdx] || "").toString().trim();
                    if (!mvd) return;
                    const sku = row[skuIdx] || "";
                    const slg = row[slgIdx] || "";
                    const part = `${sku} | ${slg}`;
                    if (!tempMap.has(mvd)) tempMap.set(mvd, []);
                    tempMap.get(mvd).push(part);
                });
                tempMap.forEach((parts, mvd) => {
                    window.mvdSummaries.set(mvd, parts.join(" + "));
                });
            }

            // Ghi nhớ index gốc để hỗ trợ sắp xếp "dưới lên trên"
            let data = currentData.slice(1).map((row, idx) => ({
                row: row,
                originalIndex: idx + 1
            }));

            // Mặc định sắp xếp theo ngay_nhan giảm dần nếu chưa có sortConfig
            if (sortConfig.col === null && ngayNhanIdx !== -1) {
                sortConfig.col = ngayNhanIdx;
                sortConfig.dir = 'desc';
            }

            // Xác định danh sách cột đang được hiển thị
            let visibleIndices = [];
            if (CONFIG.displayColumns && CONFIG.displayColumns.length > 0) {
                CONFIG.displayColumns.forEach(colName => {
                    const idx = rawHeaders.indexOf(colName);
                    if (idx !== -1) visibleIndices.push(idx);
                });
            } else {
                visibleIndices = rawHeaders.map((_, i) => i);
            }

            // 1. Lọc dữ liệu
            data = data.filter(item => {
                const row = item.row;
                const absIdx = currentData.indexOf(row);
                if (absIdx === editingRowIndex) return true;

                // Lọc trống
                const hasData = visibleIndices.some(idx => row[idx] && row[idx].toString().trim() !== "");
                if (!hasData) return false;

                // Lọc tìm kiếm
                if (term) {
                    return visibleIndices.some(idx => row[idx] && row[idx].toString().toLowerCase().includes(term));
                }
                return true;
            });

            // 2. Sắp xếp Đa tầng
            data.sort((aItem, bItem) => {
                const a = aItem.row;
                const b = bItem.row;

                // Ưu tiên dòng đang sửa
                if (isAddingNewRow) {
                    const absA = currentData.indexOf(a);
                    const absB = currentData.indexOf(b);
                    if (absA === editingRowIndex) return -1;
                    if (absB === editingRowIndex) return 1;
                }

                // Tiêu chí 1: Luôn ưu tiên Ngày nhận (Lớn tới Bé) - Của ngày nào hiển thị ngày đó
                if (ngayNhanIdx !== -1) {
                    const dateA = parseDate(a[ngayNhanIdx] || "");
                    const dateB = parseDate(b[ngayNhanIdx] || "");
                    if (dateA > dateB) return -1;
                    if (dateA < dateB) return 1;
                }

                // Tiêu chí 2: Theo cột người dùng chọn (Nếu không phải cột Ngày nhận)
                if (sortConfig.col !== null && sortConfig.col !== ngayNhanIdx) {
                    let valA = a[sortConfig.col] || "";
                    let valB = b[sortConfig.col] || "";

                    const colName = rawHeaders[sortConfig.col];
                    const isDateCol = colName === "ngay_nhan" || colName === "ngay_xly" || colName === "ngay_hoan";

                    let cmp = 0;
                    if (isDateCol) {
                        const dateA2 = parseDate(valA);
                        const dateB2 = parseDate(valB);
                        cmp = dateA2 - dateB2;
                    } else {
                        const numA = parseFloat(valA);
                        const numB = parseFloat(valB);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            cmp = numA - numB;
                        } else {
                            cmp = valA.toString().localeCompare(valB.toString());
                        }
                    }

                    if (cmp !== 0) return sortConfig.dir === 'asc' ? cmp : -cmp;
                }

                // Tiêu chí 3: Thứ tự Sheet (Dưới lên Trên) - Dùng khi các giá trị trên bằng nhau
                return bItem.originalIndex - aItem.originalIndex;
            });

            displayData = [rawHeaders, ...data.map(item => item.row)];
            updateSortButtonsUI();
            renderTable();
        }

        function updateSortButtonsUI() {
            const btnMVD = document.getElementById('btnSortMVD');
            const btnRow = document.getElementById('btnSortRow');
            if (!btnMVD || !btnRow || !currentData[0]) return;

            const sheetHeaders = currentData[0].map(h => h.toString().trim().toLowerCase());
            const mvdIdx = sheetHeaders.indexOf("mvd");

            // Reset
            btnMVD.classList.remove('active');
            btnRow.classList.remove('active');

            if (sortConfig.col === mvdIdx && mvdIdx !== -1) {
                btnMVD.classList.add('active');
            } else if (sortConfig.col === null) {
                btnRow.classList.add('active');
            }
        }

        function renderTable() {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            const mobileContainer = document.getElementById('mobileCardsContainer');

            head.innerHTML = '';
            body.innerHTML = '';
            if (mobileContainer) mobileContainer.innerHTML = '';

            if (displayData.length === 0) return;

            // Kiểm tra mobile
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                renderMobileCards();
                updatePaginationUI();
                return;
            }

            const headFragment = document.createDocumentFragment();
            const bodyFragment = document.createDocumentFragment();

            const rawHeaders = displayData[0];

            // Xác định danh sách cột cần hiển thị
            let visibleIndices = [];
            const sheetHeaders = displayData[0].map(h => h.toString().trim().toLowerCase());

            if (CONFIG.displayColumns && CONFIG.displayColumns.length > 0) {
                CONFIG.displayColumns.forEach(target => {
                    const targetClean = target.toString().trim().toLowerCase();
                    const idx = sheetHeaders.indexOf(targetClean);
                    if (idx !== -1) {
                        visibleIndices.push(idx);
                    } else if (targetClean === '_virtual_summary') {
                        visibleIndices.push('_virtual_summary');
                    }
                });
            } else {
                visibleIndices = rawHeaders.map((_, i) => i);
            }

            // Render Header
            const thCheck = document.createElement('th');
            thCheck.style.width = "40px";
            const masterCheckbox = document.createElement('input');
            masterCheckbox.type = "checkbox";
            masterCheckbox.className = "custom-checkbox";
            masterCheckbox.checked = isSelectionMode;
            masterCheckbox.title = isSelectionMode ? "Đóng chế độ chọn" : "Mở chế độ chọn";
            masterCheckbox.onchange = (e) => toggleSelectionMode(e.target.checked);
            thCheck.appendChild(masterCheckbox);
            headFragment.appendChild(thCheck);

            const thStt = document.createElement('th');
            thStt.textContent = "#";
            thStt.style.width = "50px";
            headFragment.appendChild(thStt);

            visibleIndices.forEach(idx => {
                const th = document.createElement('th');
                if (idx === '_virtual_summary') {
                    th.textContent = "Tổng hợp SKU/SLG";
                } else {
                    const h = rawHeaders[idx];
                    th.innerHTML = `${h} <span class="sort-icon"></span>`;
                    th.onclick = () => handleSort(idx);
                    if (sortConfig.col === idx) {
                        th.className = sortConfig.dir === 'asc' ? 'sorted-asc' : 'sorted-desc';
                    }
                }
                headFragment.appendChild(th);
            });
            const thAction = document.createElement('th');
            thAction.textContent = "Thao tác";
            headFragment.appendChild(thAction);

            // Render Body
            const totalRows = displayData.length - 1;
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const startIdx = (currentPage - 1) * rowsPerPage + 1;
            const endIdx = Math.min(startIdx + rowsPerPage, displayData.length);
            const pageData = displayData.slice(startIdx, endIdx);

            let lastGroupDate = null;
            const ngayNhanIdx = rawHeaders.indexOf("ngay_nhan");

            pageData.forEach((row, pIdx) => {
                const absoluteIndex = currentData.indexOf(row);
                const isEditing = (editingRowIndex === absoluteIndex);

                // Grouping logic
                if (ngayNhanIdx !== -1 && !isEditing) {
                    const currentDate = row[ngayNhanIdx] || "Chưa có ngày";
                    if (currentDate !== lastGroupDate) {
                        const groupTr = document.createElement('tr');
                        groupTr.style.background = "rgba(99, 102, 241, 0.1)";
                        const groupTd = document.createElement('td');
                        groupTd.colSpan = visibleIndices.length + 2;
                        groupTd.style.padding = "0.5rem 1rem";
                        groupTd.style.fontWeight = "bold";
                        groupTd.style.color = "var(--primary)";
                        groupTd.innerHTML = `📅 Ngày nhận: ${currentDate}`;
                        groupTr.appendChild(groupTd);
                        bodyFragment.appendChild(groupTr);
                        lastGroupDate = currentDate;
                    }
                }

                const tr = document.createElement('tr');
                if (selectedRows.has(absoluteIndex)) tr.style.background = "rgba(99, 102, 241, 0.05)";

                const tdCheck = document.createElement('td');
                if (isSelectionMode) {
                    const checkbox = document.createElement('input');
                    checkbox.type = "checkbox";
                    checkbox.className = "custom-checkbox";
                    checkbox.checked = selectedRows.has(absoluteIndex);
                    checkbox.onclick = (e) => toggleSelect(absoluteIndex, startIdx + pIdx, e);
                    tdCheck.appendChild(checkbox);
                }
                tr.appendChild(tdCheck);

                const tdStt = document.createElement('td');
                tdStt.textContent = startIdx + pIdx;
                tdStt.style.color = "var(--text-dim)";
                tr.appendChild(tdStt);

                visibleIndices.forEach((colIndex, vIdx) => {
                    const td = document.createElement('td');
                    if (colIndex === '_virtual_summary') {
                        const mvd = (window.mvdIdx !== -1 && row[window.mvdIdx]) ? row[window.mvdIdx].toString().trim() : "";
                        td.textContent = mvd ? (window.mvdSummaries.get(mvd) || "") : "";
                        td.style.fontSize = "0.8rem";
                        td.style.fontWeight = "600";
                        td.style.color = "var(--primary)";
                    } else if (isEditing) {
                        const isFirst = (vIdx === 0);
                        const columnName = rawHeaders[colIndex] ? rawHeaders[colIndex].toString().trim().toLowerCase() : "";
                        const isAnhColumn = (columnName === 'anh' || columnName.startsWith('anh_'));
                        const isNgayColumn = (columnName === 'ngay_nhan');
                        const isMvdColumn = (columnName === 'mvd');
                        const isSlgColumn = (columnName === 'slg');

                        if (isSlgColumn) {
                            td.innerHTML = `
                                <div class="input-group">
                                    <div class="btn-qty" onclick="changeQuantity(this, -1)">-</div>
                                    <input type="text" class="edit-inline-input" 
                                        data-col="${colIndex}" value="${row[colIndex] || '1'}" 
                                        onblur="handleRowBlur()" style="width: 50px !important;">
                                    <div class="btn-qty" onclick="changeQuantity(this, 1)">+</div>
                                </div>
                            `;
                        } else if (isNgayColumn) {
                            td.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="text" class="text-input-inline edit-inline-input datepicker-input" 
                                        data-col="${colIndex}" value="${row[colIndex] || ''}" 
                                        readonly 
                                        onblur="handleRowBlur()">
                                    <label class="btn-date-helper wrap-datepicker" title="Chọn ngày">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                    </label>
                                </div>
                            `;
                        } else {
                            td.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="text" class="text-input-inline edit-inline-input" 
                                        data-col="${colIndex}" value="${row[colIndex] || ''}" 
                                        ${isFirst ? 'id="firstEditInput"' : ''} 
                                        onblur="handleRowBlur()">
                                    
                                    ${isMvdColumn ? `
                                    <label class="btn-qr-helper" title="Quét mã QR" onmousedown="isUploading=true" onclick="startQRScanner(this)">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><rect x="7" y="7" width="3" height="3"></rect><rect x="14" y="7" width="3" height="3"></rect><rect x="7" y="14" width="3" height="3"></rect><rect x="14" y="14" width="3" height="3"></rect></svg>
                                    </label>
                                    ` : ''}

                                    ${isAnhColumn ? `
                                    <label class="btn-upload-inline" title="Tải ảnh lên" onmousedown="isUploading=true">
                                        <input type="file" style="display: none;" onchange="handleImageUpload(this, ${colIndex})">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                    </label>
                                    ` : ''}
                                </div>
                            `;
                        }
                    } else {
                        const cellValue = row[colIndex] || "";
                        if (isImageUrl(cellValue)) {
                            td.innerHTML = `<img src="${cellValue}" class="img-preview" onclick="zoomImage('${cellValue.replace(/'/g, "\\'")}')" onerror="this.parentElement.textContent='${cellValue.replace(/'/g, "\\'")}'">`;
                        } else {
                            td.textContent = cellValue;
                        }
                    }
                    tr.appendChild(td);
                });

                const tdBtn = document.createElement('td');
                if (isEditing) {
                    tdBtn.innerHTML = `
                        <div class="action-cell">
                            <span style="color: var(--primary); font-size: 0.8rem; font-style: italic;">Đang sửa...</span>
                            <button class="btn-edit" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;" onclick="cancelInlineEdit()">Hủy</button>
                        </div>
                    `;
                } else {
                    tdBtn.innerHTML = `
                        <div class="action-cell">
                            <button class="btn-edit" onclick="startInlineEdit(${absoluteIndex})">Sửa</button>
                            <button class="btn-copy-inline" onclick="duplicateRow(${absoluteIndex})" title="Nhân bản đơn hàng này">Nhân bản</button>
                        </div>
                    `;
                }
                tr.appendChild(tdBtn);
                bodyFragment.appendChild(tr);
            });

            head.appendChild(headFragment);
            body.appendChild(bodyFragment);

            // Khởi tạo Flatpickr cho các ô ngày qua biểu tượng
            document.querySelectorAll('.wrap-datepicker').forEach(el => {
                const input = el.closest('div').querySelector('input');
                flatpickr(el, {
                    locale: "vn",
                    dateFormat: "d/m/Y",
                    allowInput: true,
                    // Theme tối
                    monthSelectorType: 'static',
                    // Gắn vào input kề cạnh
                    positionElement: input,
                    onChange: function (selectedDates, dateStr) {
                        input.value = dateStr;
                    },
                    // Hỗ trợ "Hôm nay" và "Xóa"
                    onReady: function (selectedDates, dateStr, instance) {
                        const container = instance.calendarContainer;
                        const footer = document.createElement("div");
                        footer.style.display = "flex";
                        footer.style.justifyContent = "space-between";
                        footer.style.padding = "10px";
                        footer.style.borderTop = "1px solid var(--glass-border)";

                        const clearBtn = document.createElement("button");
                        clearBtn.className = "btn-edit";
                        clearBtn.style.background = "rgba(239, 68, 68, 0.1)";
                        clearBtn.style.color = "#ef4444";
                        clearBtn.innerText = "Xóa";
                        clearBtn.onclick = function () { instance.clear(); instance.close(); };

                        const todayBtn = document.createElement("button");
                        todayBtn.className = "btn-save";
                        todayBtn.innerText = "Hôm nay";
                        todayBtn.onclick = function () { instance.setDate(new Date()); instance.close(); };

                        footer.appendChild(clearBtn);
                        footer.appendChild(todayBtn);
                        container.appendChild(footer);
                    }
                });
            });

            // Tự động focus vào ô đầu tiên khi mở chế độ sửa
            const firstInput = document.getElementById('firstEditInput');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 50);
            }

            updatePaginationUI();
        }

        function updatePaginationUI() {
            const totalRows = displayData.length - 1;
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
            document.getElementById('pageInfo').textContent = `Trang ${currentPage} / ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function renderMobileCards() {
            const container = document.getElementById('mobileCardsContainer');
            if (!container) return;

            const rawHeaders = displayData[0];
            const sheetHeaders = rawHeaders.map(h => h.toString().trim().toLowerCase());

            const mvdIdx = sheetHeaders.indexOf("mvd");
            const ngayNhanIdx = sheetHeaders.indexOf("ngay_nhan");
            const skuIdx = sheetHeaders.indexOf("sku");
            const slgIdx = sheetHeaders.indexOf("slg");
            const maGianIdx = sheetHeaders.indexOf("ma_gian");
            const anhIdx = sheetHeaders.find(h => h.startsWith("anh_")) ? sheetHeaders.indexOf(sheetHeaders.find(h => h.startsWith("anh_"))) : sheetHeaders.indexOf("anh");

            const totalRows = displayData.length - 1;
            const startIdx = (currentPage - 1) * rowsPerPage + 1;
            const endIdx = Math.min(startIdx + rowsPerPage, displayData.length);
            const pageData = displayData.slice(startIdx, endIdx);

            let lastGroupDate = null;

            pageData.forEach((row, pIdx) => {
                const absoluteIndex = currentData.indexOf(row);

                // Grouping Date
                if (ngayNhanIdx !== -1) {
                    const currentDate = row[ngayNhanIdx] || "Chưa có ngày";
                    if (currentDate !== lastGroupDate) {
                        const dateBadge = document.createElement('div');
                        dateBadge.style.margin = "10px 0 5px 0";
                        dateBadge.style.fontSize = "0.9rem";
                        dateBadge.style.fontWeight = "bold";
                        dateBadge.style.color = "var(--primary)";
                        dateBadge.innerHTML = `📅 Ngày nhận: ${currentDate}`;
                        container.appendChild(dateBadge);
                        lastGroupDate = currentDate;
                    }
                }

                const card = document.createElement('div');
                card.className = `mobile-card ${selectedRows.has(absoluteIndex) ? 'selected' : ''}`;

                const mvdText = mvdIdx !== -1 ? row[mvdIdx] : "N/A";
                const dateText = ngayNhanIdx !== -1 ? row[ngayNhanIdx] : "";
                const skuText = skuIdx !== -1 ? row[skuIdx] : "";
                const slgText = slgIdx !== -1 ? row[slgIdx] : "";
                const maGianText = maGianIdx !== -1 ? row[maGianIdx] : "";
                const imgSrc = (anhIdx !== -1 && row[anhIdx]) ? row[anhIdx] : "https://via.placeholder.com/80?text=No+Img";

                let summaryText = "";
                if (mvdText && window.mvdSummaries && window.mvdSummaries.has(mvdText)) {
                    summaryText = window.mvdSummaries.get(mvdText);
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-mvd">${mvdText}</div>
                        <div class="card-date">${dateText}</div>
                        ${isSelectionMode ? `<input type="checkbox" class="card-checkbox custom-checkbox" ${selectedRows.has(absoluteIndex) ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelect(${absoluteIndex}, ${startIdx + pIdx}, event)">` : ''}
                    </div>
                    <div class="card-body" onclick="startInlineEdit(${absoluteIndex})">
                        <div class="card-image">
                            <img src="${imgSrc}" onerror="this.src='https://via.placeholder.com/80?text=Error'">
                        </div>
                        <div class="card-info">
                            <div class="info-item"><span class="info-label">SKU:</span> <strong>${skuText}</strong></div>
                            <div class="info-item"><span class="info-label">SLG:</span> <strong>${slgText}</strong></div>
                            <div class="info-item"><span class="info-label">Gian:</span> ${maGianText}</div>
                            ${summaryText ? `<div class="info-item" style="color: #fbbf24; font-size: 0.8rem; margin-top: 5px;">📦 ${summaryText}</div>` : ''}
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-edit" onclick="startInlineEdit(${absoluteIndex})">Sửa</button>
                        <button class="btn-copy-inline" onclick="duplicateRow(${absoluteIndex})">Nhân bản</button>
                        <button class="btn-edit" style="color: #ef4444; background: rgba(239, 68, 68, 0.1);" onclick="clearRowData(${absoluteIndex})">Xóa</button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function sortByMVD() {
            const rawHeaders = currentData[0].map(h => h.toString().trim().toLowerCase());
            const mvdIdx = rawHeaders.indexOf("mvd");
            if (mvdIdx !== -1) {
                handleSort(mvdIdx);
            }
        }

        function sortByRowOrder() {
            sortConfig.col = null;
            sortConfig.dir = 'desc';
            filterAndSortData();
        }

        function handleSort(colIndex) {
            if (sortConfig.col === colIndex) {
                sortConfig.dir = sortConfig.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.col = colIndex;
                sortConfig.dir = 'asc';
            }
            filterAndSortData();
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
        }

        function filterData() {
            currentPage = 1;
            filterAndSortData();
        }

        function handleSearchInput() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterData();
            }, 300); // 300ms debounce
        }

        // --- INLINE EDIT & SAVE ---
        function startInlineEdit(rowIndex) {
            if (isAddingNewRow) return alert("Vui lòng hoàn tất hoặc hủy dòng đang thêm.");
            editingRowIndex = rowIndex;
            renderTable();
        }

        function cancelInlineEdit() {
            if (isAddingNewRow) {
                currentData.splice(editingRowIndex, 1);
                isAddingNewRow = false;
            }
            editingRowIndex = null;
            filterAndSortData();
        }

        // Tự động lưu khi rời khỏi dòng
        function handleRowBlur() {
            // Đợi một chút để activeElement cập nhật
            setTimeout(() => {
                if (isUploading || isSaving) return; // Nếu đang upload hoặc đang lưu thì không tự động lưu/đóng mode sửa

                const active = document.activeElement;
                // Nếu item mới focus không nằm trong class 'edit-inline-input', nghĩa là đã rời khỏi dòng
                if (!active || !active.classList.contains('edit-inline-input')) {
                    if (editingRowIndex !== null) {
                        saveData();
                    }
                }
            }, 150);
        }

        async function saveData() {
            if (isSaving) return;
            isSaving = true;
            const statusLabel = document.getElementById('saveStatus');
            try {
                const inputs = document.querySelectorAll('.edit-inline-input');

                // Nếu không có input và không phải đang add mới, có thể là do re-render
                if (inputs.length === 0 && !isAddingNewRow) return;

                const rawHeaders = currentData[0];
                const newData = new Array(rawHeaders.length).fill("");

                // Điền dữ liệu cũ vào newData trước
                currentData[editingRowIndex].forEach((val, idx) => {
                    if (idx < newData.length) newData[idx] = val;
                });

                let hasChange = false;

                if (inputs.length > 0) {
                    inputs.forEach(input => {
                        const col = parseInt(input.getAttribute('data-col'));
                        const val = input.value || "";
                        if (newData[col] !== val) {
                            newData[col] = val;
                            hasChange = true;
                        }
                    });
                } else if (isAddingNewRow) {
                    hasChange = true;
                }

                // Nếu không có gì thay đổi, chỉ cần đóng chế độ sửa
                if (!hasChange && !isAddingNewRow) {
                    editingRowIndex = null;
                    renderTable();
                    return;
                }

                statusLabel.style.display = 'block';
                const token = await getAccessToken();
                const sid = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
                const sname = localStorage.getItem('gs_name') || CONFIG.sheetName;

                let url, method;
                if (isAddingNewRow) {
                    url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${sname}!A:A:append?valueInputOption=USER_ENTERED`;
                    method = "POST";
                } else {
                    // Xác định cột cuối cùng dựa trên số lượng header
                    const colLetter = getColLetter(rawHeaders.length);
                    const range = `${sname}!A${editingRowIndex + 1}:${colLetter}${editingRowIndex + 1}`;
                    url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${range}?valueInputOption=USER_ENTERED`;
                    method = "PUT";
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        values: [newData]
                    })
                });

                if (response.ok) {
                    if (isAddingNewRow) {
                        isAddingNewRow = false;
                        editingRowIndex = null;
                        await fetchData();
                    } else {
                        currentData[editingRowIndex] = newData;
                        try { localStorage.setItem('gs_cached_data', JSON.stringify(currentData)); } catch (e) { }
                        editingRowIndex = null;
                        filterAndSortData();
                    }
                } else {
                    const err = await response.json();
                    alert("Lỗi khi lưu: " + err.error.message);
                }
            } catch (err) {
                console.error("Save error:", err);
            } finally {
                setTimeout(() => { if (statusLabel) statusLabel.style.display = 'none'; }, 1000);
                isSaving = false;
            }
        }

        // --- ADD & DELETE ---
        function openAddModal() {
            if (isAddingNewRow || editingRowIndex !== null) {
                return alert("Vui lòng hoàn tất dòng đang sửa trước.");
            }

            const rawHeaders = currentData[0];
            const grid = document.getElementById('addFormGrid');
            grid.innerHTML = "";

            CONFIG.displayColumns.forEach(columnName => {
                const colIndex = rawHeaders.indexOf(columnName);
                if (colIndex === -1 && columnName !== 'id') return;

                const formItem = document.createElement('div');
                formItem.className = 'form-item';

                let defaultValue = "";
                if (columnName === 'ngay_nhan') {
                    const now = new Date();
                    defaultValue = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}/${now.getFullYear()}`;
                } else if (columnName === 'slg') {
                    defaultValue = "1";
                }

                const isMvd = (columnName === 'mvd');
                const isNgay = (columnName === 'ngay_nhan');
                const isSlg = (columnName === 'slg');
                const isAnh = (columnName === 'anh' || columnName.startsWith('anh_'));

                let inputHtml = "";
                if (isSlg) {
                    inputHtml = `
                        <div class="input-group" style="width: 100%;">
                            <div class="btn-qty" onclick="changeQuantity(this, -1)">-</div>
                            <input type="text" class="add-input" data-col="${colIndex}" value="${defaultValue}" style="flex: 1;">
                            <div class="btn-qty" onclick="changeQuantity(this, 1)">+</div>
                        </div>
                    `;
                } else if (isNgay) {
                    inputHtml = `
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" class="text-input-inline add-input add-datepicker-input" data-col="${colIndex}" value="${defaultValue}" readonly style="flex: 1;">
                            <label class="btn-date-helper wrap-add-datepicker" title="Chọn ngày">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            </label>
                        </div>
                    `;
                } else if (isMvd) {
                    inputHtml = `
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" class="text-input-inline add-input" data-col="${colIndex}" value="${defaultValue}" style="flex: 1;">
                            <label class="btn-qr-helper" title="Quét mã QR" onclick="startQRScanner(this)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><rect x="7" y="7" width="3" height="3"></rect><rect x="14" y="7" width="3" height="3"></rect><rect x="7" y="14" width="3" height="3"></rect><rect x="14" y="14" width="3" height="3"></rect></svg>
                            </label>
                        </div>
                    `;
                } else if (isAnh) {
                    inputHtml = `
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <input type="text" class="text-input-inline add-input" data-col="${colIndex}" value="${defaultValue}" style="flex: 1;">
                            <label class="btn-upload-inline" title="Tải ảnh lên" onmousedown="isUploading=true">
                                <input type="file" style="display: none;" onchange="handleImageUpload(this, ${colIndex})">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            </label>
                        </div>
                    `;
                } else {
                    inputHtml = `<input type="text" class="text-input-inline add-input" data-col="${colIndex}" value="${defaultValue}">`;
                }

                formItem.innerHTML = `<label>${columnName.toUpperCase()}</label>${inputHtml}`;
                grid.appendChild(formItem);
            });

            document.getElementById('addModal').style.display = 'flex';

            // Khởi tạo Flatpickr cho form mới
            document.querySelectorAll('.wrap-add-datepicker').forEach(el => {
                const input = el.closest('div').querySelector('input');
                flatpickr(el, {
                    locale: "vn",
                    dateFormat: "d/m/Y",
                    allowInput: true,
                    monthSelectorType: 'static',
                    positionElement: input,
                    onChange: function (selectedDates, dateStr) {
                        input.value = dateStr;
                    },
                    onReady: function (selectedDates, dateStr, instance) {
                        const container = instance.calendarContainer;
                        const footer = document.createElement("div");
                        footer.style.display = "flex";
                        footer.style.justifyContent = "space-between";
                        footer.style.padding = "10px";
                        footer.style.borderTop = "1px solid var(--glass-border)";
                        const cBtn = document.createElement("button");
                        cBtn.className = "btn-edit";
                        cBtn.style.background = "rgba(239, 68, 68, 0.1)";
                        cBtn.style.color = "#ef4444";
                        cBtn.innerText = "Xóa";
                        cBtn.onclick = () => { instance.clear(); instance.close(); };
                        const tBtn = document.createElement("button");
                        tBtn.className = "btn-save";
                        tBtn.innerText = "Hôm nay";
                        tBtn.onclick = () => { instance.setDate(new Date()); instance.close(); };
                        footer.appendChild(cBtn);
                        footer.appendChild(tBtn);
                        container.appendChild(footer);
                    }
                });
            });
        }

        async function saveNewRow() {
            if (isSaving) return;
            const inputs = document.querySelectorAll('.add-input');
            const rawHeaders = currentData[0];
            const newData = new Array(rawHeaders.length).fill("");

            inputs.forEach(input => {
                const col = parseInt(input.getAttribute('data-col'));
                if (col !== -1) newData[col] = input.value || "";
            });

            // Nếu côt id trống, gán tạm (Sheet API sẽ tự handle nếu bạn config)
            const idIdx = rawHeaders.indexOf("id");
            if (idIdx !== -1 && !newData[idIdx]) {
                newData[idIdx] = Date.now().toString();
            }

            isSaving = true;
            isAddingNewRow = true; // Để fetchData biết re-render
            const statusLabel = document.getElementById('saveStatus');
            statusLabel.style.display = 'block';

            try {
                const token = await getAccessToken();
                const sid = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
                const sname = localStorage.getItem('gs_name') || CONFIG.sheetName;

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${sname}!A:A:append?valueInputOption=USER_ENTERED`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values: [newData] })
                });

                if (response.ok) {
                    closeModal('addModal');
                    isAddingNewRow = false;
                    await fetchData();
                } else {
                    const err = await response.json();
                    alert("Lỗi khi thêm dòng: " + err.error.message);
                }
            } catch (err) {
                console.error("Add error:", err);
            } finally {
                statusLabel.style.display = 'none';
                isSaving = false;
            }
        }

        function exportToExcel() {
            if (currentData.length < 2) return alert("Không có dữ liệu để xuất.");

            const rawHeaders = currentData[0];
            const visibleIndices = CONFIG.displayColumns.map(colName => rawHeaders.indexOf(colName)).filter(idx => idx !== -1);

            let rowsToExport = [];
            if (selectedRows.size > 0) {
                rowsToExport = Array.from(selectedRows).sort((a, b) => a - b).map(idx => currentData[idx]);
            } else {
                rowsToExport = displayData.slice(1);
            }

            const exportData = [rawHeaders, ...rowsToExport].map(row => {
                return visibleIndices.map(idx => row[idx]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, "Dữ liệu");

            const fileName = `Dữ_liệu_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportToMisa() {
            if (currentData.length < 2) return alert("Không có dữ liệu để xuất.");

            const rawHeaders = currentData[0].map(h => h.toString().trim().toLowerCase());
            const mvdIdx = rawHeaders.indexOf("mvd");
            const ngayNhanIdx = rawHeaders.indexOf("ngay_nhan");
            const skuIdx = rawHeaders.indexOf("sku");
            const slgIdx = rawHeaders.indexOf("slg");
            const maGianIdx = rawHeaders.indexOf("ma_gian");

            const misaHeaders = [
                "Hiển thị trên sổ", "Hình thức bán hàng", "Phương thức thanh toán", "Kiêm phiếu nhập kho",
                "Ngày hạch toán (*)", "Ngày chứng từ (*)", "Số chứng từ (*)", "Ngày phiếu nhập", "Số phiếu nhập",
                "Mẫu số HĐ", "Ký hiệu HĐ", "Số hóa đơn", "Ngày hóa đơn", "Mã khách hàng", "Tên khách hàng",
                "Địa chỉ", "Mã số thuế", "Diễn giải/Lý do chi", "NV bán hàng", "Người giao hàng",
                "Diễn giải phiếu nhập", "Kèm theo chứng từ gốc (Phiếu nhập)", "Cách lấy đơn giá nhập",
                "Mã hàng (*)", "Tên hàng", "Hàng khuyến mại", "TK trả lại/TK nợ (*)", "TK công nợ/TK tiền/TK có (*)",
                "ĐVT", "Số lượng", "Đơn giá sau thuế", "Đơn giá", "Thành tiền", "Tỷ lệ CK (%)",
                "Tiền chiết khấu", "TK chiết khấu", "% thuế GTGT", "Tiền thuế GTGT", "TK thuế GTGT",
                "HH không TH trên tờ khai thuế GTGT", "Kho", "TK Kho", "TK giá vốn", "Đơn giá vốn",
                "Tiền vốn", "Hàng hoá giữ hộ/bán hộ", "Mã đơn hàng", "Mã thống kê"
            ];

            let rowsToExport = [];
            if (selectedRows.size > 0) {
                rowsToExport = Array.from(selectedRows).sort((a, b) => a - b).map(idx => currentData[idx]);
            } else {
                rowsToExport = displayData.slice(1);
            }

            const exportData = rowsToExport.map(row => {
                const ngayVal = ngayNhanIdx !== -1 ? (row[ngayNhanIdx] || "") : "";
                const mvdVal = mvdIdx !== -1 ? (row[mvdIdx] || "") : "";
                const maGianVal = maGianIdx !== -1 ? (row[maGianIdx] || "") : "";
                const skuVal = skuIdx !== -1 ? (row[skuIdx] || "") : "";
                const slgVal = slgIdx !== -1 ? (row[slgIdx] || "") : "";

                // Mảng 48 phần tử (0-indexed)
                let misaRow = new Array(48).fill("");

                misaRow[0] = "0"; // Hiển thị trên sổ
                misaRow[1] = "0"; // Hình thức bán hàng
                misaRow[2] = "0"; // Phương thức thanh toán
                misaRow[3] = "1"; // Kiêm phiếu nhập kho
                misaRow[4] = ngayVal; // Ngày hạch toán
                misaRow[5] = ngayVal; // Ngày chứng từ
                misaRow[6] = mvdVal;  // Số chứng từ
                misaRow[8] = mvdVal;  // Số phiếu nhập
                // 9->12 để trống
                misaRow[13] = maGianVal; // Mã khách hàng
                // 14->22 để trống
                misaRow[23] = skuVal; // Mã hàng (*)
                // 24->25 để trống
                misaRow[26] = "5212"; // TK trả lại/TK nợ
                misaRow[27] = "131";  // TK công nợ/TK tiền/TK có
                // 28 để trống
                misaRow[29] = slgVal; // Số lượng
                misaRow[30] = "";     // Đơn giá sau thuế
                misaRow[31] = "0";    // Đơn giá
                misaRow[32] = "0";    // Thành tiền
                // 33->39 để trống
                misaRow[40] = "KMB";  // Kho
                misaRow[41] = "1561"; // TK Kho
                misaRow[42] = "632";  // TK giá vốn

                return misaRow;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([misaHeaders, ...exportData]);
            XLSX.utils.book_append_sheet(wb, ws, "Misa");

            const fileName = `Export_Misa_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function addRow() {
            openAddModal();
        }

        async function clearRowData(absoluteIndex) {
            if (isAddingNewRow) return alert("Vui lòng hoàn tất hoặc hủy dòng đang thêm.");
            if (!confirm("Bạn có chắc chắn muốn xóa toàn bộ dữ liệu của dòng này không?")) return;

            await deleteRowsFromSheet([absoluteIndex]);
        }

        function toggleSelect(absoluteIndex, displayIndex, event) {
            if (event && event.shiftKey && lastSelectedIndex !== null) {
                // Chọn vùng
                const start = Math.min(lastSelectedIndex, displayIndex);
                const end = Math.max(lastSelectedIndex, displayIndex);

                // Trạng thái của ô đầu tiên được click (lastSelectedIndex)
                const lastAbsoluteIndex = currentData.indexOf(displayData[lastSelectedIndex]);
                const newState = selectedRows.has(lastAbsoluteIndex); // Theo logic người dùng: Shift+Click thường là áp dụng trạng thái của điểm bắt đầu

                for (let i = start; i <= end; i++) {
                    const rowIdx = currentData.indexOf(displayData[i]);
                    if (rowIdx !== -1) {
                        if (newState) selectedRows.add(rowIdx);
                        else selectedRows.delete(rowIdx);
                    }
                }
            } else {
                // Chọn đơn lẻ
                if (selectedRows.has(absoluteIndex)) {
                    selectedRows.delete(absoluteIndex);
                } else {
                    selectedRows.add(absoluteIndex);
                }
            }
            lastSelectedIndex = displayIndex;
            updateBulkActionsUI();
            renderTable();
        }

        function toggleSelectionMode(checked) {
            isSelectionMode = checked;
            if (!isSelectionMode) {
                selectedRows.clear();
                lastSelectedIndex = null;
                updateBulkActionsUI();
            }
            renderTable();
        }

        function clearSelection() {
            selectedRows.clear();
            lastSelectedIndex = null;
            updateBulkActionsUI();
            renderTable();
        }

        function updateBulkActionsUI() {
            const btnDelete = document.getElementById('btnBulkDelete');
            const countText = document.getElementById('selectedCountText');

            if (selectedRows.size > 0) {
                if (btnDelete) btnDelete.style.display = 'flex';
                if (countText) countText.textContent = selectedRows.size;
            } else {
                if (btnDelete) btnDelete.style.display = 'none';
            }
        }

        async function duplicateRow(absoluteIndex) {
            const rawHeaders = currentData[0];
            const sourceRow = currentData[absoluteIndex];
            const newRowData = new Array(rawHeaders.length).fill("");

            // Các cột cần nhân bản
            const colsToCopy = ['ngay_nhan', 'mvd', 'ma_gian', 'anh_1'];

            rawHeaders.forEach((h, idx) => {
                const headerName = h.toString().trim().toLowerCase();
                if (colsToCopy.includes(headerName)) {
                    newRowData[idx] = sourceRow[idx] || "";
                }
                // Luôn tạo ID mới nếu có cột id
                if (headerName === "id") {
                    newRowData[idx] = Date.now().toString();
                }
            });

            const statusLabel = document.getElementById('saveStatus');
            statusLabel.textContent = "Đang nhân bản đơn hàng...";
            statusLabel.style.display = 'block';

            try {
                const token = await getAccessToken();
                const sid = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
                const sname = localStorage.getItem('gs_name') || CONFIG.sheetName;

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${sname}!A:A:append?valueInputOption=USER_ENTERED`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ values: [newRowData] })
                });

                if (response.ok) {
                    statusLabel.textContent = "Nhân bản thành công!";
                    setTimeout(() => statusLabel.style.display = 'none', 2000);
                    fetchData();
                } else {
                    alert("Lỗi khi nhân bản dòng.");
                }
            } catch (err) {
                console.error("Duplicate error:", err);
            } finally {
                setTimeout(() => {
                    if (statusLabel && !statusLabel.textContent.includes("Nhân bản")) statusLabel.style.display = 'none';
                }, 1000);
            }
        }




        async function deleteSelectedRows() {
            if (selectedRows.size === 0) return;
            if (!confirm(`Bạn có chắc muốn xóa sạch dữ liệu của ${selectedRows.size} dòng đã chọn?`)) return;

            const indices = Array.from(selectedRows);
            await deleteRowsFromSheet(indices);
            selectedRows.clear();
            updateBulkActionsUI();
        }

        async function deleteRowsFromSheet(indices) {
            const statusLabel = document.getElementById('saveStatus');
            try {
                statusLabel.textContent = "Đang xóa dữ liệu...";
                statusLabel.style.display = 'block';

                const token = await getAccessToken();
                const sid = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
                const sname = localStorage.getItem('gs_name') || CONFIG.sheetName;

                // Để xóa hàng loạt hiệu quả, chúng ta có thể dùng batchUpdate hoặc gọi clear cho từng dòng
                // Hiện tại code đang dùng clear cho đẹp (giữ nguyên cấu trúc dòng)
                const promises = indices.map(idx => {
                    const range = `${sname}!A${idx + 1}:Z${idx + 1}`;
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/${range}:clear`;
                    return fetch(url, { method: "POST", headers: { "Authorization": `Bearer ${token}` } });
                });

                const results = await Promise.all(promises);
                const allOk = results.every(res => res.ok);

                if (allOk) {
                    indices.forEach(idx => {
                        currentData[idx] = currentData[0].map(() => "");
                    });
                    try { localStorage.setItem('gs_cached_data', JSON.stringify(currentData)); } catch (e) { }
                    filterAndSortData();
                } else {
                    alert("Có lỗi xảy ra khi xóa một số dòng.");
                    fetchData(); // Tải lại để đồng bộ
                }
            } catch (err) {
                console.error("Delete error:", err);
            } finally {
                statusLabel.textContent = "Đang lưu thay đổi...";
                setTimeout(() => statusLabel.style.display = 'none', 1000);
            }
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('inputSpreadsheetId').value = localStorage.getItem('gs_id') || CONFIG.spreadsheetId;
            document.getElementById('inputSheetName').value = localStorage.getItem('gs_name') || CONFIG.sheetName;
            document.getElementById('inputDisplayColumns').value = (localStorage.getItem('gs_cols') || CONFIG.displayColumns.join(', '));
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function applySettings() {
            const id = document.getElementById('inputSpreadsheetId').value;
            const name = document.getElementById('inputSheetName').value;
            const colsRaw = document.getElementById('inputDisplayColumns').value;

            localStorage.setItem('gs_id', id);
            localStorage.setItem('gs_name', name);
            localStorage.setItem('gs_cols', colsRaw);

            // Cập nhật CONFIG động
            CONFIG.displayColumns = colsRaw.split(',').map(s => s.trim()).filter(s => s !== "");

            closeModal('settingsModal');
            fetchData();
        }

        function resetSettings() {
            if (confirm("Bạn có chắc muốn xóa cài đặt và dùng cấu hình mặc định?")) {
                localStorage.removeItem('gs_id');
                localStorage.removeItem('gs_name');
                localStorage.removeItem('gs_cols');
                location.reload(); // Reload để nhận lại CONFIG mặc định
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- UTILS ---
        function isImageUrl(url) {
            if (typeof url !== 'string') return false;
            const cleanUrl = url.trim().toLowerCase();
            return (cleanUrl.startsWith('http') &&
                (cleanUrl.match(/\.(jpeg|jpg|gif|png|webp|svg|avif)(\?.*)?$/) || cleanUrl.includes('googleusercontent.com')));
        }

        function zoomImage(url) {
            const overlay = document.getElementById('imageOverlay');
            const img = document.getElementById('overlayImage');
            img.src = url;
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageOverlay() {
            const overlay = document.getElementById('imageOverlay');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Chuyển số cột thành chữ cái (1 -> A, 27 -> AA)
        function getColLetter(n) {
            let letter = "";
            while (n > 0) {
                let temp = (n - 1) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                n = (n - temp - 1) / 26;
            }
            return letter || "A";
        }

        // --- HELPERS FOR EDITING ---
        function changeQuantity(el, delta) {
            const input = el.parentElement.querySelector('input');
            if (input) {
                let val = parseInt(input.value) || 0;
                val += delta;
                if (val < 1) val = 1; // Giới hạn tối thiểu là 1
                input.value = val;
                // saveData sẽ đọc từ input khi blur
            }
        }

        function setToday(el, colIndex) {
            const input = el.closest('div').querySelector('input[type="text"]');
            if (input) {
                const now = new Date();
                const d = String(now.getDate()).padStart(2, '0');
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const y = now.getFullYear();
                input.value = `${d}/${m}/${y}`;
                // Câp nhật dữ liệu cục bộ ngay nếu cần, nhưng saveData sẽ đọc từ input
            }
        }

        function startQRScanner(el) {
            currentTargetInput = el.closest('div').querySelector('input[type="text"]');
            document.getElementById('qrModal').style.display = 'flex';
            isUploading = true; // Ngăn blur tự động lưu khi mở camera

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start(
                { facingMode: "environment" },
                qrConfig,
                (decodedText) => {
                    if (currentTargetInput) {
                        currentTargetInput.value = decodedText;
                        stopQRScanner();
                    }
                },
                (errorMessage) => {
                    // console.log(errorMessage);
                }
            ).catch((err) => {
                console.error("Lỗi camera:", err);
                alert("Không thể mở camera. Vui lòng cấp quyền truy cập.");
                stopQRScanner();
            });
        }

        function stopQRScanner() {
            document.getElementById('qrModal').style.display = 'none';
            isUploading = false;
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                });
            }
            // Trigger blur check if needed
            if (currentTargetInput) {
                setTimeout(() => {
                    currentTargetInput.focus();
                    currentTargetInput.blur();
                }, 100);
            }
            currentTargetInput = null;
        }

        async function handleImageUpload(input, colIndex) {
            const file = input.files[0];
            if (!file) return;

            const apiKey = CONFIG.imgbbApiKey;
            if (!apiKey) {
                alert("Bạn chưa cấu hình imgbbApiKey trong code. Hãy đăng ký tài khoản tại imgbb.com để lấy API key.");
                return;
            }

            const isAddModal = document.getElementById('addModal').style.display === 'flex';

            if (editingRowIndex === null && !isAddModal) {
                isUploading = false;
                return;
            }
            isUploading = true; // Chặn saveData từ sự kiện blur

            const statusLabel = document.getElementById('saveStatus');
            statusLabel.textContent = "Đang tải ảnh lên ImgBB...";
            statusLabel.style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    const directUrl = result.data.url;

                    // Cập nhật giá trị vào DOM và dữ liệu cục bộ ngay lập tức
                    const targetInput = input.closest('div').querySelector('input[type="text"]');
                    if (targetInput) {
                        targetInput.value = directUrl;
                    }
                    // KHÔNG cập nhật currentData ở đây để saveData() thấy sự thay đổi so với cache

                    isUploading = false; // Mở khóa để saveData có thể chạy
                    if (!isAddModal) {
                        await saveData(); // Chỉ tự động lưu nếu đang sửa trực tiếp trên bảng
                    }
                } else {
                    alert("Lỗi tải ảnh: " + (result.error ? result.error.message : "Thất bại"));
                    isUploading = false;
                }
            } catch (err) {
                console.error("Upload error:", err);
                alert("Lỗi kết nối khi tải ảnh. Kiểm tra Internet và API Key.");
                isUploading = false;
            } finally {
                statusLabel.style.display = 'none';
                input.value = "";
            }
        }

        // Khởi tạo
        window.onload = () => {
            // Load cột từ localStorage nếu có
            const savedCols = localStorage.getItem('gs_cols');
            if (savedCols) {
                CONFIG.displayColumns = savedCols.split(',').map(s => s.trim()).filter(s => s !== "");
            }

            const cachedData = localStorage.getItem('gs_cached_data');
            if (cachedData) {
                try {
                    currentData = JSON.parse(cachedData);
                    filterAndSortData();
                } catch (e) { console.error("Cache parse error", e); }
            }

            // Tự động render lại khi xoay màn hình hoặc resize
            window.addEventListener('resize', () => {
                renderTable();
            });

            fetchData();
        };
    </script>
</body>

</html>

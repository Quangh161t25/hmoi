<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VieAI - Báo cáo Hàng hóa & Tồn kho</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb; --primary-light: #3b82f6; --primary-dark: #1d4ed8; 
      --secondary: #0ea5e9; --accent: #06b6d4; --gradient: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; 
      --gray-400: #94a3b8; --gray-500: #64748b; --gray-600: #475569; --gray-700: #334155; 
      --gray-800: #1e293b; --white: #ffffff; --success: #10b981; --warning: #f59e0b; 
      --danger: #ef4444; --danger-light: #fecaca; --warning-light: #fef3c7;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 8px; --radius-lg: 12px; --radius-xl: 16px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
      color: var(--gray-700); 
      line-height: 1.6; 
      min-height: 100vh;
    }
    
    .header { 
      background: var(--gradient); 
      color: white; 
      padding: 18px 24px; 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      box-shadow: var(--shadow-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-content { display: flex; align-items: center; gap: 12px; }
    .header h2 { font-size: 22px; font-weight: 700; }
    .logo { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .logo i { font-size: 20px; }
    
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
    .user-name { font-weight: 500; font-size: 14px; }
    
    .tabs { 
      display: flex; 
      gap: 4px; 
      background: white; 
      padding: 12px 24px; 
      border-bottom: 1px solid var(--gray-200); 
      position: sticky; 
      top: 76px; 
      z-index: 90; 
      overflow-x: auto;
      box-shadow: var(--shadow-sm);
    }
    
    .tabs button { 
      padding: 12px 20px; 
      border: none; 
      border-radius: var(--radius); 
      background: transparent; 
      font-weight: 600; 
      cursor: pointer; 
      white-space: nowrap; 
      color: var(--gray-600); 
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tabs button:hover { 
      background: var(--gray-100); 
      color: var(--primary);
    }
    
    .tabs button.active { 
      background: var(--primary); 
      color: white; 
      box-shadow: var(--shadow);
    }
    
    .tab { display: none; padding: 24px; }
    .tab.active { display: block; }
    
    .card { 
      background: white; 
      border-radius: var(--radius-xl); 
      box-shadow: var(--shadow); 
      margin-bottom: 24px; 
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .card-header { 
      padding: 20px 24px; 
      border-bottom: 1px solid var(--gray-200); 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: var(--gray-50);
    }
    
    .card-title { 
      font-size: 20px; 
      font-weight: 700; 
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title i {
      color: var(--primary);
    }
    
    .controls { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      padding: 20px 24px; 
      background: var(--gray-50); 
      border-bottom: 1px solid var(--gray-200);
    }
    
    .input, .select, .btn { 
      padding: 12px 16px; 
      border: 1px solid var(--gray-300); 
      border-radius: var(--radius); 
      font-size: 14px; 
      background: white; 
      transition: all 0.2s;
    }
    
    .input:focus, .select:focus { 
      outline: none; 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
    }
    
    .btn { 
      cursor: pointer; 
      font-weight: 600; 
      background: var(--primary); 
      color: white; 
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .btn:hover { 
      background: var(--primary-dark); 
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .btn-preset { 
      background: var(--gray-100); 
      color: var(--gray-700); 
      font-weight: 600; 
      border: 1px solid var(--gray-300);
    }
    
    .btn-preset.active { 
      background: var(--primary); 
      color: white; 
      border-color: var(--primary);
    }
    
    .btn-icon {
      padding: 10px 14px;
    }
    
    .table-container { 
      position: relative; 
      overflow: auto; 
      max-height: calc(100vh - 300px); 
      border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 14px; 
    }
    
    th, td { 
      padding: 14px 16px; 
      text-align: left; 
      border-bottom: 1px solid var(--gray-200); 
      white-space: nowrap; 
    }
    
    th { 
      background: var(--gray-50); 
      position: sticky; 
      top: 0; 
      z-index: 1; 
      font-weight: 700; 
      color: var(--gray-700);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover { 
      background: var(--primary-light); 
      color: white;
    }
    
    .loading {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      width: 50px; 
      height: 50px; 
      border: 4px solid #f3f4f6; 
      border-top-color: var(--primary);
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      z-index: 10;
    }
    
    @keyframes spin { 
      to { transform: translate(-50%, -50%) rotate(360deg); } 
    }
    
    .empty-state { 
      text-align: center; 
      padding: 60px 20px; 
      color: var(--gray-500);
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--gray-400);
    }
    
    .total-row { 
      background: var(--primary-light) !important; 
      font-weight: 700; 
      color: white;
    }
    
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    
    .percent-low { color: var(--danger); font-weight: 700; }
    .percent-medium { color: var(--warning); font-weight: 700; }
    .percent-high { color: var(--success); font-weight: 700; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin: 8px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray-600);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-trend {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    
    @media (max-width: 1024px) {
      .stats-container { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .controls { flex-direction: column; }
      .input, .select, .btn { width: 100%; }
      .stats-container { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .user-info { align-self: flex-end; margin-top: -50px; }
      .card-header { flex-direction: column; align-items: flex-start; gap: 16px; }
    }
    
    @media (max-width: 480px) {
      .tabs { padding: 8px 12px; }
      .tabs button { padding: 10px 12px; font-size: 13px; }
      .tab { padding: 16px; }
      .user-info { margin-top: 0; align-self: flex-start; }
    }
    
    .footer {
      text-align: center;
      padding: 20px;
      color: var(--gray-500);
      font-size: 14px;
      border-top: 1px solid var(--gray-200);
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-boxes"></i>
      </div>
      <h2>Báo cáo Hàng hóa & Tồn kho theo tuần</h2>
    </div>
    <div class="user-info">
      <div class="user-name">Kho mn</div>
      <div class="user-avatar">
        <i class="fas fa-user"></i>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button data-tab="tab-hanghoa" class="active">
      <i class="fas fa-chart-line"></i>
      Báo cáo hàng hóa
    </button>
    <button data-tab="tab-tonkho">
      <i class="fas fa-boxes"></i>
      Báo cáo tồn kho
    </button>
    <button data-tab="tab-hangcham">
      <i class="fas fa-exclamation-triangle"></i>
      Hàng nhiều bán được ít
    </button>
  </div>

  <!-- TAB BÁO CÁO HÀNG HÓA -->
  <div id="tab-hanghoa" class="tab active">
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-box-open"></i>
          Tổng sản phẩm
        </div>
        <div class="stat-value" id="totalProducts">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng số ID sản phẩm
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-shipping-fast"></i>
          Tổng xuất hàng
        </div>
        <div class="stat-value" id="totalExports">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng xuất khi lọc
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-chart-bar"></i>
          Sản phẩm xuất nhiều nhất
        </div>
        <div class="stat-value" id="topProduct">-</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-fire"></i>
          Sản phẩm bán chạy
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-calendar-alt"></i>
          Khoảng thời gian
        </div>
        <div class="stat-value" id="dateRange">-</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-clock"></i>
          Khoảng ngày đã chọn
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-bar"></i>
          Tổng xuất hàng theo sản phẩm
        </h3>
        <div class="controls">
          <button class="btn btn-preset active" onclick="setPreset('week')">
            <i class="fas fa-calendar-week"></i>
            Tuần này
          </button>
          <button class="btn btn-preset" onclick="setPreset('lastweek')">
            <i class="fas fa-chevron-left"></i>
            Tuần trước
          </button>
          <button class="btn btn-preset" onclick="setPreset('month')">
            <i class="fas fa-calendar-alt"></i>
            Tháng này
          </button>
          <input type="date" id="fromDateHH" class="input">
          <input type="date" id="toDateHH" class="input">
          <select id="filterThuongHieu" class="select">
            <option value="">Tất cả thương hiệu</option>
          </select>
          <input id="filterIdSP" class="input" placeholder="Lọc ID SP...">
          <button class="btn" onclick="renderHangHoa()">
            <i class="fas fa-filter"></i>
            Lọc
          </button>
        </div>
      </div>
      <div class="table-container">
        <div class="loading"></div>
        <table id="tblHangHoa">
          <thead>
            <tr>
              <th>ID SP</th>
              <th>Tên sản phẩm</th>
              <th>Thương hiệu</th>
              <th class="text-right">Tổng xuất</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB BÁO CÁO TỒN KHO -->
  <div id="tab-tonkho" class="tab">
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-warehouse"></i>
          Tổng tồn kho
        </div>
        <div class="stat-value" id="totalInventory">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng tồn cuối kỳ
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-money-bill-wave"></i>
          Giá trị tồn kho
        </div>
        <div class="stat-value" id="inventoryValue">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng giá trị tồn kho
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-box"></i>
          Sản phẩm sắp hết
        </div>
        <div class="stat-value" id="lowStockProducts">0</div>
        <div class="stat-trend trend-down">
          <i class="fas fa-exclamation-circle"></i>
          Cần nhập thêm
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-cubes"></i>
          Tổng sản phẩm
        </div>
        <div class="stat-value" id="totalProductsTK">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Số sản phẩm có tồn kho
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-boxes"></i>
          Báo cáo tồn kho theo kỳ
        </h3>
        <div class="controls">
          <input type="date" id="fromDateTK" class="input" placeholder="Từ ngày">
          <input type="date" id="toDateTK" class="input" placeholder="Đến ngày">
          <button class="btn" onclick="renderTonKho()">
            <i class="fas fa-sync-alt"></i>
            Cập nhật
          </button>
        </div>
      </div>
      <div class="table-container">
        <div class="loading"></div>
        <table id="tblTonKho">
          <thead>
            <tr>
              <th>SKU Cha</th>
              <th>ID SP</th>
              <th>Tên SP</th>
              <th class="text-right">Giá nhập</th>
              <th class="text-right">TỒN ĐẦU</th>
              <th class="text-right">TỒN TRC KÌ</th>
              <th class="text-right">Nhập kỳ</th>
              <th class="text-right">Xuất kỳ</th>
              <th class="text-right">Tồn cuối kỳ</th>
              <th class="text-right">Giá trị tồn</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB HÀNG NHIỀU BÁN ĐƯỢC ÍT -->
  <div id="tab-hangcham" class="tab">
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-boxes"></i>
          Sản phẩm bán chậm
        </div>
        <div class="stat-value" id="totalSlowProducts">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng sản phẩm bán chậm
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-percentage"></i>
          Tỷ lệ bán thấp nhất
        </div>
        <div class="stat-value" id="lowestSaleRate">0%</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tỷ lệ bán thấp nhất
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-warehouse"></i>
          Tổng tồn kho bán chậm
        </div>
        <div class="stat-value" id="totalSlowInventory">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng tồn kho bán chậm
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-calculator"></i>
          Tổng xuất bán chậm
        </div>
        <div class="stat-value" id="totalSlowExports">0</div>
        <div class="stat-trend trend-up">
          <i class="fas fa-info-circle"></i>
          Tổng xuất hàng bán chậm
        </div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-exclamation-triangle"></i>
          Hàng tồn nhiều nhưng bán được ít (< 10%)
        </h3>
        <div class="controls">
          <input type="date" id="fromDateHC" class="input" placeholder="Từ ngày">
          <input type="date" id="toDateHC" class="input" placeholder="Đến ngày">
          <button class="btn" onclick="renderHangCham()">
            <i class="fas fa-sync-alt"></i>
            Cập nhật
          </button>
        </div>
      </div>
      <div class="table-container">
        <div class="loading"></div>
        <table id="tblHangCham">
          <thead>
            <tr>
              <th>SKU Cha</th>
              <th>ID SP</th>
              <th>Tên SP</th>
              <th class="text-right">TỒN KHO</th>
              <th class="text-right">Nhập kỳ</th>
              <th class="text-right">Xuất kỳ</th>
              <th class="text-right percent-low">% BÁN</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Hệ thống Báo cáo Hàng hóa & Tồn kho - wameli  &copy; 2025</p>
  </div>

  <script>
    // ========== CẤU HÌNH ==========
    const API_URL = "https://script.google.com/macros/s/AKfycbxNG88EMIe9WWHHyU-lfoNC03XL_xGNSHvSmgBSY_jzG3s3zaw-NHTfRR5i_Wp5XQNG/exec";
    let DATA = { DON_HANG_CT: [], DS_SP_PM: [], TON_KHO: [] };
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // ========== LẤY DỮ LIỆU ==========
    fetch(API_URL)
      .then(r => r.json())
      .then(raw => {
        DATA.DON_HANG_CT = raw.filter(r => r._sheet === "DON_HANG_CT");
        DATA.DS_SP_PM = raw.filter(r => r._sheet === "DS_SP_PM");
        DATA.TON_KHO = raw.filter(r => r._sheet === "TON_KHO");
        initUI();
        setPreset('week');
      })
      .catch(err => {
        alert("Lỗi kết nối API!");
        console.error(err);
      });

    // ========== KHỞI TẠO UI ==========
    function initUI() {
      const brands = ["Tất cả thương hiệu", ...new Set(DATA.DON_HANG_CT.map(r => r.thuong_hieu).filter(Boolean))];
      $("#filterThuongHieu").innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join("");
    }

    // ========== ĐẶT LỌC NHANH ==========
    function setPreset(type) {
      const now = new Date();
      let from, to;

      if (type === 'week') {
        const day = now.getDay() || 7;
        from = new Date(now - (day - 1) * 86400000);
        to = new Date(from.getTime() + 6 * 86400000);
      } else if (type === 'lastweek') {
        const day = now.getDay() || 7;
        to = new Date(now - day * 86400000);
        from = new Date(to.getTime() - 6 * 86400000);
      } else if (type === 'month') {
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      }

      const f = from.toISOString().slice(0,10);
      const t = to.toISOString().slice(0,10);

      $("#fromDateHH").value = f; $("#toDateHH").value = t;
      $("#fromDateTK").value = f; $("#toDateTK").value = t;
      $("#fromDateHC").value = f; $("#toDateHC").value = t;

      $$(".btn-preset").forEach(b => b.classList.remove("active"));
      $(`[onclick="setPreset('${type}')"]`).classList.add("active");

      renderHangHoa();
      renderTonKho();
      renderHangCham();
    }

    // ========== TAB 1: BÁO CÁO HÀNG HÓA ==========
    function renderHangHoa() {
      const loading = $("#tab-hanghoa .loading");
      loading.style.display = "block";

      setTimeout(() => {
        const from = $("#fromDateHH").value ? new Date($("#fromDateHH").value) : null;
        const to = $("#toDateHH").value ? new Date($("#toDateHH").value) : null;
        const filterId = ($("#filterIdSP").value || "").trim().toLowerCase();
        const filterBrand = $("#filterThuongHieu").value;

        const summary = {};
        let tongXuat = 0;
        let uniqueProducts = new Set();

        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho !== "KHO" || r.trương !== "XUẤT") return;
          const d = new Date(r.ngay.split("/").reverse().join("-"));
          if ((from && d < from) || (to && d > to)) return;

          const idKey = (r.id_sp || "").toLowerCase();
          if (filterId && !idKey.includes(filterId)) return;
          if (filterBrand && filterBrand !== "Tất cả thương hiệu" && r.thuong_hieu !== filterBrand) return;

          if (!summary[idKey]) {
            summary[idKey] = { id_sp: r.id_sp, ten: r.ten, thuong_hieu: r.thuong_hieu || "Không có", sl: 0 };
          }
          const sl = +r.so_luong || 0;
          summary[idKey].sl += sl;
          tongXuat += sl;
          uniqueProducts.add(idKey);
        });

        const result = Object.values(summary).sort((a, b) => b.sl - a.sl);
        const tbody = $("#tblHangHoa tbody");
        tbody.innerHTML = "";

        // Cập nhật thống kê
        $("#totalProducts").textContent = uniqueProducts.size;
        $("#totalExports").textContent = tongXuat.toLocaleString();
        
        // Tìm sản phẩm bán chạy nhất
        if (result.length > 0) {
          const topProduct = result[0];
          $("#topProduct").textContent = topProduct.id_sp;
        } else {
          $("#topProduct").textContent = "-";
        }
        
        // Cập nhật khoảng thời gian
        const fromDate = $("#fromDateHH").value;
        const toDate = $("#toDateHH").value;
        if (fromDate && toDate) {
          $("#dateRange").textContent = `${fromDate} đến ${toDate}`;
        } else {
          $("#dateRange").textContent = "Chưa chọn";
        }

        if (!result.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Không có dữ liệu xuất</p>
              </td>
            </tr>`;
          loading.style.display = "none";
          return;
        }

        const frag = new DocumentFragment();
        result.forEach(r => {
          const tr = document.createElement("tr");
          [r.id_sp, r.ten, r.thuong_hieu, r.sl.toLocaleString()].forEach((v, i) => {
            const td = document.createElement("td");
            td.textContent = v;
            if (i === 3) td.className = "text-right";
            tr.appendChild(td);
          });
          frag.appendChild(tr);
        });

        const trTong = document.createElement("tr");
        trTong.className = "total-row";
        trTong.innerHTML = `<td colspan="3">TỔNG XUẤT</td><td class="text-right">${tongXuat.toLocaleString()}</td>`;
        frag.appendChild(trTong);

        tbody.appendChild(frag);
        loading.style.display = "none";
      }, 50);
    }

    // ========== TAB 2: BÁO CÁO TỒN KHO ==========
    function renderTonKho() {
      const loading = $("#tab-tonkho .loading");
      loading.style.display = "block";

      setTimeout(() => {
        const from = $("#fromDateTK").value ? new Date($("#fromDateTK").value) : null;
        const to = $("#toDateTK").value ? new Date($("#toDateTK").value) : null;

        const giaNhapMap = {};
        DATA.DS_SP_PM.forEach(p => { if (p.sku_cha) giaNhapMap[p.sku_cha] = +p.gia_nhap || 0; });

        const tonDau = {};
        DATA.TON_KHO.forEach(r => {
          if (r.kho === "KHO" && r.id_sp) {
            const key = (r.id_sp || "").toLowerCase();
            tonDau[key] = +r.ton_dau || 0;
          }
        });

        const tonTrcKi = {};
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho !== "KHO") return;
          const d = new Date(r.ngay.split("/").reverse().join("-"));
          if (from && d >= from) return;
          const key = (r.id_sp || "").toLowerCase();
          if (!tonTrcKi[key]) tonTrcKi[key] = { nhap: 0, xuat: 0 };
          if (r.trương === "NHẬP") tonTrcKi[key].nhap += +r.so_luong || 0;
          if (r.trương === "XUẤT") tonTrcKi[key].xuat += +r.so_luong || 0;
        });

        const trongKy = {};
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho !== "KHO") return;
          const d = new Date(r.ngay.split("/").reverse().join("-"));
          if ((from && d < from) || (to && d > to)) return;
          const key = (r.id_sp || "").toLowerCase();
          if (!trongKy[key]) {
            trongKy[key] = { nhap: 0, xuat: 0, sku_cha: r.sku_cha, ten: r.ten, id_sp_orig: r.id_sp };
          }
          if (r.trương === "NHẬP") trongKy[key].nhap += +r.so_luong || 0;
          if (r.trương === "XUẤT") trongKy[key].xuat += +r.so_luong || 0;
        });

        const allIdSP = new Set();
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho === "KHO" && r.id_sp) allIdSP.add((r.id_sp || "").toLowerCase());
        });

        const result = Array.from(allIdSP).map(key => {
          const sample = DATA.DON_HANG_CT.find(r => (r.id_sp || "").toLowerCase() === key) || {};
          const sku_cha = sample.sku_cha || "";
          const ten = sample.ten || "Không có tên";
          const id_sp_orig = sample.id_sp || key.toUpperCase();

          const ton_dau_val = tonDau[key] || 0;
          const pre = tonTrcKi[key] || { nhap: 0, xuat: 0 };
          const ton_trc_ki_val = pre.nhap - pre.xuat;

          const ky = trongKy[key] || { nhap: 0, xuat: 0 };
          const ton_cuoi = ton_dau_val + ton_trc_ki_val + ky.nhap - ky.xuat;
          const giaNhap = giaNhapMap[sku_cha] || 0;
          const gia_tri = ton_cuoi * giaNhap;

          return {
            sku_cha, id_sp: id_sp_orig, ten,
            gia_nhap: giaNhap,
            ton_dau: ton_dau_val,
            ton_trc_ki: ton_trc_ki_val,
            nhap_ky: ky.nhap,
            xuat_ky: ky.xuat,
            ton_cuoi, gia_tri
          };
        })
        .filter(r => r.ton_cuoi > 0)
        .sort((a, b) => b.ton_cuoi - a.ton_cuoi);

        // Cập nhật thống kê tồn kho
        let totalInventory = 0;
        let totalInventoryValue = 0;
        let lowStockCount = 0;
        
        result.forEach(r => {
          totalInventory += r.ton_cuoi;
          totalInventoryValue += r.gia_tri;
          if (r.ton_cuoi <= 5) {
            lowStockCount++;
          }
        });

        $("#totalInventory").textContent = totalInventory.toLocaleString();
        $("#inventoryValue").textContent = formatCurrencyShort(totalInventoryValue);
        $("#lowStockProducts").textContent = lowStockCount;
        $("#totalProductsTK").textContent = result.length;

        const tbody = $("#tblTonKho tbody");
        tbody.innerHTML = result.length ? "" : `
          <tr>
            <td colspan="10" class="empty-state">
              <i class="fas fa-box-open"></i>
              <p>Không có sản phẩm tồn kho</p>
            </td>
          </tr>`;

        const frag = new DocumentFragment();
        result.forEach(r => {
          const tr = document.createElement("tr");
          if (r.ton_cuoi <= 5) tr.style.background = "#fef3c7";

          [
            r.sku_cha, r.id_sp, r.ten,
            formatCurrency(r.gia_nhap),
            r.ton_dau, r.ton_trc_ki, r.nhap_ky, r.xuat_ky, r.ton_cuoi,
            formatCurrency(r.gia_tri)
          ].forEach((v, i) => {
            const td = document.createElement("td");
            td.textContent = v;
            if (i >= 3) td.className = "text-right";
            tr.appendChild(td);
          });
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        loading.style.display = "none";
      }, 50);
    }

    // ========== TAB 3: HÀNG NHIỀU BÁN ĐƯỢC ÍT (<10%) ==========
    function renderHangCham() {
      const loading = $("#tab-hangcham .loading");
      loading.style.display = "block";

      setTimeout(() => {
        const from = $("#fromDateHC").value ? new Date($("#fromDateHC").value) : null;
        const to = $("#toDateHC").value ? new Date($("#toDateHC").value) : null;

        // 1. TỒN ĐẦU từ TON_KHO
        const tonDau = {};
        DATA.TON_KHO.forEach(r => {
          if (r.kho === "KHO" && r.id_sp) {
            const key = (r.id_sp || "").toLowerCase();
            tonDau[key] = +r.ton_dau || 0;
          }
        });

        // 2. TỒN TRC KÌ = (Nhập - Xuất) trước ngày from
        const tonTrcKi = {};
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho !== "KHO") return;
          const d = new Date(r.ngay.split("/").reverse().join("-"));
          if (from && d >= from) return;
          const key = (r.id_sp || "").toLowerCase();
          if (!tonTrcKi[key]) tonTrcKi[key] = { nhap: 0, xuat: 0 };
          if (r.trương === "NHẬP") tonTrcKi[key].nhap += +r.so_luong || 0;
          if (r.trương === "XUẤT") tonTrcKi[key].xuat += +r.so_luong || 0;
        });

        // 3. Trong kỳ
        const trongKy = {};
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho !== "KHO") return;
          const d = new Date(r.ngay.split("/").reverse().join("-"));
          if ((from && d < from) || (to && d > to)) return;
          const key = (r.id_sp || "").toLowerCase();
          if (!trongKy[key]) {
            trongKy[key] = { nhap: 0, xuat: 0, sku_cha: r.sku_cha, ten: r.ten, id_sp_orig: r.id_sp };
          }
          if (r.trương === "NHẬP") trongKy[key].nhap += +r.so_luong || 0;
          if (r.trương === "XUẤT") trongKy[key].xuat += +r.so_luong || 0;
        });

        // 4. Tất cả ID_SP
        const allIdSP = new Set();
        DATA.DON_HANG_CT.forEach(r => {
          if (r.kho === "KHO" && r.id_sp) allIdSP.add((r.id_sp || "").toLowerCase());
        });

        // 5. Tính toán + LỌC
        const result = Array.from(allIdSP).map(key => {
          const sample = DATA.DON_HANG_CT.find(r => (r.id_sp || "").toLowerCase() === key) || {};
          const sku_cha = sample.sku_cha || "";
          const ten = sample.ten || "Không có tên";
          const id_sp_orig = sample.id_sp || key.toUpperCase();

          const ton_dau_val = tonDau[key] || 0;
          const pre = tonTrcKi[key] || { nhap: 0, xuat: 0 };
          const ton_trc_ki_val = pre.nhap - pre.xuat;
          const ton_kho = ton_dau_val + ton_trc_ki_val; // TỒN KHO = TỒN ĐẦU + TỒN TRC KÌ

          const ky = trongKy[key] || { nhap: 0, xuat: 0 };
          const xuat_ky = ky.xuat;

          const phan_tram_ban = ton_kho > 0 ? (xuat_ky / ton_kho) * 100 : 0;

          return {
            sku_cha, id_sp: id_sp_orig, ten,
            ton_kho,
            nhap_ky: ky.nhap,
            xuat_ky,
            phan_tram_ban
          };
        })
        .filter(r => r.xuat_ky > 0 && r.phan_tram_ban < 10 && r.ton_kho > 0) // ĐIỀU KIỆN
        .sort((a, b) => a.phan_tram_ban - b.phan_tram_ban); // Tăng dần

        // Cập nhật thống kê hàng chậm bán
        let totalSlowInventory = 0;
        let totalSlowExports = 0;
        let lowestRate = result.length > 0 ? result[0].phan_tram_ban : 0;
        
        result.forEach(r => {
          totalSlowInventory += r.ton_kho;
          totalSlowExports += r.xuat_ky;
          if (r.phan_tram_ban < lowestRate) {
            lowestRate = r.phan_tram_ban;
          }
        });

        $("#totalSlowProducts").textContent = result.length;
        $("#lowestSaleRate").textContent = lowestRate.toFixed(2) + "%";
        $("#totalSlowInventory").textContent = totalSlowInventory.toLocaleString();
        $("#totalSlowExports").textContent = totalSlowExports.toLocaleString();

        // 6. Hiển thị
        const tbody = $("#tblHangCham tbody");
        tbody.innerHTML = result.length ? "" : `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-check-circle"></i>
              <p>Không có hàng tồn nhiều bán ít</p>
            </td>
          </tr>`;

        const frag = new DocumentFragment();
        result.forEach(r => {
          const tr = document.createElement("tr");

          [
            r.sku_cha, r.id_sp, r.ten,
            r.ton_kho.toLocaleString(),
            r.nhap_ky.toLocaleString(),
            r.xuat_ky.toLocaleString(),
            r.phan_tram_ban.toFixed(2) + "%"
          ].forEach((v, i) => {
            const td = document.createElement("td");
            td.textContent = v;
            if (i >= 3) td.className = "text-right";
            if (i === 6) td.classList.add("percent-low");
            tr.appendChild(td);
          });
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        loading.style.display = "none";
      }, 50);
    }

    // ========== HỖ TRỢ ==========
    function formatCurrency(n) {
      return new Intl.NumberFormat('vi-VN').format(n) + " đ";
    }
    
    function formatCurrencyShort(n) {
      if (n >= 1000000000) {
        return (n / 1000000000).toFixed(1) + " tỷ";
      } else if (n >= 1000000) {
        return (n / 1000000).toFixed(1) + " tr";
      } else {
        return new Intl.NumberFormat('vi-VN').format(n) + " đ";
      }
    }

    // ========== CHUYỂN TAB ==========
    $$(".tabs button").forEach(btn => {
      btn.onclick = () => {
        $$(".tabs button, .tab").forEach(el => el.classList.remove("active"));
        btn.classList.add("active");
        $(`#${btn.dataset.tab}`).classList.add("active");
        if (btn.dataset.tab === "tab-tonkho") renderTonKho();
        if (btn.dataset.tab === "tab-hangcham") renderHangCham();
      };
    });

    // Đồng bộ ngày
    $("#fromDateHH, #toDateHH").forEach(el => el.onchange = () => {
      const f = $("#fromDateHH").value;
      const t = $("#toDateHH").value;
      $("#fromDateTK").value = f; $("#toDateTK").value = t;
      $("#fromDateHC").value = f; $("#toDateHC").value = t;
    });
  </script>
</body>
</html>

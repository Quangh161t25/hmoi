<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Yêu Cầu Xuất Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap&subset=vietnamese"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#000080',
                    },
                    fontFamily: {
                        sans: ['time new roman', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @media print {
            .no-print {
                display: none;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                size: A5 landscape;
                margin: 0;
            }
        }

        /* Custom table borders for professional look */
        .print-table th,
        .print-table td {
            border: 1px solid black;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Print/Download Buttons -->
    <div class="fixed top-4 right-4 no-print print:hidden z-50 flex gap-2" data-html2canvas-ignore="true">
        <button onclick="downloadPDF()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Tải PDF (A5)
        </button>

        <button onclick="downloadExcel()"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Tải Excel
        </button>

        <button onclick="window.print()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-lg flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            In Phiếu
        </button>
        <button onclick="resetData()"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow-lg">
            Làm mới
        </button>
    </div>

    <!-- Main Container: Fixed 210mm x 148mm (A5 Landscape) -->
    <div id="invoice-content"
        class="w-[210mm] h-[148mm] mx-auto bg-white shadow-xl p-3 pt-2 md:p-4 md:pt-2 relative print:shadow-none print:m-0 overflow-hidden leading-tight">

        <!-- Header -->
        <header class="mb-2">
            <div class="flex justify-between items-start mb-1">
                <div class="text-sm font-semibold">
                    <p class="uppercase">CÔNG TY CỔ PHẦN LIÊN DOANH XNK QUỐC TẾ</p>
                    <p class="uppercase mt-0.5">CHI NHÁNH MB</p>
                </div>
                <div class="text-right text-xs italic text-gray-500">
                    <!-- Placeholder for logo or other info if needed -->
                </div>
            </div>

            <h1 class="text-2xl font-bold text-center text-navy uppercase mb-2 tracking-wide">PHIẾU YÊU CẦU XUẤT HÀNG
            </h1>
        </header>

        <!-- Form Info -->
        <div id="form-info" class="grid grid-cols-2 gap-x-4 gap-y-1 mb-2">
            <!-- Col 1 -->
            <div class="space-y-1">
                <div class="flex items-center">
                    <label class="w-20 font-semibold text-gray-700 whitespace-nowrap">Người YC:</label>
                    <input type="text" id="requesterName"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
                <div class="flex items-center">
                    <label class="w-20 font-semibold text-gray-700 whitespace-nowrap">Gian hàng:</label>
                    <input type="text" id="storeName"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
                <div class="flex items-center">
                    <label class="w-20 font-semibold text-gray-700 whitespace-nowrap">Mã GH:</label>
                    <input type="text" id="storeCode"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
            </div>

            <!-- Col 2 -->
            <div class="space-y-1">
                <div class="flex items-center">
                    <label class="w-24 font-semibold text-gray-700 whitespace-nowrap">Khách hàng:</label>
                    <input type="text" id="customerName"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
                <div class="flex items-center">
                    <label class="w-24 font-semibold text-gray-700 whitespace-nowrap">SĐT:</label>
                    <input type="text" id="phone"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
                <div class="flex items-center">
                    <label class="w-24 font-semibold text-gray-700 whitespace-nowrap">Địa chỉ:</label>
                    <input type="text" id="address"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent"
                        placeholder="...">
                </div>
                <div class="flex items-center">
                    <label class="w-24 font-semibold text-gray-700 whitespace-nowrap">Ngày lập:</label>
                    <input type="date" id="date"
                        class="flex-1 border-b border-gray-300 focus:border-navy outline-none px-1 bg-transparent font-sans">
                </div>
            </div>
        </div>

        <!-- Dynamic Product Table -->
        <div class="mb-1">
            <table class="w-full border-collapse print-table text-sm">
                <thead>
                    <tr class="bg-gray-100 text-center font-bold">
                        <th class="border border-gray-400 p-2 w-12">STT</th>
                        <th class="border border-gray-400 p-2">Tên sản phẩm</th>
                        <th class="border border-gray-400 p-2 w-24">MSP (SKU)</th>
                        <th class="border border-gray-400 p-2 w-20">Số lượng</th>
                        <th class="border border-gray-400 p-2 w-28">Đơn giá</th>
                        <th class="border border-gray-400 p-2 w-28">Thành tiền</th>
                        <th class="border border-gray-400 p-2 w-32">Ghi chú</th>
                        <th class="border border-gray-400 p-2 w-10 no-print" data-html2canvas-ignore="true">Xóa</th>
                    </tr>
                </thead>
                <tbody id="product-list">
                    <!-- Rows will be added here by JS -->
                </tbody>
                <tfoot>
                    <tr class="font-bold bg-gray-50">
                        <td colspan="3" class="border border-gray-400 p-2 text-center text-navy">CỘNG</td>
                        <td id="total-qty" class="border border-gray-400 p-2 text-center">0</td>
                        <td class="border border-gray-400 p-2"></td>
                        <td id="total-amount" class="border border-gray-400 p-2 text-right">0</td>
                        <td class="border border-gray-400 p-2"></td>
                        <td class="border border-gray-400 p-2 no-print" data-html2canvas-ignore="true"></td>
                    </tr>
                </tfoot>
            </table>

            <div class="mt-4 no-print text-center" data-html2canvas-ignore="true">
                <button onclick="addRow()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2 mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                    Thêm dòng sản phẩm
                </button>
            </div>
        </div>

        <!-- Signature Section -->
        <div class="flex justify-between text-center mt-1 text-[10px]">
            <div class="flex-1">
                <p class="font-bold uppercase mb-0.5">Người lập phiếu</p>
                <div class="h-8"></div>
                <input type="text" id="creatorSignature"
                    class="text-center w-full bg-transparent outline-none placeholder-gray-300 text-[10px]"
                    placeholder="Nguyễn Văn A">
            </div>
            <div class="flex-1">
                <p class="font-bold uppercase mb-0.5">Người nhận hàng</p>
                <div class="h-8"></div>
                <input type="text"
                    class="text-center w-full bg-transparent outline-none placeholder-gray-300 text-[10px]"
                    placeholder="...">
            </div>
            <div class="flex-1">
                <p class="font-bold uppercase mb-0.5">Thủ kho</p>
                <div class="h-8"></div>
                <input type="text"
                    class="text-center w-full bg-transparent outline-none placeholder-gray-300 text-[10px]"
                    placeholder="...">
            </div>
            <div class="flex-1">
                <p class="font-bold uppercase mb-0.5">Giám đốc</p>
                <div class="h-8"></div>
                <input type="text"
                    class="text-center w-full bg-transparent outline-none placeholder-gray-300 text-[10px]"
                    placeholder="...">
            </div>
        </div>
    </div>

    <script>


// State to hold table data
let products = [];
// Initial row count for auto-filling dummy data if needed, or just for unique IDs
let nextId = 1;

// Define fields to save/load
const INPUT_IDS = [
    'requesterName', 'storeName', 'storeCode',
    'customerName', 'phone', 'address', 'date',
    'creatorSignature'
];

// Load data on start
document.addEventListener('DOMContentLoaded', () => {
    // loadData(); // Disabled: User wants clean slate on reload
    loadFromURL(); // Override with URL params if present

    if (products.length === 0) {
        // Start with one empty row
        addRow();
    } else {
        renderTable();
    }
});

function loadFromURL() {
    const params = new URLSearchParams(window.location.search);

    // Check if URL has ANY of our specific keys or products
    const hasUrlData = INPUT_IDS.some(id => params.has(id)) || params.has('products');

    if (hasUrlData) {
        // "Strict Mode": If URL has data, we overwrite everything.

        INPUT_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (params.has(id)) {
                    el.value = params.get(id);
                } else if (id === 'date') {
                    // Rule: If date missing in URL, use Today
                    el.valueAsDate = new Date();
                } else {
                    // Other fields: Clear if missing
                    el.value = '';
                }
            }
        });

        // Special Sync: If requesterName is present but creatorSignature is NOT, auto-fill signature logic
        if (params.has('requesterName') && !params.has('creatorSignature')) {
            const sig = document.getElementById('creatorSignature');
            if (sig) sig.value = params.get('requesterName');
        }

        // Load products (expects JSON string)
        if (params.has('products')) {
            try {
                const productsParam = JSON.parse(params.get('products'));
                if (Array.isArray(productsParam) && productsParam.length > 0) {
                    // Ensure IDs are unique and correct
                    products = productsParam.map((p, i) => ({
                        ...p,
                        id: nextId++ // Assign new IDs to avoid conflicts
                    }));
                } else {
                    products = [];
                }
            } catch (e) {
                console.error("Invalid products JSON in URL", e);
                products = [];
            }
        } else {
            // URL has data but no products -> clear products
            products = [];
        }

        saveData();
        renderTable();
    }
}

// Add input listeners to save data automatically
INPUT_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', (e) => {
            saveData();
            // Auto-sync Requester Name to Creator Signature
            if (id === 'requesterName') {
                const signatureEl = document.getElementById('creatorSignature');
                if (signatureEl) {
                    signatureEl.value = e.target.value;
                }
            }
        });
    }
});

function addRow() {
    products.push({
        id: nextId++,
        name: '',
        sku: '',
        qty: 0,
        price: 0,
        note: ''
    });
    renderTable();
    saveData();
}

function removeRow(index) {
    if (products.length > 1) { // Prevent deleting the last remaining row
        products.splice(index, 1);
        renderTable();
        saveData();
    } else {
        alert("Không thể xóa dòng cuối cùng!");
    }
}

function updateProduct(index, field, value) {
    products[index][field] = value;

    // If quantity or price changes, update the row total and grand totals
    if (field === 'qty' || field === 'price') {
        const rowTotal = products[index].qty * products[index].price;
        const totalCell = document.getElementById(`prod-${index}-total`);
        if (totalCell) {
            totalCell.innerText = rowTotal.toLocaleString('vi-VN');
        }
        updateTotals();
    }

    saveData();
}

function updateTotals() {
    let totalQty = 0;
    let totalAmount = 0;

    products.forEach(prod => {
        totalQty += Number(prod.qty);
        totalAmount += (prod.qty * prod.price);
    });

    document.getElementById('total-qty').innerText = totalQty.toLocaleString('vi-VN');
    document.getElementById('total-amount').innerText = totalAmount.toLocaleString('vi-VN') + ' đ';
}

function renderTable() {
    const tbody = document.getElementById('product-list');
    tbody.innerHTML = '';

    let totalQty = 0;
    let totalAmount = 0;

    products.forEach((prod, index) => {
        const rowTotal = prod.qty * prod.price;
        totalQty += Number(prod.qty);
        totalAmount += rowTotal;

        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
            <td class="border border-gray-400 p-1 text-center bg-transparent">${index + 1}</td>
            <td class="border border-gray-400 p-0">
                <input type="text" id="prod-${index}-name" 
                    class="w-full h-full p-1 outline-none bg-transparent" 
                    value="${prod.name}" 
                    oninput="updateProduct(${index}, 'name', this.value)"
                >
            </td>
            <td class="border border-gray-400 p-0">
                <input type="text" id="prod-${index}-sku" 
                    class="w-full h-full p-1 text-center outline-none bg-transparent" 
                    value="${prod.sku}" 
                    oninput="updateProduct(${index}, 'sku', this.value)"
                >
            </td>
            <td class="border border-gray-400 p-0">
                <input type="number" id="prod-${index}-qty" 
                    class="w-full h-full p-1 text-center outline-none bg-transparent" 
                    value="${prod.qty}" 
                    oninput="updateProduct(${index}, 'qty', this.value)"
                >
            </td>
            <td class="border border-gray-400 p-0">
                <input type="number" id="prod-${index}-price" 
                    class="w-full h-full p-1 text-right outline-none bg-transparent" 
                    value="${prod.price}" 
                    oninput="updateProduct(${index}, 'price', this.value)"
                >
            </td>
            <td id="prod-${index}-total" class="border border-gray-400 p-1 text-right font-medium">
                ${rowTotal.toLocaleString('vi-VN')}
            </td>
            <td class="border border-gray-400 p-0">
                <input type="text" id="prod-${index}-note" 
                    class="w-full h-full p-1 outline-none bg-transparent" 
                    value="${prod.note}" 
                    oninput="updateProduct(${index}, 'note', this.value)"
                >
            </td>
            <td class="border border-gray-400 p-1 text-center no-print" data-html2canvas-ignore="true">
                <button onclick="removeRow(${index})" class="text-red-500 hover:text-red-700 font-bold px-1">
                    &times;
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('total-qty').innerText = totalQty.toLocaleString('vi-VN');
    document.getElementById('total-amount').innerText = totalAmount.toLocaleString('vi-VN') + ' đ';
}

function saveData() {
    const data = {
        products: products,
        inputs: {}
    };

    INPUT_IDS.forEach(id => {
        data.inputs[id] = document.getElementById(id).value;
    });

    localStorage.setItem('exportForm_data', JSON.stringify(data));
}

function loadData() {
    const saved = localStorage.getItem('exportForm_data');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            if (data.products) products = data.products;
            if (data.inputs) {
                INPUT_IDS.forEach(id => {
                    if (data.inputs[id]) document.getElementById(id).value = data.inputs[id];
                });
            }
        } catch (e) {
            console.error("Error loading data", e);
        }
    } else {
        document.getElementById('date').valueAsDate = new Date();
    }
}

function resetData() {
    if (confirm("Bạn có chắc chắn muốn xóa hết dữ liệu và làm mới phiếu không?")) {
        localStorage.removeItem('exportForm_data');
        location.reload();
    }
}

function downloadPDF() {
    const element = document.getElementById('invoice-content');
    const opt = {
        margin: 0,
        filename: 'phieu-xuat-kho.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a5', orientation: 'landscape' },
        pagebreak: { mode: 'avoid-all' }
    };
    html2pdf().set(opt).from(element).save();
}

function downloadExcel() {
    // Collect data
    const phone = document.getElementById('phone').value || '';
    const storeCode = document.getElementById('storeCode').value || '';

    // Create Array of Arrays
    // A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9, K=10, L=11, M=12, N=13, O=14, P=15, Q=16
    // Requirements:
    // A: Phone
    // D: Phone
    // I: Product Name
    // L: SKU - StoreCode
    // Q: Quantity

    // Header Row
    const headers = new Array(17).fill('');
    headers[0] = "SĐT Khách";
    headers[3] = "SĐT Khách";
    headers[8] = "Tên Sản Phẩm";
    headers[11] = "Mã SP - Mã GH";
    headers[16] = "Số Lượng";

    const data = [headers];

    products.forEach(p => {
        const row = new Array(17).fill(''); // Create empty row up to index 16 (Q)

        row[0] = phone; // A: SĐT khách
        row[3] = phone; // D: SĐT khách
        row[8] = p.name; // I: Tên sản phẩm
        row[11] = `${p.sku}-${storeCode}`; // L: Mã SP - Mã GH
        row[16] = Number(p.qty); // Q: Số lượng

        data.push(row);
    });

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

    // Generate Excel file
    XLSX.writeFile(wb, "danh-sach-xuat-hang.xlsx");
}
</script>
</body>

</html>

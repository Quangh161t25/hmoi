<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>B√ÅO C√ÅO CHI TI·∫æT ƒê∆†N H√ÄNG</title>
<style>
/* CSS cho giao di·ªán t·ªïng th·ªÉ v√† c√°c bi·∫øn m√†u */
:root{
  --primary:#3498db;--secondary:#2c3e50;--success:#27ae60;--danger:#e74c3c;
  --warning:#f39c12;--info:#17a2b8;--light:#f8f9fa;--dark:#343a40;
  --transition:all .3s ease;--box-shadow:0 4px 12px rgba(0,0,0,.08);
  --border-radius:8px;
}
* {
  box-sizing: border-box;
}
body{
  font-family:'Segoe UI', 'Roboto', sans-serif;
  background:#f0f4f8;
  margin:0;
  padding:20px;
  color:#333;
  line-height:1.5;
}
.container{
  background:#fff;
  border-radius:var(--border-radius);
  box-shadow:var(--box-shadow);
  max-width:1400px;
  margin:0 auto;
  overflow:hidden;
}
.header{
  background:linear-gradient(135deg, var(--primary), var(--secondary));
  color:#fff;
  text-align:center;
  padding:25px 20px;
  position:relative;
}
.header h2 {
  margin:0;
  font-weight:600;
  font-size:1.5rem;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

/* CSS cho Filter Controls */
.filter-section {
  padding:20px;
  background:#f8fafc;
  border-bottom:1px solid #e1e8f0;
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}
.filter-group {
  flex:1;
  min-width:200px;
}
.filter-label {
  font-size:14px;
  color:#555;
  margin-bottom:8px;
  font-weight:600;
  display:block;
}
.filter-buttons-container {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.btn-filter {
  padding:8px 14px;
  border:1px solid #d1d9e6;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  background-color:#fff;
  color:#333;
  transition:var(--transition);
  flex-shrink:0;
}
.btn-filter.active {
  background-color:var(--primary);
  border-color:var(--primary);
  color:#fff;
  box-shadow:0 2px 4px rgba(52,152,219,0.3);
}
.btn-filter:hover:not(.active) {
  background-color:#f0f3f8;
  transform:translateY(-1px);
}

.quick-filter-bar {
  padding:15px 20px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  border-bottom:1px solid #e1e8f0;
  background:#f8fafc;
}
.btn-quick {
  padding:8px 16px;
  border:1px solid #d1d9e6;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
  background-color:#fff;
  color:#333;
  transition:var(--transition);
  margin-bottom:0;
  font-weight:500;
}
.btn-quick.active, .btn-quick:hover {
  background-color:var(--primary);
  border-color:var(--primary);
  color:#fff;
  box-shadow:0 2px 4px rgba(52,152,219,0.3);
}

.controls-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:15px;
  padding:20px;
  background:#f8fafc;
}
.input-group {
  display:flex;
  flex-direction:column;
}
.input-group label {
  font-size:13px;
  color:#555;
  margin-bottom:6px;
  font-weight:500;
}
.filter-input {
  padding:10px 12px;
  border:1px solid #d1d9e6;
  border-radius:6px;
  font-size:14px;
  background-color:#fff;
  transition:border-color .2s;
  width:100%; 
  box-sizing:border-box;
}
.filter-input:focus {
  border-color:var(--primary);
  outline:none;
  box-shadow:0 0 0 3px rgba(52,152,219,0.1);
}
.action-buttons {
  display:flex;
  flex-direction:row;
  align-items:flex-end; 
  gap:10px;
}
.btn {
  padding:10px 16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:500;
  transition:var(--transition);
  white-space:nowrap;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:5px;
}
.btn-primary {
  background:var(--primary);
  color:#fff;
  box-shadow:0 2px 4px rgba(52,152,219,0.3);
}
.btn-secondary {
  background:#e9ecef;
  color:#495057;
}
.btn:hover{
  opacity:0.9;
  transform:translateY(-1px);
}

/* CSS cho Summary Metrics */
.summary-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  padding:25px 20px;
  background:#fff;
}
.metric-box{
  background:#fff;
  padding:20px;
  border-radius:var(--border-radius);
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  border-left:4px solid var(--primary);
  transition:var(--transition);
  display:flex;
  flex-direction:column;
}
.metric-box:hover {
  transform:translateY(-3px);
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
.metric-box.danger{border-left-color:var(--danger)}
.metric-box.success{border-left-color:var(--success)}
.metric-box.warning{border-left-color:var(--warning)}
.metric-title{
  font-size:13px;
  color:#777;
  margin-bottom:8px;
  text-transform:uppercase;
  font-weight:600;
  letter-spacing:0.5px;
}
.metric-value{
  font-size:22px;
  font-weight:700;
  color:#333;
}
.metric-value.negative{color:var(--danger)}
.metric-value.positive{color:var(--success)}

/* CSS cho B·∫£ng D·ªØ li·ªáu */
.table-section {
  padding:0 20px 20px;
}
.table-wrapper{
  overflow-x:auto;
  border:1px solid #e1e8f0;
  border-radius:var(--border-radius);
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width:1400px;
}
th,td{
  border:1px solid #e8edf5;
  padding:12px 10px;
  text-align:left;
  white-space:nowrap;
}
th{
  background:#f0f3fa;
  position:sticky;
  top:0;
  z-index:1;
  font-weight:600;
  color:#2c3e50;
}
tr:nth-child(even){background:#fafcff}
tr:hover{background:#f0f5ff}
.loading{
  text-align:center;
  padding:40px;
  font-size:16px;
  color:var(--primary);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
}
.loading:after {
  content:"";
  width:40px;
  height:40px;
  border:4px solid #f3f3f3;
  border-top:4px solid var(--primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* CSS cho Pagination */
.pagination-controls{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 20px;
  background:#fff;
  border-top:1px solid #eee;
  flex-wrap:wrap;
  gap:15px;
}
.page-size-select{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:14px;
}
.pagination-info{
  font-size:14px;
  color:#555;
}
.pagination-buttons{
  display:flex;
  gap:5px;
}
.pagination-buttons button{
  padding:8px 12px;
  border:1px solid #ddd;
  border-radius:4px;
  background:#fff;
  cursor:pointer;
  transition:var(--transition);
  font-size:13px;
  min-width:40px;
}
.pagination-buttons button:hover:not(:disabled){
  background:#f0f0f0;
}
.pagination-buttons button:disabled{
  opacity:.5;
  cursor:not-allowed;
}
.pagination-buttons .active{
  background:var(--primary);
  color:#fff;
  border-color:var(--primary);
}
.pagination-buttons span {
  padding:8px 4px;
  font-size:13px;
  color:#777;
}

/* Responsive */
@media(max-width:768px){
  .summary-grid{grid-template-columns:1fr 1fr;}
  .pagination-controls{flex-direction:column;align-items:flex-start;gap:15px;}
  .controls-grid{grid-template-columns:1fr;}
  .action-buttons{flex-direction:row;}
  .filter-section{flex-direction:column;}
  .header h2{font-size:1.3rem;}
}
@media(max-width:480px){
  .summary-grid{grid-template-columns:1fr;}
  body{padding:10px;}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>üìã B√°o c√°o Chi ti·∫øt ƒê∆°n H√†ng</h2>
  </div>

  <!-- KHU V·ª∞C L·ªåC NHANH NG√ÄY TH√ÅNG -->
 
  
  <!-- KHU V·ª∞C L·ªåC N√öT B·∫§M (T√åNH TR·∫†NG & TR·∫†NG TH√ÅI) -->
  

  <!-- KHU V·ª∞C T√ìM T·∫ÆT CH·ªà S·ªê -->
  <div id="summaryMetrics" class="summary-grid">
    <div class="metric-box">
      <div class="metric-title">1. T·ªïng ƒê∆°n H√†ng</div>
      <div class="metric-value" id="totalOrders">...</div>
    </div>
    <div class="metric-box success">
      <div class="metric-title">2. T·ªïng Doanh Thu (B√°n)</div>
      <div class="metric-value" id="totalRevenue">...</div>
    </div>
    <div class="metric-box">
      <div class="metric-title">3. T·ªïng Gi√° V·ªën (Nh·∫≠p)</div>
      <div class="metric-value" id="totalCost">...</div>
      </div>
    <div class="metric-box">
      <div class="metric-title">4. T·ªïng QC Ph√¢n B·ªï</div>
      <div class="metric-value" id="totalAdCost">...</div>
    </div>
    <div class="metric-box danger">
      <div class="metric-title">5. S·ªë ƒê∆°n Ho√†n/H·ªßy</div>
      <div class="metric-value" id="totalCanceledOrders">...</div>
    </div>
    <div class="metric-box danger">
      <div class="metric-title">6. Chi Ph√≠ Ho√†n H·ªßy (LN)</div>
      <div class="metric-value" id="costOfCanceledOrders">...</div>
    </div>
    <div class="metric-box success">
      <div class="metric-title">7. L·ª£i Nhu·∫≠n R√≤ng</div>
      <div class="metric-value" id="netProfit">...</div>
    </div>
  </div>
  

  <!-- KHU V·ª∞C ƒêI·ªÄU KHI·ªÇN L·ªåC TRUY·ªÄN TH·ªêNG -->
  <div class="controls-grid" id="filterControls">
    <!-- √î T√¨m ki·∫øm chung -->
    <div class="input-group">
      <label for="globalSearch">T√¨m ki·∫øm chung:</label>
      <input type="text" id="globalSearch" class="filter-input" placeholder="Nh·∫≠p m√£ ƒë∆°n, m√£ shop, t√¨nh tr·∫°ng..." onkeyup="applyFilters()"/>
    </div>
    <div class="input-group">
      <label for="fromDate">T·ª´ Ng√†y:</label>
      <input type="date" id="fromDate" class="filter-input" onchange="applyFilters()"/>
    </div>
    <div class="input-group">
      <label for="toDate">T·ªõi Ng√†y:</label>
      <input type="date" id="toDate" class="filter-input" onchange="applyFilters()"/>
    </div>
    <!-- Select Box M√£ Shop -->
    <div class="input-group">
      <label for="shopCodeFilter">M√£ Shop:</label>
      <select id="ma_shopFilter" class="filter-input" onchange="applyFilters()"></select>
    </div>
    
    <div class="input-group action-buttons">
      <button class="btn btn-primary" onclick="applyFilters()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10 18H14V16H10V18ZM3 6V8H21V6H3ZM6 13H18V11H6V13Z" fill="currentColor"/>
        </svg>
        L·ªçc L·∫°i
      </button>
      <button class="btn btn-secondary" onclick="clearFilters()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
        </svg>
        X√≥a L·ªçc
      </button>
    </div>
  </div>
  <div class="filter-section">
    <div class="filter-group">
      <div class="filter-label">T√¨nh Tr·∫°ng:</div>
      <div id="tinh_trangButtons" class="filter-buttons-container" data-filter-col="tinh_trang">
        <!-- N√∫t b·∫•m ƒë∆∞·ª£c ch√®n b·∫±ng JS -->
      </div>
    </div>
    <div class="filter-group">
      <div class="filter-label">Tr·∫°ng Th√°i:</div>
      <div id="trang_thaiButtons" class="filter-buttons-container" data-filter-col="trang_thai">
        <!-- N√∫t b·∫•m ƒë∆∞·ª£c ch√®n b·∫±ng JS -->
      </div>
    </div>
  </div>
<div class="quick-filter-bar" id="quickFilterBar">
    <button class="btn-quick" id="btn-today" onclick="setQuickFilter('today')">H√¥m Nay</button>
    <button class="btn-quick" id="btn-yesterday" onclick="setQuickFilter('yesterday')">H√¥m Qua</button>
    <button class="btn-quick" id="btn-this-week" onclick="setQuickFilter('this-week')">Tu·∫ßn N√†y</button>
    <button class="btn-quick" id="btn-last-week" onclick="setQuickFilter('last-week')">Tu·∫ßn Tr∆∞·ªõc</button>
    <button class="btn-quick" id="btn-this-month" onclick="setQuickFilter('this-month')">Th√°ng N√†y</button>
  </div>
  <!-- B·∫¢NG D·ªÆ LI·ªÜU -->
  <div id="dataSection" class="table-section">
    <div class="loading" id="loadingIndicator">ƒêang t·∫£i to√†n b·ªô d·ªØ li·ªáu...</div>
    <div class="table-wrapper" id="tableWrapper" style="display:none;">
      <table id="data-table">
        <thead><tr id="header-row"></tr></thead>
        <tbody id="data-body"></tbody>
      </table>
    </div>
    <!-- KHU V·ª∞C PH√ÇN TRANG -->
    <div id="paginationControls" class="pagination-controls" style="display:none;">
      <div class="page-size-select">
        Hi·ªÉn th·ªã:
        <select id="pageSizeSelect" onchange="changePageSize(this.value)">
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="400">400</option>
          <option value="500">500</option>
        </select>
        d√≤ng
      </div>
      <div id="paginationInfo" class="pagination-info"></div>
      <div id="paginationButtons" class="pagination-buttons"></div>
    </div>
  </div>
</div>

<script>
// URL API - ƒê·∫£m b·∫£o URL n√†y l√† URL th·ª±c t·∫ø c·ªßa b·∫°n
const API_URL = "https://script.google.com/macros/s/AKfycbwhIPBU-5nj95IYYWvb5RS1DodSHE709w2d4UupOv6AES0B9dL2lQ8RMOoVKYVBbLU/exec";
let originalData = []; // D·ªØ li·ªáu g·ªëc sau khi t·∫£i
let filteredData = []; // D·ªØ li·ªáu sau khi ƒë√£ ƒë∆∞·ª£c l·ªçc
let currentPage = 1;
let pageSize = 50; 

// Bi·∫øn l∆∞u tr·ªØ gi√° tr·ªã l·ªçc n√∫t b·∫•m
const activeButtonFilters = {
  tinh_trang: '', // Gi√° tr·ªã ƒë∆∞·ª£c ch·ªçn cho T√¨nh Tr·∫°ng
  trang_thai: '' // Gi√° tr·ªã ƒë∆∞·ª£c ch·ªçn cho Tr·∫°ng Th√°i
};

// Bi·∫øn l∆∞u tr·ªØ b·ªô l·ªçc nhanh ƒëang √°p d·ª•ng
let currentQuickFilter = null; 

/* Danh s√°ch c√°c c·ªôt mu·ªën hi·ªÉn th·ªã */
const DISPLAY_COLS = [
  "STT", "Ng√†y nh·∫≠p", "ma_shop", "mvd", "mdh", "all_id_sp", "thanh_tien_nhap", 
  "thanh_tien_ban", "phan_bo_quang_cao", "loi_nhuan", "tinh_trang", "trang_thai", "udt"
];

/* H√†m h·ªó tr·ª£ ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá */
function formatCurrency(number) {
  if (typeof number !== 'number' || isNaN(number)) return '0';
  return number.toLocaleString('vi-VN');
}

/* H√†m chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng ng√†y dd/mm/yyyy sang ƒë·ªëi t∆∞·ª£ng Date */
function parseDateVi(dateString) {
  if (!dateString) return null;
  // X·ª≠ l√Ω c√°c ƒë·ªãnh d·∫°ng ng√†y ph·ªï bi·∫øn (dd/mm/yyyy ho·∫∑c dd-mm-yyyy, b·ªè qua ph·∫ßn gi·ªù n·∫øu c√≥)
  const parts = dateString.split(/[\/\-| ]/).filter(p => p.trim()).map(p => p.trim());
  if (parts.length >= 3) {
    // C·∫ßn ƒë·∫£m b·∫£o th·ª© t·ª± ng√†y/th√°ng/nƒÉm
    const [day, month, year] = parts.slice(0, 3).map(Number);
    // Tr·∫£ v·ªÅ ng√†y ƒë·∫ßu ti√™n c·ªßa ng√†y (00:00:00)
    return new Date(year, month - 1, day); 
  }
  return null;
}

/* H√†m chuy·ªÉn ƒë·ªïi Date sang chu·ªói YYYY-MM-DD (cho input type="date") */
function formatDate(date) {
  const d = new Date(date);
  let month = '' + (d.getMonth() + 1);
  let day = '' + d.getDate();
  const year = d.getFullYear();

  if (month.length < 2) month = '0' + month;
  if (day.length < 2) day = '0' + day;

  return [year, month, day].join('-');
}

/* H√†m l·∫•y gi√° tr·ªã s·ªë t·ª´ chu·ªói d·ªØ li·ªáu (x·ª≠ l√Ω d·∫•u ph·∫©y) */
function getNumericValue(row, key) {
  const content = row[key] || "";
  const num = parseFloat(String(content).replace(/,/g, ''));
  return isNaN(num) ? 0 : num;
}


/* ===== Load d·ªØ li·ªáu ban ƒë·∫ßu ===== */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("loadingIndicator").style.display = "block";
  document.getElementById("tableWrapper").style.display = "none";
  document.getElementById("paginationControls").style.display = "none";

  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      const sheetData = data.find(s => s.sheetName === "ƒê∆†N_H√ÄNG");
      // L·∫•y d·ªØ li·ªáu v√† b·ªè qua h√†ng ti√™u ƒë·ªÅ ƒë·∫ßu ti√™n n·∫øu c·∫ßn
      originalData = (sheetData && Array.isArray(sheetData.data)) ? sheetData.data : [];
      
      // S·∫Øp x·∫øp theo c·ªôt 'Ng√†y nh·∫≠p' gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n tr√™n)
      originalData.sort((a, b) => {
        const dateA = parseDateVi(a['Ng√†y nh·∫≠p']);
        const dateB = parseDateVi(b['Ng√†y nh·∫≠p']);
        return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
      });

      // 1. ƒêi·ªÅn gi√° tr·ªã duy nh·∫•t v√†o b·ªô l·ªçc
      populateFilters(originalData);

      // 2. Thi·∫øt l·∫≠p l·ªçc m·∫∑c ƒë·ªãnh l√† H√¥m Nay
      setQuickFilter('today'); 
      // applyFilters() ƒë∆∞·ª£c g·ªçi b√™n trong setQuickFilter

      document.getElementById("loadingIndicator").style.display = "none";
      // tableWrapper hi·ªÉn th·ªã sau khi applyFilters() ho√†n th√†nh
    })
    .catch(e => {
      console.error("L·ªói t·∫£i d·ªØ li·ªáu:", e);
      document.getElementById("loadingIndicator").textContent = "L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.";
    });
});


/* ===== L·ªçc Nhanh Ng√†y Th√°ng (Quick Filters) ===== */

function setQuickFilter(period) {
  const now = new Date();
  let startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // ƒê·∫∑t v·ªÅ 00:00:00
  let endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
  
  // B·ªè highlight c≈© v√† highlight n√∫t m·ªõi
  document.querySelectorAll('.btn-quick').forEach(btn => btn.classList.remove('active'));
  const newActiveBtn = document.getElementById(`btn-${period}`);
  if (newActiveBtn) newActiveBtn.classList.add('active');

  currentQuickFilter = period;

  switch (period) {
    case 'today':
      // startDate v√† endDate ƒë√£ l√† h√¥m nay
      break;
    case 'yesterday':
      startDate.setDate(now.getDate() - 1);
      endDate.setDate(now.getDate() - 1);
      break;
    case 'this-week':
      // 0 l√† Ch·ªß Nh·∫≠t, 1 l√† Th·ª© Hai. Mu·ªën b·∫Øt ƒë·∫ßu t·ª´ Th·ª© Hai (ƒë·∫∑t 1 l√† ng√†y ƒë·∫ßu tu·∫ßn)
      const dayOfWeek = (now.getDay() === 0) ? 6 : now.getDay() - 1; 
      startDate.setDate(now.getDate() - dayOfWeek);
      endDate.setDate(startDate.getDate() + 6); 
      break;
    case 'last-week':
      const lastWeekStartDay = now.getDay() === 0 ? 6 : now.getDay() - 1;
      startDate.setDate(now.getDate() - lastWeekStartDay - 7);
      endDate.setDate(startDate.getDate() + 6);
      break;
    case 'this-month':
      startDate.setDate(1); 
      endDate.setMonth(now.getMonth() + 1);
      endDate.setDate(0);
      break;
    default:
      currentQuickFilter = null; // V√¥ hi·ªáu h√≥a quick filter n·∫øu l√† clearFilters
      return;
  }

  const toDateInput = document.getElementById('toDate');
  const fromDateInput = document.getElementById('fromDate');
  
  fromDateInput.value = formatDate(startDate);
  toDateInput.value = formatDate(endDate);
  
  applyFilters();
}


/* ===== X·ª≠ l√Ω B·ªô l·ªçc D·ªØ li·ªáu (Bao g·ªìm T√¨m ki·∫øm chung) ===== */

// H√†m ƒëi·ªÅn c√°c gi√° tr·ªã duy nh·∫•t v√†o Select Box (M√£ Shop) v√† Button Groups (T√¨nh Tr·∫°ng, Tr·∫°ng Th√°i)
function populateFilters(data) {
  // 1. Populate M√£ Shop (Select Box)
  const maShopSelectEl = document.getElementById('ma_shopFilter');
  const uniqueMaShop = [...new Set(data.map(r => r['ma_shop']).filter(v => v !== null && v !== undefined && v !== ''))].sort();
  maShopSelectEl.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
  uniqueMaShop.forEach(val => {
    const option = document.createElement('option');
    option.value = val;
    option.textContent = val;
    maShopSelectEl.appendChild(option);
  });

  // 2. Populate T√¨nh Tr·∫°ng & Tr·∫°ng Th√°i (Buttons)
  ['tinh_trang', 'trang_thai'].forEach(col => {
    const containerEl = document.getElementById(col + 'Buttons'); 
    if (!containerEl) return;
    
    const uniqueValues = [...new Set(data.map(r => r[col]).filter(v => v !== null && v !== undefined && v !== ''))].sort();
    
    containerEl.innerHTML = '';

    // Th√™m n√∫t 'T·∫•t c·∫£'
    const allButton = document.createElement('button');
    allButton.className = 'btn-filter active'; // M·∫∑c ƒë·ªãnh l√† 'T·∫•t c·∫£' ƒë∆∞·ª£c ch·ªçn
    allButton.textContent = '-- T·∫•t c·∫£ --';
    allButton.setAttribute('data-value', '');
    allButton.setAttribute('onclick', `setButtonFilter('${col}', '')`);
    containerEl.appendChild(allButton);

    // Th√™m c√°c n√∫t gi√° tr·ªã duy nh·∫•t
    uniqueValues.forEach(val => {
      const button = document.createElement('button');
      button.className = 'btn-filter';
      button.textContent = val;
      button.setAttribute('data-value', val);
      button.setAttribute('onclick', `setButtonFilter('${col}', '${val}')`);
      containerEl.appendChild(button);
    });
  });
}

// H√†m x·ª≠ l√Ω khi nh·∫•n n√∫t l·ªçc (T√¨nh Tr·∫°ng/Tr·∫°ng Th√°i)
function setButtonFilter(col, value) {
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i
  activeButtonFilters[col] = value;

  // Highlight n√∫t
  const containerEl = document.getElementById(col + 'Buttons');
  containerEl.querySelectorAll('.btn-filter').forEach(btn => {
    if (btn.getAttribute('data-value') === value) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // √Åp d·ª•ng b·ªô l·ªçc
  applyFilters();
}


// H√†m √°p d·ª•ng t·∫•t c·∫£ c√°c b·ªô l·ªçc (Date, Selects, Buttons, Search)
function applyFilters() {
  document.getElementById("loadingIndicator").style.display = "block";
  document.getElementById("tableWrapper").style.display = "none";
  document.getElementById("paginationControls").style.display = "none";

  const fromDateStr = document.getElementById('fromDate').value;
  const toDateStr = document.getElementById('toDate').value;
  // Select Box
  const shopCode = document.getElementById('ma_shopFilter').value;
  // Button Filters
  const tinhTrang = activeButtonFilters.tinh_trang;
  const trangThai = activeButtonFilters.trang_thai;
  // T√¨m ki·∫øm chung 
  const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();

  // Chuy·ªÉn ng√†y YYYY-MM-DD t·ª´ input sang ƒë·ªëi t∆∞·ª£ng Date ƒë·ªÉ so s√°nh
  const fromDate = fromDateStr ? new Date(fromDateStr + "T00:00:00") : null;
  const toDate = toDateStr ? new Date(toDateStr + "T23:59:59") : null;

  const filtered = originalData.filter(r => {
    
    // 1. L·ªçc theo Ng√†y nh·∫≠p
    let passesDate = true;
    const dataDate = parseDateVi(r['Ng√†y nh·∫≠p']);
    
    if (dataDate) {
      if (fromDate && dataDate.getTime() < fromDate.getTime()) passesDate = false;
      // So s√°nh v·ªõi toDate, ƒë·∫£m b·∫£o toDate bao g·ªìm c·∫£ ng√†y ƒë√≥ (23:59:59)
      if (toDate && dataDate.getTime() > toDate.getTime()) passesDate = false; 
    } else if (fromDate || toDate) {
      passesDate = false; 
    }

    // 2. L·ªçc theo M√£ Shop (Select Box)
    const passesShop = !shopCode || (r['ma_shop'] || '').includes(shopCode);
    
    // 3. L·ªçc theo T√¨nh tr·∫°ng (Button)
    const passesTinhTrang = !tinhTrang || (r['tinh_trang'] || '') === tinhTrang;
    
    // 4. L·ªçc theo Tr·∫°ng th√°i (Button)
    const passesTrangThai = !trangThai || (r['trang_thai'] || '') === trangThai;

    // 5. L·ªçc theo T√¨m ki·∫øm chung 
    let passesSearch = true;
    if (searchTerm) {
      // Ki·ªÉm tra xem gi√° tr·ªã t√¨m ki·∫øm c√≥ t·ªìn t·∫°i trong B·∫§T K·ª≤ c·ªôt n√†o c·ªßa h√†ng kh√¥ng
      passesSearch = Object.values(r).some(val => 
        String(val || '').toLowerCase().includes(searchTerm)
      );
    }

    return passesDate && passesShop && passesTinhTrang && passesTrangThai && passesSearch;
  });

  filteredData = filtered;

  // C·∫≠p nh·∫≠t T√≥m t·∫Øt
  calculateSummary(filteredData);

  // Reset ph√¢n trang v·ªÅ trang 1 sau khi l·ªçc
  currentPage = 1;
  renderPaginatedTable();

  // ·∫®n/hi·ªán Loading v√† B·∫£ng
  document.getElementById("loadingIndicator").style.display = "none";
  document.getElementById("tableWrapper").style.display = "block";

  // Hi·ªÉn th·ªã/·∫®n ƒëi·ªÅu khi·ªÉn ph√¢n trang
  if (filteredData.length > pageSize) {
    document.getElementById("paginationControls").style.display = "flex";
  } else {
    document.getElementById("paginationControls").style.display = "none";
  }
}

// H√†m x√≥a t·∫•t c·∫£ b·ªô l·ªçc
function clearFilters() {
  // X√≥a l·ªçc ng√†y th√°ng
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';

  // X√≥a l·ªçc select box
  document.getElementById('ma_shopFilter').value = '';

  // X√≥a l·ªçc n√∫t b·∫•m
  ['tinh_trang', 'trang_thai'].forEach(col => {
    setButtonFilter(col, ''); // ƒê·∫∑t l·∫°i v·ªÅ gi√° tr·ªã r·ªóng (T·∫•t c·∫£)
  });

  // X√≥a t√¨m ki·∫øm chung
  document.getElementById('globalSearch').value = '';
  
  // B·ªè highlight tr√™n c√°c n√∫t l·ªçc nhanh ng√†y th√°ng
  document.querySelectorAll('.btn-quick').forEach(btn => btn.classList.remove('active'));
  currentQuickFilter = null;
  
  applyFilters();
}


/* ===== PH√ÇN TRANG (PAGINATION) FUNCTIONS ===== */

// Thay ƒë·ªïi s·ªë l∆∞·ª£ng d√≤ng hi·ªÉn th·ªã tr√™n m·ªói trang
function changePageSize(size) {
  pageSize = parseInt(size);
  currentPage = 1; // Lu√¥n quay v·ªÅ trang ƒë·∫ßu ti√™n khi ƒë·ªïi k√≠ch th∆∞·ªõc trang
  renderPaginatedTable();
}

// Chuy·ªÉn ƒë·∫øn m·ªôt trang c·ª• th·ªÉ
function goToPage(page) {
  const totalPages = Math.ceil(filteredData.length / pageSize);
  if (page >= 1 && page <= totalPages) {
    currentPage = page;
    renderPaginatedTable();
  }
}

// Hi·ªÉn th·ªã b·∫£ng v·ªõi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ph√¢n trang
function renderPaginatedTable() {
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const dataToDisplay = filteredData.slice(startIndex, endIndex);

  renderTable(dataToDisplay, startIndex); 
  renderPaginationControls();
}

// Hi·ªÉn th·ªã c√°c n√∫t ƒëi·ªÅu khi·ªÉn ph√¢n trang
function renderPaginationControls() {
  const totalItems = filteredData.length;
  const totalPages = Math.ceil(totalItems / pageSize);
  const startItem = (currentPage - 1) * pageSize + 1;
  const endItem = Math.min(currentPage * pageSize, totalItems);
  const info = document.getElementById('paginationInfo');
  const buttonsContainer = document.getElementById('paginationButtons');

  if (totalItems === 0) {
    info.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu";
    buttonsContainer.innerHTML = "";
    return;
  }
  
  if (totalItems <= pageSize) {
    info.textContent = `Hi·ªÉn th·ªã ${totalItems} d√≤ng`;
    buttonsContainer.innerHTML = "";
    return;
  }

  info.textContent = `ƒêang hi·ªÉn th·ªã t·ª´ ${startItem} ƒë·∫øn ${endItem} c·ªßa ${totalItems} d√≤ng`;
  
  buttonsContainer.innerHTML = '';

  // N√∫t 'Trang tr∆∞·ªõc'
  buttonsContainer.innerHTML += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Tr∆∞·ªõc</button>`;

  // Logic hi·ªÉn th·ªã t·ªëi ƒëa 5 n√∫t trang (ho·∫∑c √≠t h∆°n)
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  if (currentPage <= 3) endPage = Math.min(5, totalPages);
  if (currentPage > totalPages - 2) startPage = Math.max(1, totalPages - 4);
  
  // Th√™m n√∫t 1 v√† d·∫•u ... n·∫øu c·∫ßn
  if (startPage > 1) {
    buttonsContainer.innerHTML += `<button onclick="goToPage(1)">1</button>`;
    if (startPage > 2) buttonsContainer.innerHTML += `<span>...</span>`;
  }

  // Th√™m c√°c n√∫t trang gi·ªØa
  for (let i = startPage; i <= endPage; i++) {
    buttonsContainer.innerHTML += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
  }
  
  // Th√™m n√∫t cu·ªëi v√† d·∫•u ... n·∫øu c·∫ßn
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) buttonsContainer.innerHTML += `<span>...</span>`;
    buttonsContainer.innerHTML += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
  }

  // N√∫t 'Trang sau'
  buttonsContainer.innerHTML += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Sau &raquo;</button>`;
}


/* ===== T√≠nh to√°n T√≥m t·∫Øt Ch·ªâ s·ªë (Summary) ===== */

function calculateSummary(data) {
  const summary = {
    totalOrders: data.length, 
    totalRevenue: 0, 
    totalCost: 0, 
    totalAdCost: 0, 
    canceledOrders: 0, 
    costOfCanceledOrders: 0, 
    netProfit: 0 
  };

  data.forEach(r => {
    const revenue = getNumericValue(r, 'thanh_tien_ban');
    const cost = getNumericValue(r, 'thanh_tien_nhap');
    const adCost = getNumericValue(r, 'phan_bo_quang_cao');
    const profit = getNumericValue(r, 'loi_nhuan');
    // X√°c ƒë·ªãnh ƒë∆°n ho√†n/h·ªßy
    const isCanceled = (r['trang_thai'] || '').toUpperCase().includes('HUY');

    summary.totalRevenue += revenue;
    summary.totalCost += cost;
    summary.totalAdCost += adCost;
    summary.netProfit += profit;

    if (isCanceled) {
      summary.canceledOrders++;
      // Chi ph√≠ ho√†n h·ªßy ƒë∆∞·ª£c t√≠nh l√† L·ª£i nhu·∫≠n c·ªßa ƒë∆°n ƒë√≥
      summary.costOfCanceledOrders += profit; 
    }
  });

  displaySummary(summary);
}

function displaySummary(summary) {
  const { totalOrders, totalRevenue, totalCost, totalAdCost, canceledOrders, costOfCanceledOrders, netProfit } = summary;

  // 1. T·ªïng ƒë∆°n h√†ng
  document.getElementById('totalOrders').textContent = totalOrders.toLocaleString('vi-VN');

  // 2. T·ªïng doanh thu
  document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

  // 3. T·ªïng gi√° v·ªën
  document.getElementById('totalCost').textContent = formatCurrency(totalCost);

  // 4. T·ªïng chi ph√≠ QC
  document.getElementById('totalAdCost').textContent = formatCurrency(totalAdCost);

  // 5. S·ªë ƒë∆°n ho√†n/h·ªßy
  document.getElementById('totalCanceledOrders').textContent = canceledOrders.toLocaleString('vi-VN');

  // 6. Chi ph√≠ ho√†n
  const costOfCanceledEl = document.getElementById('costOfCanceledOrders');
  costOfCanceledEl.textContent = formatCurrency(costOfCanceledOrders);
  const costBox6 = costOfCanceledEl.closest('.metric-box');
  costBox6.classList.remove('danger', 'success');
  costBox6.classList.add(costOfCanceledOrders < 0 ? 'danger' : 'success');

  // 7. L·ª£i nhu·∫≠n r√≤ng
  const netProfitEl = document.getElementById('netProfit');
  netProfitEl.textContent = formatCurrency(netProfit);
  const netProfitBox7 = netProfitEl.closest('.metric-box');
  netProfitBox7.classList.remove('danger', 'success');
  netProfitBox7.classList.add(netProfit >= 0 ? 'success' : 'danger');
}


/* ===== B·∫£ng d·ªØ li·ªáu: H√†m renderTable ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ x·ª≠ l√Ω STT ph√¢n trang ===== */
function renderTable(data, startIndex = 0){
  const h = document.getElementById("header-row");
  const b = document.getElementById("data-body");
  h.innerHTML = "";
  b.innerHTML = "";
  
  // Render Header
  DISPLAY_COLS.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c;
    h.appendChild(th);
  });

  // Render Body
  data.forEach((r, i) => {
    const tr = document.createElement("tr");
    DISPLAY_COLS.forEach(c => {
      const td = document.createElement("td");
      let content = r[c] || "";

      if (c === "STT") {
        td.textContent = startIndex + i + 1; // T√≠nh STT d·ª±a tr√™n trang hi·ªán t·∫°i
      } else if (content && (c.includes('tien') || c.includes('loi_nhuan') || c.includes('quang_cao'))) {
        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
        const num = getNumericValue(r, c);
        td.textContent = formatCurrency(num);
        td.style.textAlign = 'right';
        // Highlight m√†u ƒë·ªè cho s·ªë √¢m (L·ª£i nhu·∫≠n l·ªó)
        if (c === 'loi_nhuan' && num < 0) {
          td.style.color = 'var(--danger)';
        }
      } else if (c.includes('Ng√†y') || c === 'udt') {
        // ƒê·ªãnh d·∫°ng ng√†y (ch·ªâ l·∫•y ph·∫ßn ng√†y/th√°ng/nƒÉm ƒë·∫ßu ti√™n n·∫øu c√≥ k√Ω t·ª± '|')
        td.textContent = content.split('|')[0].trim();
      } else {
        td.textContent = content;
      }
      
      tr.appendChild(td);
    });
    b.appendChild(tr);
  });
}
</script>
</body>
</html>
